

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1. PHYTEC 文档 &mdash; PHYTEC BSP Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=e72c8e07" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/phytec-theme.css?v=a2e5d7c6" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/table-wrap-text.css?v=4b2a02b9" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="canonical" href="https://phytec.github.io/doc-bsp-yocto/bsp/am6x/am62l/head.html" />
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=7d86a446"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/translations.js?v=beaddf03"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="next" title="1. 介绍" href="quickstart-alpha.html" />
    <link rel="prev" title="AM62L Manuals" href="am62l.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PHYTEC BSP Documentation
              <img src="../../../_static/logo-phytec.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BSP Manuals</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../imx8/imx8.html">i.MX 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../imx9/imx9.html">i.MX 9</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../am6x.html">AM6X</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="am62l.html">phyFLEX-AM62L Manuals</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="am62l.html#head">HEAD</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">1. PHYTEC 文档</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#supported-hardware">1.1. 支持的硬件</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#getting-started">2. 开始使用</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#get-the-image">2.1. 下载镜像</a></li>
<li class="toctree-l5"><a class="reference internal" href="#write-the-image-to-sd-card">2.2. 将镜像写入SD卡</a></li>
<li class="toctree-l5"><a class="reference internal" href="#first-start-up">2.3. 首次启动</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#building-the-bsp">3. 编译BSP</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#basic-set-up">3.1. 基本设置</a></li>
<li class="toctree-l5"><a class="reference internal" href="#get-the-bsp">3.2. 下载BSP</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#installing-the-os">4. 安装操作系统</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#bootmode-switch-s1">4.1. 启动模式开关 (S1)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#flash-e-mmc">4.2. Flash e.MMC</a></li>
<li class="toctree-l5"><a class="reference internal" href="#flash-spi-nor-flash">4.3. 烧写 SPI NOR Flash</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#development">5. 开发</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#standalone-build-preparation">5.1. 独立编译准备</a></li>
<li class="toctree-l5"><a class="reference internal" href="#u-boot-standalone-build">5.2. 单独编译U-Boot</a></li>
<li class="toctree-l5"><a class="reference internal" href="#kernel-standalone-build">5.3. 单独编译内核</a></li>
<li class="toctree-l5"><a class="reference internal" href="#host-network-preparation">5.4. 主机网络准备</a></li>
<li class="toctree-l5"><a class="reference internal" href="#booting-the-kernel-from-a-network">5.5. 从网络启动内核</a></li>
<li class="toctree-l5"><a class="reference internal" href="#accessing-the-development-states">5.6. 获取BSP开发中版本</a></li>
<li class="toctree-l5"><a class="reference internal" href="#accessing-the-latest-upstream-support">5.7. 获取最新的Upstream支持</a></li>
<li class="toctree-l5"><a class="reference internal" href="#format-sd-card">5.8. Format SD card</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#device-tree-dt">6. 设备树 (DT)</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#introduction">6.1. 介绍</a></li>
<li class="toctree-l5"><a class="reference internal" href="#phytec-soc-bsp-device-tree-concept">6.2. PHYTEC AM62L BSP设备树概念</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#accessing-peripherals">7. 访问外设</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#soc-pin-muxing">7.1. AM62L 引脚复用</a></li>
<li class="toctree-l5"><a class="reference internal" href="#rs232">7.2. RS232</a></li>
<li class="toctree-l5"><a class="reference internal" href="#network">7.3. 网络</a></li>
<li class="toctree-l5"><a class="reference internal" href="#sd-card">7.4. SD card</a></li>
<li class="toctree-l5"><a class="reference internal" href="#e-mmc-devices">7.5. e.MMC Devices</a></li>
<li class="toctree-l5"><a class="reference internal" href="#spi-master">7.6. SPI主设备</a></li>
<li class="toctree-l5"><a class="reference internal" href="#gpios">7.7. GPIOs</a></li>
<li class="toctree-l5"><a class="reference internal" href="#adc">7.8. ADC</a></li>
<li class="toctree-l5"><a class="reference internal" href="#leds">7.9. LED灯</a></li>
<li class="toctree-l5"><a class="reference internal" href="#i2c-bus">7.10. I²C总线</a></li>
<li class="toctree-l5"><a class="reference internal" href="#eeprom">7.11. EEPROM</a></li>
<li class="toctree-l5"><a class="reference internal" href="#rtc">7.12. RTC</a></li>
<li class="toctree-l5"><a class="reference internal" href="#usb-host-controller">7.13. USB主控制器</a></li>
<li class="toctree-l5"><a class="reference internal" href="#can-fd">7.14. CAN FD</a></li>
<li class="toctree-l5"><a class="reference internal" href="#video">7.15. 视频</a></li>
<li class="toctree-l5"><a class="reference internal" href="#display">7.16. 显示</a></li>
<li class="toctree-l5"><a class="reference internal" href="#power-management">7.17. 电源管理</a></li>
<li class="toctree-l5"><a class="reference internal" href="#thermal-management">7.18. 热管理</a></li>
<li class="toctree-l5"><a class="reference internal" href="#watchdog">7.19. 看门狗</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="am62l.html#quickstart-guide-alpha">Quickstart Guide ALPHA</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Yocto Manuals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../yocto/manual-index.html">Unstable (dev)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../yocto/manual-index.html#kirkstone">Kirkstone</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../yocto/manual-index.html#mickledore">Mickledore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../yocto/manual-index.html#scarthgap">Scarthgap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../yocto/manual-index.html#walnascar">Walnascar</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application Manuals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../rauc/manual-index.html">RAUC Update &amp; Device Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/manual-index.html">Security Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coprocessor/index.html">Coprocessor</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">贡献</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing_links.html">贡献</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PHYTEC BSP Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../am6x.html">AM6X</a></li>
          <li class="breadcrumb-item"><a href="am62l.html">AM62L Manuals</a></li>
      <li class="breadcrumb-item active"><span class="section-number">1. </span>PHYTEC 文档</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/phytec/doc-bsp-yocto/blob/main/source/bsp/am6x/am62l/head.rst" class="fa fa-github"> 在 GitHub 上编辑</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>pdf格式的文档： <a class="reference external" href="../../../_static/am62l-fpsc-head.pdf">下载</a></p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Head AM62L FPSC BSP 手册模板</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>文档标题</p></td>
<td><p>Head AM62L FPSC BSP 手册模板</p></td>
</tr>
<tr class="row-odd"><td><p>文档类型</p></td>
<td><p>BSP 手册</p></td>
</tr>
<tr class="row-even"><td><p>型号</p></td>
<td><p>Head</p></td>
</tr>
<tr class="row-odd"><td><p>Yocto 手册</p></td>
<td><p>Scarthgap</p></td>
</tr>
<tr class="row-even"><td><p>发布日期</p></td>
<td><p>XXXX/XX/XX</p></td>
</tr>
<tr class="row-odd"><td><p>母文档</p></td>
<td><p>Head AM62L FPSC BSP 手册模板</p></td>
</tr>
</tbody>
</table>
<p>下表显示了与本手册兼容的 BSP：</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>适用BSP</p></th>
<th class="head"><p>BSP 发布类型</p></th>
<th class="head"><p>BSP 发布日期</p></th>
<th class="head"><p>BSP 状态</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BSP-Yocto-Ampliphy-AM62Lx-ALPHA2</p></td>
<td><p>Alpha</p></td>
<td><p>2025/07/10</p></td>
<td><p>已发布</p></td>
</tr>
</tbody>
</table>
<p>本手册指导您完成BSP包的安装、编译和烧写，并描述如何使用 <strong>phyFLEX-AM62L FPSC Kit</strong> 的硬件接口。本手册还包括如何从源码编译内核、u-boot镜像。本手册包含需要在PC(Linux操作系统)上执行的指令。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>This document contains code examples that describe the communication with the
board over the serial shell. The code examples lines begin with <code class="docutils literal notranslate"><span class="pre">host:~$</span></code>,
<code class="docutils literal notranslate"><span class="pre">target:~$</span></code> or <code class="docutils literal notranslate"><span class="pre">u-boot=&gt;</span></code>. This describes where the commands are to be
executed. Only after these keywords must the actual command be copied.</p>
</div>
<section id="phytec-documentation">
<h1><span class="section-number">1. </span>PHYTEC 文档<a class="headerlink" href="#phytec-documentation" title="Link to this heading"></a></h1>
<p>PHYTEC provides a variety of hardware and software documentation for all of its
products. This includes any or all of the following:</p>
<dl class="simple">
<dt>QS Guide</dt><dd><p>A short guide on how to set up and boot a phyCORE based board.</p>
</dd>
<dt>Hardware Manual</dt><dd><p>A detailed description of the System-on-Module and accompanying carrierboard.</p>
</dd>
<dt>Yocto Guide</dt><dd><p>A comprehensive guide for the Yocto version the phyCORE uses. This guide
contains an overview of Yocto; introducing, installing, and customizing the
PHYTEC BSP; how to work with programs like Poky and Bitbake; and much more.</p>
</dd>
<dt>BSP 手册</dt><dd><p>A manual specific to the BSP version of the phyCORE. Information such as how
to build the BSP, booting, updating software, device tree, and accessing
peripherals can be found here.</p>
</dd>
<dt>Development Environment Guide</dt><dd><p>This guide shows how to work with the Virtual Machine (VM) Host PHYTEC has
developed and prepared to run various Development Environments. There are
detailed step-by-step instructions for Eclipse and Qt Creator, which are
included in the VM. There are instructions for running demo projects for
these programs on a phyCORE product as well. Information on how to build a
Linux host PC yourself is also a part of this guide.</p>
</dd>
<dt>Pin Muxing Table</dt><dd><p>phyCORE SOMs have an accompanying pin table (in Excel format). This table
will show the complete default signal path, from the processor to the carrier
board. The default device tree muxing option will also be included. This
gives a developer all the information needed in one location to make muxing
changes and design options when developing a specialized carrier board or
adapting a PHYTEC phyCORE SOM to an application.</p>
</dd>
</dl>
<p>除了这些标准手册和指南之外，PHYTEC 还将提供产品变更通知、应用说明和技术说明。这些文档将根据具体案例进行针对性提供。大部分文档都可以在我们产品的 <a class="reference external" href="https://www.phytec.de/produkte/system-on-modules/phyflex-am62lx-fpsc/#downloads/">https://www.phytec.de/produkte/system-on-modules/phyflex-am62lx-fpsc/#downloads/</a> 中找到。</p>
<section id="supported-hardware">
<h2><span class="section-number">1.1. </span>支持的硬件<a class="headerlink" href="#supported-hardware" title="Link to this heading"></a></h2>
<p>在我们的网页上，您可以查看适用于BSP版本 BSP-Yocto-Ampliphy-AM62Lx-ALPHA2 的所有Machine及其对应的Article Numbers(产品型号)： <a class="reference external" href="https://www.phytec.de/bsp-download/?bsp=BSP-Yocto-Ampliphy-AM62Lx-ALPHA2">网页</a>.</p>
<p>如果您在“Supported Machines”一栏选择了特定的 <strong>Machine Name</strong> ，您可以查看该machine下可用的 <strong>Article Numbers</strong> 以及硬件信息的简短描述。如果您只有硬件的 <strong>Article Numbers</strong> ，您可以将 <strong>Machine Name</strong> 下拉菜单留空，仅选择您的 <strong>Article Numbers</strong> 。现在，它应该会显示您特定硬件所需的 <strong>Machine Name</strong></p>
<section id="sbc-components">
<span id="am62l-fpsc-head-components"></span><h3><span class="section-number">1.1.1. </span>Libra FPSC 器件<a class="headerlink" href="#sbc-components" title="Link to this heading"></a></h3>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="../../../_images/Libra-front-components1.jpg"><img alt="../../../_images/Libra-front-components1.jpg" src="../../../_images/Libra-front-components1.jpg" style="width: 90%;" />
</a>
<figcaption>
<p><span class="caption-text">Libra 器件（顶部）</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id3">
<a class="reference internal image-reference" href="../../../_images/Libra-back-components1.jpg"><img alt="../../../_images/Libra-back-components1.jpg" src="../../../_images/Libra-back-components1.jpg" style="width: 85%;" />
</a>
<figcaption>
<p><span class="caption-text">Libra 器件（底部）</span><a class="headerlink" href="#id3" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
</section>
</section>
<section id="getting-started">
<span id="am62l-fpsc-head-getting-started"></span><h1><span class="section-number">2. </span>开始使用<a class="headerlink" href="#getting-started" title="Link to this heading"></a></h1>
<p>The <strong>phyFLEX-AM62L FPSC Kit</strong> is shipped with a pre-flashed SD card. It contains the
phytec-qt6demo-image and can be used directly as a boot source. The e.MMC is
programmed with only a U-Boot by default. You can get all sources from the
<a class="reference external" href="https://download.phytec.de/Software/Linux/BSP-Yocto-AM62Lx/">BSP downloads</a> page. This chapter explains how to flash a BSP image
to SD card and how to start the board.</p>
<p>There are several ways to flash an image to SD card or even e.MMC. Most notably
using simple, sequential writing with the Linux command line tool <code class="docutils literal notranslate"><span class="pre">dd</span></code>. An
alternative way is to use PHYTEC's system initialization program called
<a class="reference external" href="https://github.com/phytec/partup">partup</a>, which makes it especially easy to
format more complex systems. You can get <a class="reference external" href="https://github.com/phytec/partup/releases">prebuilt Linux binaries of partup</a> from its release page. Also read
<a class="reference external" href="https://github.com/phytec/partup#readme">partup's README</a> for installation
instructions.</p>
<section id="get-the-image">
<h2><span class="section-number">2.1. </span>下载镜像<a class="headerlink" href="#get-the-image" title="Link to this heading"></a></h2>
<p>The image contains all necessary files and makes sure partitions and any raw
data are correctly written. Both the partup package and the WIC image, which can
be flashed using <code class="docutils literal notranslate"><span class="pre">dd</span></code>, can be downloaded from our <a class="reference external" href="https://download.phytec.de/Software/Linux/BSP-Yocto-AM62Lx/">BSP downloads</a> page.</p>
<p>Note that you can find different image versions and variants on our download
server. The images are located on the server by folders per &quot;BSP-Version&quot;,
&quot;Distro-Name&quot; and &quot;Machine-Name&quot;.</p>
<p>Example to download a partup package and a WIC image from the download server:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>wget<span class="w"> </span>https://download.phytec.de/Software/Linux/BSP-Yocto-AM62Lx/BSP-Yocto-Ampliphy-AM62Lx-ALPHA2/images/ampliphy-vendor/am62lxx-libra-fpsc-1/phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.partup
<span class="gp">host:~$ </span>wget<span class="w"> </span>https://download.phytec.de/Software/Linux/BSP-Yocto-AM62Lx/BSP-Yocto-Ampliphy-AM62Lx-ALPHA2/images/ampliphy-vendor/am62lxx-libra-fpsc-1/phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.xz
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>For e.MMC, more complex partitioning schemes or even just large images, we
recommend using the partup package, as it is faster in writing than <code class="docutils literal notranslate"><span class="pre">dd</span></code>
and allows for a more flexible configuration of the target flash device.</p>
</div>
</section>
<section id="write-the-image-to-sd-card">
<h2><span class="section-number">2.2. </span>将镜像写入SD卡<a class="headerlink" href="#write-the-image-to-sd-card" title="Link to this heading"></a></h2>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>要创建SD卡启动盘，必须要拥有Linux PC上的root权限。在选择烧写设备时请务必小心！所选设备上的所有文件将在命令执行后立即被擦除，而且擦除前不会有任何进一步的确认！</p>
<p>选择错误的设备可能会导致 <strong>数据丢失</strong> ，例如，可能会擦除您当前所在PC上的系统！</p>
</div>
<section id="finding-the-correct-device">
<h3><span class="section-number">2.2.1. </span>寻找正确的设备<a class="headerlink" href="#finding-the-correct-device" title="Link to this heading"></a></h3>
<p id="getting-started-find-correct-device">要创建SD卡启动盘，首先要找到PC上您SD卡对应的正确设备名称。在开始将镜像复制到SD卡之前，请卸载任何已挂载的分区。</p>
<ol class="arabic">
<li><p>为了获取正确的设备名称，请移除您的SD卡并执行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>lsblk
</pre></div>
</div>
</li>
<li><p>现在插入你的SD卡，然后再次执行命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>lsblk
</pre></div>
</div>
</li>
<li><p>比较两个输出，以获取第二个输出中的新设备名称。这些是SD卡的设备名称（如果SD卡已格式化，则包括设备名称和对应的分区）。</p></li>
<li><p>为了验证找到的设备名称的最终正确性，请执行命令 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">dmesg</span></code>。在其输出的最后几行中，您应该也能找到设备名称，例如 <code class="docutils literal notranslate"><span class="pre">/dev/sde</span></code> 或 <code class="docutils literal notranslate"><span class="pre">/dev/mmcblk0</span></code> （具体取决于您的系统）。</p></li>
</ol>
<p>或者，您可以使用图形化的程序，例如 <a class="reference external" href="https://apps.gnome.org/en/DiskUtility/">GNOME Disks</a> 或 <a class="reference external" href="https://apps.kde.org/partitionmanager/">KDE Partition Manager</a> 来找到正确的设备。</p>
<p>现在您已经得到了正确的设备名称，例如 <code class="docutils literal notranslate"><span class="pre">/dev/sde</span></code>，如果SD卡曾格式化过，需要确认已取消其分区的挂载，您可以在输出中看到带有附加了数字的设备名称（例如 <code class="docutils literal notranslate"><span class="pre">/dev/sde1</span></code>），它们是SD卡的分区。一些Linux发行版系统在设备插入时会自动挂载分区。在写入之前，必须卸载这些分区，以避免数据损坏。</p>
<p>卸载所有这些分区，例如：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>umount<span class="w"> </span>/dev/sde1
<span class="gp">host:~$ </span>sudo<span class="w"> </span>umount<span class="w"> </span>/dev/sde2
</pre></div>
</div>
<p>Now, the SD card is ready to be flashed with an image, using either <code class="docutils literal notranslate"><span class="pre">partup</span></code>,
<code class="docutils literal notranslate"><span class="pre">dd</span></code> or <code class="docutils literal notranslate"><span class="pre">bmaptool</span></code>.</p>
</section>
<section id="using-bmaptool">
<h3><span class="section-number">2.2.2. </span>Using bmaptool<a class="headerlink" href="#using-bmaptool" title="Link to this heading"></a></h3>
<p>One way to prepare an SD card is using
<a class="reference external" href="https://github.com/yoctoproject/bmaptool">bmaptool</a>. Yocto
automatically creates a block map file (<code class="docutils literal notranslate"><span class="pre">&lt;IMAGENAME&gt;-&lt;MACHINE&gt;.wic.bmap</span></code>) for
the WIC image that describes the image content and includes checksums for data
integrity. <em>bmaptool</em> is packaged by various Linux distributions. For
Debian-based systems install it by issuing:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>bmap-tools
</pre></div>
</div>
<p>通过以下命令将WIC镜像烧写到SD卡：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>bmaptool<span class="w"> </span>copy<span class="w"> </span>phytec-qt6demo-image-am62lxx-libra-fpsc-1?<span class="o">(</span>.rootfs<span class="o">)</span>.wic?<span class="o">(</span>.xz<span class="o">)</span><span class="w"> </span>/dev/&lt;your_device&gt;
</pre></div>
</div>
<p>将 &lt;your_device&gt; 替换为您之前找到的SD卡设备名称，并确保将文件 <code class="docutils literal notranslate"><span class="pre">&lt;IMAGENAME&gt;-&lt;MACHINE&gt;.wic.bmap</span></code> 与WIC镜像文件放在一起，以便bmaptool知道哪些块需要写入，哪些块需要跳过。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p><em>bmaptool</em> 仅擦写SD卡上镜像数据所在的区域。这意味着在写入新的镜像后，之前写入的旧U-Boot环境变量可能仍然可用。</p>
</div>
</section>
<section id="using-partup">
<h3><span class="section-number">2.2.3. </span>使用partup<a class="headerlink" href="#using-partup" title="Link to this heading"></a></h3>
<p>使用partup烧写SD卡只需一个命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>partup<span class="w"> </span>install<span class="w"> </span>phytec-qt6demo-image-am62lxx-libra-fpsc-1?<span class="o">(</span>.rootfs<span class="o">)</span>.partup<span class="w"> </span>/dev/&lt;your_device&gt;
</pre></div>
</div>
<p>确保将 &lt;your_device&gt; 替换为您之前找到的设备名称。</p>
<p>关于partup的进一步使用说明，请参阅其 <a class="reference external" href="https://partup.readthedocs.io/en/latest/">官方文档</a> 。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>使用resize2fs版本1.46.6及更早版本的PC系统（例如Ubuntu 22.04）无法烧写在Mickledore以及更新的yocto版本上创建的partup软件包。这个是因为resize2fs新增了默认选项而导致的兼容性问题。有关详细信息，请参阅 <a class="reference external" href="https://e2fsprogs.sourceforge.net/e2fsprogs-release.html#1.47.0">release notes</a> 。</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><em>partup</em> 具有清除eMMC user区域中特定区域的功能，我们提供的partup程序中用该功能擦除U-Boot环境变量。这是 <em>bmaptool</em> 工具所无法完成的一点，如前一部分所提到的。</p>
<p>partup相较于其他烧写工具的一个主要优势是，它可以配置MMC的特定部分，比如他可以直接写入eMMCboot分区，无需调用其他命令。</p>
</div>
</section>
<section id="using-dd">
<h3><span class="section-number">2.2.4. </span>使用 <code class="docutils literal notranslate"><span class="pre">dd</span></code><a class="headerlink" href="#using-dd" title="Link to this heading"></a></h3>
<p>在卸载所有SD卡的挂载分区后，您可以烧写SD卡。</p>
<p>一些PHYTEC BSP会生成未压缩的镜像（文件名扩展名为*.wic），而另一些则生成压缩的镜像（文件名扩展名为*.wic.xz）。</p>
<p>要写入未压缩的镜像（*.wic），请使用以下命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>phytec-qt6demo-image-am62lxx-libra-fpsc-1?<span class="o">(</span>.rootfs<span class="o">)</span>.wic<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/&lt;your_device&gt;<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync<span class="w"> </span><span class="nv">status</span><span class="o">=</span>progress
</pre></div>
</div>
<p>或者要写入压缩后的镜像（*.wic.xz），请使用以下命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>xzcat<span class="w"> </span>phytec-qt6demo-image-am62lxx-libra-fpsc-1?<span class="o">(</span>.rootfs<span class="o">)</span>.wic.xz<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>dd<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/&lt;your_device&gt;<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync<span class="w"> </span><span class="nv">status</span><span class="o">=</span>progress
</pre></div>
</div>
<p>再次确保将 &lt;your_device&gt; 替换为之前找到的设备名称。</p>
<p>参数 <code class="docutils literal notranslate"><span class="pre">conv=fsync</span></code> 强制在 <code class="docutils literal notranslate"><span class="pre">dd</span></code> 返回之前对设备进行sync操作。这确保所有数据块都已写入SD卡，而没有任何数据缓存在内存中。参数 <code class="docutils literal notranslate"><span class="pre">status=progress</span></code> 将打印出进度信息。</p>
</section>
</section>
<section id="first-start-up">
<h2><span class="section-number">2.3. </span>首次启动<a class="headerlink" href="#first-start-up" title="Link to this heading"></a></h2>
<ul>
<li><p>要从SD卡启动， <a class="reference internal" href="#am62l-fpsc-head-bootswitch"><span class="std std-ref">bootmode switch (S1)</span></a> 需要设置为以下位置：</p>
<a class="reference internal image-reference" href="../../../_images/dipswitch-4-1000.svg"><img alt="../../../_images/dipswitch-4-1000.svg" src="../../../_images/dipswitch-4-1000.svg" style="width: 92.0px; height: 112.0px;" />
</a>
</li>
<li><p>插入SD卡</p></li>
<li><p>Connect the target and the host with <strong>USB-C</strong> on <a class="reference internal" href="#am62l-fpsc-head-components"><span class="std std-ref">(X14)</span></a>
debug USB</p></li>
<li><p>给开发板通电</p></li>
</ul>
</section>
</section>
<section id="building-the-bsp">
<h1><span class="section-number">3. </span>编译BSP<a class="headerlink" href="#building-the-bsp" title="Link to this heading"></a></h1>
<p>本节将指导您使用Yocto和phyLinux脚本进行 AM62L BSP的编译。更多有关phytec meta-layer和Yocto的信息，请访问： <a class="reference internal" href="../../../yocto/scarthgap.html#yocto-man-scarthgap"><span class="std std-ref">Yocto Reference Manual (scarthgap)</span></a> 。</p>
<section id="basic-set-up">
<h2><span class="section-number">3.1. </span>基本设置<a class="headerlink" href="#basic-set-up" title="Link to this heading"></a></h2>
<p>如果您从未在您的主机上使用Yocto编译过Phytec BSP，您应查看 <a class="reference internal" href="../../../yocto/scarthgap.html#yocto-man-scarthgap"><span class="std std-ref">Yocto Reference Manual (scarthgap)</span></a> 中的BSP Workspace安装一节。</p>
</section>
<section id="get-the-bsp">
<h2><span class="section-number">3.2. </span>下载BSP<a class="headerlink" href="#get-the-bsp" title="Link to this heading"></a></h2>
<p>There are two ways to get the BSP sources. You can download the complete BSP
sources from our <a class="reference external" href="https://download.phytec.de/Software/Linux/BSP-Yocto-AM62Lx/">BSP downloads</a> page; or you can fetch and build it
yourself with Yocto. This is particularly useful if you want to make
customizations.</p>
<p>The phyLinux script is a basic management tool for PHYTEC Yocto BSP releases
written in Python. It is mainly a helper to get started with the BSP sources
structure.</p>
<ul>
<li><p>创建一个新的项目文件夹，获取phyLinux脚本，并赋予脚本具备可执行权限：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>mkdir<span class="w"> </span>~/yocto
<span class="gp">host:~$ </span><span class="nb">cd</span><span class="w"> </span>yocto/
<span class="gp">host:~/yocto$ </span>wget<span class="w"> </span>https://download.phytec.de/Software/Linux/Yocto/Tools/phyLinux
<span class="gp">host:~/yocto$ </span>chmod<span class="w"> </span>+x<span class="w"> </span>phyLinux
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>我们需要一个空的项目文件夹，phyLinux首先会清理当前所在的工作目录。从一个不为空的目录下调用phyLinux将会产生告警。</p>
</div>
</li>
<li><p>运行phyLinux：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/yocto$ </span>./phyLinux<span class="w"> </span>init
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在首次初始化时，phyLinux脚本会要求您在 <code class="docutils literal notranslate"><span class="pre">/usr/local/bin</span></code> 目录中安装Repo工具。</p>
</div>
</li>
<li><p>During the execution of the init command, you need to choose your processor
platform (SoC), PHYTEC's BSP release number, and the hardware (MACHINE) you
are working on.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>If you cannot identify your board with the information given in the selector,
have a look at the invoice for the product. And have a look at the webpage
of <a class="reference external" href="https://www.phytec.de/bsp-download/?bsp=BSP-Yocto-Ampliphy-AM62Lx-ALPHA2">our BSP</a>.</p>
</div>
</li>
<li><p>也可以通过命令行参数直接传递这些信息：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/yocto$ </span><span class="nv">DISTRO</span><span class="o">=</span>ampliphy-vendor<span class="w"> </span><span class="nv">MACHINE</span><span class="o">=</span>am62lxx-libra-fpsc-1<span class="w"> </span>./phyLinux<span class="w"> </span>init<span class="w"> </span>-p<span class="w"> </span>am62l-fpsc<span class="w"> </span>-r<span class="w"> </span>BSP-Yocto-Ampliphy-AM62Lx-ALPHA2
</pre></div>
</div>
</li>
</ul>
<p>After the execution of the init command, phyLinux will print a few important
notes. For example, it will print your git identity, SOC and BSP release which
was selected as well as information for the next steps in the build process.</p>
<section id="starting-the-build-process">
<h3><span class="section-number">3.2.1. </span>开始构建<a class="headerlink" href="#starting-the-build-process" title="Link to this heading"></a></h3>
<ul>
<li><p>设置Shell环境变量：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/yocto$ </span><span class="nb">source</span><span class="w"> </span>sources/poky/oe-init-build-env
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在每次打开新的用于编译的shell时，都需要先执行这一步骤。</p>
</div>
</li>
<li><p>当前的工作目录会变更为 build/。</p></li>
</ul>
<ul>
<li><p>编译您的镜像：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/yocto/build$ </span>bitbake<span class="w"> </span>phytec-qt6demo-image
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>对于第一次编译，我们建议从我们的较小的非图形化镜像phytec-headless-image开始，以查看一切是否正常工作。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/yocto/build$ </span>bitbake<span class="w"> </span>phytec-headless-image
</pre></div>
</div>
<p>第一次构建过程在现代的Intel Core i7处理器上大约需要40分钟。后续的构建将使用本次编译产生的缓存，大约需要3分钟。</p>
</div>
</li>
</ul>
</section>
<section id="bsp-images">
<h3><span class="section-number">3.2.2. </span>BSP镜像<a class="headerlink" href="#bsp-images" title="Link to this heading"></a></h3>
<p>所有由Bitbake生成的镜像都放在 <code class="docutils literal notranslate"><span class="pre">~/yocto/build/deploy*/images/&lt;machine&gt;</span></code> 。例如以下列表是 am62lxx-libra-fpsc-1 machine生成的所有文件：</p>
<ul class="simple" id="am62l-fpsc-head-images">
<li><p><strong>u-boot.img</strong>: U-Boot bootloader image</p></li>
<li><p><strong>oftree</strong>: 默认内核设备树</p></li>
<li><p><strong>ti-boot3.bin</strong>: First stage bootloader (R5 SPL)</p></li>
<li><p><strong>tispl.bin</strong>: Secondary program loader (SPL)</p></li>
<li><p><strong>bl1.bin</strong>: ARM Trusted Firmware binary</p></li>
<li><p><strong>bl31.bin</strong>: ARM Trusted Firmware binary</p></li>
<li><p><strong>fitImage</strong>: Linux内核FIT镜像</p></li>
<li><p><strong>fitImage-its*.its</strong></p></li>
<li><p><strong>Image</strong>: Linux内核镜像</p></li>
<li><p><strong>Image.config</strong>: 内核config文件</p></li>
<li><p><strong>k3-am62l32-libra-fpsc*.dtb</strong>: Kernel device tree file</p></li>
<li><p><strong>phytec-qt6demo-image*.tar.gz</strong>: 根文件系统</p></li>
<li><p><strong>phytec-qt6demo-image*.rootfs.wic.xz</strong>: 压缩的SD卡镜像</p></li>
</ul>
</section>
</section>
</section>
<section id="installing-the-os">
<h1><span class="section-number">4. </span>安装操作系统<a class="headerlink" href="#installing-the-os" title="Link to this heading"></a></h1>
<section id="bootmode-switch-s1">
<h2><span class="section-number">4.1. </span>启动模式开关 (S1)<a class="headerlink" href="#bootmode-switch-s1" title="Link to this heading"></a></h2>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>Hardware revision baseboard: 1618.1</p>
</div>
<p>The Libra FPSC features a boot switch with four individually switchable ports to
select the phyFLEX-AM62L FPSC default bootsource.</p>
<table class="docutils align-default" id="am62l-fpsc-head-bootswitch">
<tbody>
<tr class="row-odd"><td><figure class="align-default" id="id4">
<a class="reference internal image-reference" href="../../../_images/dipswitch-4-1100.svg"><img alt="../../../_images/dipswitch-4-1100.svg" src="../../../_images/dipswitch-4-1100.svg" style="width: 92.0px; height: 112.0px;" />
</a>
<figcaption>
<p><span class="caption-text">eMMC</span><a class="headerlink" href="#id4" title="Link to this image"></a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-default" id="id5">
<a class="reference internal image-reference" href="../../../_images/dipswitch-4-1000.svg"><img alt="../../../_images/dipswitch-4-1000.svg" src="../../../_images/dipswitch-4-1000.svg" style="width: 92.0px; height: 112.0px;" />
</a>
<figcaption>
<p><span class="caption-text">SD卡</span><a class="headerlink" href="#id5" title="Link to this image"></a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-default" id="id6">
<a class="reference internal image-reference" href="../../../_images/dipswitch-4-0010.svg"><img alt="../../../_images/dipswitch-4-0010.svg" src="../../../_images/dipswitch-4-0010.svg" style="width: 92.0px; height: 112.0px;" />
</a>
<figcaption>
<p><span class="caption-text">SPI NOR</span><a class="headerlink" href="#id6" title="Link to this image"></a></p>
</figcaption>
</figure>
</td>
</tr>
</tbody>
</table>
</section>
<section id="flash-e-mmc">
<h2><span class="section-number">4.2. </span>Flash e.MMC<a class="headerlink" href="#flash-e-mmc" title="Link to this heading"></a></h2>
<p>为了保持文档的一致性和简洁性，假设已经配置好了TFTP服务器；所有生成的镜像（如上所列）都被复制到默认的/srv/tftp目录。如果您没有进行设置，您需要修改路径到包含镜像的目录。有关如何设置TFTP服务器和目录的说明，请参见 <a class="reference internal" href="#am62l-fpsc-head-development"><span class="std std-ref">Setup Network Host</span></a> 。</p>
<p>To boot from e.MMC, make sure that the BSP image is flashed correctly to the
e.MMC and the <a class="reference internal" href="#am62l-fpsc-head-bootswitch"><span class="std std-ref">bootmode switch (S1)</span></a> is set to <strong>e.MMC</strong>.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>When e.MMC and SD card are flashed with the same (identical) image, the UUIDs
of the boot partitions are also identical. If the SD card is connected when
booting, this leads to non-deterministic behavior as Linux mounts the boot
partition based on UUID.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>blkid
</pre></div>
</div>
<p>可以运行上述命令来检查系统启动在这种条件下是否会到影响。如果 <code class="docutils literal notranslate"><span class="pre">mmcblk2p1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">mmcblk1p1</span></code> 具有相同的UUID，则会影响系统正确启动。</p>
</div>
<section id="flash-e-mmc-from-network">
<h3><span class="section-number">4.2.1. </span>Flash e.MMC from Network<a class="headerlink" href="#flash-e-mmc-from-network" title="Link to this heading"></a></h3>
<p>AM62L boards have an Ethernet connector and can be updated over a network. Be
sure to set up the development host correctly. The IP needs to be set to
192.168.3.10, the netmask to 255.255.255.0, and a TFTP server needs to be
available. From a high-level point of view, an e.MMC device is like an SD card.
Therefore, it is possible to flash the <strong>WIC image</strong> (<code class="docutils literal notranslate"><span class="pre">&lt;name&gt;.wic</span></code>) from
the Yocto build system directly to the e.MMC. The image contains the
bootloader, kernel, device tree, device tree overlays, and root file system.</p>
<section id="flash-e-mmc-via-network-in-linux-on-host">
<h4><span class="section-number">4.2.1.1. </span>Flash e.MMC via Network in Linux on Host<a class="headerlink" href="#flash-e-mmc-via-network-in-linux-on-host" title="Link to this heading"></a></h4>
<p>It is also possible to install the OS at e.MMC from your Linux host. As before,
you need a complete image on your host.</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>需要保证设备和存储镜像的主机之间的网络正常！ <a class="reference internal" href="#am62l-fpsc-head-development"><span class="std std-ref">Setup Network Host</span></a></p>
</div>
<p>查看主机上可用的镜像文件：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>ls<span class="w"> </span>/srv/tftp
<span class="go">phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.xz</span>
<span class="go">phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.bmap</span>
</pre></div>
</div>
<p>Send the image with the <code class="docutils literal notranslate"><span class="pre">bmaptool</span></code> command combined with ssh through the network
to the e.MMC of your device:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>scp<span class="w"> </span>/srv/tftp/phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.*<span class="w"> </span>root@192.168.3.11:/tmp<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ssh<span class="w"> </span>root@192.168.3.11<span class="w"> </span><span class="s2">&quot;bmaptool copy /tmp/phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.xz /dev/mmcblk0&quot;</span>
</pre></div>
</div>
</section>
<section id="flash-e-mmc-via-network-in-linux-on-target">
<h4><span class="section-number">4.2.1.2. </span>Flash e.MMC via Network in Linux on Target<a class="headerlink" href="#flash-e-mmc-via-network-in-linux-on-target" title="Link to this heading"></a></h4>
<p>You can update the e.MMC from your target.</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>需要保证设备和存储镜像的主机之间的网络正常！ <a class="reference internal" href="#am62l-fpsc-head-development"><span class="std std-ref">Setup Network Host</span></a></p>
</div>
<p>Take a compressed or decompressed image with the accompanying block map file
<cite>*.bmap</cite> on the host and send it with <cite>ssh</cite> through the network to the e.MMC of
the target with a one-line command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>scp<span class="w"> </span>&lt;USER&gt;@192.168.3.10:/srv/tftp/phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.*<span class="w"> </span>/tmp<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>bmaptool<span class="w"> </span>copy<span class="w"> </span>/tmp/phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.xz<span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
</section>
<section id="flash-e-mmc-from-network-in-u-boot-on-target">
<h4><span class="section-number">4.2.1.3. </span>Flash e.MMC from Network in U-Boot on Target<a class="headerlink" href="#flash-e-mmc-from-network-in-u-boot-on-target" title="Link to this heading"></a></h4>
<p>These steps will show how to update the e.MMC via a network.</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>This step only works if the size of the image file is less than 1GB due to
limited usage of RAM size in the Bootloader after enabling OP-TEE.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>需要保证设备和存储镜像的主机之间的网络正常！ <a class="reference internal" href="#am62l-fpsc-head-development"><span class="std std-ref">Setup Network Host</span></a></p>
</div>
<p>解压缩您的镜像</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>unxz<span class="w"> </span>/srv/tftp/phytec-headless-image-am62lxx-libra-fpsc-1.rootfs.wic.xz
</pre></div>
</div>
<p>通过网络将您的镜像加载到内存中：</p>
<ul>
<li><p>使用DHCP</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; dhcp phytec-headless-image-am62lxx-libra-fpsc-1.rootfs.wic
BOOTP broadcast 1
DHCP client bound to address 192.168.3.1 (1 ms)
Using ethernet@30be0000 device
TFTP from server 192.168.3.10; our IP address is 192.168.3.1
Filename &#39;phytec-headless-image-am62lxx-libra-fpsc-1.rootfs.wic&#39;.
Load address: 0x40480000
Loading: ######################################
         ######################################
         ######################################
         ...
         ...
         ...
         ######################################
         #############
         11.2 MiB/s
done
Bytes transferred = 911842304 (36599c00 hex)
</pre></div>
</div>
</li>
<li><p>使用静态IP地址（必须先设置serverip和ipaddr）。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; tftp ${loadaddr} phytec-headless-image-am62lxx-libra-fpsc-1.rootfs.wic
Using ethernet@30be0000 device
TFTP from server 192.168.3.10; our IP address is 192.168.3.11
Filename &#39;phytec-headless-image-am62lxx-libra-fpsc-1.rootfs.wic&#39;.
Load address: 0x40480000
Loading: ######################################
         ######################################
         ######################################
         ...
         ...
         ...
         ######################################
         #############
         11.2 MiB/s
done
Bytes transferred = 911842304 (36599c00 hex)
</pre></div>
</div>
</li>
</ul>
<p>Write the image to the e.MMC:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; mmc dev 0
switch to partitions #0, OK
mmc0(part 0) is current device
u-boot=&gt; setexpr nblk ${filesize} / 0x200
u-boot=&gt; mmc write ${loadaddr} 0x0 ${nblk}

MMC write: dev # 0, block # 0, count 1780942 ... 1780942 blocks written: OK
</pre></div>
</div>
</section>
</section>
<section id="flash-e-mmc-from-usb-stick">
<h3><span class="section-number">4.2.2. </span>Flash e.MMC from USB stick<a class="headerlink" href="#flash-e-mmc-from-usb-stick" title="Link to this heading"></a></h3>
<section id="flash-e-mmc-from-usb-in-linux">
<h4><span class="section-number">4.2.2.1. </span>Flash e.MMC from USB in Linux<a class="headerlink" href="#flash-e-mmc-from-usb-in-linux" title="Link to this heading"></a></h4>
<p>These steps will show how to flash the e.MMC on Linux with a USB stick. You only
need a complete image saved on the USB stick and a bootable WIC image. (e.g.
phytec-qt6demo-image-am62lxx-libra-fpsc-1.|yocto-imageext|). Set the
<a class="reference internal" href="#am62l-fpsc-head-bootswitch"><span class="std std-ref">bootmode switch (S1)</span></a> to SD card.</p>
<ul>
<li><p>插入并挂载U盘：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[   60.458908] usb-storage 1-1.1:1.0: USB Mass Storage device detected</span>
<span class="go">[   60.467286] scsi host0: usb-storage 1-1.1:1.0</span>
<span class="go">[   61.504607] scsi 0:0:0:0: Direct-Access                               8.07 PQ: 0 ANSI: 2</span>
<span class="go">[   61.515283] sd 0:0:0:0: [sda] 3782656 512-byte logical blocks: (1.94 GB/1.80 GiB)</span>
<span class="go">[   61.523285] sd 0:0:0:0: [sda] Write Protect is off</span>
<span class="go">[   61.528509] sd 0:0:0:0: [sda] No Caching mode page found</span>
<span class="go">[   61.533889] sd 0:0:0:0: [sda] Assuming drive cache: write through</span>
<span class="go">[   61.665969]  sda: sda1</span>
<span class="go">[   61.672284] sd 0:0:0:0: [sda] Attached SCSI removable disk</span>
<span class="gp">target:~$ </span>mount<span class="w"> </span>/dev/sda1<span class="w"> </span>/mnt
</pre></div>
</div>
</li>
<li><p>现在查看您在USB优盘上保存的镜像文件：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ls<span class="w"> </span>/mnt
<span class="go">phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.xz</span>
<span class="go">phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.bmap</span>
</pre></div>
</div>
</li>
<li><p>Write the image to the phyFLEX-AM62L FPSC e.MMC (MMC device 2 without partition):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>bmaptool<span class="w"> </span>copy<span class="w"> </span>/mnt/phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.xz<span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
</li>
<li><p>After a complete write, your board can boot from e.MMC.</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>在此之前，您需要将 <a class="reference internal" href="#am62l-fpsc-head-bootswitch"><span class="std std-ref">bootmode switch (S1)</span></a> 配置为 <strong>eMMC</strong>。</p>
</div>
</li>
</ul>
</section>
<section id="flash-e-mmc-from-usb-stick-in-u-boot-on-target">
<h4><span class="section-number">4.2.2.2. </span>Flash e.MMC from USB stick in U-Boot on Target<a class="headerlink" href="#flash-e-mmc-from-usb-stick-in-u-boot-on-target" title="Link to this heading"></a></h4>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>此步骤仅在镜像文件小于1GB的情况下会被执行成功，因为在启用OPTEE后，Bootloader中可用的RAM大小有限，不足以加载超过1GB的镜像</p>
</div>
<p>These steps will show how to update the e.MMC via a USB device. Configure the
<a class="reference internal" href="#am62l-fpsc-head-bootswitch"><span class="std std-ref">bootmode switch (S1)</span></a> to SD card and insert an SD card. Power on the board and stop
in U-Boot prompt. Insert a USB device with the copied uncompressed WIC image to
the USB slot.</p>
<p>将镜像从USB设备加载到RAM中：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; usb start
starting USB...
USB0:   USB EHCI 1.00
scanning bus 0 for devices... 2 USB Device(s) found
       scanning usb for storage devices... 1 Storage Device(s) found
u-boot=&gt; fatload usb 0:1 0x58000000 phytec-headless-image-am62lxx-libra-fpsc-1.rootfs.wic
497444864 bytes read in 31577 ms (15 MiB/s)
</pre></div>
</div>
<p>Write the image to the e.MMC:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; mmc dev 0
switch to partitions #0, OK
mmc0(part 0) is current device
u-boot=&gt; setexpr nblk ${filesize} / 0x200
u-boot=&gt; mmc write 0x58000000 0x0 ${nblk}

MMC write: dev # 0, block # 0, count 1024000 ... 1024000 blocks written: OK
u-boot=&gt; boot
</pre></div>
</div>
</section>
</section>
<section id="flash-e-mmc-from-sd-card">
<h3><span class="section-number">4.2.3. </span>Flash e.MMC from SD card<a class="headerlink" href="#flash-e-mmc-from-sd-card" title="Link to this heading"></a></h3>
<p>Even if there is no network available, you can update the e.MMC. For that, you
only need a ready-to-use image file (<code class="docutils literal notranslate"><span class="pre">*.wic</span></code>) located on the SD card.
Because the image file is quite large, you need to allocate more SD card space.
To create a new partition or enlarge your SD card, see <a class="reference internal" href="#am62l-fpsc-head-format-sd"><span class="std std-ref">Resizing ext4 Root Filesystem</span></a>.</p>
<p>或者，使用partup包烧写SD卡，如 <a class="reference internal" href="#am62l-fpsc-head-getting-started"><span class="std std-ref">Getting Started</span></a> 中所述。这样就可使用SD卡的全部容量。</p>
<section id="flash-e-mmc-from-sd-card-in-linux-on-target">
<h4><span class="section-number">4.2.3.1. </span>Flash e.MMC from SD card in Linux on Target<a class="headerlink" href="#flash-e-mmc-from-sd-card-in-linux-on-target" title="Link to this heading"></a></h4>
<p>You can also flash the e.MMC on Linux. You only need a partup package or WIC
image saved on the SD card.</p>
<ul>
<li><p>检查在SD卡上保存的partup包或WIC镜像文件：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ls
<span class="go">phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.partup</span>
<span class="go">phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.xz</span>
<span class="go">phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.bmap</span>
</pre></div>
</div>
</li>
<li><p>Write the image to the phyFLEX-AM62L FPSC e.MMC (MMC device 0 <strong>without</strong>
partition) using <a class="reference external" href="https://github.com/phytec/partup">partup</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>partup<span class="w"> </span>install<span class="w"> </span>phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.partup<span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
<p>Flashing the partup package has the advantage of using the full capacity of
the e.MMC device, adjusting partitions accordingly.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>另外，也可以使用 <code class="docutils literal notranslate"><span class="pre">bmaptool</span></code> 工具：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>bmaptool<span class="w"> </span>copy<span class="w"> </span>phytec-qt6demo-image-am62lxx-libra-fpsc-1.rootfs.wic.xz<span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
<p>请注意，在使用 <code class="docutils literal notranslate"><span class="pre">bmaptool</span></code> 烧写时，根文件系统分区并不会使用eMMC的最大容量。</p>
</div>
</li>
<li><p>After a complete write, your board can boot from e.MMC.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>Before this will work, you need to configure the <a class="reference internal" href="#am62l-fpsc-head-bootswitch"><span class="std std-ref">bootmode switch (S1)</span></a> to
e.MMC.</p>
</div>
</li>
</ul>
</section>
<section id="flash-e-mmc-from-sd-card-in-u-boot-on-target">
<h4><span class="section-number">4.2.3.2. </span>Flash e.MMC from SD card in U-Boot on Target<a class="headerlink" href="#flash-e-mmc-from-sd-card-in-u-boot-on-target" title="Link to this heading"></a></h4>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>This step only works if the size of the image file is less than 1GB due to
limited usage of RAM size in the Bootloader after enabling OPTEE. If the
image file is too large use the <cite>Updating e.MMC from SD card in
Linux on Target</cite> subsection.</p>
</div>
<ul>
<li><p>将一个可用的镜像烧写到SD卡，并创建一个EXT4格式的第三分区。将WIC镜像（例如 phytec-qt6demo-image.rootfs.wic）复制到该分区。</p></li>
<li><p>Configure the <a class="reference internal" href="#am62l-fpsc-head-bootswitch"><span class="std std-ref">bootmode switch (S1)</span></a> to SD card and insert the SD card.</p></li>
<li><p>打开电源并进入U-Boot。</p></li>
<li><p>加载镜像：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; ext4load mmc 1:3 ${loadaddr} phytec-headless-image-am62lxx-libra-fpsc-1.rootfs.wic
reading
911842304 bytes read in 39253 ms (22.2 MiB/s)
</pre></div>
</div>
</li>
<li><p>Switch the mmc dev to e.MMC:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; mmc list
FSL_SDHC: 1 (SD)
FSL_SDHC: 0 (eMMC)
u-boot=&gt; mmc dev 0
switch to partitions #0, OK
mmc0(part 0) is current device
</pre></div>
</div>
</li>
<li><p>Flash your WIC image (for example phytec-qt6demo-image.rootfs.wic)
from the SD card to e.MMC. This will partition the card and copy tiboot3.bin,
tispl.bin, u-boot.img, Image, dtb, dtbo, and root file system to e.MMC.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setexpr nblk ${filesize} / 0x200
u-boot=&gt; mmc write ${loadaddr} 0x0 ${nblk}

MMC write: dev # 0, block # 0, count 1780942 ... 1780942 blocks written: OK
</pre></div>
</div>
</li>
<li><p>Power off the board and change the <a class="reference internal" href="#am62l-fpsc-head-bootswitch"><span class="std std-ref">bootmode switch (S1)</span></a> to e.MMC.</p></li>
</ul>
</section>
</section>
</section>
<section id="flash-spi-nor-flash">
<h2><span class="section-number">4.3. </span>烧写 SPI NOR Flash<a class="headerlink" href="#flash-spi-nor-flash" title="Link to this heading"></a></h2>
<p>The phyFLEX-AM62L FPSCs are optionally equipped with SPI NOR Flash. To boot from SPI
Flash, set <a class="reference internal" href="#am62l-fpsc-head-bootswitch"><span class="std std-ref">bootmode switch (S1)</span></a> to <strong>SPI NOR</strong>. The SPI Flash is usually quite small.
The <strong>phyFLEX-AM62L FPSC Kit</strong> only has 64MiB SPI NOR flash populated. Only the bootloader and the
environment can be stored. The kernel, device tree, and file system are taken
from other boot sources.</p>
<p>The SPI NOR flash partition table is defined in the U-Boot device tree. It can
be printed with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; =&gt; mtd list
SF: Detected mt35xu512aba with page size 256 Bytes, erase size 4 KiB, total 64 MiB
List of MTD devices:
* nor0
  - device: flash@0
  - parent: spi@fc40000
  - driver: jedec_spi_nor
  - path: /bus@f0000/bus@fc00000/spi@fc40000/flash@0
  - type: NOR flash
  - block size: 0x1000 bytes
  - min I/O: 0x1 bytes
  - 0x000000000000-0x000004000000 : &quot;nor0&quot;
          - 0x000000000000-0x000000080000 : &quot;ospi.tiboot3&quot;
          - 0x000000080000-0x000000280000 : &quot;ospi.tispl&quot;
          - 0x000000280000-0x000000680000 : &quot;ospi.u-boot&quot;
          - 0x000000680000-0x0000006c0000 : &quot;ospi.env&quot;
          - 0x0000006c0000-0x000000700000 : &quot;ospi.env.backup&quot;
</pre></div>
</div>
<p>We have two possibilities for flashing:</p>
<ul class="simple">
<li><p>Flash SPI NOR with a combined binary, which contains all the necessary files
(tiboot3.bin, tispl.bin and u-boot.img) on the correct offsets. A whole
SPI NOR device in Linux is always marked as first MTD device (e.g.
/dev/mtd0) in U-Boot the device is called nor0.</p></li>
<li><p>Flash SPI NOR with separate binaries to the corresponding partition. This can
be used when only certain bootloader part needs to be updated.</p></li>
</ul>
<section id="flash-spi-nor-flash-from-network">
<h3><span class="section-number">4.3.1. </span>通过网络烧写SPI NOR Flash<a class="headerlink" href="#flash-spi-nor-flash-from-network" title="Link to this heading"></a></h3>
<p>The SPI NOR can contain the bootloader and environment to boot from. The arm64
kernel can not decompress itself, the image size extends the SPI NOR flash
populated on the phyFLEX-AM62L FPSC.</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>需要保证设备和存储镜像的主机之间的网络正常！ <a class="reference internal" href="#am62l-fpsc-head-development"><span class="std std-ref">Setup Network Host</span></a></p>
</div>
<section id="flash-spi-nor-from-network-in-kernel-on-target">
<h4><span class="section-number">4.3.1.1. </span>在开发板linux环境中通过网络烧写SPI NOR Flash<a class="headerlink" href="#flash-spi-nor-from-network-in-kernel-on-target" title="Link to this heading"></a></h4>
<ul>
<li><p>将镜像从主机复制到开发板：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>scp<span class="w"> </span>ti-boot-container.img<span class="w"> </span>root@192.168.3.11:/root
</pre></div>
</div>
</li>
<li><p>查找要擦除的U-boot分区的块数：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mtdinfo<span class="w"> </span>/dev/mtd0
<span class="go">mtd0</span>
<span class="go">Name:                           fc40000.spi.0</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                131072 bytes, 128.0 KiB</span>
<span class="go">Amount of eraseblocks:          512 (67108864 bytes, 64.0 MiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:0</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>
</pre></div>
</div>
</li>
<li><p>Erase the necessary SPI NOR device/partition and flash it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>flash_erase<span class="w"> </span>/dev/mtd0<span class="w"> </span>0x0<span class="w"> </span><span class="m">0</span>
<span class="gp">target:~$ </span>flashcp<span class="w"> </span>ti-boot-container.img<span class="w"> </span>/dev/mtd0
</pre></div>
</div>
</li>
</ul>
</section>
<section id="flash-spi-nor-from-network-in-u-boot-on-target">
<h4><span class="section-number">4.3.1.2. </span>在开发板的U-Boot环境中通过网络烧写SPI NOR<a class="headerlink" href="#flash-spi-nor-from-network-in-u-boot-on-target" title="Link to this heading"></a></h4>
<p>Similar to updating the e.MMC over a network, be sure to set up the development
host correctly. The IP needs to be set to 192.168.3.10, the netmask to
255.255.255.0, and a TFTP server needs to be available.</p>
<ul>
<li><p>SPI NOR Flash需要使用特殊格式的U-Boot镜像。确保您使用了正确的镜像文件。通过tftp加载镜像，然后将bootloader写入Flash：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; tftp ${loadaddr} ti-boot-container.img
u-boot=&gt; mtd write nor0 ${loadaddr} 0 ${filesize}
SF: Detected mt35xu512aba with page size 256 Bytes, erase size 4 KiB, total 64 MiB
Writing 3752323 byte(s) at offset 0x00000000
</pre></div>
</div>
</li>
<li><p>Optinaly erase the environment partition as well. This way, the environment can be
written after booting from SPI NOR flash:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; mtd erase ospi.env
u-boot=&gt; mtd erase ospi.env.backup
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="flash-spi-nor-flash-from-sd-card">
<h3><span class="section-number">4.3.2. </span>Flash SPI NOR Flash from SD card<a class="headerlink" href="#flash-spi-nor-flash-from-sd-card" title="Link to this heading"></a></h3>
<p>The bootloader on SPI NOR flash can be also flashed from SD card.</p>
<section id="flash-spi-nor-from-sd-card-in-kernel-on-target">
<h4><span class="section-number">4.3.2.1. </span>Flash SPI NOR from SD card in kernel on Target<a class="headerlink" href="#flash-spi-nor-from-sd-card-in-kernel-on-target" title="Link to this heading"></a></h4>
<ul>
<li><p>Copy the SPI NOR flash U-boot container to the first partition on the SD
card.</p></li>
<li><p>Mount the SD card:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mount<span class="w"> </span>/dev/mmcblk1p1<span class="w"> </span>/mnt
</pre></div>
</div>
</li>
<li><p>Find the number of blocks to erase of the SPI NOR:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mtdinfo<span class="w"> </span>/dev/mtd0
<span class="go">mtd0</span>
<span class="go">Name:                           fc40000.spi.0</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                131072 bytes, 128.0 KiB</span>
<span class="go">Amount of eraseblocks:          512 (67108864 bytes, 64.0 MiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:0</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>
</pre></div>
</div>
</li>
<li><p>Erase the SPI NOR and flash it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>flash_erase<span class="w"> </span>/dev/mtd0<span class="w"> </span>0x0<span class="w"> </span><span class="m">0</span>
<span class="gp">target:~$ </span>flashcp<span class="w"> </span>/mnt/ti-boot-container.img<span class="w"> </span>/dev/mtd0
</pre></div>
</div>
</li>
</ul>
</section>
<section id="flash-spi-nor-from-sd-card-in-u-boot-on-target">
<h4><span class="section-number">4.3.2.2. </span>Flash SPI NOR from SD card in U-Boot on Target<a class="headerlink" href="#flash-spi-nor-from-sd-card-in-u-boot-on-target" title="Link to this heading"></a></h4>
<ul>
<li><p>Copy the SPI NOR flash U-boot container to the first partition on the SD
card.</p></li>
<li><p>A specially formatted U-boot image for the SPI NOR flash is used. Ensure you
use the correct image file. Load the image from the SD card, erase and write
the bootloader to the flash:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; mmc dev 1
u-boot=&gt; fatload mmc 1:1 ${loadaddr} ti-boot-container.img
u-boot=&gt; mtd write nor0 ${loadaddr} 0 ${filesize}
</pre></div>
</div>
</li>
<li><p>Optinaly erase the environment partition as well. This way, the environment can be
written after booting from SPI NOR flash:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; mtd erase ospi.env
u-boot=&gt; mtd erase ospi.env.backup
</pre></div>
</div>
</li>
</ul>
</section>
</section>
</section>
</section>
<section id="development">
<span id="am62l-fpsc-head-development"></span><h1><span class="section-number">5. </span>开发<a class="headerlink" href="#development" title="Link to this heading"></a></h1>
<section id="standalone-build-preparation">
<h2><span class="section-number">5.1. </span>独立编译准备<a class="headerlink" href="#standalone-build-preparation" title="Link to this heading"></a></h2>
<p>In this section, we describe how to build the U-Boot and the Linux kernel
without using the <a class="reference external" href="https://www.yoctoproject.org/">Yocto Project</a>. This
procedure makes the most sense for development. The U-Boot source code,
the Linux kernel, and all other git repositories are available on
<a class="reference external" href="https://github.com/phytec">GitHub</a>.</p>
<section id="git-repositories">
<h3><span class="section-number">5.1.1. </span>Git 仓库<a class="headerlink" href="#git-repositories" title="Link to this heading"></a></h3>
<ul>
<li><p>使用的 U-Boot 仓库：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>https://github.com/phytec/u-boot-phytec-ti
</pre></div>
</div>
</li>
<li><p>我们的U-Boot基于 u-boot-phytec-ti 并添加了一些硬件相关的补丁。</p></li>
<li><p>使用的 Linux 内核仓库：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>https://github.com/phytec/linux-phytec-ti
</pre></div>
</div>
</li>
<li><p>我们的 AM62L 内核是基于 linux-phytec-ti 内核。</p></li>
</ul>
<p>要找出核心板应使用的u-boot和kernel版本对应的git仓库tag标签，请查看您的BSP源文件夹：</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>meta-phytec/recipes-kernel/linux/linux-phytec-ti_*.bb
meta-phytec/recipes-bsp/u-boot/u-boot-phytec-ti_*.bb
</pre></div>
</div>
</div></blockquote>
</section>
<section id="get-the-sdk">
<h3><span class="section-number">5.1.2. </span>获取SDK<a class="headerlink" href="#get-the-sdk" title="Link to this heading"></a></h3>
<p>You can download the SDK from the <a class="reference external" href="https://download.phytec.de/Software/Linux/BSP-Yocto-AM62Lx/BSP-Yocto-Ampliphy-AM62Lx-ALPHA2/sdk/ampliphy-vendor/">SDK downloads</a> page, or build it yourself with Yocto:</p>
<ul>
<li><p>移动到Yocto的build目录：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span><span class="nb">source</span><span class="w"> </span>sources/poky/oe-init-build-env
<span class="gp">host:~$ </span>bitbake<span class="w"> </span>-c<span class="w"> </span>populate_sdk<span class="w"> </span>phytec-qt6demo-image<span class="w"> </span><span class="c1"># or another image</span>
</pre></div>
</div>
</li>
</ul>
<p>在成功编译后，SDK安装包保存在  <code class="docutils literal notranslate"><span class="pre">build/deploy*/sdk</span></code>。</p>
</section>
<section id="install-the-sdk">
<h3><span class="section-number">5.1.3. </span>安装SDK<a class="headerlink" href="#install-the-sdk" title="Link to this heading"></a></h3>
<ul>
<li><p>设置正确的权限并安装SDK：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>chmod<span class="w"> </span>+x<span class="w"> </span>phytec-ampliphy-vendor-glibc-x86_64-phytec-qt6demo-image-aarch64-toolchain-BSP-Yocto-Ampliphy-AM62Lx-ALPHA2.sh
<span class="gp">host:~$ </span>./phytec-ampliphy-vendor-glibc-x86_64-phytec-qt6demo-image-aarch64-toolchain-BSP-Yocto-Ampliphy-AM62Lx-ALPHA2.sh
<span class="go">============================================================================================================</span>
<span class="go">Enter target directory for SDK (default: /opt/ampliphy-vendor/BSP-Yocto-Ampliphy-AM62Lx-ALPHA2):</span>
<span class="go">You are about to install the SDK to &quot;/opt/ampliphy-vendor/BSP-Yocto-Ampliphy-AM62Lx-ALPHA2&quot;. Proceed [Y/n]? Y</span>
<span class="go">Extracting SDK...done</span>
<span class="go">Setting it up...done</span>
<span class="go">SDK has been successfully set up and is ready to be used.</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="using-the-sdk">
<h3><span class="section-number">5.1.4. </span>使用SDK<a class="headerlink" href="#using-the-sdk" title="Link to this heading"></a></h3>
<p>通过在工具链目录中source <em>environment-setup</em> 文件来初始化您的 shell 交叉编译环境：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span><span class="nb">source</span><span class="w"> </span>/opt/ampliphy-vendor/BSP-Yocto-Ampliphy-AM62Lx-ALPHA2/environment-setup-aarch64-phytec-linux
</pre></div>
</div>
</section>
<section id="installing-required-tools">
<h3><span class="section-number">5.1.5. </span>安装所需工具<a class="headerlink" href="#installing-required-tools" title="Link to this heading"></a></h3>
<p>独立编译Linux kernel和U-Boot需要主机安装一些额外的工具。对于Ubuntu，您可以使用以下命令安装它们：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>bison<span class="w"> </span>flex<span class="w"> </span>libssl-dev<span class="w"> </span>bc<span class="w"> </span>libncurses-dev<span class="w"> </span>python3<span class="w"> </span>python3-setuptools<span class="w"> </span>python3-dev<span class="w"> </span>python3-yaml<span class="w"> </span>python3-jsonschema<span class="w"> </span>python3-pyelftools<span class="w"> </span>swig<span class="w"> </span>yamllint<span class="w"> </span>libgnutls28-dev
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>Using the SDK on older host distributions (e.g., Ubuntu 20.04 LTS) with Scarthgap TI-based BSPs
can cause issues when building U-Boot or Linux kernel tools for host use. If you encounter an
&quot;undefined reference&quot; error, a workaround is to prepend the host's binutils to the PATH.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">host$ export PATH=/usr/bin:$PATH</span>
</pre></div>
</div>
<p>在加载SDK <em>environment-setup</em> 后，运行此命令。</p>
<p>请注意，在较新版本的发行版（如Ubuntu 22.04）中未观察到SDK相关问题，这些发行版似乎无需任何修改即可正常工作。</p>
</div>
</section>
</section>
<section id="u-boot-standalone-build">
<span id="am62l-fpsc-head-development-build-uboot"></span><h2><span class="section-number">5.2. </span>单独编译U-Boot<a class="headerlink" href="#u-boot-standalone-build" title="Link to this heading"></a></h2>
<section id="get-the-source-code">
<h3><span class="section-number">5.2.1. </span>获取源代码<a class="headerlink" href="#get-the-source-code" title="Link to this heading"></a></h3>
<ul>
<li><p>获取U-Boot源代码：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/phytec/u-boot-phytec-ti
</pre></div>
</div>
</li>
<li><p>要获取正确的 <em>U-Boot</em> <strong>tag</strong>，您需要查看我们的release notes，可以在这里找到：<a class="reference external" href="https://git.phytec.de/phy2octo/tree/releasenotes?h=am62lx">release notes</a></p></li>
<li><p>此版本中使用的 <strong>tag</strong> 称为 11.01.02</p></li>
<li><p>查看所需的 <em>U-Boot</em> <strong>tag</strong>：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span><span class="nb">cd</span><span class="w"> </span>~/u-boot-phytec-ti/
<span class="gp">host:~/u-boot-phytec-ti$ </span>git<span class="w"> </span>fetch<span class="w"> </span>--all<span class="w"> </span>--tags
<span class="gp">host:~/u-boot-phytec-ti$ </span>git<span class="w"> </span>checkout<span class="w"> </span>tags/11.01.02
</pre></div>
</div>
</li>
<li><p>设置编译环境：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/u-boot-phytec-ti$ </span><span class="nb">source</span><span class="w"> </span>/opt/ampliphy-vendor/BSP-Yocto-Ampliphy-AM62Lx-ALPHA2/environment-setup-aarch64-phytec-linux
</pre></div>
</div>
</li>
</ul>
</section>
<section id="get-the-needed-binaries">
<h3><span class="section-number">5.2.2. </span>获取所需的二进制文件<a class="headerlink" href="#get-the-needed-binaries" title="Link to this heading"></a></h3>
<p>要编译bootloader，您需要将这些文件复制到您的 u-boot-phytec-ti 编译目录，并将其重命名以适应 <em>mkimage</em> 脚本：</p>
<ul class="simple">
<li><dl class="simple">
<dt><strong>ARM Trusted firmware binaries</strong>:</dt><dd><ul>
<li><p>bl1.bin</p></li>
<li><p>bl31.bin</p></li>
<li><p>binary blobs</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>If you already built our BSP with Yocto, you can get the
bl1.bin, bl31.bin and binary blobs from the directory mentioned
here: <a class="reference internal" href="#am62l-fpsc-head-images"><span class="std std-ref">BSP Images</span></a></p>
<p>或者你可以在这里下载文件： <a class="reference external" href="https://download.phytec.de/Software/Linux/BSP-Yocto-AM62Lx/BSP-Yocto-Ampliphy-AM62Lx-ALPHA2/images/ampliphy-vendor/am62lxx-libra-fpsc-1/">https://download.phytec.de/Software/Linux/BSP-Yocto-AM62Lx/BSP-Yocto-Ampliphy-AM62Lx-ALPHA2/images/ampliphy-vendor/am62lxx-libra-fpsc-1/</a></p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>确保您重命名所需的文件，以和 <em>mkimage tool</em> 兼容。</p>
</div>
</section>
<section id="build-the-bootloader">
<h3><span class="section-number">5.2.3. </span>编译bootloader<a class="headerlink" href="#build-the-bootloader" title="Link to this heading"></a></h3>
<p>Build tiboot3.bin, tispl.bin and u-boot.img:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/u-boot-phytec-ti$ </span>make<span class="w"> </span>phycore_am62lx_defconfig
<span class="gp">host:~/u-boot-phytec-ti$ </span>make<span class="w"> </span><span class="nv">BL1</span><span class="o">=</span>/path/to/bl1.bin<span class="w"> </span><span class="nv">BL31</span><span class="o">=</span>/path/to/bl31.bin<span class="w"> </span><span class="nv">BINMAN_INDIRS</span><span class="o">=</span>/path/to/binary_blobs
</pre></div>
</div>
</div></blockquote>
</section>
<section id="create-bootloader-binaries-for-flashing">
<h3><span class="section-number">5.2.4. </span>Create bootloader binaries for flashing<a class="headerlink" href="#create-bootloader-binaries-for-flashing" title="Link to this heading"></a></h3>
<section id="use-with-uda-filesystem-mode">
<h4><span class="section-number">5.2.4.1. </span>Use with UDA filesystem mode<a class="headerlink" href="#use-with-uda-filesystem-mode" title="Link to this heading"></a></h4>
<p>To use the newly generated files with UDA filesystem boot. They can be coped to
the medium as is. E.g. to test this standalone build with SD-Card boot copy the
binaries to the SD-Card boot partition:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/|u-boot-repo-name|$ </span>cp<span class="w"> </span>tiboot3.bin<span class="w"> </span>tispl.bin<span class="w"> </span>u-boot.img<span class="w"> </span>/path/to/SD-Card/boot
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">提示</p>
<p>如果您有我们的BSP Yocto工程代码，具体的偏移值也会在Yocto变量&quot;BOOTLOADER_SEEK&quot;和&quot;BOOTLOADER_SEEK_EMMC&quot;中声明。</p>
</div>
</section>
<section id="use-with-block-device">
<h4><span class="section-number">5.2.4.2. </span>Use with block device<a class="headerlink" href="#use-with-block-device" title="Link to this heading"></a></h4>
<p>The three binaries can be used with block devices. E.g. eMMC and SPI NOR. Create
a combined image of all three:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/u-boot-phytec-ti$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>tiboot3.bin<span class="w"> </span><span class="nv">of</span><span class="o">=</span>ti-boot-container.img<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync
<span class="gp">host:~/u-boot-phytec-ti$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>tispl.bin<span class="w"> </span><span class="nv">of</span><span class="o">=</span>ti-boot-container.img<span class="w"> </span><span class="nv">seek</span><span class="o">=</span><span class="m">1024</span><span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync
<span class="gp">host:~/u-boot-phytec-ti$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>tispl.bin<span class="w"> </span><span class="nv">of</span><span class="o">=</span>ti-boot-container.img<span class="w"> </span><span class="nv">seek</span><span class="o">=</span><span class="m">5120</span><span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync
</pre></div>
</div>
<ul class="simple">
<li><p>flash to a block device e.g. eMMC:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/block/mmcblk0boot0/force_ro
<span class="gp">target:~$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>ti-boot-container.img<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/mmcblk0boot0<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync
</pre></div>
</div>
</section>
</section>
</section>
<section id="kernel-standalone-build">
<h2><span class="section-number">5.3. </span>单独编译内核<a class="headerlink" href="#kernel-standalone-build" title="Link to this heading"></a></h2>
<section id="setup-sources">
<h3><span class="section-number">5.3.1. </span>配置源代码<a class="headerlink" href="#setup-sources" title="Link to this heading"></a></h3>
<ul>
<li><p>使用的 linux-phytec-ti 分支可以在 <a class="reference external" href="https://git.phytec.de/phy2octo/tree/releasenotes?h=am62lx">release notes</a> 中找到</p></li>
<li><p>此版本所需的标签称为 v6.12.35-11.01.05-phy</p></li>
<li><p>Check out 所需的 linux-phytec-ti 标签：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/phytec/linux-phytec-ti
<span class="gp">host:~$ </span><span class="nb">cd</span><span class="w"> </span>~/linux-phytec-ti/
<span class="gp">host:~/linux-phytec-ti$ </span>git<span class="w"> </span>fetch<span class="w"> </span>--all<span class="w"> </span>--tags
<span class="gp">host:~/linux-phytec-ti$ </span>git<span class="w"> </span>checkout<span class="w"> </span>tags/v6.12.35-11.01.05-phy
</pre></div>
</div>
</li>
<li><p>为了提交更改，强烈建议切换到一个新分支：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-ti$ </span>git<span class="w"> </span>switch<span class="w"> </span>--create<span class="w"> </span>&lt;new-branch&gt;
</pre></div>
</div>
</li>
<li><p>设置编译环境：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-ti$ </span><span class="nb">source</span><span class="w"> </span>/opt/ampliphy-vendor/BSP-Yocto-Ampliphy-AM62Lx-ALPHA2/environment-setup-aarch64-phytec-linux
</pre></div>
</div>
</li>
</ul>
</section>
<section id="build-the-kernel">
<h3><span class="section-number">5.3.2. </span>编译内核<a class="headerlink" href="#build-the-kernel" title="Link to this heading"></a></h3>
<ul>
<li><p>编译Linux内核：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-ti$ </span>make<span class="w"> </span>phytec_ti_defconfig
<span class="gp">host:~/linux-phytec-ti$ </span>make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span>
</pre></div>
</div>
</li>
<li><p>安装内核模块，比如安装到 NFS 目录：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-ti$ </span>make<span class="w"> </span><span class="nv">INSTALL_MOD_PATH</span><span class="o">=</span>/home/&lt;user&gt;/&lt;rootfspath&gt;<span class="w"> </span>modules_install
</pre></div>
</div>
</li>
<li><p>镜像可以在 ~/linux-phytec-ti/arch/arm64/boot/Image 找到</p></li>
<li><p>The dtb can be found at
~/linux-phytec-ti/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dtb</p></li>
<li><p>要（重新）编译设备树和 -overlay 文件，只需运行</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-ti$ </span>make<span class="w"> </span>dtbs
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果您遇到以下编译问题：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>scripts/dtc/yamltree.c:9:10: fatal error: yaml.h: No such file or directory
</pre></div>
</div>
<p>确保您在主机系统上安装了 <em>&quot;libyaml-dev&quot;</em> 包：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>libyaml-dev
</pre></div>
</div>
</div>
</section>
<section id="copy-kernel-to-sd-card">
<h3><span class="section-number">5.3.3. </span>将内核复制到SD卡<a class="headerlink" href="#copy-kernel-to-sd-card" title="Link to this heading"></a></h3>
<p>内核及module和对应的设备树二进制文件可以用以下方式复制到已挂载的SD卡上。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-ti$ </span>cp<span class="w"> </span>arch/arm64/boot/Image<span class="w"> </span>/path/to/sdcard/boot/
<span class="gp">host:~/linux-phytec-ti$ </span>cp<span class="w"> </span>arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dtb<span class="w"> </span>/path/to/sdcard/boot/oftree
<span class="gp">host:~/linux-phytec-ti$ </span>make<span class="w"> </span><span class="nv">INSTALL_MOD_PATH</span><span class="o">=</span>/path/to/sdcard/root/<span class="w"> </span>modules_install
</pre></div>
</div>
</section>
</section>
<section id="host-network-preparation">
<h2><span class="section-number">5.4. </span>主机网络准备<a class="headerlink" href="#host-network-preparation" title="Link to this heading"></a></h2>
<p>为了在bootloader中执行涉及网络的各种任务，需要配置一些主机服务。在开发主机上，必须安装和配置TFTP、NFS和DHCP服务。启动以太网所需的工具如下：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>tftpd-hpa<span class="w"> </span>nfs-kernel-server<span class="w"> </span>kea
</pre></div>
</div>
<section id="tftp-server-setup">
<h3><span class="section-number">5.4.1. </span>TFTP服务设置<a class="headerlink" href="#tftp-server-setup" title="Link to this heading"></a></h3>
<ul>
<li><p>首先，创建一个目录来存储TFTP文件：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>/srv/tftp
</pre></div>
</div>
</li>
<li><p>然后将您的BSP镜像文件复制到此目录，并确保other用户也对tftp目录中的所有文件具有读取权限，否则将无法从开发板访问这些文件。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>chmod<span class="w"> </span>-R<span class="w"> </span>o+r<span class="w"> </span>/srv/tftp
</pre></div>
</div>
</li>
<li><p>您还需要为相应的接口配置一个静态IP地址。PHYTEC开发板的默认IP地址是192.168.3.11。可以将主机地址设置为192.168.3.10，子网掩码为255.255.255.0</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>ip<span class="w"> </span>addr<span class="w"> </span>show<span class="w"> </span>&lt;network-interface&gt;
</pre></div>
</div>
<p>将 &lt;network-interface&gt; 替换为连接到开发板的网络接口。您可以通过不指定网络接口来显示所有可选网络接口。</p>
</li>
<li><p>返回的结果应包含以下内容：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>inet 192.168.3.10/24 brd 192.168.3.255
</pre></div>
</div>
</li>
<li><p>创建或编辑 <code class="docutils literal notranslate"><span class="pre">/etc/default/tftpd-hpa</span></code> 文件：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /etc/default/tftpd-hpa

TFTP_USERNAME=&quot;tftp&quot;
TFTP_DIRECTORY=&quot;/srv/tftp&quot;
TFTP_ADDRESS=&quot;:69&quot;
TFTP_OPTIONS=&quot;-s -c&quot;
</pre></div>
</div>
</li>
<li><p>将 TFTP_DIRECTORY 设置为您的 TFTP 服务器根目录</p></li>
<li><p>将TFTP_ADDRESS设置为TFTP服务监听的主机地址（设置为0.0.0.0:69以监听69端口上所有IP）。</p></li>
<li><p>设置 TFTP_OPTIONS，以下命令显示可配置的选项：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>man<span class="w"> </span>tftpd
</pre></div>
</div>
</li>
<li><p>重新启动服务以应用配置更改：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>service<span class="w"> </span>tftpd-hpa<span class="w"> </span>restart
</pre></div>
</div>
</li>
</ul>
<p>现在将开发板的以太网端口连接到您的主机。我们还需要在开发板和运行TFTP服务的主机之间建立网络连接。TFTP服务器的IP地址应设置为192.168.3.10，子网掩码为255.255.255.0。</p>
<section id="nfs-server-setup">
<h4><span class="section-number">5.4.1.1. </span>NFS服务器设置<a class="headerlink" href="#nfs-server-setup" title="Link to this heading"></a></h4>
<ul>
<li><p>创建一个NFS目录：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>/srv/nfs
</pre></div>
</div>
</li>
<li><p>Temporarily export the nfs directory:
The NFS server is not restricted to a certain file system location, so all we
have to do is to export our root file system to the embedded network. In this
example, the whole directory is exported and the &quot;lab network&quot; address of the
development host is 192.168.3.10. The IP address has to be adapted to the
local needs:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>exportfs<span class="w"> </span>-i<span class="w"> </span>-o<span class="w"> </span>rw,no_root_squash,sync,no_subtree_check<span class="w"> </span><span class="m">192</span>.168.3.0/255.255.255.0:/srv/nfs
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>unexport the rootfs when finished:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>exportfs<span class="w"> </span>-u<span class="w"> </span><span class="m">192</span>.168.3.0/255.255.255.0:/srv/nfs
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<section id="permanent-export">
<h5><span class="section-number">5.4.1.1.1. </span>Permanent export<a class="headerlink" href="#permanent-export" title="Link to this heading"></a></h5>
<ul>
<li><p>To make the export persistent across reboots on most distributions, modify the
<code class="docutils literal notranslate"><span class="pre">/etc/exports</span></code> file and export it:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/srv/nfs 192.168.3.0/255.255.255.0(rw,no_root_squash,sync,no_subtree_check)
</pre></div>
</div>
</li>
<li><p>现在NFS服务器需要再次读取 <code class="docutils literal notranslate"><span class="pre">/etc/exportfs</span></code> 文件：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>exportfs<span class="w"> </span>-ra
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="dhcp-server-setup">
<h4><span class="section-number">5.4.1.2. </span>DHCP服务器设置<a class="headerlink" href="#dhcp-server-setup" title="Link to this heading"></a></h4>
<ul>
<li><p>创建或编辑 <code class="docutils literal notranslate"><span class="pre">/etc/kea/kea-dhcp4.conf</span></code> 文件；以内部子网为例，将 &lt;network-interface&gt; 替换为物理网络接口的名称：</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;Dhcp4&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;interfaces-config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;interfaces&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;&lt;network-interface&gt;/192.168.3.10&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;lease-database&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;memfile&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;persist&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/tmp/dhcp4.leases&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;valid-lifetime&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">28800</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;subnet4&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">        </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;next-server&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.3.10&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;subnet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.3.0/24&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;pools&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;pool&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.3.1 - 192.168.3.255&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>在创建子网时请小心，因为这可能会扰乱公司网络政策。为了安全起见，请使用不同的子网，并通过 <code class="docutils literal notranslate"><span class="pre">interfaces</span></code> 配置选项指定该网络。</p>
</div>
<ul>
<li><p>现在DHCP服务需要重新读取 <code class="docutils literal notranslate"><span class="pre">/etc/kea/kea-dhcp4.conf</span></code> 文件：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>kea-dhcp4-server
</pre></div>
</div>
</li>
</ul>
<p>当您启动/重启主机时，如果kea-dhcp4配置中指定的网络接口未处于活动状态，kea-dhcp4-server将无法启动。因此请确保在连接接口后启动或者重启该systemd服务。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>DHCP server setup is only needed when using dynamic IP addresses. For our
vendor BSPs, static IP addresses are used by default.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; env print ip_dyn
ip_dyn=no
</pre></div>
</div>
<p>To use dynamic IP addresses for netboot, <code class="docutils literal notranslate"><span class="pre">ip_dyn</span></code> needs to be set to <code class="docutils literal notranslate"><span class="pre">yes</span></code>.</p>
</div>
</section>
</section>
</section>
<section id="booting-the-kernel-from-a-network">
<h2><span class="section-number">5.5. </span>从网络启动内核<a class="headerlink" href="#booting-the-kernel-from-a-network" title="Link to this heading"></a></h2>
<p>从网络启动意味着通过TFTP加载内核和设备树，并通过NFS加载根文件系统。但bootloader需要从另外的的启动设备加载。</p>
<section id="place-images-on-host-for-netboot">
<h3><span class="section-number">5.5.1. </span>在主机上放置网络启动的镜像<a class="headerlink" href="#place-images-on-host-for-netboot" title="Link to this heading"></a></h3>
<ul>
<li><p>Copy the kernel fitImage, which already contains device-tree and all
device-tree overlays to your tftp directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>cp<span class="w"> </span>fitImage<span class="w"> </span>/srv/tftp
</pre></div>
</div>
</li>
<li><p>Copy the booting script to your tftp directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>cp<span class="w"> </span>net_boot_fit.scr.uimg<span class="w"> </span>/srv/tftp
</pre></div>
</div>
</li>
<li><p>确保other用户对tftp目录中的所有文件具有读取权限，否则将无法从开发板访问它们：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>chmod<span class="w"> </span>-R<span class="w"> </span>o+r<span class="w"> </span>/srv/tftp
</pre></div>
</div>
</li>
<li><p>将根文件系统解压到您的NFS目录中：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>tar<span class="w"> </span>-xvzf<span class="w"> </span>phytec-qt6demo-image-am62lxx-libra-fpsc-1.tar.xz<span class="w"> </span>-C<span class="w"> </span>/srv/nfs
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>请确保使用sudo执行命令，以保留根文件系统中文件的所属权限。</p>
</div>
</section>
<section id="set-appropriate-u-boot-variables">
<h3><span class="section-number">5.5.2. </span>Set appropriate U-boot variables<a class="headerlink" href="#set-appropriate-u-boot-variables" title="Link to this heading"></a></h3>
<p>Since the nfsroot directory could be different in other networks, we do not set
any default values. Enter the following commands to modify the bootloader
environment.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv nfsroot /srv/nfs
</pre></div>
</div>
<p>Set any overlay configurations needed:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv overlays overlay.dtbo
</pre></div>
</div>
</section>
<section id="booting-from-an-embedded-board">
<h3><span class="section-number">5.5.3. </span>从开发板启动<a class="headerlink" href="#booting-from-an-embedded-board" title="Link to this heading"></a></h3>
<p>Set the correct boot target, if not already set by u-boot board code and boot
into network boot:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; setenv boot_targets dhcp</span>
<span class="go">u-boot=&gt; boot</span>
</pre></div>
</div>
</section>
<section id="network-settings-on-target">
<h3><span class="section-number">5.5.4. </span>开发板上的网络设置<a class="headerlink" href="#network-settings-on-target" title="Link to this heading"></a></h3>
<p>如果要自定义开发板上的以太网配置，请按照此处的说明进行操作： <a class="reference internal" href="#am62l-fpsc-head-network"><span class="std std-ref">Network Environment Customization</span></a></p>
</section>
</section>
<section id="accessing-the-development-states">
<h2><span class="section-number">5.6. </span>获取BSP开发中版本<a class="headerlink" href="#accessing-the-development-states" title="Link to this heading"></a></h2>
<section id="development-state-of-current-release">
<h3><span class="section-number">5.6.1. </span>当前release的开发中版本<a class="headerlink" href="#development-state-of-current-release" title="Link to this heading"></a></h3>
<p>这些release manifest文件是为了让您访问 <em>Yocto</em> BSP的开发版本。它们不会在phyLinux选择菜单中显示，需要手动选择。可以使用以下命令行来完成此操作：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>./phyLinux<span class="w"> </span>init<span class="w"> </span>-p<span class="w"> </span>am62l-fpsc<span class="w"> </span>-r<span class="w"> </span>BSP-Yocto-Ampliphy-AM62Lx-FPSC-PD25.1.y
</pre></div>
</div>
<p>这将初始化一个BSP，用于跟踪当前版本（ BSP-Yocto-Ampliphy-AM62Lx-ALPHA2 ）的最新开发版本。从现在开始，在此文件夹中执行 <em>repo sync</em> 将从我们的Git仓库中拉取所有最新的更改：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>repo<span class="w"> </span>sync
</pre></div>
</div>
</section>
<section id="development-state-of-upcoming-release">
<h3><span class="section-number">5.6.2. </span>即将发布版本的开发中版本<a class="headerlink" href="#development-state-of-upcoming-release" title="Link to this heading"></a></h3>
<p>即将发布版本的开发中版本可以通过这种方式访问。请执行以下命令，并查找一个比最新版本（ BSP-Yocto-Ampliphy-AM62Lx-ALPHA2 ）的PDXX.Y数字更高的版本，并且以 <code class="docutils literal notranslate"><span class="pre">.y</span></code> 结尾：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>./phyLinux<span class="w"> </span>init<span class="w"> </span>-p<span class="w"> </span>am62l-fpsc
</pre></div>
</div>
</section>
</section>
<section id="accessing-the-latest-upstream-support">
<h2><span class="section-number">5.7. </span>获取最新的Upstream支持<a class="headerlink" href="#accessing-the-latest-upstream-support" title="Link to this heading"></a></h2>
<p>We have a vanilla manifest that makes use of the Yocto master branches (not a
vendor release), Linux, and U-Boot. This can be used to test the latest upstream
kernel/U-Boot.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>master分支的manifest反映了最新的开发状态。有时会出现一些bug。我们会定期修复master分支。</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>./phyLinux<span class="w"> </span>init<span class="w"> </span>-p<span class="w"> </span>am62l-fpsc<span class="w"> </span>-r<span class="w"> </span>BSP-Yocto-Ampliphy-AM62Lx-master
</pre></div>
</div>
</section>
<section id="format-sd-card">
<span id="am62l-fpsc-head-format-sd"></span><h2><span class="section-number">5.8. </span>Format SD card<a class="headerlink" href="#format-sd-card" title="Link to this heading"></a></h2>
<p>使用单一的SD卡启动盘对存储介质进行烧写是开发过程中的常见任务。本章节针对此场景提供基础说明。大多数镜像的大小超过了默认的root分区剩余容量。要使用SD卡进行烧写，根文件系统需要扩展或创建一个单独的分区。有几种不同的方法可以格式化SD卡。最简单的方法是使用Gparted。</p>
<section id="gparted">
<h3><span class="section-number">5.8.1. </span>Gparted<a class="headerlink" href="#gparted" title="Link to this heading"></a></h3>
<ul>
<li><p>获取 GParted：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>gparted
</pre></div>
</div>
</li>
<li><p>Insert the SD card into your host and get the device name:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail
<span class="go">...</span>
<span class="go">[30436.175412] sd 4:0:0:0: [sdb] 62453760 512-byte logical blocks: (32.0 GB/29.8 GiB)</span>
<span class="go">[30436.179846]  sdb: sdb1 sdb2</span>
<span class="go">...</span>
</pre></div>
</div>
</li>
<li><p>Unmount all SD card partitions.</p></li>
<li><p>启动 GParted：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>gparted
</pre></div>
</div>
</li>
</ul>
<img alt="../../../_images/gparted1.png" src="../../../_images/gparted1.png" />
<section id="expand-rootfs">
<h4><span class="section-number">5.8.1.1. </span>扩展根文件系统<a class="headerlink" href="#expand-rootfs" title="Link to this heading"></a></h4>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>使用resize2fs版本1.46.6及更早版本的PC系统（例如Ubuntu 22.04）无法烧写在Mickledore以及更新的yocto版本上创建的partup软件包。这个是因为resize2fs新增了默认选项而导致的兼容性问题。有关详细信息，请参阅 <a class="reference external" href="https://e2fsprogs.sourceforge.net/e2fsprogs-release.html#1.47.0">发布说明</a> 。</p>
</div>
<ul class="simple">
<li><p>Choose your SD card device at the drop-down menu on the top right</p></li>
<li><p>选择 ext4 根分区并点击调整大小：</p></li>
</ul>
<img alt="../../../_images/gparted5.png" src="../../../_images/gparted5.png" />
<img alt="../../../_images/gparted2.png" src="../../../_images/gparted2.png" />
<ul class="simple">
<li><p>您可以根据需要拖动滑块或手动输入大小。</p></li>
</ul>
<img alt="../../../_images/gparted3.png" src="../../../_images/gparted3.png" />
<ul class="simple">
<li><p>通过点击“Change Size”按钮确认您的输入。</p></li>
</ul>
<img alt="../../../_images/gparted4.png" src="../../../_images/gparted4.png" />
<ul>
<li><p>要应用您的更改，请按绿色勾号。</p></li>
<li><p>现在您可以挂载根分区并将 phytec-qt6demo-image-am62lxx-libra-fpsc-1.wic 镜像复制到其中。然后再卸载它：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>cp<span class="w"> </span>phytec-qt6demo-image-am62lxx-libra-fpsc-1.wic<span class="w"> </span>/mnt/<span class="w"> </span><span class="p">;</span><span class="w"> </span>sync
<span class="gp">host:~$ </span>umount<span class="w"> </span>/mnt
</pre></div>
</div>
</li>
</ul>
</section>
<section id="create-the-third-partition">
<h4><span class="section-number">5.8.1.2. </span>创建第三个分区<a class="headerlink" href="#create-the-third-partition" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Choose your SD card device at the drop-down menu on the top right</p></li>
</ul>
<img alt="../../../_images/gparted1.png" src="../../../_images/gparted1.png" />
<ul class="simple">
<li><p>选择更大的未分配区域，然后点击&quot;New&quot;：</p></li>
</ul>
<img alt="../../../_images/gparted6.png" src="../../../_images/gparted6.png" />
<ul class="simple">
<li><p>点击&quot;Add&quot;</p></li>
</ul>
<img alt="../../../_images/gparted7.png" src="../../../_images/gparted7.png" />
<ul class="simple">
<li><p>按绿色勾确认更改。</p></li>
</ul>
<img alt="../../../_images/gparted8.png" src="../../../_images/gparted8.png" />
<ul>
<li><p>现在您可以挂载新的分区并将 phytec-qt6demo-image-am62lxx-libra-fpsc-1.wic 镜像复制到其中。然后卸载它：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>mount<span class="w"> </span>/dev/sde3<span class="w"> </span>/mnt
<span class="gp">host:~$ </span>sudo<span class="w"> </span>cp<span class="w"> </span>phytec-qt6demo-image-am62lxx-libra-fpsc-1.wic<span class="w"> </span>/mnt/<span class="w"> </span><span class="p">;</span><span class="w"> </span>sync
<span class="gp">host:~$ </span>umount<span class="w"> </span>/mnt
</pre></div>
</div>
</li>
</ul>
</section>
</section>
</section>
</section>
<section id="device-tree-dt">
<span id="am62l-fpsc-head-device-tree"></span><h1><span class="section-number">6. </span>设备树 (DT)<a class="headerlink" href="#device-tree-dt" title="Link to this heading"></a></h1>
<section id="introduction">
<h2><span class="section-number">6.1. </span>介绍<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>以下文本简要描述了设备树，关于设备树的相关文档可以在Linux kernel文档中找到（<a class="reference external" href="https://docs.kernel.org/devicetree/usage-model.html">https://docs.kernel.org/devicetree/usage-model.html</a>）。</p>
<p>“Open Firmware Device Tree”或简称设备树（DT）是一种用于描述硬件的数据结构和语言。更具体地说，它是一个可由操作系统读取的硬件描述，以便操作系统不需要对machine的细节进行硬编码</p>
<p>内核文档是学习设备树的一个非常好的资源。关于设备树数据格式的概述可以在 <a class="reference external" href="https://www.devicetree.org/">devicetree.org</a> 的设备树使用页面找到。</p>
</section>
<section id="phytec-soc-bsp-device-tree-concept">
<h2><span class="section-number">6.2. </span>PHYTEC AM62L BSP设备树概念<a class="headerlink" href="#phytec-soc-bsp-device-tree-concept" title="Link to this heading"></a></h2>
<p>以下部分说明了PHYTEC配置基于 AM62L 的核心板设备树的一些规则。</p>
<section id="device-tree-structure">
<h3><span class="section-number">6.2.1. </span>设备树结构<a class="headerlink" href="#device-tree-structure" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><em>Module.dtsi</em> - 文件包括所有安装在核心板上的设备，例如PMIC和RAM。</p></li>
<li><p><em>Board.dts</em> - 包含核心板 dtsi 文件。从SoC AM62L 引出并在底板使用的设备也包含在此 dts 中。</p></li>
<li><p><em>Overlay.dtso</em> - 根据核心板或底板上可选硬件（例如 SPI 闪存或 PEB-AV-10）的情况来启用/禁用一些功能。</p></li>
</ul>
<p>在Linux内核的根目录下，我们的 AM62 平台的设备树文件可以在 <code class="docutils literal notranslate"><span class="pre">arch/arm64/boot/dts/freescale/</span></code> 找到。</p>
</section>
<section id="device-tree-overlay">
<h3><span class="section-number">6.2.2. </span>设备树Overlay<a class="headerlink" href="#device-tree-overlay" title="Link to this heading"></a></h3>
<p>设备树Overlay是可以在启动时合并到设备树中的设备树片段。下面是扩展板的硬件描述。对比源码中的include，overlay通过覆盖的方式来生效。overlay也可以根据实际开发板的硬件配置来设置设备树节点状态。设备树Overlay与我们Linux内核仓库中的其他设备树文件一起放在子文件夹 <code class="docutils literal notranslate"><span class="pre">arch/arm64/boot/dts/freescale/</span></code> 中。</p>
<p>am62lxx-libra-fpsc-1.conf 可用的overlay文件有：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>k3-am62l3-libra-fpsc-lvds-ac209.dtbo
</pre></div>
</div>
<p id="am62l-fpsc-head-ubootexternalenv">可以在linux中使用以下命令来列出FIT镜像中所有的overlay配置</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>dumpimage<span class="w"> </span>-l<span class="w"> </span>/boot/fitImage
</pre></div>
</div>
<p>或者在u-boot：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; load mmc ${mmcdev}:1 ${loadaddr} fitImage</span>
<span class="go">u-boot=&gt; iminfo</span>
</pre></div>
</div>
<p>可以在Linux或U-Boot环境下配置overlay。overlay是在引导命令调用后、内核加载之前生效。接下来的部分将更详细地解释配置方法。</p>
<section id="set-overlays-variable">
<h4><span class="section-number">6.2.2.1. </span>设置 <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> 变量<a class="headerlink" href="#set-overlays-variable" title="Link to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> U-Boot 环境变量包含一个以井号#分隔的overlay文件列表，这些overlay文件将在启动过程中应用。overlays变量中的overlay列表会包含在FIT镜像中。在 $KERNEL_DEVICETREE 这个 Yocto machine 变量中设置的 overlay 文件将自动添加到FIT镜像中。</p>
<p><code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> 变量可以直接在U-Boot环境中设置，也可以作为外部 <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code> 环境文件的一部分。当希望使用在U-Boot环境中手工配置的overlay变量，可以配置 <code class="docutils literal notranslate"><span class="pre">env</span> <span class="pre">set</span> <span class="pre">no_bootenv</span> <span class="pre">1</span></code> ，因为overlay变量可能在运行启动脚本时被覆盖。默认情况下， <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> 变量来自位于启动分区的 <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code> 文件。您可以在已启动的开发板上从Linux读取和写入该文件：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/boot/bootenv.txt
<span class="go">overlays=conf-k3-am62l3-libra-rdk-fpsc-peb-eval-01.dtbo#conf-|dtbo-peb-av-10|</span>
</pre></div>
</div>
<p>更改将在下次重启后生效。如果没有可用的 <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code> 文件，可以直接在U-Boot环境中设置overlay变量。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv overlays conf-|dtbo-peb-av-10|
u-boot=&gt; printenv overlays
overlays=conf-|dtbo-peb-av-10|
u-boot=&gt; boot
</pre></div>
</div>
<p>如果用户定义了 <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> 变量，同时存在 <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code> 文件，则需要设置 <code class="docutils literal notranslate"><span class="pre">${no_bootenv}</span></code> 变量：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv no_bootenv 1
u-boot=&gt; setenv overlays conf-|dtbo-peb-av-10|
u-boot=&gt; boot
</pre></div>
</div>
<p>有关环境的更多信息，请参见 U-boot External Environment subsection of the
<a class="reference internal" href="#am62l-fpsc-head-ubootexternalenv"><span class="std std-ref">device tree overlay section</span></a>。</p>
<p>我们使用 <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> 变量来描述在运行时无法自动检测的扩展板和摄像头。如果想禁用 <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> 变量中列出的overlay，可以在U-Boot的环境中将overlay变量unset，并且将 <code class="docutils literal notranslate"><span class="pre">${no_overlays}</span></code> 变量设置为 <cite>1</cite>。</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; env delete overlays
u-boot=&gt; env set no_bootenv 1
</pre></div>
</div>
<p>如果希望通过 bootenv.txt 文件设置除overlay之外的 U-Boot 变量并且禁用overlay，可以从 bootenv.txt 文件中删除overlay定义行，而不是设置 no_bootenv。</p>
</section>
<section id="som-variants">
<h4><span class="section-number">6.2.2.2. </span>不同的SoM配置<a class="headerlink" href="#som-variants" title="Link to this heading"></a></h4>
<p>核心板会自动加载额外的overlay，以禁用核心板未贴装的组件。通过读取出厂EEPROM数据（EEPROM SoM Detection）来实现自动加载对应的overlay。</p>
<p>核心板型号会决定是否应用设备树overlay。要在U-Boot环境中查询是否会应用某个overlay，请运行：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; env print fit_extensions
</pre></div>
</div>
<p>如果没有可用的EEPROM数据，则不加载任何设备树overlay。</p>
<p>要禁止启动时自动加载不同核心板的overlay，可以在bootloader环境中将 <code class="docutils literal notranslate"><span class="pre">${no_extensions}</span></code> 变量设置为 <cite>1</cite> ：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv no_extensions 1
u-boot=&gt; boot
</pre></div>
</div>
</section>
</section>
<section id="u-boot-external-environment">
<h3><span class="section-number">6.2.3. </span>U-boot外部环境<a class="headerlink" href="#u-boot-external-environment" title="Link to this heading"></a></h3>
<p>在Linux内核启动时，外部环境 <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code> 文本文件将从MMC设备的boot分区或通过TFTP加载。该文件的主要目的是存储 <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> 变量。这可以针对不同的machine在Yocto中预定义不同的overlay配置。文件的内容在meta-phytec中的Yocto recipe中的bootenv中定义： <a class="extlink-yocto-bootenv reference external" href="https://git.phytec.de/meta-phytec/tree/recipes-bsp/bootenv?h=scarthgap">https://git.phytec.de/meta-phytec/tree/recipes-bsp/bootenv?h=scarthgap</a></p>
<p>该文件中也可以设置其他变量。这些变量将覆盖环境中现有的设置。但只有对boot命令后进行计算的变量生效，例如 <code class="docutils literal notranslate"><span class="pre">${nfsroot}</span></code> 或 <code class="docutils literal notranslate"><span class="pre">${mmcargs}</span></code>。在文件中更改其他变量将不会有作用。以网络启动的用法作为示例。</p>
<p>如果无法加载外部环境，启动过程将继续进行，并使用自带的环境变量值。</p>
</section>
<section id="change-u-boot-environment-from-linux-on-target">
<h3><span class="section-number">6.2.4. </span>在Linux环境下更改开发板上的U-boot环境变量<a class="headerlink" href="#change-u-boot-environment-from-linux-on-target" title="Link to this heading"></a></h3>
<p>Libubootenv是我们镜像中包含的一个工具，用于在开发板linux上修改U-Boot环境。</p>
<p>使用以下命令打印U-Boot环境：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>fw_printenv
</pre></div>
</div>
<p>使用以下命令修改U-Boot环境：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>fw_setenv<span class="w"> </span>&lt;variable&gt;<span class="w"> </span>&lt;value&gt;
</pre></div>
</div>
<div class="admonition caution">
<p class="admonition-title">小心</p>
<p>Libubootenv会读取配置文件中配置的环境变量。要修改的环境变量会被插入到该文件中，默认情况下使用eMMC中存储环境变量。</p>
<p>如果eMMC没有被烧写过或者eMMC环境被擦除，libubootenv将无法工作。您应该修改 <code class="docutils literal notranslate"><span class="pre">/etc/fw_env.config</span></code> 文件，以匹配您想要使用的环境源。</p>
</div>
</section>
</section>
</section>
<section id="accessing-peripherals">
<h1><span class="section-number">7. </span>访问外设<a class="headerlink" href="#accessing-peripherals" title="Link to this heading"></a></h1>
<p>To find out which boards and modules are supported by the release of PHYTEC's
phyFLEX-AM62L FPSC BSP described herein, visit <a class="reference external" href="https://www.phytec.de/bsp-download/?bsp=BSP-Yocto-Ampliphy-AM62Lx-ALPHA2">our BSP</a> web page and click
the corresponding BSP release in the download section. Here you can find all
hardware supported in the columns &quot;Hardware Article Number&quot; and the correct
machine name in the corresponding cell under &quot;Machine Name&quot;.</p>
<p>为了最大化软件的可复用性，Linux内核提供了一个巧妙的软件架构，软件会根据不同硬件组件来分层。BSP（板级支持包）尽可能地对套件的功能进行模块化。当定制开发板或自定义核心板时，大部分软件配置可以简单的复制粘贴。与具体的开发板相关的内核代码可以在内核代码仓库中的设备树（DT）中找到，路径为 <code class="docutils literal notranslate"><span class="pre">arch/arm64/boot/dts/freescale/*.dts</span></code> 。</p>
<p>实际上，软件复用是Linux内核最重要的特性之一，尤其是在ARM架构中，它必须应对大量复杂且不同的系统级芯片（SoC）。整个开发板的硬件在设备树（DT）中描述，独立于内核镜像。硬件描述在一个单独的二进制文件中，称为设备树二进制文件（Device Tree Blob，DTB）（参见 <a class="reference internal" href="#am62l-fpsc-head-device-tree"><span class="std std-ref">device tree</span></a>）。</p>
<p>请阅读PHYTEC AM62L BSP设备树概念部分，以了解我们的 AM62 BSP设备树模型。</p>
<p>以下部分概述了 AM62 平台上支持的硬件组件及其对应操作系统驱动程序。客户可以根据自身的需求进行更改。</p>
<section id="soc-pin-muxing">
<h2><span class="section-number">7.1. </span>AM62L 引脚复用<a class="headerlink" href="#soc-pin-muxing" title="Link to this heading"></a></h2>
<p>该 AM62L Soc包含许多外设接口。为了在保持最大功能性的同时减少封装尺寸和降低整体系统成本，许多 AM62L 引脚可以多路复用为多达八种信号功能。尽管存在许多可能的引脚多路复用组合，但由于时序限制，只有一定数量的组合被称为有效的 IO 集合。这些有效的 IO 集合经过精心挑选，以为用户提供尽可能多的应用场景。</p>
<p>Please refer to our Hardware Manual or the TI AM62L Reference Manual for more
information about the specific pins and the muxing capabilities.</p>
<p>IO 集合的配置，也称为复用（muxing），是在设备树中完成的。驱动程序pinctrl-single读取设备树的节点fsl,pins，并进行引脚复用配置。</p>
<p>The following is an example of the pin muxing of the UART0 device in
k3-am62l3-libra-rdk-fpsc.dtsi:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>main_uart0_pins_default: main-uart0-default-pins {
   pinctrl-single,pins = &lt;
      AM62LX_IOPAD(0x01b4, PIN_INPUT, 0)      /* (D13) UART0_RXD */
      AM62LX_IOPAD(0x01b8, PIN_OUTPUT, 0)     /* (C13) UART0_TXD */
   &gt;;
   bootph-all;
};
</pre></div>
</div>
<p>The first argument of the macro AM62LX_IOPAD(pa, val, muxmode) is the pad offset
address within the I/O controller (in this example 0x1b4, corresponding UART0_RXD).
The second argument (val) specifies the pad configuration, such as input/output
and pull-up/pull-down. Third argument (muxmode) selects the functional mux mode
for the pad, i.e. which peripheral signal is connected to it. In this case, 0
corresponds to the default mux option for UART0.</p>
<p>The device tree representation for UART0 pinmuxing:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L150">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L150</a></p>
</section>
<section id="rs232">
<h2><span class="section-number">7.2. </span>RS232<a class="headerlink" href="#rs232" title="Link to this heading"></a></h2>
<p>The FPSC Standard supports 3 UART units. On the Libra FPSC, TTL level signals
of UART0 (the standard console) and WKUP_UART0 are routed to a FT4232H UART
to USB converter expansion. This USB is brought out at USB-C connector X14.
UART4 is connected to a multi-protocol transceiver for RS-232 and RS-485,
available at pin header connector <a class="reference internal" href="#am62l-fpsc-head-components"><span class="std std-ref">X27</span></a> at the RS-232 level,
or at the RS-485 level. The muxing of the used transceivers is done by switch
<a class="reference internal" href="#am62l-fpsc-head-components"><span class="std std-ref">S5</span></a> on the baseboard.
For more information about the correct setup please refer to the phyFLEX-AM62L FPSC/Libra FPSC
Hardware Manual section UARTs. The switch <a class="reference internal" href="#am62l-fpsc-head-components"><span class="std std-ref">S5</span></a> need to be set correctly.</p>
<ul>
<li><p>以人类可读的格式显示终端的当前设置：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>stty<span class="w"> </span>-a
</pre></div>
</div>
</li>
<li><p>通过简单的echo和cat，可以测试基本的通信。示例：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">123</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/ttyS1
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>cat<span class="w"> </span>/dev/ttyUSB2
</pre></div>
</div>
</li>
</ul>
<p>The device tree representation for RS232:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L327">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L327</a></p>
</section>
<section id="network">
<span id="am62l-fpsc-head-network"></span><h2><span class="section-number">7.3. </span>网络<a class="headerlink" href="#network" title="Link to this heading"></a></h2>
<p>Libra FPSC-AM62L 提供两个以太网接口。我们的核心板和底板各提供一个千兆以太网接口。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>The naming convention of the Ethernet interfaces in the hardware (ETH0
and ETH1) do not align with the network interfaces (end0 and end1) in
Linux. So, be aware of these differences:</p>
<div class="line-block">
<div class="line">ETH1 = end0</div>
<div class="line">ETH0 = end1</div>
</div>
</div>
<p>所有接口都提供一个标准的Linux网络端口，可以使用BSD套接字接口进行编程。整个网络配置由systemd-networkd守护进程管理。相关的配置文件可以在开发板的 <code class="docutils literal notranslate"><span class="pre">/lib/systemd/network/</span></code> 目录中找到，以及在BSP中的 <code class="docutils literal notranslate"><span class="pre">meta-ampliphy/recipes-core/systemd/systemd-conf</span></code> 目录中。</p>
<p>IP addresses can be configured within *.network files. The interfaces are
configured to static IP as default. The default IP address and netmask for end0
is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>end0: 192.168.3.11/24
</pre></div>
</div>
<p>To configure end0 to dynamic IP over DHCP, go to
<code class="code docutils literal notranslate"><span class="pre">/lib/systemd/network/\*-end0.network</span></code>
and delete the line:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Address=192.168.3.11/24
</pre></div>
</div>
<p>The DT Ethernet setup might be split into two files depending on your hardware
configuration: the module DT and the board-specific DT. The device tree set up
for the ethernet where the PHY is populated on the SoM can be found here:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L148">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L148</a>
`.</p>
<p>The device tree set up for EQOS Ethernet IP core where the PHY is populated
on the Libra FPSC can be found here:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L213">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L213</a>.</p>
<section id="network-environment-customization">
<h3><span class="section-number">7.3.1. </span>网络配置<a class="headerlink" href="#network-environment-customization" title="Link to this heading"></a></h3>
<section id="u-boot-network-environment">
<h4><span class="section-number">7.3.1.1. </span>U-boot网络环境<a class="headerlink" href="#u-boot-network-environment" title="Link to this heading"></a></h4>
<ul>
<li><p>要在bootloader中查找以太网设置：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; printenv ipaddr serverip netmask
</pre></div>
</div>
</li>
<li><p>在将主机设置为IP 192.168.3.10和子网掩码255.255.255.0的情况下，开发板应该返回：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; printenv ipaddr serverip netmask
ipaddr=192.168.3.11
serverip=192.168.3.10
netmask=255.225.255.0
</pre></div>
</div>
</li>
<li><p>如果您需要进行任何更改：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv &lt;parameter&gt; &lt;value&gt;
</pre></div>
</div>
<p>&lt;parameter&gt; 应该是 ipaddr、netmask、gatewayip 或 serverip 中的一个。&lt;value&gt; 将是所选参数的设定值。</p>
</li>
<li><p>您所做的更改目前是临时的。要保存这些更改：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; saveenv
</pre></div>
</div>
</li>
</ul>
<p>在这里，您也可以将IP地址更改为DHCP，而不是使用静态IP地址。</p>
<ul>
<li><p>配置：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv ip dhcp
</pre></div>
</div>
</li>
<li><p>设置 TFTP 和 NFS 的路径。修改可以如下所示：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv nfsroot /home/user/nfssrc
</pre></div>
</div>
</li>
</ul>
<p>请注意，这些修改只会影响bootloader的设置。</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>像nfsroot和netargs这样的变量可以被U-boot外部环境重新赋值。对于网络启动，外部环境将通过tftp加载。例如，要在 <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code> 文件中设置nfsroot变量，请在tftproot目录修改：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>nfsroot=/home/user/nfssrc
</pre></div>
</div>
<p>无需在开发板上存储这些信息。请注意，U-boot外部环境对于像 ipaddr 或 serveraddr 这样的变量不起作用，因为它们在加载外部环境之前已经被设置完成。</p>
</div>
<section id="secondary-ethernet-interface-configuration-in-u-boot">
<h5><span class="section-number">7.3.1.1.1. </span>Secondary Ethernet Interface Configuration in U-Boot<a class="headerlink" href="#secondary-ethernet-interface-configuration-in-u-boot" title="Link to this heading"></a></h5>
<p>By default, U-Boot utilizes the Ethernet PHY located on the module. To use the network connection
provided by the PHY on the carrier board, configuration changes are required.</p>
<p>To enable the secondary Ethernet interface in U-Boot, the active Ethernet connection must be
adjusted. The IP address configuration in U-Boot may also need modification.</p>
<p>Configure the development host with IP address 192.168.4.10 and netmask 255.255.255.0. The target
device must then be configured as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv ethact eth1
u-boot=&gt; setenv ipaddr 192.168.4.11
</pre></div>
</div>
</section>
</section>
<section id="kernel-network-environment">
<h4><span class="section-number">7.3.1.2. </span>内核网络环境<a class="headerlink" href="#kernel-network-environment" title="Link to this heading"></a></h4>
<ul>
<li><p>Find the ethernet settings for end0 in the target kernel:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>-statistics<span class="w"> </span>address<span class="w"> </span>show<span class="w"> </span>end0
<span class="go">2: end0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span>
<span class="go">    link/ether 50:2d:f4:19:d6:33 brd ff:ff:ff:ff:ff:ff</span>
<span class="go">    RX:  bytes packets errors dropped  missed   mcast</span>
<span class="go">             0       0      0       0       0       0</span>
<span class="go">    TX:  bytes packets errors dropped carrier collsns</span>
<span class="go">             0       0      0       0       0       0</span>
</pre></div>
</div>
</li>
<li><p>Temporary adaption of the end0 configuration:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>address<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.3.11/24<span class="w"> </span>dev<span class="w"> </span>end0
</pre></div>
</div>
</li>
</ul>
</section>
</section>
</section>
<section id="sd-card">
<h2><span class="section-number">7.4. </span>SD card<a class="headerlink" href="#sd-card" title="Link to this heading"></a></h2>
<p>The AM62L supports a slot for Secure Digital cards to be used as general-purpose
block devices. These devices can be used in the same way as any other block
device.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>这些设备是热插拔的。然而，您必须确保在设备仍然挂载时不要拔掉它。这可能会导致数据丢失！</p>
</div>
<p>After inserting an SD card, the kernel will generate new device nodes in /dev.
The full device can be reached via its /dev/mmcblk1 device node. SD card
partitions will show up as:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/dev/mmcblk1p&lt;Y&gt;
</pre></div>
</div>
<p>&lt;Y&gt; 作为分区编号，从1开始计数，直到该设备的最大分区数量。分区可以使用任何类型的文件系统进行格式化，并且可以以标准方式进行处理，例如，可以使用mount 和 umount 命令进行分区挂载和卸载。</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>这些分区设备节点要求SD卡包含有效的分区表（类似于“硬盘”）。如果没有分区表，则整个设备作为一个文件系统使用（类似于“软盘”）。在这种情况下，必须使用 /dev/mmcblk1 进行格式化和挂载。卡始终以可写方式挂载。</p>
</div>
<p>DT configuration for the MMC (SD card slot) interface can be found here:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L272">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L272</a>
and
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L355">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L355</a></p>
<p>DT configuration for the e.MMC interface can be found here:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L263">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L263</a></p>
</section>
<section id="e-mmc-devices">
<h2><span class="section-number">7.5. </span>e.MMC Devices<a class="headerlink" href="#e-mmc-devices" title="Link to this heading"></a></h2>
<p>PHYTEC modules like phyFLEX-AM62L FPSC are populated with an e.MMC memory chip as the
main storage. e.MMC devices contain raw Multi-Level Cells (MLC) or Triple-Level
Cells (TLC) combined with a memory controller that handles ECC and wear
leveling. They are connected via an SD/MMC interface to the AM62L and are
represented as block devices in the Linux kernel like SD cards, flash drives, or
hard disks.</p>
<p>The electric and protocol specifications are provided by JEDEC
(<a class="reference external" href="https://www.jedec.org/standards-documents/technology-focus-areas/flash-memory-ssds-ufs-emmc/e-mmc">https://www.jedec.org/standards-documents/technology-focus-areas/flash-memory-ssds-ufs-emmc/e-mmc</a>).
The e.MMC manufacturer's datasheet is relatively short and meant to be read
together with the supported version of the JEDEC e.MMC standard.</p>
<p>PHYTEC currently utilizes the e.MMC chips with JEDEC Version 5.0 and 5.1</p>
<section id="extended-csd-register">
<h3><span class="section-number">7.5.1. </span>扩展CSD寄存器<a class="headerlink" href="#extended-csd-register" title="Link to this heading"></a></h3>
<p>e.MMC devices have an extensive amount of extra information and settings that are
available via the Extended CSD registers. For a detailed list of the registers,
see manufacturer datasheets and the JEDEC standard.</p>
<p>在Linux用户空间中，您可以查询寄存器：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>extcsd<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
<p>你将会看到：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>=============================================
   Extended CSD rev 1.7 (MMC 5.0)
=============================================

 Card Supported Command sets [S_CMD_SET: 0x01]
 [...]
</pre></div>
</div>
</section>
<section id="enabling-background-operations-bkops">
<h3><span class="section-number">7.5.2. </span>使能后台操作 (BKOPS)<a class="headerlink" href="#enabling-background-operations-bkops" title="Link to this heading"></a></h3>
<p>In contrast to raw NAND Flash, an e.MMC device contains a Flash Transfer Layer
(FTL) that handles the wear leveling, block management, and ECC of the raw MLC
or TLC. This requires some maintenance tasks (for example erasing unused blocks)
that are performed regularly. These tasks are called <strong>Background Operations
(BKOPS)</strong>.</p>
<p>默认情况下（取决于芯片），后台操作可能会定期执行，也可能不会，他影响读写的最大延迟时间。</p>
<p>The JEDEC Standard has specified a method since version v4.41 that the host can
issue BKOPS manually. See the JEDEC Standard chapter Background Operations and
the description of registers BKOPS_EN (Reg: 163) and BKOPS_START (Reg: 164) in
the e.MMC datasheet for more details.</p>
<p>寄存器 BKOPS_EN（寄存器：163）的位 MANUAL_EN（位 0）的含义：</p>
<ul class="simple">
<li><p>值 0：主机不支持手动触发 BKOPS。设备写入性能会受到影响。</p></li>
<li><p>值1：主机支持手动触发BKOPS。当主机不进行设备读写时，它会不时触发BKOPS。</p></li>
</ul>
<p>The mechanism to issue background operations has been implemented in
the Linux kernel since v3.7. You only have to enable BKOPS_EN on the e.MMC
device (see below for details).</p>
<p>JEDEC标准v5.1引入了一种新的自动BKOPS功能。它使主机能够定期触发后台操作，因为设备在空闲时会自动启动BKOPS（请参见寄存器BKOPS_EN（寄存器：163）中位AUTO_EN的描述）。</p>
<ul>
<li><p>要检查 <em>BKOPS_EN</em> 是否已设置，请执行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>extcsd<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/mmcblk0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>BKOPS_EN
</pre></div>
</div>
<p>输出将会是，例如：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Enable background operations handshake [BKOPS_EN]: 0x01
#OR
Enable background operations handshake [BKOPS_EN]: 0x00
</pre></div>
</div>
<p>值0x00表示BKOPS_EN被禁用，设备的写入性能受到影响。值0x01表示BKOPS_EN被启用，主机将不时发起后台操作。</p>
</li>
<li><p>通过以下命令使能BKOPS_EN：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ target:~$ </span>mmc<span class="w"> </span>--help

<span class="go">[...]</span>
<span class="go">mmc bkops_en &lt;auto|manual&gt; &lt;device&gt;</span>
<span class="go">    Enable the eMMC BKOPS feature on &lt;device&gt;.</span>
<span class="go">    The auto (AUTO_EN) setting is only supported on eMMC 5.0 or newer.</span>
<span class="go">    Setting auto won&#39;t have any effect if manual is set.</span>
<span class="go">    NOTE!  Setting manual (MANUAL_EN) is one-time programmable (unreversible) change.</span>
</pre></div>
</div>
</li>
<li><p>要设置BKOPS_EN位，请执行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>bkops_en<span class="w"> </span>manual<span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
</li>
<li><p>为了确保新设置生效并且内核能够自动触发BKOPS，请先关闭系统：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>poweroff
</pre></div>
</div>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>BKOPS_EN位是一次性可编程的，无法恢复。</p>
</div>
</section>
<section id="reliable-write">
<h3><span class="section-number">7.5.3. </span>可靠写入<a class="headerlink" href="#reliable-write" title="Link to this heading"></a></h3>
<p>有两种不同的可靠写入选项：</p>
<ol class="arabic simple">
<li><p>Reliable Write option for a whole e.MMC device/partition.</p></li>
<li><p>单次写的可靠写入方式。</p></li>
</ol>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>Do not confuse e.MMC partitions with partitions of a DOS, MBR, or GPT
partition table (see the previous section).</p>
</div>
<p>The first Reliable Write option is mostly already enabled on the e.MMCs mounted
on the phyFLEX-AM62L FPSC SoMs. To check this on the running target:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>extcsd<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/mmcblk0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A<span class="w"> </span><span class="m">5</span><span class="w"> </span>WR_REL_SET
<span class="go">Write reliability setting register [WR_REL_SET]: 0x1f</span>
<span class="go"> user area: the device protects existing data if a power failure occurs during a write o</span>
<span class="go">peration</span>
<span class="go"> partition 1: the device protects existing data if a power failure occurs during a write</span>
<span class="go"> operation</span>
<span class="go"> partition 2: the device protects existing data if a power failure occurs during a write</span>
<span class="go"> operation</span>
<span class="go"> partition 3: the device protects existing data if a power failure occurs during a write</span>
<span class="go"> operation</span>
<span class="go"> partition 4: the device protects existing data if a power failure occurs during a write</span>
<span class="go"> operation</span>
<span class="go">--</span>
<span class="go"> Device supports writing EXT_CSD_WR_REL_SET</span>
<span class="go"> Device supports the enhanced def. of reliable write</span>
</pre></div>
</div>
<p>如果默认没有启用，可以使用mmc工具启用它：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>--help

<span class="go">[...]</span>
<span class="go">mmc write_reliability set &lt;-y|-n|-c&gt; &lt;partition&gt; &lt;device&gt;</span>
<span class="go">    Enable write reliability per partition for the &lt;device&gt;.</span>
<span class="go">    Dry-run only unless -y or -c is passed.</span>
<span class="go">    Use -c if more partitioning settings are still to come.</span>
<span class="go">    NOTE!  This is a one-time programmable (unreversible) change.</span>
</pre></div>
</div>
<p>第二个可靠写入方式是命令CMD23中的配置位Reliable Write Request parameter（可靠写入请求参数）（位31）。自内核版本v3.0起，文件系统（例如ext4的日志）和用户空间应用程序（如fdisk的分区表）会通过内核使用该可靠写功能。在Linux内核源代码中，它通过标志REQ_META进行处理。</p>
<p><strong>结论</strong>：使用挂载选项 data=journal 的 ext4 文件系统在断电情况下是安全的。文件系统检查可以在断电后恢复文件系统，但在断电前刚写入的数据可能会丢失。在各种情况下，都可以恢复文件系统的正常状态。为了确保应用程序文件的正常保存，应用程序中应使用系统函数 fdatasync 或 fsync。</p>
</section>
<section id="resizing-ext4-root-filesystem">
<h3><span class="section-number">7.5.4. </span>调整 ext4 根文件系统的大小<a class="headerlink" href="#resizing-ext4-root-filesystem" title="Link to this heading"></a></h3>
<p>When flashing the SD card image to e.MMC the ext4 root partition is not extended
to the end of the e.MMC. parted can be used to expand the root partition. The
example works for any block device such as e.MMC, SD card, or hard disk.</p>
<ul>
<li><p>获取当前设备大小：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>parted<span class="w"> </span>/dev/mmcblk0<span class="w"> </span>print
</pre></div>
</div>
</li>
<li><p>输出如下：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Model: MMC Q2J55L (sd/mmc)
Disk /dev/mmcblk0: 7617MB
Sect[ 1799.850385]  mmcblk0: p1 p2
or size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type     File system  Flags
 1      4194kB  72.4MB  68.2MB  primary  fat16        boot, lba
 2      72.4MB  537MB   465MB   primary  ext4
</pre></div>
</div>
</li>
<li><p>使用parted将文件系统分区调整为设备的最大大小：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>parted<span class="w"> </span>/dev/mmcblk0<span class="w"> </span>resizepart<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">100</span>%
<span class="go">Information: You may need to update /etc/fstab.</span>

<span class="gp">target:~$ </span>parted<span class="w"> </span>/dev/mmcblk0<span class="w"> </span>print
<span class="go">Model: MMC Q2J55L (sd/mmc)</span>
<span class="go">Disk /dev/mmcblk0: 7617MB</span>
<span class="go">Sector size (logical/physical): 512[ 1974.191657]  mmcblk0: p1 p2</span>
<span class="go">B/512B</span>
<span class="go">Partition Table: msdos</span>
<span class="go">Disk Flags:</span>

<span class="go">Number  Start   End     Size    Type     File system  Flags</span>
<span class="go"> 1      4194kB  72.4MB  68.2MB  primary  fat16        boot, lba</span>
<span class="go"> 2      72.4MB  7617MB  7545MB  primary  ext4</span>
</pre></div>
</div>
</li>
<li><p>将文件系统调整为新的分区大小：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>resize2fs<span class="w"> </span>/dev/mmcblk0p2
<span class="go">resize2fs 1.46.1 (9-Feb-2021)</span>
<span class="go">Filesystem at /dev/mmcblk0p2 is mounted on /; on-line resizing required</span>
<span class="go">[ 131.609512] EXT4-fs (mmcblk0p2): resizing filesystem</span>
<span class="go">from 454136 to 7367680 blocks</span>
<span class="go">old_desc_blocks = 4, new_desc_blocks = 57</span>
<span class="go">[ 131.970278] EXT4-fs (mmcblk0p2): resized filesystem to 7367680</span>
<span class="go">The filesystem on /dev/mmcblk0p2 is now 7367680 (1k) blocks long</span>
</pre></div>
</div>
</li>
</ul>
<p>Increasing the filesystem size can be done while it is mounted.  But you can
also boot the board from an SD card and then resize the file system on the e.MMC
partition while it is not mounted.</p>
</section>
<section id="enable-pseudo-slc-mode">
<h3><span class="section-number">7.5.5. </span>启用伪SLC模式<a class="headerlink" href="#enable-pseudo-slc-mode" title="Link to this heading"></a></h3>
<p>e.MMC devices use MLC or TLC
(<a class="reference external" href="https://en.wikipedia.org/wiki/Multi-level_cell">https://en.wikipedia.org/wiki/Multi-level_cell</a>) to store the data. Compared
with SLC used in NAND Flash, MLC or TLC have lower reliability and a higher
error rate at lower costs.</p>
<p>如果您更喜欢可靠性而不是存储容量，可以启用伪SLC模式或SLC模式。这个方法采用了增强属性，该属性在JEDEC标准中有所描述，可以对设备的一个连续区域设置。JEDEC标准并未规定增强属性的实现细节和保证，这由芯片制造商自行决定。对于美光（Micron）芯片，增强属性提高了可靠性，但也将容量减半。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>在设备上启用增强属性时，所有数据将被丢失。</p>
</div>
<p>以下步骤展示了如何启用增强属性。</p>
<ul>
<li><p>First obtain the current size of the e.MMC device with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>parted<span class="w"> </span>-m<span class="w"> </span>/dev/mmcblk0<span class="w"> </span>unit<span class="w"> </span>B<span class="w"> </span>print
</pre></div>
</div>
<p>你将收到：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>BYT;
/dev/mmcblk0:63652757504B:sd/mmc:512:512:unknown:MMC S0J58X:;
</pre></div>
</div>
<p>如您所见，该设备的容量为 63652757504 字节 = 60704 MiB。</p>
</li>
<li><p>要获取启用伪SLC模式后的设备的大小，请使用：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>extcsd<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/mmcblk0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ENH_SIZE_MULT<span class="w"> </span>-A<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<p>例如：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Max Enhanced Area Size [MAX_ENH_SIZE_MULT]: 0x000764
i.e. 3719168 KiB
--
Enhanced User Data Area Size [ENH_SIZE_MULT]: 0x000000
i.e. 0 KiB
</pre></div>
</div>
<p>这里的最大大小是3719168 KiB = 3632 MiB。</p>
</li>
<li><p>现在，您可以通过输入以下命令为整个设备设置增强属性，例如 3719168 KiB：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>enh_area<span class="w"> </span><span class="nb">set</span><span class="w"> </span>-y<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">3719168</span><span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
<p>你将获得：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Done setting ENH_USR area on /dev/mmcblk0
setting OTP PARTITION_SETTING_COMPLETED!
Setting OTP PARTITION_SETTING_COMPLETED on /dev/mmcblk0 SUCCESS
Device power cycle needed for settings to take effect.
Confirm that PARTITION_SETTING_COMPLETED bit is set using &#39;extcsd read&#39; after power cycle
</pre></div>
</div>
</li>
<li><p>为了确保新设置已生效，请关闭系统：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>poweroff
</pre></div>
</div>
<p>并进行上下电。建议您现在确认设置是否正确。</p>
</li>
<li><p>首先，检查ENH_SIZE_MULT的值，它必须是3719168 KiB：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>extcsd<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/mmcblk0<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ENH_SIZE_MULT<span class="w">  </span>-A<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<p>您应该看到：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Max Enhanced Area Size [MAX_ENH_SIZE_MULT]: 0x000764
i.e. 3719168 KiB
--
Enhanced User Data Area Size [ENH_SIZE_MULT]: 0x000764
i.e. 3719168 KiB
</pre></div>
</div>
</li>
<li><p>最后，检查设备的大小：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>parted<span class="w"> </span>-m<span class="w"> </span>/dev/mmcblk0<span class="w"> </span>unit<span class="w"> </span>B<span class="w"> </span>print
<span class="go">BYT;</span>
<span class="go">/dev/mmcblk0:31742492672B:sd/mmc:512:512:unknown:MMC S0J58X:;</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="erasing-the-device">
<h3><span class="section-number">7.5.6. </span>擦除设备<a class="headerlink" href="#erasing-the-device" title="Link to this heading"></a></h3>
<p>It is possible to erase the e.MMC device directly rather than overwriting it
with zeros. The e.MMC block management algorithm will erase the underlying MLC
or TLC or mark these blocks as discard. The data on the device is lost and will
be read back as zeros.</p>
<ul>
<li><p>After booting from SD card execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>blkdiscard<span class="w"> </span>-f<span class="w"> </span>--secure<span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
<p>选项 --secure 确保命令在 eMMC 设备擦除所有块之前会等待。-f (强制) 选项强制擦写，当 eMMC 设备包含有效数据分区时需要使用-f选项。</p>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/mmcblk0<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync
</pre></div>
</div>
<p>该命令也会擦除设备上的所有信息，但这个命令不利于设备的磨损均衡，并且需要花费更长的时间！</p>
</div>
</section>
<section id="e-mmc-boot-partitions">
<h3><span class="section-number">7.5.7. </span>e.MMC Boot Partitions<a class="headerlink" href="#e-mmc-boot-partitions" title="Link to this heading"></a></h3>
<p>An e.MMC device contains four different hardware partitions: user, boot1, boot2,
and rpmb.</p>
<p>The user partition is called the User Data Area in the JEDEC standard and is the
main storage partition. The partitions boot1 and boot2 can be used to host the
bootloader and are more reliable. Which partition the AM62L uses to load
the bootloader is controlled by the boot configuration of the e.MMC device. The
partition rpmb is a small partition and can only be accessed via a trusted
mechanism.</p>
<p>此外，User分区可以分为四个自定义的一般用途分区。对此功能的解释不在本文件涵盖的范围。有关更多信息，请参阅JEDEC标准第7.2章分区管理。</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>Do not confuse e.MMC partitions with partitions of a DOS, MBR, or GPT
partition table.</p>
</div>
<p>The current PHYTEC BSP does not use the extra partitioning feature of e.MMC
devices. The U-Boot is flashed at the beginning of the user partition.
The U-Boot environment is placed at a fixed location after the U-Boot. An MBR
partition table is used to create two partitions, a FAT32 boot, and ext4 rootfs
partition. They are located right after the U-Boot and the U-Boot environment.
The FAT32 boot partition contains the kernel and device tree.</p>
<p>With e.MMC flash storage it is possible to use the dedicated boot partitions for
redundantly storing the bootloader. The Bootloader environment still resides in
the user area before the first partition. The user area also still contains the
bootloader which the image first shipped during its initialization process.
Below is an example, to flash the bootloader to one of the two boot partitions
and switch the boot device via userspace commands.</p>
<section id="via-userspace-commands">
<h4><span class="section-number">7.5.7.1. </span>通过用户空间命令<a class="headerlink" href="#via-userspace-commands" title="Link to this heading"></a></h4>
<p>在主机上运行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>scp<span class="w"> </span>&lt;bootloader&gt;<span class="w"> </span>root@192.168.3.11:/tmp/
</pre></div>
</div>
<p>The partitions boot1 and boot2 are read-only by default. To write to them from
user space, you have to disable <code class="docutils literal notranslate"><span class="pre">force_ro</span></code> in the sysfs.</p>
<p>To manually write the bootloader to the e.MMC boot partitions, first disable the
write protection:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/block/mmcblk0boot0/force_ro
<span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/block/mmcblk0boot1/force_ro
</pre></div>
</div>
<p>Write the bootloader to the e.MMC boot partitions:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/tmp/&lt;bootloader&gt;<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/mmcblk0boot0
<span class="gp">target:~$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/tmp/&lt;bootloader&gt;<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/mmcblk0boot1
</pre></div>
</div>
<p>下表是 AM62L SoC的偏移量：</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>SoC</p></th>
<th class="head"><p>User分区偏移量</p></th>
<th class="head"><p>Boot分区偏移量</p></th>
<th class="head"><p>e.MMC Device</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>AM62L</p></td>
<td><p>32 kiB</p></td>
<td><p>0 kiB</p></td>
<td><p>/dev/mmcblk0</p></td>
</tr>
</tbody>
</table>
<p>After that set the boot partition from user space using the <code class="docutils literal notranslate"><span class="pre">mmc</span></code> tool:</p>
<p>(对于 'boot0') :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>bootpart<span class="w"> </span><span class="nb">enable</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
<p>(对于'boot1')：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>bootpart<span class="w"> </span><span class="nb">enable</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
<p id="emmc-disable-boot-part">To disable booting from the e.MMC boot partitions simply enter the following
command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>bootpart<span class="w"> </span><span class="nb">enable</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
<p>To explicitly enable booting from the e.MMC user area, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>bootpart<span class="w"> </span><span class="nb">enable</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>/dev/mmcblk0
</pre></div>
</div>
</section>
<section id="automatic-failover">
<h4><span class="section-number">7.5.7.2. </span>Automatic failover<a class="headerlink" href="#automatic-failover" title="Link to this heading"></a></h4>
<p>The ROM loader implements an automatic failover mechanism for e.MMC boot partitions. If booting
from the primary partition fails, the system automatically attempts to boot from the secondary
partition. This failover is indicated by a change in the boot message from
<code class="docutils literal notranslate"><span class="pre">Boot</span> <span class="pre">Stage:</span> <span class="pre">Primary</span> <span class="pre">boot</span></code> to <code class="docutils literal notranslate"><span class="pre">Boot</span> <span class="pre">Stage:</span> <span class="pre">Secondary</span> <span class="pre">boot</span></code>.
This functionality is limited to boot0 and boot1 partitions and does not apply to the user area.</p>
</section>
</section>
</section>
<section id="spi-master">
<h2><span class="section-number">7.6. </span>SPI主设备<a class="headerlink" href="#spi-master" title="Link to this heading"></a></h2>
<p>The AM62L controller has MCSPI and an OSPI controllers included. The MCSPI
controller supports four SPI channels with each up to 4 devices. The OSPI
controllers supports Single/Dual/Quad/Octal mode data transfer (1/2/4/8
bidirectional data lines).</p>
<section id="spi-nor-flash">
<h3><span class="section-number">7.6.1. </span>SPI NOR 烧写<a class="headerlink" href="#spi-nor-flash" title="Link to this heading"></a></h3>
<p>Libra FPSC is equipped with a QSPI NOR Flash which connects to the AM62L's
OSPI interface.</p>
<p>From Linux userspace, the NOR Flash partitions are
accessible via /dev/mtd&lt;N&gt; devices where &lt;N&gt; is the MTD device number associated
with the NOR flash partition to access. To find the correct MTD device number
for a partition, run on the target:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@am62lxx-libra-fpsc-1:~$ </span>mtdinfo<span class="w"> </span>--all
<span class="go">Count of MTD devices:           5</span>
<span class="go">Present MTD devices:            mtd0, mtd1, mtd2, mtd3, mtd4</span>
<span class="go">Sysfs interface supported:      yes</span>

<span class="go">mtd0</span>
<span class="go">Name:                           ospi.tiboot3</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                131072 bytes, 128.0 KiB</span>
<span class="go">Amount of eraseblocks:          4 (524288 bytes, 512.0 KiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:0</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>

<span class="go">mtd1</span>
<span class="go">Name:                           ospi.tispl</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                131072 bytes, 128.0 KiB</span>
<span class="go">Amount of eraseblocks:          16 (2097152 bytes, 2.0 MiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:2</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>

<span class="go">mtd2</span>
<span class="go">Name:                           ospi.u-boot</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                131072 bytes, 128.0 KiB</span>
<span class="go">Amount of eraseblocks:          32 (4194304 bytes, 4.0 MiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:4</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>

<span class="go">mtd3</span>
<span class="go">Name:                           ospi.env</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                131072 bytes, 128.0 KiB</span>
<span class="go">Amount of eraseblocks:          2 (262144 bytes, 256.0 KiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:6</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>

<span class="go">mtd4</span>
<span class="go">Name:                           ospi.env.backup</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                131072 bytes, 128.0 KiB</span>
<span class="go">Amount of eraseblocks:          2 (262144 bytes, 256.0 KiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:8</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>
</pre></div>
</div>
<p>它列出了所有MTD设备及其对应的分区名称。闪存节点在模块DTS中的SPI主节点内定义。SPI节点包含连接到此SPI总线的所有设备，在这种情况下只有SPI NOR Flash。</p>
<p>设备树中SPI主节点的定义可以在这里找到：</p>
<p><a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L335">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L335</a></p>
</section>
</section>
<section id="gpios">
<h2><span class="section-number">7.7. </span>GPIOs<a class="headerlink" href="#gpios" title="Link to this heading"></a></h2>
<p>The Libra FPSC has a set of pins especially dedicated to user I/Os. Those pins are
connected directly to AM62L pins and are muxed as GPIOs. They are directly
usable in Linux userspace. The processor has organized its GPIOs into nine banks
of 16 GPIOs each (up to 144 GPIOs). However, not all GPIOs are pinned out on the
Libra FPSC board.</p>
<p>In Linux, the internal GPIO module is exposed as a single GPIO controller,
represented by gpiochip0. This controller provides access to all available GPIOs
on the device. On the Libra FPSC, this corresponds to 126 GPIO lines in total.</p>
<p>从用户空间访问GPIO将使用libgpiod。它提供了一个库和工具，用于与Linux GPIO字符设备进行交互。以下是一些工具的用法示例：</p>
<ul>
<li><p>检测芯片上的gpiochips：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gpiodetect
<span class="go">gpiochip0 [600000.gpio] (126 lines)</span>
</pre></div>
</div>
</li>
<li><p>GPIO expander</p>
<p>Beside the GPIOs of the AM62L SoC, the Libra FPSC has a GPIO expander, which adds
more GPIOs to the system.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">gpiochip2 [4-0020] (16 lines)</span>
</pre></div>
</div>
<p>DT configuration for the GPIO expander can be found here:</p>
<p><a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L274">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L274</a></p>
</li>
</ul>
<ul>
<li><p>显示关于gpiochips的详细信息，包括它们的名称、consumer、方向、活动状态和附加flag：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gpioinfo<span class="w"> </span>-c<span class="w"> </span>gpiochip0
</pre></div>
</div>
</li>
<li><p>读取GPIO的值（例如从gpiochip0的GPIO 20）：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gpioget<span class="w"> </span>-c<span class="w"> </span>gpiochip0<span class="w"> </span><span class="m">20</span>
</pre></div>
</div>
</li>
<li><p>将gpiochip0上的GPIO 20的值设置为0并退出工具：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gpioset<span class="w"> </span>-z<span class="w"> </span>-c<span class="w"> </span>gpiochip0<span class="w"> </span><span class="nv">20</span><span class="o">=</span><span class="m">0</span>
</pre></div>
</div>
</li>
<li><p>gpioset的帮助文本显示了可能的选项：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gpioset<span class="w"> </span>--help
<span class="go">Usage: gpioset [OPTIONS] &lt;line=value&gt;...</span>

<span class="go">Set values of GPIO lines.</span>

<span class="go">Lines are specified by name, or optionally by offset if the chip option</span>
<span class="go">is provided.</span>
<span class="go">Values may be &#39;1&#39; or &#39;0&#39;, or equivalently &#39;active&#39;/&#39;inactive&#39; or &#39;on&#39;/&#39;off&#39;.</span>

<span class="go">The line output state is maintained until the process exits, but after that</span>
<span class="go">is not guaranteed.</span>

<span class="go">Options:</span>
<span class="go">      --banner            display a banner on successful startup</span>
<span class="go">  -b, --bias &lt;bias&gt;       specify the line bias</span>
<span class="go">                  Possible values: &#39;pull-down&#39;, &#39;pull-up&#39;, &#39;disabled&#39;.</span>
<span class="go">                  (default is to leave bias unchanged)</span>
<span class="go">      --by-name           treat lines as names even if they would parse as an offset</span>
<span class="go">  -c, --chip &lt;chip&gt;       restrict scope to a particular chip</span>
<span class="go">  -C, --consumer &lt;name&gt;   consumer name applied to requested lines (default is &#39;gpioset&#39;)</span>
<span class="go">  -d, --drive &lt;drive&gt;     specify the line drive mode</span>
<span class="go">                  Possible values: &#39;push-pull&#39;, &#39;open-drain&#39;, &#39;open-source&#39;.</span>
<span class="go">                  (default is &#39;push-pull&#39;)</span>
<span class="go">  -h, --help              display this help and exit</span>
<span class="go">  -l, --active-low        treat the line as active low</span>
<span class="go">  -p, --hold-period &lt;period&gt;</span>
<span class="go">                  the minimum time period to hold lines at the requested values</span>
<span class="go">  -s, --strict            abort if requested line names are not unique</span>
<span class="go">  -t, --toggle &lt;period&gt;[,period]...</span>
<span class="go">                  toggle the line(s) after the specified period(s)</span>
<span class="go">                  If the last period is non-zero then the sequence repeats.</span>
<span class="go">      --unquoted  don&#39;t quote line names</span>
<span class="go">  -v, --version           output version information and exit</span>
<span class="go">  -z, --daemonize set values then detach from the controlling terminal</span>

<span class="go">Chips:</span>
<span class="go">    A GPIO chip may be identified by number, name, or path.</span>
<span class="go">    e.g. &#39;0&#39;, &#39;gpiochip0&#39;, and &#39;/dev/gpiochip0&#39; all refer to the same chip.</span>

<span class="go">Periods:</span>
<span class="go">    Periods are taken as milliseconds unless units are specified. e.g. 10us.</span>
<span class="go">    Supported units are &#39;s&#39;, &#39;ms&#39;, and &#39;us&#39;.</span>

<span class="go">*Note*</span>
<span class="go">    The state of a GPIO line controlled over the character device reverts to default</span>
<span class="go">    when the last process referencing the file descriptor representing the device file exits.</span>
<span class="go">    This means that it&#39;s wrong to run gpioset, have it exit and expect the line to continue</span>
<span class="go">    being driven high or low. It may happen if given pin is floating but it must be interpreted</span>
<span class="go">    as undefined behavior.</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>某些GPIO用于特殊功能。在使用某个GPIO之前，请参考您板子的原理图或硬件手册，以确保该IO未被其他功能占用。</p>
</div>
<section id="gpios-via-sysfs">
<h3><span class="section-number">7.7.1. </span>通过sysfs访问GPIO<a class="headerlink" href="#gpios-via-sysfs" title="Link to this heading"></a></h3>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>通过sysfs访问GPIO已经过时了，我们建议使用libgpiod。</p>
</div>
<p>默认情况下不再支持通过sysfs访问GPIO。只有手动在内核配置中启用 <code class="docutils literal notranslate"><span class="pre">CONFIG_GPIO_SYSFS</span></code> 后才能支持。要在menuconfig中使 <code class="docutils literal notranslate"><span class="pre">CONFIG_GPIO_SYSFS</span></code> 可见，必须首先启用选项 <code class="docutils literal notranslate"><span class="pre">CONFIG_EXPERT</span></code> 。</p>
<p>You can also add this option for example to the defconfig you use in
<code class="docutils literal notranslate"><span class="pre">arch/arm64/configs/</span></code> in the linux kernel sources. For our TI based releases,
this could be for example phytec_ti_defconfig:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>..
CONFIG_EXPERT=y
CONFIG_GPIO_SYSFS=y
..
</pre></div>
</div>
<p>您也可以创建一个新的config片段。有关详细信息，请参阅我们的 <a class="reference internal" href="../../../yocto/scarthgap.html#yocto-man-scarthgap-kernel-and-bootloader-conf"><span class="std std-ref">Yocto Reference Manual</span></a>。</p>
</section>
</section>
<section id="adc">
<h2><span class="section-number">7.8. </span>ADC<a class="headerlink" href="#adc" title="Link to this heading"></a></h2>
<p>The PHYTEC phyFLEX-AM62L FPSC includes general purpose Analog-to-Digital Converters (ADC) which
can be used for interfacing analog sensors.</p>
<p>通过sysfs可以读取ADC值：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/bus/iio/devices/iio:deviceX/in_voltageY_raw
</pre></div>
</div>
<p>On Libra FPSC the ADC lines are accessible on X73 expansion connector:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ADC输入</p></th>
<th class="head"><p>X73 pin</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ADC_IN0</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-odd"><td><p>ADC_IN1</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-even"><td><p>ADC_IN2</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-odd"><td><p>ADC_IN3</p></td>
<td><p>9</p></td>
</tr>
<tr class="row-even"><td><p>ADC_IN4</p></td>
<td><p>4</p></td>
</tr>
<tr class="row-odd"><td><p>ADC_IN5</p></td>
<td><p>6</p></td>
</tr>
<tr class="row-even"><td><p>ADC_IN6</p></td>
<td><p>8</p></td>
</tr>
<tr class="row-odd"><td><p>ADC_IN7</p></td>
<td><p>10</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>On AM62L, only ADC_IN0 to ADC_IN3 are available for use. ADC_IN4 to ADC_IN7
are not connected internally. This limitation also applies to the
current/voltage sensing functionality.</p>
</div>
<p>Additionally, there is a current and voltage sensing circuitry available on Libra FPSC.
It is capable of measuring the input current consumption and supply voltage of
the phyFLEX-AM62L FPSC SoM, as well as the Libra FPSC carrier board's 1.8V, 3.3V and 5V power rails.</p>
<p>The current-sensing circuitry uses four INA241A4QDDFRQ1 current-sense amplifiers
(gain: 100 V/V), each paired with a 4 mΩ shunt resistor. Their outputs feed the
ADC input channels (Vref = 1.8 V) through a 1:3 voltage divider. With this
configuration, the resulting current resolution is 3.295898 mA/LSB.</p>
<p>The voltage-sensing circuitry uses simple 1:3.46 voltage dividers connected to
the ADC input channels (Vref = 1.8 V). This yields a voltage resolution of
1.520508 mV/LSB.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Channel Function</p></th>
<th class="head"><p>ADC Input</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SoM current sensing</p></td>
<td><p>ADC_IN0</p></td>
</tr>
<tr class="row-odd"><td><p>SoM voltage sensing</p></td>
<td><p>ADC_IN1</p></td>
</tr>
<tr class="row-even"><td><p>Carrier board 5V rail current sensing</p></td>
<td><p>ADC_IN2</p></td>
</tr>
<tr class="row-odd"><td><p>Carrier board 5V rail voltage sensing</p></td>
<td><p>ADC_IN3</p></td>
</tr>
<tr class="row-even"><td><p>Carrier board 3.3V rail current sensing</p></td>
<td><p>ADC_IN4</p></td>
</tr>
<tr class="row-odd"><td><p>Carrier board 3.3V rail voltage sensing</p></td>
<td><p>ADC_IN5</p></td>
</tr>
<tr class="row-even"><td><p>Carrier board 1.8V rail current sensing</p></td>
<td><p>ADC_IN6</p></td>
</tr>
<tr class="row-odd"><td><p>Carrier board 1.8V rail voltage sensing</p></td>
<td><p>ADC_IN7</p></td>
</tr>
</tbody>
</table>
<p>Current scaling factor is available as a sysfs parameter
<code class="docutils literal notranslate"><span class="pre">/sys/bus/iio/devices/iio:device1/in_current0_scale</span></code>.</p>
<p>The phyFLEX-AM62L FPSC SoM consumption can thus be measured with this simple script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="nv">RAW</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span>/sys/bus/iio/devices/iio:device1/in_current0_raw<span class="k">)</span>
<span class="nv">SCALE</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span>/sys/bus/iio/devices/iio:device1/in_current0_scale<span class="k">)</span>
<span class="nv">CURRENT</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$RAW</span><span class="s2"> * </span><span class="nv">$SCALE</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span>-l<span class="k">)</span>
<span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;Current: %.3f mA\n&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENT</span><span class="s2">&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Current scaling factor calculation depends on <code class="docutils literal notranslate"><span class="pre">CONFIG_IIO_RESCALE=y</span></code> kernel configuration.</p>
</div>
<p>In our BSP we also enable config option <code class="docutils literal notranslate"><span class="pre">CONFIG_SENSORS_IIO_HWMON=y</span></code> which provides
hwmon interface to conveniently measure phyFLEX-AM62L FPSC SoM consumption directly via the sysfs
parameter:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>root@<span class="p">|</span>yocto-machinename<span class="p">|</span>:~$<span class="w"> </span>cat<span class="w"> </span>/sys/class/hwmon/hwmon1/curr1_input
<span class="m">415</span>
</pre></div>
</div>
<p>In the example output provided above, the current consumption measured was 415 mA &#64; 5V.</p>
</section>
<section id="leds">
<h2><span class="section-number">7.9. </span>LED灯<a class="headerlink" href="#leds" title="Link to this heading"></a></h2>
<p>如果有任何LED灯连接到GPIO管脚，您可以通过特定的LED驱动程序接口访问它们，而不是使用通用的GPIO接口（请参见GPIO部分）。您将通过 <code class="docutils literal notranslate"><span class="pre">/sys/class/leds/</span></code> 而不是 <code class="docutils literal notranslate"><span class="pre">/sys/class/gpio/</span></code> 来访问它们。LED的最大亮度可以从 <code class="docutils literal notranslate"><span class="pre">max_brightness</span></code> 文件中读取。brightness文件将设置LED的亮度（取值范围从0到max_brightness）。大多数LED硬件上不支持调整亮度，所以在所有非零亮度下都会点亮。</p>
<p>下面是一个简单的例子。</p>
<p>要获取所有可用的LED，请输入：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ls<span class="w"> </span>/sys/class/leds
<span class="go">led-1@  led-2@  led-3@  mmc1::@  mmc2::@</span>
</pre></div>
</div>
<p>The Libra FPSC provides the following LED indicators: led-1, led-2 and led-3.</p>
<ul>
<li><p>打开LED灯：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">255</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/leds/led-1/brightness
</pre></div>
</div>
</li>
<li><p>关闭LED：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/leds/led-1/brightness
</pre></div>
</div>
</li>
</ul>
<p>Device tree configuration for the User I/O configuration can be found here:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L251">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L251</a></p>
</section>
<section id="i2c-bus">
<h2><span class="section-number">7.10. </span>I²C总线<a class="headerlink" href="#i2c-bus" title="Link to this heading"></a></h2>
<p>该 AM62L 包含多个多主支持快速模式的 I²C模块。PHYTEC板提供了许多不同的I²C设备，这些设备连接到 AM62L 的I²C模块。 本节描述了我们 Libra FPSC 中集成的一些I²C设备的基本设备使用及其设备树（DT）表示。</p>
<p>i2c的设备树节点包含一些设置，例如时钟频率，用于设置总线频率，以及引脚控制设置，包括scl-gpios和sda-gpios，这些是用于总线恢复的备用引脚配置。</p>
<p>General I²C bus configuration from SoM (e.g. k3-am62l-phyflex-fpsc.dtsi):
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L172">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L172</a></p>
<p>General I²C bus configuration from carrierboard (e.g. k3-am62l3-libra-rdk-fpsc.dts)
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L233">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L233</a></p>
</section>
<section id="eeprom">
<h2><span class="section-number">7.11. </span>EEPROM<a class="headerlink" href="#eeprom" title="Link to this heading"></a></h2>
<p>The system features two I2C EEPROM devices distributed across the SoM and
carrier board:</p>
<p>On the phyFLEX-AM62L FPSC SoM:</p>
<ul class="simple">
<li><p>Board Detection EEPROM</p>
<ul>
<li><p>Bus: I2C-1</p></li>
<li><p>Address: 0x50</p></li>
<li><p>Purpose: Factory configuration for board identification</p></li>
</ul>
</li>
</ul>
<p>Device Tree Reference for SoM EEPROMs:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L249">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L249</a></p>
<p>And on the Libra FPSC carrier board:</p>
<ul class="simple">
<li><p>Board Detection EEPROM</p>
<ul>
<li><p>Bus: I2C-2</p></li>
<li><p>Address: 0x51</p></li>
<li><p>Purpose: Reserved for carrier board identification</p></li>
</ul>
</li>
</ul>
<p>Device Tree Reference for Carrier Board:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L238">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L238</a></p>
<section id="i2c-eeprom-access">
<h3><span class="section-number">7.11.1. </span>I2C EEPROM access<a class="headerlink" href="#i2c-eeprom-access" title="Link to this heading"></a></h3>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>The first 1024 (0x400) bytes of
the EEPROM area (bus: I2C-1 addr: 0x50)
should not be erased or overwritten. As this will influence the behavior of
the bootloader. The board might not boot correctly anymore.</p>
</div>
<section id="eeprom-reading-and-writing-in-u-boot">
<h4><span class="section-number">7.11.1.1. </span>EEPROM reading and writing in U-Boot<a class="headerlink" href="#eeprom-reading-and-writing-in-u-boot" title="Link to this heading"></a></h4>
<p>In U-Boot the <code class="docutils literal notranslate"><span class="pre">i2c</span></code> command can be used for EEPROM read and write operations.</p>
<p>First set the correct I2C bus, where the EEPROM is connected.
<cite>&lt;bus-no&gt;</cite> is the I2C bus number of the EEPROM.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; i2c dev &lt;bus-no&gt;</span>
</pre></div>
</div>
<p>To read and print the first 32 bytes from EEPROM execute.
<cite>&lt;addr&gt;</cite> is the I2C address of the EEPROM.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; i2c md &lt;addr&gt; 0x00 0x20</span>
</pre></div>
</div>
<p>To read the first 32 bytes from EEPROM into memory (loadaddr) execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; i2c read &lt;addr&gt; 0x00 0x20 $loadaddr</span>
</pre></div>
</div>
<p>To write 0xff to the 32 bytes at offset 0x100 execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; i2c mw &lt;addr&gt; 0x100 0xff 0x20</span>
</pre></div>
</div>
<p>To write 32 bytes to offset 0x100 to EEPROM from memory (loadaddr) execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; i2c write $loadaddr &lt;addr&gt; 0x100 0x20</span>
</pre></div>
</div>
</section>
<section id="eeprom-reading-and-writing-in-linux">
<h4><span class="section-number">7.11.1.2. </span>EEPROM reading and writing in Linux<a class="headerlink" href="#eeprom-reading-and-writing-in-linux" title="Link to this heading"></a></h4>
<p>Reading and writing can also be done via sysfs in Linux. For this, find the
correct path in sysfs first. It follows this logic:
/sys/class/i2c-dev/i2c-&lt;bus-no&gt;/device/&lt;bus-no&gt;-&lt;addr&gt;/eeprom
<cite>&lt;bus-no&gt;</cite> is the bus number of the EEPROM
<cite>&lt;addr&gt;</cite> is the address of the EEPROM in 4 digits hex.</p>
<p>To read and print the EEPROM content as a hex number, execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hexdump<span class="w"> </span>-C<span class="w"> </span>&lt;eeprom-sysfs-path&gt;
</pre></div>
</div>
<p>or:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>&lt;eeprom-sysfs-path&gt;<span class="w"> </span><span class="p">|</span><span class="w"> </span>od<span class="w"> </span>-x
</pre></div>
</div>
<p>To fill the EEPROM with zeros leaving out the EEPROM data use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>&lt;eeprom-sysfs-path&gt;<span class="w"> </span><span class="nv">seek</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">256</span>
</pre></div>
</div>
</section>
</section>
<section id="eeprom-som-detection">
<h3><span class="section-number">7.11.2. </span>EEPROM SoM 检测<a class="headerlink" href="#eeprom-som-detection" title="Link to this heading"></a></h3>
<p>The I2C EEPROM, populated on the phyFLEX-AM62L FPSC, is addressable over I2C address
0x50 on bus 1. PHYTEC uses this 32 byte data
area to store information about the SoM. This includes PCB revision and mounting
options.</p>
<p>The EEPROM data is read at a very early stage during startup. It is used to
select the correct RAM configuration. This makes it possible to use the same
bootloader image for different RAM sizes and choose the correct DTS overlays
automatically.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>The first 1024 (0x400) bytes of
the EEPROM area (bus: I2C-1 addr: 0x50)
should not be erased or overwritten. As this will influence the behavior of
the bootloader. The board might not boot correctly anymore.</p>
</div>
<p>使用API修订版2数据格式烧写的核心板将在早期启动阶段打印出有关模块的信息。</p>
</section>
<section id="rescue-eeprom-data">
<h3><span class="section-number">7.11.3. </span>恢复EEPROM数据<a class="headerlink" href="#rescue-eeprom-data" title="Link to this heading"></a></h3>
<p>The hardware introspection data is pre-programmed on the EEPROM data spaces. If
you accidentally delete or overwrite this data, please contact our support team.</p>
</section>
</section>
<section id="rtc">
<h2><span class="section-number">7.12. </span>RTC<a class="headerlink" href="#rtc" title="Link to this heading"></a></h2>
<p>RTC可以通过 <code class="docutils literal notranslate"><span class="pre">/dev/rtc*</span></code> 访问。由于PHYTEC板通常有多个RTC，因此可能会有多个RTC设备文件。</p>
<ul>
<li><p>要找到RTC设备的名称，可以通过以下方式读取其sysfs条目：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/class/rtc/rtc*/name
</pre></div>
</div>
</li>
<li><p>例如，你将得到：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rtc-rv3028 0-0052
snvs_rtc 30370000.snvs:snvs-rtc-lp
</pre></div>
</div>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>这将列出所有实时时钟（RTC），包括非I²C接口的RTC。如果存在设备树/aliases条目，Linux会根据这些条目分配RTC设备ID。</p>
</div>
<p>日期和时间可以通过 <code class="docutils literal notranslate"><span class="pre">hwclock</span></code> 工具和date命令进行操作。要显示目标上设置的当前日期和时间：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>date
<span class="go">Thu Jan  1 00:01:26 UTC 1970</span>
</pre></div>
</div>
<p>使用日期命令更改日期和时间。日期命令以以下语法设置时间：&quot;YYYY-MM-DD hh:mm:ss (+|-)hh:mm&quot;：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>date<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;2022-03-02 11:15:00 +0100&quot;</span>
<span class="go">Wed Mar  2 10:15:00 UTC 2022</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>您的时区（在此示例中为 +0100）可能会有所不同。</p>
</div>
<p>使用date命令并不会改变实时时钟（RTC）的时间和日期，因此如果我们重启开发板，这些更改将会被丢弃。要写入RTC，我们需要使用 <code class="docutils literal notranslate"><span class="pre">hwclock</span></code> 命令。使用 <code class="docutils literal notranslate"><span class="pre">hwclock</span></code> 工具将当前的日期和时间（通过date命令设置）写入RTC，然后重启开发板以检查更改是否已应用到RTC上：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hwclock<span class="w"> </span>-w
<span class="gp">target:~$ </span>reboot
<span class="go">    .</span>
<span class="go">    .</span>
<span class="go">    .</span>
<span class="gp">target:~$ </span>date
<span class="go">Wed Mar  2 10:34:06 UTC 2022</span>
</pre></div>
</div>
<p>要从实时时钟（RTC）设置系统时间和日期，请使用：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>date
<span class="go">Thu Jan  1 01:00:02 UTC 1970</span>
<span class="gp">target:~$ </span>hwclock<span class="w"> </span>-s
<span class="gp">target:~$ </span>date
<span class="go">Wed Mar  2 10:45:01 UTC 2022</span>
</pre></div>
</div>
<section id="rtc-wakealarm">
<h3><span class="section-number">7.12.1. </span>RTC唤醒alarm<a class="headerlink" href="#rtc-wakealarm" title="Link to this heading"></a></h3>
<p>可以从实时时钟（RTC）发出中断以唤醒系统。该格式使用Unix纪元时间，即自1970年1月1日UTC午夜以来的秒数。要在从挂起到RAM状态后的4分钟唤醒系统，请输入：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;+240&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/rtc/rtc0/wakealarm
<span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span>mem<span class="w"> </span>&gt;<span class="w"> </span>/sys/power/state
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>内部唤醒alarm时间将被向上舍入到下一个分钟，因为alarm功能不支持秒。</p>
</div>
</section>
<section id="rtc-parameters">
<h3><span class="section-number">7.12.2. </span>RTC参数<a class="headerlink" href="#rtc-parameters" title="Link to this heading"></a></h3>
<p>实时时钟（RTC）具有一些功能，可以通过 <code class="docutils literal notranslate"><span class="pre">hwclock</span></code> 工具进行读取和设置。</p>
<ul>
<li><p>我们可以通过以下方式检查RTC支持的功能：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hwclock<span class="w"> </span>--param-get<span class="w"> </span>features
<span class="go">The RTC parameter 0x0 is set to 0x71.</span>
</pre></div>
</div>
<p>这个值的含义在内核中进行了编码，每个位的定义为：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#define RTC_FEATURE_ALARM               0
#define RTC_FEATURE_ALARM_RES_MINUTE    1
#define RTC_FEATURE_NEED_WEEK_DAY       2
#define RTC_FEATURE_ALARM_RES_2S        3
#define RTC_FEATURE_UPDATE_INTERRUPT    4
#define RTC_FEATURE_CORRECTION          5
#define RTC_FEATURE_BACKUP_SWITCH_MODE  6
#define RTC_FEATURE_ALARM_WAKEUP_ONLY   7
#define RTC_FEATURE_CNT                 8
</pre></div>
</div>
</li>
<li><p>我们可以通过以下方式检查RTC BSM（Backup Switchover Mode 备份切换模式）：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hwclock<span class="w"> </span>--param-get<span class="w"> </span>bsm
<span class="go">The RTC parameter 0x2 is set to 0x1.</span>
</pre></div>
</div>
</li>
<li><p>我们可以通过以下方式设置RTC BSM：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hwclock<span class="w"> </span>--param-set<span class="w"> </span><span class="nv">bsm</span><span class="o">=</span>0x2
<span class="go">The RTC parameter 0x2 will be set to 0x2.</span>
</pre></div>
</div>
<p>BSM位的定义为：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#define RTC_BSM_DISABLED   0
#define RTC_BSM_DIRECT     1
#define RTC_BSM_LEVEL      2
#define RTC_BSM_STANDBY    3
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>您应该将BSM模式设置为DSM或LSM，以便在初始电源不可用时，RTC可以切换到备用电源。请查看 <strong>RV-3028</strong> RTC的Datasheet，以了解LSM（电平切换模式）和DSM（直接切换模式）这两个定义的工作模式。</p>
</div>
</li>
</ul>
<p>DT representation for I²C RTCs:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L257">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l-phycore-fpsc.dtsi#L257</a></p>
<p>And the addions on the carrierboard:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L228">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L228</a></p>
</section>
</section>
<section id="usb-host-controller">
<h2><span class="section-number">7.13. </span>USB主控制器<a class="headerlink" href="#usb-host-controller" title="Link to this heading"></a></h2>
<p>The USB controller of the AM62L SoC provides a low-cost connectivity solution
for numerous consumer portable devices by providing a mechanism for data
transfer between USB devices with a line/bus speed of up to 480 Mbit/s (High-Speed
'HS'). The USB subsystem has two independent USB controller cores. Both cores
are capable of acting as a USB peripheral device or a USB host. Each is
connected to a USB 2.0 PHY.</p>
<p>BSP支持大容量存储设备（优盘）和键盘。其他与USB相关的设备驱动程序必须根据需要在内核配置中启用。由于udev，所有连接的存储设备都会获得唯一的ID，并可以在 <code class="docutils literal notranslate"><span class="pre">/dev/disk/by-id</span></code> 中找到。这些ID可以在 <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> 中用于以不同的方式挂载不同的USB存储设备。</p>
<p>DT representation for USB Host:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L382">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L382</a></p>
</section>
<section id="can-fd">
<h2><span class="section-number">7.14. </span>CAN FD<a class="headerlink" href="#can-fd" title="Link to this heading"></a></h2>
<p>The Libra FPSC has two CAN interfaces supporting CAN FD. They are supported by the
Linux standard CAN framework which builds upon then the Linux network layer.
Using this framework, the CAN interfaces behave like an ordinary Linux network
device, with some additional features special to CAN. More information can be
found in the Linux Kernel
documentation: <a class="reference external" href="https://www.kernel.org/doc/html/latest/networking/can.html">https://www.kernel.org/doc/html/latest/networking/can.html</a></p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The switches S6 and S7 are switching the 120 Ohm bus termination resistors.
For proper functionality of the CAN FD interface, the bus needs to be
terminated. If no external bus termination resistors are mounted, the
switches S6 (for CAN FD1) and S7 (for CAN FD2) need to be set to ON.</p>
</div>
<ul>
<li><p>使用：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>link
</pre></div>
</div>
<p>to see the state of the interfaces. The two CAN interfaces should show up as
main_mcan0 and main_mcan1.</p>
</li>
<li><p>To get information on main_mcan0, such as bit rate and error counters, type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>-d<span class="w"> </span>-s<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>main_mcan0
</pre></div>
</div>
<p>The information for main_mcan0 will look like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>4: main_mcan0: &lt;NOARP,UP,LOWER_UP,ECHO&gt; mtu 72 qdisc pfifo_fast state UP mode DEFAULT group default qlen 10
    link/can  promiscuity 0 allmulti 0 minmtu 0 maxmtu 0
    can &lt;FD&gt; state ERROR-ACTIVE (berr-counter tx 0 rx 0) restart-ms 0
          bitrate 800000 sample-point 0.800
          tq 12 prop-seg 39 phase-seg1 40 phase-seg2 20 sjw 10 brp 1
          m_can: tseg1 2..256 tseg2 2..128 sjw 1..128 brp 1..512 brp_inc 1
          dbitrate 800000 dsample-point 0.800
          dtq 50 dprop-seg 9 dphase-seg1 10 dphase-seg2 5 dsjw 2 dbrp 4
          m_can: dtseg1 1..32 dtseg2 1..16 dsjw 1..16 dbrp 1..32 dbrp_inc 1
          clock 80000000
          re-started bus-errors arbit-lost error-warn error-pass bus-off
          0          0          0          0          0          0         numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 tso_max_size 655
    RX:  bytes packets errors dropped  missed   mcast
    0       0      0       0       0       0
    TX:  bytes packets errors dropped carrier collsns
    0       0      0       0       0       0
</pre></div>
</div>
</li>
</ul>
<p>输出包含一组标准参数，这些参数也适用于以太网接口，因此并非所有参数对于CAN都是相关的（例如MAC地址）。以下输出参数包含有用的信息：</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>can0</p></th>
<th class="head"><p>接口名称</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>NOARP</p></td>
<td><p>CAN无法使用ARP协议</p></td>
</tr>
<tr class="row-odd"><td><p>MTU</p></td>
<td><p>最大传输单元</p></td>
</tr>
<tr class="row-even"><td><p>RX packets</p></td>
<td><p>接收的数据包数量</p></td>
</tr>
<tr class="row-odd"><td><p>TX packets</p></td>
<td><p>发送的数据包数量</p></td>
</tr>
<tr class="row-even"><td><p>RX bytes</p></td>
<td><p>接收字节数</p></td>
</tr>
<tr class="row-odd"><td><p>TX bytes</p></td>
<td><p>发送字节数</p></td>
</tr>
<tr class="row-even"><td><p>errors...</p></td>
<td><p>总线错误统计信息</p></td>
</tr>
</tbody>
</table>
<p>The CAN configuration is done in the systemd configuration
file <code class="docutils literal notranslate"><span class="pre">/lib/systemd/network/11-main_mcan.network</span></code>. For a persistent change of (as an
example, the default bitrates), change the configuration in the BSP
under <code class="docutils literal notranslate"><span class="pre">./meta-ampliphy/recipes-core/systemd/systemd-conf/11-main_mcan.network</span></code> in
the root filesystem and rebuild the root filesystem.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Match]
Name=main_mcan*

[CAN]
BitRate=800000
DataBitRate=800000
FDMode=yes
</pre></div>
</div>
<p>比特率也可以手动更改，例如，设置为灵活比特率（flexible bitrate）：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>main_mcan0<span class="w"> </span>down
<span class="gp">target:~$ </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>main_mcan0<span class="w"> </span>txqueuelen<span class="w"> </span><span class="m">10</span><span class="w"> </span>up<span class="w"> </span><span class="nb">type</span><span class="w"> </span>can<span class="w"> </span>bitrate<span class="w"> </span><span class="m">500000</span><span class="w"> </span>sample-point<span class="w"> </span><span class="m">0</span>.75<span class="w"> </span>dbitrate<span class="w"> </span><span class="m">4000000</span><span class="w"> </span>dsample-point<span class="w"> </span><span class="m">0</span>.8<span class="w"> </span>fd<span class="w"> </span>on
</pre></div>
</div>
<p>您可以使用cansend发送消息，或使用candump接收消息：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cansend<span class="w"> </span>main_mcan0<span class="w"> </span><span class="m">123</span><span class="c1">#45.67</span>
<span class="gp">target:~$ </span>candump<span class="w"> </span>main_mcan0
</pre></div>
</div>
<p>要生成用于测试目的的随机CAN流量，请使用cangen：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cangen
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cansend</span> <span class="pre">--help</span></code> 和 <code class="docutils literal notranslate"><span class="pre">candump</span> <span class="pre">--help</span></code> 提供了关于选项和用法的帮助信息。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>mcp2518fd SPI到CAN FD只支持从125kB/s开始的波特率。可以选择更慢的速率，但可能无法正常工作。</p>
</div>
<p>Device Tree CAN configuration of k3-am62l3-libra-rdk-fpsc.dts:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L306">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-rdk-fpsc.dts#L306</a></p>
</section>
<section id="video">
<h2><span class="section-number">7.15. </span>视频<a class="headerlink" href="#video" title="Link to this heading"></a></h2>
<section id="videos-with-gstreamer">
<h3><span class="section-number">7.15.1. </span>视频与Gstreamer<a class="headerlink" href="#videos-with-gstreamer" title="Link to this heading"></a></h3>
<p>默认情况下，BSP安装了一个示例视频，路径为 <cite>/usr/share/qtphy/videos/</cite> 。可以使用以下命令之一开始视频播放：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gst-launch-1.0<span class="w"> </span>playbin<span class="w"> </span><span class="nv">uri</span><span class="o">=</span>file:///usr/share/qtphy/videos/caminandes_3_llamigos_720p_vp9.webm
</pre></div>
</div>
<ul class="simple">
<li><p>或者：</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gst-launch-1.0<span class="w"> </span>-v<span class="w"> </span>filesrc<span class="w"> </span><span class="nv">location</span><span class="o">=</span>/usr/share/qtphy/videos/caminandes_3_llamigos_720p_vp9.webm<span class="w"> </span>!<span class="w"> </span>decodebin<span class="w"> </span><span class="nv">name</span><span class="o">=</span>decoder<span class="w"> </span>decoder.<span class="w"> </span>!<span class="w"> </span>videoconvert<span class="w"> </span>!<span class="w"> </span>waylandsink
</pre></div>
</div>
<ul class="simple">
<li><p>或者：</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gst-play-1.0<span class="w"> </span>/usr/share/qtphy/videos/caminandes_3_llamigos_720p_vp9.webm<span class="w"> </span>--videosink<span class="w"> </span>waylandsink
</pre></div>
</div>
</section>
</section>
<section id="display">
<h2><span class="section-number">7.16. </span>显示<a class="headerlink" href="#display" title="Link to this heading"></a></h2>
<p>The Libra FPSC supports up to 3 different display outputs. The following table shows
the required extensions and devicetree overlays for the different interfaces.
For the alpha release, we have included overlay for <code class="docutils literal notranslate"><span class="pre">powertip,ac209</span></code>
LVDS display.
The name can be found on the back of the display.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Currently only LVDS1 (onboard LVDS) is supported</p>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>接口</p></th>
<th class="head"><p>扩展板</p></th>
<th class="head"><p>设备树overlay</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>LVDS1</p></td>
<td><p>Libra FPSC</p></td>
<td><p>k3-am62l3-libra-fpsc-lvds-ac209.dtbo</p></td>
</tr>
</tbody>
</table>
<p>The default interface is LVDS1 (onboard LVDS).</p>
<section id="qt-demo">
<h3><span class="section-number">7.16.1. </span>Qt Demo<a class="headerlink" href="#qt-demo" title="Link to this heading"></a></h3>
<p>使用 <code class="docutils literal notranslate"><span class="pre">phytec-qt6demo-image</span></code> 时，Weston会在启动时启动。我们的Qt6 DEMO应用程序名为“qtphy”，可以通过以下方式停止：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>systemctl<span class="w"> </span>stop<span class="w"> </span>qtphy
</pre></div>
</div>
<ul>
<li><p>要重新开始Demo，请运行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>systemctl<span class="w"> </span>start<span class="w"> </span>qtphy
</pre></div>
</div>
</li>
<li><p>要禁用Demo的自动启动，请运行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>systemctl<span class="w"> </span>disable<span class="w"> </span>qtphy
</pre></div>
</div>
</li>
<li><p>要启用Demo的自动启动，请运行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>qtphy
</pre></div>
</div>
</li>
<li><p>Weston可以通过以下方式停止：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>systemctl<span class="w"> </span>stop<span class="w"> </span>weston
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在关闭Weston之前，必须先关闭Qt Demo。</p>
</div>
</section>
<section id="backlight-control">
<h3><span class="section-number">7.16.2. </span>背光控制<a class="headerlink" href="#backlight-control" title="Link to this heading"></a></h3>
<p>如果LCD连接到PHYTEC开发板，可以通过Linux内核的sysfs接口控制其背光。系统中所有可用的背光设备可以在文件夹/sys/class/backlight中找到。读取相应的文件并向其写入数据可以控制背光。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>一些具有多显示的开发板在 /sys/class/backlight 有多个背光控制。比如：backlight0和backlight1</p>
</div>
<ul>
<li><p>例如，要获取最大亮度级别（max_brightness），请执行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/class/backlight/backlight/max_brightness
</pre></div>
</div>
<p>有效的亮度值范围是 0 到 &lt;max_brightness&gt;。</p>
</li>
<li><p>要获取当前亮度级别，请输入：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/class/backlight/backlight/brightness
</pre></div>
</div>
</li>
<li><p>写入文件brightness以更改亮度：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/backlight/backlight/brightness
</pre></div>
</div>
<p>例如，关闭背光。</p>
<p>有关所有文件的文档，请参见 <a class="reference external" href="https://www.kernel.org/doc/Documentation/ABI/stable/sysfs-class-backlight">https://www.kernel.org/doc/Documentation/ABI/stable/sysfs-class-backlight</a>。</p>
</li>
</ul>
<p>Device tree description of LVDS-0 can be found here:
<a class="extlink-linux-phytec-ti reference external" href="https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-fpsc-lvds-ac209.dtso#L16">https://github.com/phytec/linux-phytec-ti/tree/v6.12.35-11.01.05-phy/arch/arm64/boot/dts/ti/k3-am62l3-libra-fpsc-lvds-ac209.dtso#L16</a></p>
</section>
</section>
<section id="power-management">
<h2><span class="section-number">7.17. </span>电源管理<a class="headerlink" href="#power-management" title="Link to this heading"></a></h2>
<section id="cpu-core-management">
<h3><span class="section-number">7.17.1. </span>CPU核心管理<a class="headerlink" href="#cpu-core-management" title="Link to this heading"></a></h3>
<p>AM62L SoC 在芯片上拥有多个处理器核心。例如，AM62L 具有 2 个 ARM 核，这些核可以在运行时单独开启和关闭。</p>
<ul>
<li><p>要查看系统中所有可用的核心，请执行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ls<span class="w"> </span>/sys/devices/system/cpu<span class="w">  </span>-1
</pre></div>
</div>
</li>
<li><p>这将显示，例如：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cpu0    cpu1   cpufreq
[...]
</pre></div>
</div>
<p>这里系统有四个处理器核心。默认情况下，系统中所有可用的核心都被启用，以获得最佳性能。</p>
</li>
<li><p>要关闭某个核，请执行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/devices/system/cpu/cpu1/online
</pre></div>
</div>
<p>作为确认，您将看到：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[  110.505012] psci: CPU1 killed
</pre></div>
</div>
<p>现在核心已关闭电源，并且该核心上不再安排任何进程。</p>
</li>
<li><p>您可以使用 top 命令查看核心和进程的图形概览：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>htop
</pre></div>
</div>
</li>
<li><p>要重新启用核心，请执行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/devices/system/cpu/cpu1/online
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="thermal-management">
<h2><span class="section-number">7.18. </span>热管理<a class="headerlink" href="#thermal-management" title="Link to this heading"></a></h2>
<section id="kernel">
<h3><span class="section-number">7.18.1. </span>内核<a class="headerlink" href="#kernel" title="Link to this heading"></a></h3>
<p>Linux内核集成了热管理功能，能够监测芯片（SoC）温度，降低CPU频率，控制风扇，通知其他驱动程序减少功耗，并在最坏的情况下关闭系统（<a class="reference external" href="https://www.kernel.org/doc/Documentation/thermal/sysfs-api.txt">https://www.kernel.org/doc/Documentation/thermal/sysfs-api.txt</a>）。</p>
<p>本节描述了如何在 AM62L SoC 平台上使用热管理内核 API。 AM62 具有用于 SoC 的内部温度传感器。</p>
<ul>
<li><p>当前温度可以以毫摄氏度为单位读取：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/class/thermal/thermal_zone0/temp
</pre></div>
</div>
</li>
<li><p>例如，你将得到：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>49530
</pre></div>
</div>
</li>
</ul>
<p>This translates to 49.53°C</p>
<p>There can be a number of trip points registered by the thermal kernel driver:</p>
<table class="docutils align-default" id="id7">
<caption><span class="caption-text">Type of trip points</span><a class="headerlink" href="#id7" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>passive</p></td>
<td><p>Mitigate heat by scaling down performance without active cooling.</p></td>
</tr>
<tr class="row-odd"><td><p>active</p></td>
<td><p>Implement more aggressive cooling methods to prevent the system from
reaching critical temperatures.</p></td>
</tr>
<tr class="row-even"><td><p>hot</p></td>
<td><p>Signals a state where the system is getting warm but hasn't reached
critical levels yet.</p></td>
</tr>
<tr class="row-odd"><td><p>critical</p></td>
<td><p>Protect the hardware from potential damage due to extreme temperatures by
forcing shutdown.</p></td>
</tr>
</tbody>
</table>
<p>Number of trip points, their type an values differ depending on the CPU variant
and CPU grade. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/class/thermal/thermal_zone0/trip_point*
<span class="go">2000</span>
<span class="go">125000</span>
<span class="go">critical</span>
</pre></div>
</div>
<p>This is a critical trip point which will cause the system to shutdown when the
temperature reaches 125°C.</p>
<p>The kernel thermal management uses these trip points to trigger events and
change the cooling behavior. The following thermal policies (also named thermal
governors) are available in the kernel:</p>
<table class="docutils align-default" id="id8">
<caption><span class="caption-text">Type of thermal governors</span><a class="headerlink" href="#id8" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Governor</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>step_wise</p></td>
<td><p>Default on most SoCs. Increases/decreases cooling device state step by
step as temperature crosses trip points.</p></td>
</tr>
<tr class="row-odd"><td><p>bang_bang</p></td>
<td><p>Simple on/off control: turns cooling device fully on above threshold,
fully off below.</p></td>
</tr>
<tr class="row-even"><td><p>user_space</p></td>
<td><p>Userspace daemon controls cooling states via sysfs. Kernel only reports
temperatures.</p></td>
</tr>
<tr class="row-odd"><td><p>fair_share</p></td>
<td><p>Distributes cooling demand proportionally among available cooling
devices.</p></td>
</tr>
<tr class="row-even"><td><p>power_allocator</p></td>
<td><p>More advanced: allocates cooling power budget dynamically (uses power
models).</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="watchdog">
<h2><span class="section-number">7.19. </span>看门狗<a class="headerlink" href="#watchdog" title="Link to this heading"></a></h2>
<p>PHYTEC AM62L 模块包含一个硬件看门狗，当系统挂起时能够重置开发板。看门狗在 U-Boot 中默认启动，超时时间为 60 秒。因此，即使在早期内核启动过程中，看门狗也已经开始运行。Linux 内核驱动程序控制看门狗，并确保它有被踢到。本节将解释如何使用 systemd 在 Linux 中配置看门狗，以避免系统挂起和重启期间的情况。</p>
<section id="watchdog-support-in-systemd">
<h3><span class="section-number">7.19.1. </span>Systemd中的看门狗支持<a class="headerlink" href="#watchdog-support-in-systemd" title="Link to this heading"></a></h3>
<p>Systemd 从版本 183 开始支持硬件看门狗。</p>
<ul>
<li><p>要启用看门狗支持，需要通过启用选项来配置 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/</span></code> 中的文件system.conf文件：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>RuntimeWatchdogSec=60s
ShutdownWatchdogSec=10min
</pre></div>
</div>
</li>
</ul>
<p><em>RuntimeWatchdogSec</em> 定义了看门狗的超时时间，而 <em>ShutdownWatchdogSec</em> 定义了系统重启时的超时时间。有关 systemd 下硬件看门狗的更多详细信息，请访问 <a class="reference external" href="http://0pointer.de/blog/projects/watchdog.html">http://0pointer.de/blog/projects/watchdog.html</a>。更改将在重启后生效，或者运行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$  </span>systemctl<span class="w"> </span>daemon-reload
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="am62l.html" class="btn btn-neutral float-left" title="AM62L Manuals" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="quickstart-alpha.html" class="btn btn-neutral float-right" title="1. 介绍" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2026, PHYTEC Messtechnik GmbH。</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    Languages
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    
    <dl>
      <dt>语言</dt>
        
          <dd><a href="https://phytec.github.io/doc-bsp-yocto/index.html">en</a></dd>
        
          <dd><a href="https://phytec.github.io/doc-bsp-yocto/zh_CN/index.html">zh_CN</a></dd>
        
    </dl>
    

    <div style="margin: 10px 0;"></div>
    <dl>
      <dt>Version</dt>
      <dd>imx95-alpha1-237-ga19484b</dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>