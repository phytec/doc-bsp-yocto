

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1. PHYTEC Documentation &mdash; PHYTEC BSP Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/code-block.css?v=7a82ee62" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/phytec-theme.css?v=82726be5" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="canonical" href="https://phytec.github.io/doc-bsp-yocto/bsp/imx8/imx8mp/head.html" />
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="1. PHYTEC Documentation" href="mainline-head.html" />
    <link rel="prev" title="i.MX 8M Plus Manuals" href="imx8mp.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PHYTEC BSP Documentation
              <img src="../../../_static/logo-phytec.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">BSP Manuals</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../imx8.html">i.MX 8</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="imx8mp.html">phyCORE-i.MX 8M Plus Manuals</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="imx8mp.html#head">HEAD</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">1. PHYTEC Documentation</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#supported-hardware">1.1. Supported Hardware</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#getting-started">2. Getting Started</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#get-the-image">2.1. Get the Image</a></li>
<li class="toctree-l5"><a class="reference internal" href="#write-the-image-to-sd-card">2.2. Write the Image to SD Card</a></li>
<li class="toctree-l5"><a class="reference internal" href="#first-start-up">2.3. First Start-up</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#building-the-bsp">3. Building the BSP</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#basic-set-up">3.1. Basic Set-Up</a></li>
<li class="toctree-l5"><a class="reference internal" href="#get-the-bsp">3.2. Get the BSP</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#installing-the-os">4. Installing the OS</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#bootmode-switch-s3">4.1. Bootmode Switch (S3)</a></li>
<li class="toctree-l5"><a class="reference internal" href="#flash-e-mmc">4.2. Flash e.MMC</a></li>
<li class="toctree-l5"><a class="reference internal" href="#flash-spi-nor-flash">4.3. Flash SPI NOR Flash</a></li>
<li class="toctree-l5"><a class="reference internal" href="#rauc">4.4. RAUC</a></li>
<li class="toctree-l5"><a class="reference internal" href="#efi-boot">4.5. EFI Boot</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#development">5. Development</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#standalone-build-preparation">5.1. Standalone Build preparation</a></li>
<li class="toctree-l5"><a class="reference internal" href="#u-boot-standalone-build">5.2. U-Boot standalone build</a></li>
<li class="toctree-l5"><a class="reference internal" href="#kernel-standalone-build">5.3. Kernel standalone build</a></li>
<li class="toctree-l5"><a class="reference internal" href="#working-with-uuu">5.4. Working with UUU</a></li>
<li class="toctree-l5"><a class="reference internal" href="#host-network-preparation">5.5. Host Network Preparation</a></li>
<li class="toctree-l5"><a class="reference internal" href="#booting-the-kernel-from-a-network">5.6. Booting the Kernel from a Network</a></li>
<li class="toctree-l5"><a class="reference internal" href="#accessing-the-development-states">5.7. Accessing the Development states</a></li>
<li class="toctree-l5"><a class="reference internal" href="#accessing-the-latest-upstream-support">5.8. Accessing the Latest Upstream Support</a></li>
<li class="toctree-l5"><a class="reference internal" href="#format-sd-card">5.9. Format SD card</a></li>
<li class="toctree-l5"><a class="reference internal" href="#switch-back-to-legacyboot">5.10. Switch back to legacyboot</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#device-tree-dt">6. Device Tree (DT)</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#introduction">6.1. Introduction</a></li>
<li class="toctree-l5"><a class="reference internal" href="#phytec-soc-bsp-device-tree-concept">6.2. PHYTEC i.MX 8M Plus BSP Device Tree Concept</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#accessing-peripherals">7. Accessing Peripherals</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#soc-pin-muxing">7.1. i.MX 8M Plus Pin Muxing</a></li>
<li class="toctree-l5"><a class="reference internal" href="#rs232-rs485">7.2. RS232/RS485</a></li>
<li class="toctree-l5"><a class="reference internal" href="#ethernet">7.3. Ethernet</a></li>
<li class="toctree-l5"><a class="reference internal" href="#wlan-bluetooth">7.4. WLAN/Bluetooth</a></li>
<li class="toctree-l5"><a class="reference internal" href="#sd-card">7.5. SD card</a></li>
<li class="toctree-l5"><a class="reference internal" href="#e-mmc-devices">7.6. e.MMC Devices</a></li>
<li class="toctree-l5"><a class="reference internal" href="#spi-master">7.7. SPI Master</a></li>
<li class="toctree-l5"><a class="reference internal" href="#gpios">7.8. GPIOs</a></li>
<li class="toctree-l5"><a class="reference internal" href="#leds">7.9. LEDs</a></li>
<li class="toctree-l5"><a class="reference internal" href="#i2c-bus">7.10. IÂ²C Bus</a></li>
<li class="toctree-l5"><a class="reference internal" href="#eeprom">7.11. EEPROM</a></li>
<li class="toctree-l5"><a class="reference internal" href="#rtc">7.12. RTC</a></li>
<li class="toctree-l5"><a class="reference internal" href="#usb-host-controller">7.13. USB Host Controller</a></li>
<li class="toctree-l5"><a class="reference internal" href="#can-fd">7.14. CAN FD</a></li>
<li class="toctree-l5"><a class="reference internal" href="#pcie">7.15. PCIe</a></li>
<li class="toctree-l5"><a class="reference internal" href="#audio">7.16. Audio</a></li>
<li class="toctree-l5"><a class="reference internal" href="#video">7.17. Video</a></li>
<li class="toctree-l5"><a class="reference internal" href="#display">7.18. Display</a></li>
<li class="toctree-l5"><a class="reference internal" href="#power-management">7.19. Power Management</a></li>
<li class="toctree-l5"><a class="reference internal" href="#thermal-management">7.20. Thermal Management</a></li>
<li class="toctree-l5"><a class="reference internal" href="#watchdog">7.21. Watchdog</a></li>
<li class="toctree-l5"><a class="reference internal" href="#snvs-power-key">7.22. snvs Power Key</a></li>
<li class="toctree-l5"><a class="reference internal" href="#npu">7.23. NPU</a></li>
<li class="toctree-l5"><a class="reference internal" href="#isp">7.24. ISP</a></li>
<li class="toctree-l5"><a class="reference internal" href="#on-chip-otp-controller-ocotp-ctrl-efuses">7.25. On-Chip OTP Controller (OCOTP_CTRL) - eFuses</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#soc-mcore">8. i.MX 8M Plus M7 Core</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#getting-the-firmware-examples">8.1. Getting the Firmware Examples</a></li>
<li class="toctree-l5"><a class="reference internal" href="#running-mcore-examples">8.2. Running M7 Core Examples</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="imx8mp.html#mainline-head">Mainline HEAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="imx8mp.html#bsp-yocto-nxp-i-mx8mp-pd24-1-0">BSP-Yocto-NXP-i.MX8MP-PD24.1.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="imx8mp.html#bsp-yocto-ampliphy-i-mx8mp-pd24-1-2">BSP-Yocto-Ampliphy-i.MX8MP-PD24.1.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="imx8mp.html#bsp-yocto-ampliphy-i-mx8mp-pd24-1-1">BSP-Yocto-Ampliphy-i.MX8MP-PD24.1.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="imx8mp.html#bsp-yocto-nxp-i-mx8mp-pd23-1-0">BSP-Yocto-NXP-i.MX8MP-PD23.1.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="imx8mp.html#bsp-yocto-nxp-i-mx8mp-pd22-1-2">BSP-Yocto-NXP-i.MX8MP-PD22.1.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="imx8mp.html#bsp-yocto-nxp-i-mx8mp-pd22-1-1">BSP-Yocto-NXP-i.MX8MP-PD22.1.1</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../imx8mp-fpsc/imx8mp-fpsc.html">phyCORE-i.MX 8M Plus FPSC Manuals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../imx8mm/imx8mm.html">phyCORE-i.MX 8M Mini Manuals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../imx8mn/imx8mn.html">phyCORE-i.MX 8M Nano Manuals</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../imx9/imx9.html">i.MX 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../am6x/am6x.html">AM6X</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Yocto Manuals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../yocto/manual-index.html">Unstable (dev)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../yocto/manual-index.html#kirkstone">Kirkstone</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../yocto/manual-index.html#mickledore">Mickledore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../yocto/manual-index.html#scarthgap">Scarthgap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application Manuals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../rauc/manual-index.html">RAUC Update &amp; Device Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/manual-index.html">Security Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coprocessor/index.html">Coprocessor</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contribute</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing_links.html">Contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PHYTEC BSP Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../imx8.html">i.MX 8</a></li>
          <li class="breadcrumb-item"><a href="imx8mp.html">i.MX 8M Plus Manuals</a></li>
      <li class="breadcrumb-item active"><span class="section-number">1. </span>PHYTEC Documentation</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/phytec/doc-bsp-yocto/blob/main/source/bsp/imx8/imx8mp/head.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>Documentation in pdf format: <a class="reference external" href="../../../_static/imx8mp-head.pdf">Download</a></p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>L-1017e.Ax i.MX 8M Plus BSP
ManualHead</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Document Title</p></td>
<td><p>L-1017e.Ax i.MX 8M Plus BSP
Manual Head</p></td>
</tr>
<tr class="row-odd"><td><p>Document Type</p></td>
<td><p>BSP Manual</p></td>
</tr>
<tr class="row-even"><td><p>Article Number</p></td>
<td><p>L-1017e.Ax</p></td>
</tr>
<tr class="row-odd"><td><p>Yocto Manual</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Release Date</p></td>
<td><p>XXXX/XX/XX</p></td>
</tr>
<tr class="row-odd"><td><p>Is Branch of</p></td>
<td><p>L-1017e.Ax i.MX 8M Plus BSP
Manual Head</p></td>
</tr>
</tbody>
</table>
<p>The table below shows the Compatible BSPs for this manual:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Compatible BSPs</p></th>
<th class="head"><p>BSP Release Type</p></th>
<th class="head"><p>BSP Release  Date</p></th>
<th class="head"><p>BSP Status</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BSP-Yocto-NXP-i.MX8MP-PD26.1.0</p></td>
<td><p>major</p></td>
<td><p>q1 2026</p></td>
<td><p>in development</p></td>
</tr>
</tbody>
</table>
<p>This BSP manual guides you through the installation and creation steps for the
Board Support Package (BSP) and describes how to handle the interfaces for the
<strong>phyCORE-i.MX8M Plus Kit</strong>. Furthermore, this document describes how to create BSP images from the
source code. This is useful for those who need to change the default image and
need a way to implement these changes in a simple and reproducible way. Further,
some sections of this manual require executing commands on a personal
computer (host). Any and all of these commands are assumed to be executed on a
Linux Operating System.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This document contains code examples that describe the communication with the
board over the serial shell. The code examples lines begin with âhost:~$â,
âtarget:~$â or âu-boot=&gt;â. This describes where the commands are to be
executed. Only after these keywords must the actual command be copied.</p>
</div>
<section id="phytec-documentation">
<h1><span class="section-number">1. </span>PHYTEC Documentation<a class="headerlink" href="#phytec-documentation" title="Link to this heading">ï</a></h1>
<p>PHYTEC provides a variety of hardware and software documentation for
all of its products. This includes any or all of the following:</p>
<ul class="simple">
<li><p><strong>QS Guide</strong>: A short guide on how to set up and boot a phyCORE based
board.</p></li>
<li><p><strong>Hardware Manual</strong>: A detailed description of the System-on-Module and
accompanying carrierboard.</p></li>
<li><p><strong>Yocto Guide</strong>: A comprehensive guide for the Yocto version
the phyCORE uses. This guide contains an overview of Yocto;
introducing, installing, and customizing the PHYTEC BSP; how to
work with programs like Poky and Bitbake; and much more.</p></li>
<li><p><strong>BSP Manual</strong>: A manual specific to the BSP version of the phyCORE.
Information such as how to build the BSP, booting, updating
software, device tree, and accessing peripherals can be found
here.</p></li>
<li><p><strong>Development Environment Guide</strong>: This guide shows how to work
with the Virtual Machine (VM) Host PHYTEC has developed and
prepared to run various Development Environments. There are
detailed step-by-step instructions for Eclipse and Qt Creator,
which are included in the VM. There are instructions for running
demo projects for these programs on a phyCORE product as well.
Information on how to build a Linux host PC yourself is also a
part of this guide.</p></li>
<li><p><strong>Pin Muxing Table</strong>: phyCORE SOMs have an accompanying pin
table (in Excel format). This table will show the complete
default signal path, from the processor to the carrier board.
The default device tree muxing option will also be included.
This gives a developer all the information needed in one location
to make muxing changes and design options when developing a
specialized carrier board or adapting a PHYTEC phyCORE SOM to an
application.</p></li>
</ul>
<p>On top of these standard manuals and guides, PHYTEC will also
provide Product Change Notifications, Application Notes, and
Technical Notes. These will be done on a case-by-case basis. Most
of the documentation can be found on the <a class="reference external" href="https://www.phytec.de/produkte/system-on-modules/phycore-imx-8m-plus/#downloads">https://www.phytec.de/produkte/system-on-modules/phycore-imx-8m-plus/#downloads</a> of our product.</p>
<section id="supported-hardware">
<h2><span class="section-number">1.1. </span>Supported Hardware<a class="headerlink" href="#supported-hardware" title="Link to this heading">ï</a></h2>
<p>On our web page, you can see all supported Machines with the available Article
Numbers for this release: BSP-Yocto-NXP-i.MX8MP-PD26.1.0 <a class="reference external" href="https://www.phytec.de/bsp-download/?bsp=BSP-Yocto-NXP-i.MX8MP-PD26.1.0">download</a>.</p>
<p>If you choose a specific <strong>Machine Name</strong> in the section <strong>Supported Machines</strong>,
you can see which <strong>Article Numbers</strong> are available under this machine and also
a short description of the hardware information. In case you only have
the <strong>Article Number</strong> of your hardware, you can leave the <strong>Machine
Name</strong> drop-down menu empty and only choose your <strong>Article Number</strong>. Now it
should show you the necessary <strong>Machine Name</strong> for your specific hardware</p>
<section id="sbc-components">
<span id="imx8mp-head-components"></span><h3><span class="section-number">1.1.1. </span>phyBOARD-Pollux Components<a class="headerlink" href="#sbc-components" title="Link to this heading">ï</a></h3>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="../../../_images/phyBOARD-Pollux-front-components.jpg"><img alt="../../../_images/phyBOARD-Pollux-front-components.jpg" src="../../../_images/phyBOARD-Pollux-front-components.jpg" style="width: 90%;" />
</a>
<figcaption>
<p><span class="caption-text"><strong>phyBOARD-Pollux Components (top)</strong></span><a class="headerlink" href="#id2" title="Link to this image">ï</a></p>
</figcaption>
</figure>
<figure class="align-center" id="id3">
<a class="reference internal image-reference" href="../../../_images/phyBOARD-Pollux-back-components.jpg"><img alt="../../../_images/phyBOARD-Pollux-back-components.jpg" src="../../../_images/phyBOARD-Pollux-back-components.jpg" style="width: 85%;" />
</a>
<figcaption>
<p><span class="caption-text"><strong>phyBOARD-Pollux Components (bottom)</strong></span><a class="headerlink" href="#id3" title="Link to this image">ï</a></p>
</figcaption>
</figure>
</section>
</section>
</section>
<section id="getting-started">
<span id="imx8mp-head-getting-started"></span><h1><span class="section-number">2. </span>Getting Started<a class="headerlink" href="#getting-started" title="Link to this heading">ï</a></h1>
<p>The <strong>phyCORE-i.MX8M Plus Kit</strong> is shipped with a pre-flashed SD card. It contains the
phytec-qt6demo-image and can be used directly as a boot source. The e.MMC is
programmed with only a U-Boot by default. You can get all sources from the
<a class="reference external" href="https://download.phytec.de/Software/Linux/BSP-Yocto-i.MX8MP/">PHYTEC download server</a>. This chapter explains how to flash a BSP
image to SD card and how to start the board.</p>
<p>There are several ways to flash an image to SD card or even e.MMC. Most notably
using simple, sequential writing with the Linux command line tool <code class="docutils literal notranslate"><span class="pre">dd</span></code>. An
alternative way is to use PHYTECâs system initialization program called
<a class="reference external" href="https://github.com/phytec/partup">partup</a>, which makes it especially easy to
format more complex systems. You can get <a class="reference external" href="https://github.com/phytec/partup/releases">prebuilt Linux binaries of partup</a> from its release page. Also read
<a class="reference external" href="https://github.com/phytec/partup#readme">partupâs README</a> for installation
instructions.</p>
<section id="get-the-image">
<h2><span class="section-number">2.1. </span>Get the Image<a class="headerlink" href="#get-the-image" title="Link to this heading">ï</a></h2>
<p>The image contains all necessary files and makes sure partitions and any raw
data are correctly written. Both the partup package and the WIC image, which can
be flashed using <code class="docutils literal notranslate"><span class="pre">dd</span></code>, can be downloaded from the <a class="reference external" href="https://download.phytec.de/Software/Linux/BSP-Yocto-i.MX8MP/">PHYTEC download server</a>.</p>
<p>Get either the partup package or the WIC image from the download server:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>wget<span class="w"> </span>https://download.phytec.de/Software/Linux/BSP-Yocto-i.MX8MP/BSP-Yocto-NXP-i.MX8MP-PD26.1.0/images/ampliphy-vendor-xwayland/phyboard-pollux-imx8mp-3/phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.partup
<span class="gp">host:~$ </span>wget<span class="w"> </span>https://download.phytec.de/Software/Linux/BSP-Yocto-i.MX8MP/BSP-Yocto-NXP-i.MX8MP-PD26.1.0/images/ampliphy-vendor-xwayland/phyboard-pollux-imx8mp-3/phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.xz
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For e.MMC, more complex partitioning schemes or even just large images, we
recommend using the partup package, as it is faster in writing than <code class="docutils literal notranslate"><span class="pre">dd</span></code>
and allows for a more flexible configuration of the target flash device.</p>
</div>
</section>
<section id="write-the-image-to-sd-card">
<h2><span class="section-number">2.2. </span>Write the Image to SD Card<a class="headerlink" href="#write-the-image-to-sd-card" title="Link to this heading">ï</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>To create your bootable SD card, you must have root privileges on your Linux
host PC. Be very careful when specifying the destination device! All files
on the selected device will be erased immediately without any further query!</p>
<p>Selecting the wrong device may result in <strong>data loss</strong> and e.g. could erase
your currently running system on your host PC!</p>
</div>
<section id="finding-the-correct-device">
<h3><span class="section-number">2.2.1. </span>Finding the Correct Device<a class="headerlink" href="#finding-the-correct-device" title="Link to this heading">ï</a></h3>
<p id="getting-started-find-correct-device">To create your bootable SD card, you must first find the correct device name
of your SD card and possible partitions. If any partitions of the SD cards are
mounted, unmount those before you start copying the image to the SD card.</p>
<ol class="arabic">
<li><p>In order to get the correct device name, remove your SD card and
execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>lsblk
</pre></div>
</div>
</li>
<li><p>Now insert your SD card and execute the command again:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>lsblk
</pre></div>
</div>
</li>
<li><p>Compare the two outputs to find the new device names listed in the second
output. These are the device names of the SD card (device and partitions if
the SD card was formatted).</p></li>
<li><p>In order to verify the device names being found, execute the command
<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">dmesg</span></code>. Within the last lines of its output, you should also find the
device names, e.g. <code class="docutils literal notranslate"><span class="pre">/dev/sde</span></code> or <code class="docutils literal notranslate"><span class="pre">/dev/mmcblk0</span></code> (depending on your
system).</p></li>
</ol>
<p>Alternatively, you may use a graphical program of your choice, like <a class="reference external" href="https://apps.gnome.org/en/DiskUtility/">GNOME Disks</a> or <a class="reference external" href="https://apps.kde.org/partitionmanager/">KDE Partition Manager</a>, to find the correct device.</p>
<p>Now that you have the correct device name, e.g. <code class="docutils literal notranslate"><span class="pre">/dev/sde</span></code>,
you can see the partitions which must be unmounted if the SD card is formatted.
In this case, you will also find the device name with an appended number
(e.g. <code class="docutils literal notranslate"><span class="pre">/dev/sde1</span></code>) in the output. These represent the partitions. Some Linux
distributions automatically mount partitions when the device gets plugged in.
Before writing, however, these need to be unmounted to avoid data corruption.</p>
<p>Unmount all those partitions, e.g.:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>umount<span class="w"> </span>/dev/sde1
<span class="gp">host:~$ </span>sudo<span class="w"> </span>umount<span class="w"> </span>/dev/sde2
</pre></div>
</div>
<p>Now, the SD card is ready to be flashed with an image, using either <code class="docutils literal notranslate"><span class="pre">partup</span></code>,
<code class="docutils literal notranslate"><span class="pre">dd</span></code> or <code class="docutils literal notranslate"><span class="pre">bmaptool</span></code>.</p>
</section>
<section id="using-bmaptool">
<h3><span class="section-number">2.2.2. </span>Using bmaptool<a class="headerlink" href="#using-bmaptool" title="Link to this heading">ï</a></h3>
<p>One way to prepare an SD card is using
<a class="reference external" href="https://github.com/yoctoproject/bmaptool">bmaptool</a>. Yocto
automatically creates a block map file (<code class="docutils literal notranslate"><span class="pre">&lt;IMAGENAME&gt;-&lt;MACHINE&gt;.wic.bmap</span></code>) for
the WIC image that describes the image content and includes checksums for data
integrity. <em>bmaptool</em> is packaged by various Linux distributions. For
Debian-based systems install it by issuing:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>bmap-tools
</pre></div>
</div>
<p>Flash a WIC image to SD card by calling:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>bmaptool<span class="w"> </span>copy<span class="w"> </span>phytec-qt6demo-image-phyboard-pollux-imx8mp-3?<span class="o">(</span>.rootfs<span class="o">)</span>.wic?<span class="o">(</span>.xz<span class="o">)</span><span class="w"> </span>/dev/&lt;your_device&gt;
</pre></div>
</div>
<p>Replace &lt;your_device&gt; with your actual SD cardâs device name found previously,
and make sure to place the file <code class="docutils literal notranslate"><span class="pre">&lt;IMAGENAME&gt;-&lt;MACHINE&gt;.wic.bmap</span></code> alongside
the regular WIC image file, so bmaptool knows which blocks to write and which
to skip.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><em>bmaptool</em> only overwrites the areas of an SD card where image data is
located. This means that a previously written U-Boot environment may still be
available after writing the image.</p>
</div>
</section>
<section id="using-partup">
<h3><span class="section-number">2.2.3. </span>Using partup<a class="headerlink" href="#using-partup" title="Link to this heading">ï</a></h3>
<p>Writing to an SD card with partup is done in a single command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>partup<span class="w"> </span>install<span class="w"> </span>phytec-qt6demo-image-phyboard-pollux-imx8mp-3?<span class="o">(</span>.rootfs<span class="o">)</span>.partup<span class="w"> </span>/dev/&lt;your_device&gt;
</pre></div>
</div>
<p>Make sure to replace &lt;your_device&gt; with your actual device name found previously.</p>
<p>Further usage of partup is explained at its <a class="reference external" href="https://partup.readthedocs.io/en/latest/">official documentation website</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Host systems which are using resize2fs version 1.46.6 and older
(e.g. Ubuntu 22.04) are not able to write partup packages created with Yocto Mickledore
or newer to SD-Card. This is due to a new default option in resize2fs which causes an
incompatibility. See <a class="reference external" href="https://e2fsprogs.sourceforge.net/e2fsprogs-release.html#1.47.0">release notes</a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>partup</em> has the advantage of allowing to clear specific raw areas in the
MMC user area, which is used in our provided partup packages to erase any
existing U-Boot environments. This is a known issue <em>bmaptool</em> does not
solve, as mentioned in the previous chapter.</p>
<p>Another key advantage of partup over other flashing tools is that it allows
configuring MMC specific parts, like writing to eMMC boot partitions, without
the need to call multiple other commands when writing.</p>
</div>
</section>
<section id="using-dd">
<h3><span class="section-number">2.2.4. </span>Using <code class="docutils literal notranslate"><span class="pre">dd</span></code><a class="headerlink" href="#using-dd" title="Link to this heading">ï</a></h3>
<p>After having unmounted all SD cardâs partitions, you can create your bootable SD card.</p>
<p>Some PHYTEC BSPs produce uncompressed images (with filename-extension *.wic),
and some others produce compressed images (with filename-extension *.wic.xz).</p>
<p>To flash an uncompressed images (*.wic) use command below:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>phytec-qt6demo-image-phyboard-pollux-imx8mp-3?<span class="o">(</span>.rootfs<span class="o">)</span>.wic<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/&lt;your_device&gt;<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync<span class="w"> </span><span class="nv">status</span><span class="o">=</span>progress
</pre></div>
</div>
<p>Or to flash a compressed images (*.wic.xz) use that command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>xzcat<span class="w"> </span>phytec-qt6demo-image-phyboard-pollux-imx8mp-3?<span class="o">(</span>.rootfs<span class="o">)</span>.wic.xz<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>dd<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/&lt;your_device&gt;<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync<span class="w"> </span><span class="nv">status</span><span class="o">=</span>progress
</pre></div>
</div>
<p>Again, make sure to replace &lt;your_device&gt; with your actual device name found
previously.</p>
<p>The parameter <code class="docutils literal notranslate"><span class="pre">conv=fsync</span></code> forces a sync operation on the device before
<code class="docutils literal notranslate"><span class="pre">dd</span></code> returns. This ensures that all blocks are written to the SD card and
none are left in memory. The parameter <code class="docutils literal notranslate"><span class="pre">status=progress</span></code> will print out
information on how much data is and still has to be copied until it is
finished.</p>
</section>
</section>
<section id="first-start-up">
<h2><span class="section-number">2.3. </span>First Start-up<a class="headerlink" href="#first-start-up" title="Link to this heading">ï</a></h2>
<ul class="simple">
<li><p>To boot from an SD card, the <a class="reference internal" href="#imx8mp-head-bootswitch"><span class="std std-ref">bootmode switch (S3)</span></a> needs to be set to the
following position:</p></li>
</ul>
<img alt="../../../_images/SD_Card_Boot3.png" src="../../../_images/SD_Card_Boot3.png" />
<ul class="simple">
<li><p>Insert the SD card</p></li>
<li><p>Connect the target and the host with <strong>micro USB</strong> on <a class="reference internal" href="#imx8mp-head-components"><span class="std std-ref">(X1)</span></a>
debug USB</p></li>
<li><p>Power up the board</p></li>
</ul>
</section>
</section>
<section id="building-the-bsp">
<h1><span class="section-number">3. </span>Building the BSP<a class="headerlink" href="#building-the-bsp" title="Link to this heading">ï</a></h1>
<p>This section will guide you through the general build process of the i.MX 8M Plus BSP
using Yocto and the phyLinux script. For more information about our
meta-layer or Yocto in general visit: <a class="reference internal" href="../../../yocto/master.html#yocto-man-master"><span class="std std-ref">Yocto Reference Manual (walnascar)</span></a>.</p>
<section id="basic-set-up">
<h2><span class="section-number">3.1. </span>Basic Set-Up<a class="headerlink" href="#basic-set-up" title="Link to this heading">ï</a></h2>
<p>If you have never created a Phytec BSP with Yocto on your computer, you should
take a closer look at the chapter BSP Workspace Installation in the
<a class="reference internal" href="../../../yocto/master.html#yocto-man-master"><span class="std std-ref">Yocto Reference Manual (walnascar)</span></a>.</p>
</section>
<section id="get-the-bsp">
<h2><span class="section-number">3.2. </span>Get the BSP<a class="headerlink" href="#get-the-bsp" title="Link to this heading">ï</a></h2>
<p>There are two ways to get the BSP sources. You can download the complete BSP
sources from our download page: <a class="reference external" href="https://download.phytec.de/Software/Linux/BSP-Yocto-i.MX8MP/">BSP-Yocto-IMX8MP</a>; or you can fetch and build it
yourself with Yocto. This is particularly useful if you want to make
customizations.</p>
<p>The phyLinux script is a basic management tool for PHYTEC Yocto BSP releases
written in Python. It is mainly a helper to get started with the BSP sources
structure.</p>
<ul>
<li><p>Create a fresh project folder, get phyLinux, and make the script executable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>mkdir<span class="w"> </span>~/yocto
<span class="gp">host:~$ </span><span class="nb">cd</span><span class="w"> </span>yocto/
<span class="gp">host:~/yocto$ </span>wget<span class="w"> </span>https://download.phytec.de/Software/Linux/Yocto/Tools/phyLinux
<span class="gp">host:~/yocto$ </span>chmod<span class="w"> </span>+x<span class="w"> </span>phyLinux
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>A clean folder is important because phyLinux will clean its working
directory. Calling phyLinux from a directory that isnât empty will result in
a warning.</p>
</div>
</li>
<li><p>Run phyLinux:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/yocto$ </span>./phyLinux<span class="w"> </span>init
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On the first initialization, the phyLinux script will ask you to install
the Repo tool in your <code class="docutils literal notranslate"><span class="pre">/usr/local/bin</span></code> directory.</p>
</div>
</li>
<li><p>During the execution of the init command, you need to choose your processor
platform (SoC), PHYTECâs BSP release number, and the hardware you are working
on.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you cannot identify your board with the information given in the selector,
have a look at the invoice for the product. And have a look at
<a class="reference external" href="https://www.phytec.de/bsp-download/?bsp=BSP-Yocto-NXP-i.MX8MP-PD26.1.0">our BSP</a>.</p>
</div>
</li>
<li><p>It is also possible to pass this information directly using command line
parameters:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/yocto$ </span><span class="nv">DISTRO</span><span class="o">=</span>ampliphy-vendor<span class="w"> </span><span class="nv">MACHINE</span><span class="o">=</span>phyboard-pollux-imx8mp-3<span class="w"> </span>./phyLinux<span class="w"> </span>init<span class="w"> </span>-p<span class="w"> </span>imx8mp<span class="w"> </span>-r<span class="w"> </span>BSP-Yocto-NXP-i.MX8MP-PD26.1.0
</pre></div>
</div>
</li>
</ul>
<p>After the execution of the init command, phyLinux will print a few important
notes. For example, it will print your git identity, SOC and BSP release which
was selected as well as information for the next steps in the build process.</p>
<section id="starting-the-build-process">
<h3><span class="section-number">3.2.1. </span>Starting the Build Process<a class="headerlink" href="#starting-the-build-process" title="Link to this heading">ï</a></h3>
<ul>
<li><p>Set up the shell environment variables:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/yocto$ </span><span class="nb">source</span><span class="w"> </span>sources/poky/oe-init-build-env
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This needs to be done every time you open a new shell for starting builds.</p>
</div>
</li>
<li><p>The current working directory of the shell should change to build/.</p></li>
<li><p>Open the main configuration file and accept the GPU and VPU binary license
agreements. Do this by uncommenting the corresponding line, as below.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/yocto/build$ </span>vim<span class="w"> </span>conf/local.conf
<span class="gp"># </span>Uncomment<span class="w"> </span>to<span class="w"> </span>accept<span class="w"> </span>NXP<span class="w"> </span>EULA
<span class="gp"># </span>EULA<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>found<span class="w"> </span>under<span class="w"> </span>../sources/meta-freescale/EULA
<span class="go">ACCEPT_FSL_EULA = &quot;1&quot;</span>
</pre></div>
</div>
</li>
<li><p>Build your image:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/yocto/build$ </span>bitbake<span class="w"> </span>phytec-qt6demo-image
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For the first build we suggest starting with our smaller non-graphical
image phytec-headless-image to see if everything is working correctly.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/yocto/build$ </span>bitbake<span class="w"> </span>phytec-headless-image
</pre></div>
</div>
<p>The first compile process takes about 40 minutes on a modern Intel
Core i7. All subsequent builds will use the filled caches and should take
about 3 minutes.</p>
</div>
</li>
</ul>
</section>
<section id="bsp-images">
<h3><span class="section-number">3.2.2. </span>BSP Images<a class="headerlink" href="#bsp-images" title="Link to this heading">ï</a></h3>
<p>All images generated by Bitbake are deployed to
<code class="docutils literal notranslate"><span class="pre">~/yocto/build/deploy*/images/&lt;machine&gt;</span></code>. The following list shows for
example all files generated for the phyboard-pollux-imx8mp-3 machine:</p>
<ul class="simple" id="imx8mp-head-images">
<li><p><strong>u-boot.bin</strong>: Binary compiled U-boot bootloader (U-Boot). Not the final
Bootloader image!</p></li>
<li><p><strong>oftree</strong>: Default kernel device tree</p></li>
<li><p><strong>u-boot-spl.bin</strong>: Secondary program loader (SPL)</p></li>
<li><p><strong>bl31-imx8mp.bin</strong>: ARM Trusted Firmware binary</p></li>
<li><p><strong>lpddr4_pmu_train_2d_dmem_202006.bin,
lpddr4_pmu_train_2d_imem_202006.bin</strong>: DDR PHY firmware images</p></li>
<li><p><strong>imx-boot</strong>: Bootloader build by imx-mkimage which includes SPL, U-Boot, ARM
Trusted Firmware and DDR firmware. This is the final bootloader image which
is bootable.</p></li>
<li><p><strong>fitImage</strong>: Linux kernel FIT image</p></li>
<li><p><strong>fitImage-its*.its</strong></p></li>
<li><p><strong>Image</strong>: Linux kernel image</p></li>
<li><p><strong>Image.config</strong>: Kernel configuration</p></li>
<li><p><strong>imx8mp-phyboard-pollux-rdk*.dtb</strong>: Kernel device tree file</p></li>
<li><p><strong>imx8mp-phy*.dtbo</strong>: Kernel device tree overlay files</p></li>
<li><p><strong>phytec-qt6demo-image*.tar.gz</strong>: Root file system</p></li>
<li><p><strong>phytec-qt6demo-image*.rootfs.wic.xz</strong>: compressed SD card image</p></li>
</ul>
</section>
</section>
</section>
<section id="installing-the-os">
<h1><span class="section-number">4. </span>Installing the OS<a class="headerlink" href="#installing-the-os" title="Link to this heading">ï</a></h1>
<section id="bootmode-switch-s3">
<h2><span class="section-number">4.1. </span>Bootmode Switch (S3)<a class="headerlink" href="#bootmode-switch-s3" title="Link to this heading">ï</a></h2>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Hardware revision baseboard: 1552.2</p>
</div>
<p>The phyBOARD-Pollux features a boot switch with four individually switchable ports to
select the phyCORE-i.MX 8M Plus default bootsource.</p>
<table class="docutils align-default" id="imx8mp-head-bootswitch">
<tbody>
<tr class="row-odd"><td><figure class="align-default" id="id4">
<img alt="../../../_images/eMMC3.png" src="../../../_images/eMMC3.png" />
<figcaption>
<p><span class="caption-text">eMMC</span><a class="headerlink" href="#id4" title="Link to this image">ï</a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-default" id="id5">
<img alt="../../../_images/Internal_Fuses2.png" src="../../../_images/Internal_Fuses2.png" />
<figcaption>
<p><span class="caption-text">Internal Fuses</span><a class="headerlink" href="#id5" title="Link to this image">ï</a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-default" id="id6">
<img alt="../../../_images/SPI_NOR3.png" src="../../../_images/SPI_NOR3.png" />
<figcaption>
<p><span class="caption-text">SPI NOR</span><a class="headerlink" href="#id6" title="Link to this image">ï</a></p>
</figcaption>
</figure>
</td>
</tr>
<tr class="row-even"><td><figure class="align-default" id="id7">
<img alt="../../../_images/USB_Serial_Download3.png" src="../../../_images/USB_Serial_Download3.png" />
<figcaption>
<p><span class="caption-text">USB Serial Download</span><a class="headerlink" href="#id7" title="Link to this image">ï</a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-default" id="id8">
<img alt="../../../_images/SD_Card_Boot3.png" src="../../../_images/SD_Card_Boot3.png" />
<figcaption>
<p><span class="caption-text">SD Card</span><a class="headerlink" href="#id8" title="Link to this image">ï</a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-default" id="id9">
<img alt="../../../_images/Test_Mode.png" src="../../../_images/Test_Mode.png" />
<figcaption>
<p><span class="caption-text">Test Mode</span><a class="headerlink" href="#id9" title="Link to this image">ï</a></p>
</figcaption>
</figure>
</td>
</tr>
</tbody>
</table>
</section>
<section id="flash-e-mmc">
<h2><span class="section-number">4.2. </span>Flash e.MMC<a class="headerlink" href="#flash-e-mmc" title="Link to this heading">ï</a></h2>
<p>For consistency, it is assumed that a TFTP server is configured; More
importantly, all generated images, as listed above, are copied to the default
/srv/tftp directory. If you do not have this set up, you need to adjust the
paths that point to the images being used in the instructions. For instructions
on how to set up the TFTP server and directory, see <a class="reference internal" href="#imx8mp-head-development"><span class="std std-ref">Setup Network Host</span></a>.</p>
<p>To boot from e.MMC, make sure that the BSP image is flashed correctly to the
e.MMC and the <a class="reference internal" href="#imx8mp-head-bootswitch"><span class="std std-ref">bootmode switch (S3)</span></a> is set to <strong>e.MMC</strong>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When e.MMC and SD card are flashed with the same (identical) image, the UUIDs
of the boot partitions are also identical. If the SD card is connected when
booting, this leads to non-deterministic behavior as Linux mounts the boot
partition based on UUID.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>blkid
</pre></div>
</div>
<p>can be run to inspect whether the current setup is affected. If <code class="docutils literal notranslate"><span class="pre">mmcblk2p1</span></code>
and <code class="docutils literal notranslate"><span class="pre">mmcblk1p1</span></code> have an identical UUID, the setup is affected.</p>
</div>
<section id="flash-e-mmc-from-network">
<h3><span class="section-number">4.2.1. </span>Flash e.MMC from Network<a class="headerlink" href="#flash-e-mmc-from-network" title="Link to this heading">ï</a></h3>
<p>i.MX 8M Plus boards have an Ethernet connector and can be updated over a network. Be
sure to set up the development host correctly. The IP needs to be set to
192.168.3.10, the netmask to 255.255.255.0, and a TFTP server needs to be
available. From a high-level point of view, an e.MMC device is like an SD card.
Therefore, it is possible to flash the <strong>WIC image</strong> (<code class="docutils literal notranslate"><span class="pre">&lt;name&gt;.wic</span></code>) from
the Yocto build system directly to the e.MMC. The image contains the
bootloader, kernel, device tree, device tree overlays, and root file system.</p>
<section id="flash-e-mmc-via-network-in-linux-on-host">
<h4><span class="section-number">4.2.1.1. </span>Flash e.MMC via Network in Linux on Host<a class="headerlink" href="#flash-e-mmc-via-network-in-linux-on-host" title="Link to this heading">ï</a></h4>
<p>It is also possible to install the OS at e.MMC from your Linux host. As before,
you need a complete image on your host.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>A working network is necessary! <a class="reference internal" href="#imx8mp-head-development"><span class="std std-ref">Setup Network Host</span></a></p>
</div>
<p>Show your available image files on the host:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>ls<span class="w"> </span>/srv/tftp
<span class="go">phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.xz</span>
<span class="go">phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.bmap</span>
</pre></div>
</div>
<p>Send the image with the <code class="docutils literal notranslate"><span class="pre">bmaptool</span></code> command combined with ssh through the network
to the e.MMC of your device:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>scp<span class="w"> </span>/srv/tftp/phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.*<span class="w"> </span>root@192.168.3.11:/tmp<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ssh<span class="w"> </span>root@192.168.3.11<span class="w"> </span><span class="s2">&quot;bmaptool copy /tmp/phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.xz /dev/mmcblk2&quot;</span>
</pre></div>
</div>
</section>
<section id="flash-e-mmc-via-network-in-linux-on-target">
<h4><span class="section-number">4.2.1.2. </span>Flash e.MMC via Network in Linux on Target<a class="headerlink" href="#flash-e-mmc-via-network-in-linux-on-target" title="Link to this heading">ï</a></h4>
<p>You can update the e.MMC from your target.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>A working network is necessary! <a class="reference internal" href="#imx8mp-head-development"><span class="std std-ref">Setup Network Host</span></a></p>
</div>
<p>Take a compressed or decompressed image with the accompanying block map file
<cite>*.bmap</cite> on the host and send it with <cite>ssh</cite> through the network to the e.MMC of
the target with a one-line command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>scp<span class="w"> </span>&lt;USER&gt;@192.168.3.10:/srv/tftp/phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.*<span class="w"> </span>/tmp<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>bmaptool<span class="w"> </span>copy<span class="w"> </span>/tmp/phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.xz<span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
</section>
<section id="flash-e-mmc-from-network-in-u-boot-on-target">
<h4><span class="section-number">4.2.1.3. </span>Flash e.MMC from Network in U-Boot on Target<a class="headerlink" href="#flash-e-mmc-from-network-in-u-boot-on-target" title="Link to this heading">ï</a></h4>
<p>These steps will show how to update the e.MMC via a network.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This step only works if the size of the image file is less than 1GB due to
limited usage of RAM size in the Bootloader after enabling OP-TEE.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>A working network is necessary! <a class="reference internal" href="#imx8mp-head-development"><span class="std std-ref">Setup Network Host</span></a></p>
</div>
<p>Uncompress your image</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>unxz<span class="w"> </span>/srv/tftp/phytec-headless-image-phyboard-pollux-imx8mp-3.rootfs.wic.xz
</pre></div>
</div>
<p>Load your image via network to RAM:</p>
<ul>
<li><p>when using dhcp</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; dhcp phytec-headless-image-phyboard-pollux-imx8mp-3.rootfs.wic
BOOTP broadcast 1
DHCP client bound to address 192.168.3.1 (1 ms)
Using ethernet@30be0000 device
TFTP from server 192.168.3.10; our IP address is 192.168.3.1
Filename &#39;phytec-headless-image-phyboard-pollux-imx8mp-3.rootfs.wic&#39;.
Load address: 0x40480000
Loading: ######################################
         ######################################
         ######################################
         ...
         ...
         ...
         ######################################
         #############
         11.2 MiB/s
done
Bytes transferred = 911842304 (36599c00 hex)
</pre></div>
</div>
</li>
<li><p>when using a static ip address (serverip and ipaddr must be set
additionally).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; tftp ${loadaddr} phytec-headless-image-phyboard-pollux-imx8mp-3.rootfs.wic
Using ethernet@30be0000 device
TFTP from server 192.168.3.10; our IP address is 192.168.3.11
Filename &#39;phytec-headless-image-phyboard-pollux-imx8mp-3.rootfs.wic&#39;.
Load address: 0x40480000
Loading: ######################################
         ######################################
         ######################################
         ...
         ...
         ...
         ######################################
         #############
         11.2 MiB/s
done
Bytes transferred = 911842304 (36599c00 hex)
</pre></div>
</div>
</li>
</ul>
<p>Write the image to the e.MMC:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; mmc dev 2
switch to partitions #0, OK
mmc2(part 0) is current device
u-boot=&gt; setexpr nblk ${filesize} / 0x200
u-boot=&gt; mmc write ${loadaddr} 0x0 ${nblk}

MMC write: dev # 2, block # 0, count 1780942 ... 1780942 blocks written: OK
</pre></div>
</div>
</section>
</section>
<section id="flash-e-mmc-u-boot-image-via-network-from-running-u-boot">
<h3><span class="section-number">4.2.2. </span>Flash e.MMC U-Boot image via Network from running U-Boot<a class="headerlink" href="#flash-e-mmc-u-boot-image-via-network-from-running-u-boot" title="Link to this heading">ï</a></h3>
<p>Update the standalone U-Boot image imx-boot is also possible from U-Boot. This
can be used if the bootloader on e.MMC is located in the e.MMC user area.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>A working network is necessary! <a class="reference internal" href="#imx8mp-head-development"><span class="std std-ref">Setup Network Host</span></a></p>
</div>
<p>Load image over tftp into RAM and then write it to e.MMC:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; tftp ${loadaddr} imx-boot
u-boot=&gt; setexpr nblk ${filesize} / 0x200
u-boot=&gt; mmc dev 2
u-boot=&gt; mmc write ${loadaddr} 0x40 ${nblk}
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The hexadecimal value represents the offset as a multiple of 512 byte
blocks. See the <a class="reference external" href="#offset-table">offset table</a> for the correct value
of the corresponding SoC.</p>
</div>
</section>
<section id="flash-e-mmc-from-usb-stick">
<h3><span class="section-number">4.2.3. </span>Flash e.MMC from USB stick<a class="headerlink" href="#flash-e-mmc-from-usb-stick" title="Link to this heading">ï</a></h3>
<section id="flash-e-mmc-from-usb-in-linux">
<h4><span class="section-number">4.2.3.1. </span>Flash e.MMC from USB in Linux<a class="headerlink" href="#flash-e-mmc-from-usb-in-linux" title="Link to this heading">ï</a></h4>
<p>These steps will show how to flash the e.MMC on Linux with a USB stick. You only
need a complete image saved on the USB stick and a bootable WIC image. (e.g.
phytec-qt6demo-image-phyboard-pollux-imx8mp-3.|yocto-imageext|). Set the
<a class="reference internal" href="#imx8mp-head-bootswitch"><span class="std std-ref">bootmode switch (S3)</span></a> to SD card.</p>
<ul>
<li><p>Insert and mount the USB stick:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[   60.458908] usb-storage 1-1.1:1.0: USB Mass Storage device detected</span>
<span class="go">[   60.467286] scsi host0: usb-storage 1-1.1:1.0</span>
<span class="go">[   61.504607] scsi 0:0:0:0: Direct-Access                               8.07 PQ: 0 ANSI: 2</span>
<span class="go">[   61.515283] sd 0:0:0:0: [sda] 3782656 512-byte logical blocks: (1.94 GB/1.80 GiB)</span>
<span class="go">[   61.523285] sd 0:0:0:0: [sda] Write Protect is off</span>
<span class="go">[   61.528509] sd 0:0:0:0: [sda] No Caching mode page found</span>
<span class="go">[   61.533889] sd 0:0:0:0: [sda] Assuming drive cache: write through</span>
<span class="go">[   61.665969]  sda: sda1</span>
<span class="go">[   61.672284] sd 0:0:0:0: [sda] Attached SCSI removable disk</span>
<span class="gp">target:~$ </span>mount<span class="w"> </span>/dev/sda1<span class="w"> </span>/mnt
</pre></div>
</div>
</li>
<li><p>Now show your saved image files on the USB Stick:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ls<span class="w"> </span>/mnt
<span class="go">phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.xz</span>
<span class="go">phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.bmap</span>
</pre></div>
</div>
</li>
<li><p>Write the image to the phyCORE-i.MX 8M Plus e.MMC (MMC device 2 without partition):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>bmaptool<span class="w"> </span>copy<span class="w"> </span>/mnt/phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.xz<span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
</li>
<li><p>After a complete write, your board can boot from e.MMC.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Before this will work, you need to configure the <a class="reference internal" href="#imx8mp-head-bootswitch"><span class="std std-ref">bootmode switch (S3)</span></a> to
<strong>eMMC</strong>.</p>
</div>
</li>
</ul>
</section>
<section id="flash-e-mmc-from-usb-stick-in-u-boot-on-target">
<h4><span class="section-number">4.2.3.2. </span>Flash e.MMC from USB stick in U-Boot on Target<a class="headerlink" href="#flash-e-mmc-from-usb-stick-in-u-boot-on-target" title="Link to this heading">ï</a></h4>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This step only works if the size of the image file is less than 1GB due to
limited usage of RAM size in the Bootloader after enabling OPTEE.</p>
</div>
<p>These steps will show how to update the e.MMC via a USB device. Configure the
<a class="reference internal" href="#imx8mp-head-bootswitch"><span class="std std-ref">bootmode switch (S3)</span></a> to SD card and insert an SD card. Power on the board and stop
in U-Boot prompt. Insert a USB device with the copied uncompressed WIC image to
the USB slot.</p>
<p>Load your image from the USB device to RAM:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; usb start
starting USB...
USB0:   USB EHCI 1.00
scanning bus 0 for devices... 2 USB Device(s) found
       scanning usb for storage devices... 1 Storage Device(s) found
u-boot=&gt; fatload usb 0:1 0x58000000 phytec-headless-image-phyboard-pollux-imx8mp-3.rootfs.wic
497444864 bytes read in 31577 ms (15 MiB/s)
</pre></div>
</div>
<p>Write the image to the e.MMC:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; mmc dev 2
switch to partitions #0, OK
mmc2(part 0) is current device
u-boot=&gt; setexpr nblk ${filesize} / 0x200
u-boot=&gt; mmc write 0x58000000 0x0 ${nblk}

MMC write: dev # 2, block # 0, count 1024000 ... 1024000 blocks written: OK
u-boot=&gt; boot
</pre></div>
</div>
</section>
</section>
<section id="flash-e-mmc-from-sd-card">
<h3><span class="section-number">4.2.4. </span>Flash e.MMC from SD card<a class="headerlink" href="#flash-e-mmc-from-sd-card" title="Link to this heading">ï</a></h3>
<p>Even if there is no network available, you can update the e.MMC. For that, you
only need a ready-to-use image file (<code class="docutils literal notranslate"><span class="pre">*.wic</span></code>) located on the SD card.
Because the image file is quite large, you need to allocate more SD card space.
To create a new partition or enlarge your SD card, see <a class="reference internal" href="#imx8mp-head-format-sd"><span class="std std-ref">Resizing ext4 Root Filesystem</span></a>.</p>
<p>Alternatively, flash a partup package to the SD card, as described in
<a class="reference internal" href="#imx8mp-head-getting-started"><span class="std std-ref">Getting Started</span></a>. This will ensure the full space of the SD card is used.</p>
<section id="flash-e-mmc-from-sd-card-in-linux-on-target">
<h4><span class="section-number">4.2.4.1. </span>Flash e.MMC from SD card in Linux on Target<a class="headerlink" href="#flash-e-mmc-from-sd-card-in-linux-on-target" title="Link to this heading">ï</a></h4>
<p>You can also flash the e.MMC on Linux. You only need a partup package or WIC
image saved on the SD card.</p>
<ul>
<li><p>Show your saved partup package or WIC image files on the SD card:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ls
<span class="go">phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.partup</span>
<span class="go">phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.xz</span>
<span class="go">phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.bmap</span>
</pre></div>
</div>
</li>
<li><p>Write the image to the phyCORE-i.MX 8M Plus e.MMC (MMC device 2 <strong>without</strong>
partition) using <a class="reference external" href="https://github.com/phytec/partup">partup</a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>partup<span class="w"> </span>install<span class="w"> </span>phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.partup<span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
<p>Flashing the partup package has the advantage of using the full capacity of
the e.MMC device, adjusting partitions accordingly.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Alternatively, <code class="docutils literal notranslate"><span class="pre">bmaptool</span></code> may be used instead:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>bmaptool<span class="w"> </span>copy<span class="w"> </span>phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.xz<span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
<p>Keep in mind that the root partition does not make use of the full space when
flashing with <code class="docutils literal notranslate"><span class="pre">bmaptool</span></code>.</p>
</div>
</li>
<li><p>After a complete write, your board can boot from e.MMC.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Before this will work, you need to configure the <a class="reference internal" href="#imx8mp-head-bootswitch"><span class="std std-ref">bootmode switch (S3)</span></a> to
e.MMC.</p>
</div>
</li>
</ul>
</section>
<section id="flash-e-mmc-from-sd-card-in-u-boot-on-target">
<h4><span class="section-number">4.2.4.2. </span>Flash e.MMC from SD card in U-Boot on Target<a class="headerlink" href="#flash-e-mmc-from-sd-card-in-u-boot-on-target" title="Link to this heading">ï</a></h4>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This step only works if the size of the image file is less than 1GB due to
limited usage of RAM size in the Bootloader after enabling OPTEE. If the
image file is too large use the <cite>Updating e.MMC from SD card in
Linux on Target</cite> subsection.</p>
</div>
<ul>
<li><p>Flash an SD card with a working image and create a third ext4 partition. Copy
the WIC image (for example phytec-qt6demo-image.rootfs.wic) to this
partition.</p></li>
<li><p>Configure the <a class="reference internal" href="#imx8mp-head-bootswitch"><span class="std std-ref">bootmode switch (S3)</span></a> to SD card and insert the SD card.</p></li>
<li><p>Power on the board and stop in U-Boot.</p></li>
<li><p>Load the image:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; ext4load mmc 1:3 ${loadaddr} phytec-headless-image-phyboard-pollux-imx8mp-3.rootfs.wic
reading
911842304 bytes read in 39253 ms (22.2 MiB/s)
</pre></div>
</div>
</li>
<li><p>Switch the mmc dev to e.MMC:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; mmc list
FSL_SDHC: 1 (SD)
FSL_SDHC: 2 (eMMC)
u-boot=&gt; mmc dev 2
switch to partitions #0, OK
mmc2(part 0) is current device
</pre></div>
</div>
</li>
<li><p>Flash your WIC image (for example phytec-qt6demo-image.rootfs.wic)
from the SD card to e.MMC. This will partition the card and copy imx-boot,
Image, dtb, dtbo, and root file system to e.MMC.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setexpr nblk ${filesize} / 0x200
u-boot=&gt; mmc write ${loadaddr} 0x0 ${nblk}

MMC write: dev # 2, block # 0, count 1780942 ... 1780942 blocks written: OK
</pre></div>
</div>
</li>
<li><p>Power off the board and change the <a class="reference internal" href="#imx8mp-head-bootswitch"><span class="std std-ref">bootmode switch (S3)</span></a> to e.MMC.</p></li>
</ul>
</section>
</section>
</section>
<section id="flash-spi-nor-flash">
<h2><span class="section-number">4.3. </span>Flash SPI NOR Flash<a class="headerlink" href="#flash-spi-nor-flash" title="Link to this heading">ï</a></h2>
<p>The phyCORE-i.MX 8M Pluss are optionally equipped with SPI NOR Flash. To boot from SPI
Flash, set <a class="reference internal" href="#imx8mp-head-bootswitch"><span class="std std-ref">bootmode switch (S3)</span></a> to <strong>SPI NOR</strong>. The SPI Flash is usually quite small.
The <strong>phyCORE-i.MX8M Plus Kit</strong> only has 32MB SPI NOR flash populated. Only the
bootloader and the environment can be stored. The kernel, device tree, and file
system are taken from e.MMC by default.</p>
<p>The SPI NOR flash partition table is defined in the U-Boot environment. It can
be printed with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; printenv mtdparts
mtdparts=30bb0000.spi:3840k(u-boot),128k(env),128k(env:redund),-(none)
</pre></div>
</div>
<section id="flash-spi-nor-flash-from-network">
<h3><span class="section-number">4.3.1. </span>Flash SPI NOR Flash from Network<a class="headerlink" href="#flash-spi-nor-flash-from-network" title="Link to this heading">ï</a></h3>
<p>The SPI NOR can contain the bootloader and environment to boot from. The arm64
kernel can not decompress itself, the image size extends the SPI NOR flash
populated on the phyCORE-i.MX 8M Plus.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>A working network is necessary! <a class="reference internal" href="#imx8mp-head-development"><span class="std std-ref">Setup Network Host</span></a></p>
</div>
<section id="flash-spi-nor-from-network-in-kernel-on-target">
<h4><span class="section-number">4.3.1.1. </span>Flash SPI NOR from Network in kernel on Target<a class="headerlink" href="#flash-spi-nor-from-network-in-kernel-on-target" title="Link to this heading">ï</a></h4>
<ul>
<li><p>Copy the image from the host to the target:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>scp<span class="w"> </span>imx-boot-phyboard-pollux-imx8mp-3-fspi.bin-flash_evk_flexspi<span class="w"> </span>root@192.168.3.11:/root
</pre></div>
</div>
</li>
<li><p>Find the number of blocks to erase of the U-boot partition:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mtdinfo<span class="w"> </span>/dev/mtd0
<span class="go">mtd0</span>
<span class="go">Name:                           u-boot</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                65536 bytes, 64.0 KiB</span>
<span class="go">Amount of eraseblocks:          60 (3932160 bytes, 3.7 MiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:0</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>
</pre></div>
</div>
</li>
<li><p>Erase the U-Boot partition and flash it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>flash_erase<span class="w"> </span>/dev/mtd0<span class="w"> </span>0x0<span class="w"> </span><span class="m">60</span>
<span class="gp">target:~$ </span>flashcp<span class="w"> </span>imx-boot-phyboard-pollux-imx8mp-3-fspi.bin-flash_evk_flexspi<span class="w"> </span>/dev/mtd0
</pre></div>
</div>
</li>
</ul>
</section>
<section id="flash-spi-nor-from-network-in-u-boot-on-target">
<h4><span class="section-number">4.3.1.2. </span>Flash SPI NOR from Network in U-Boot on Target<a class="headerlink" href="#flash-spi-nor-from-network-in-u-boot-on-target" title="Link to this heading">ï</a></h4>
<p>Similar to updating the e.MMC over a network, be sure to set up the development
host correctly. The IP needs to be set to 192.168.3.10, the netmask to
255.255.255.0, and a TFTP server needs to be available. Before reading and
writing is possible, the SPI NOR flash needs to be probed:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; sf probe
SF: Detected mt25qu512a with page size 256 Bytes, erase size 64 KiB, total 64 MiB
</pre></div>
</div>
<ul>
<li><p>A specially formatted U-Boot image for the SPI NOR flash is used. Ensure you
use the correct image file. Load the image over tftp, erase and write the
bootloader to the flash:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; tftp ${loadaddr} imx-boot-phyboard-pollux-imx8mp-3-fspi.bin-flash_evk_flexspi
u-boot=&gt; sf update ${loadaddr} 0 ${filesize}
device 0 offset 0x0, size 0x1c0b20
1641248 bytes written, 196608 bytes skipped in 4.768s, speed 394459 B/s
</pre></div>
</div>
</li>
<li><p>Erase the environment partition as well. This way, the environment can be
written after booting from SPI NOR flash:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; sf erase 0x400000 0x100000
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="flash-spi-nor-flash-from-sd-card">
<h3><span class="section-number">4.3.2. </span>Flash SPI NOR Flash from SD card<a class="headerlink" href="#flash-spi-nor-flash-from-sd-card" title="Link to this heading">ï</a></h3>
<p>The bootloader on SPI NOR flash can be also flashed with SD card.</p>
<section id="flash-spi-nor-from-sd-card-in-kernel-on-target">
<h4><span class="section-number">4.3.2.1. </span>Flash SPI NOR from SD card in kernel on Target<a class="headerlink" href="#flash-spi-nor-from-sd-card-in-kernel-on-target" title="Link to this heading">ï</a></h4>
<ul>
<li><p>Copy the SPI NOR flash U-boot image
imx-boot-phyboard-pollux-imx8mp-3-fspi.bin-flash_evk_flexspi to the first
partition on the SD card.</p></li>
<li><p>Mount the SD card:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mount<span class="w"> </span>/dev/mmcblk1p1<span class="w"> </span>/mnt
</pre></div>
</div>
</li>
<li><p>Find the number of blocks to erase of the U-Boot partition:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mtdinfo<span class="w"> </span>/dev/mtd0
<span class="go">mtd0</span>
<span class="go">Name:                           u-boot</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                65536 bytes, 64.0 KiB</span>
<span class="go">Amount of eraseblocks:          60 (3932160 bytes, 3.7 MiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:0</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>
</pre></div>
</div>
</li>
<li><p>Erase the u-boot partition and flash it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>flash_erase<span class="w"> </span>/dev/mtd0<span class="w"> </span>0x0<span class="w"> </span><span class="m">60</span>
<span class="gp">target:~$ </span>flashcp<span class="w"> </span>/mnt/imx-boot-phyboard-pollux-imx8mp-3-fspi.bin-flash_evk_flexspi<span class="w"> </span>/dev/mtd0
</pre></div>
</div>
</li>
</ul>
</section>
<section id="flash-spi-nor-from-sd-card-in-u-boot-on-target">
<h4><span class="section-number">4.3.2.2. </span>Flash SPI NOR from SD card in U-Boot on Target<a class="headerlink" href="#flash-spi-nor-from-sd-card-in-u-boot-on-target" title="Link to this heading">ï</a></h4>
<ul>
<li><p>Copy the SPI NOR flash U-boot image
imx-boot-phyboard-pollux-imx8mp-3-fspi.bin-flash_evk_flexspi to the first
partition on the SD card.</p></li>
<li><p>Before reading and writing are possible, the SPI-NOR flash
needs to be probed:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; sf probe
SF: Detected n25q256ax1 with page size 256 Bytes, erase size 64 KiB, total 32 MiB
</pre></div>
</div>
</li>
<li><p>A specially formatted U-boot image for the SPI NOR flash is used. Ensure you
use the correct image file. Load the image from the SD card, erase and write
the bootloader to the flash:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; mmc dev 1
u-boot=&gt; fatload mmc 1:1 ${loadaddr} imx-boot-phyboard-pollux-imx8mp-3-fspi.bin-flash_evk_flexspi
u-boot=&gt; sf update ${loadaddr} 0 ${filesize}
</pre></div>
</div>
</li>
<li><p>Erase the environment partition as well. This way, the environment can be
written after booting from SPI NOR flash:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; sf erase 0x400000 0x100000
</pre></div>
</div>
</li>
</ul>
</section>
</section>
</section>
<section id="rauc">
<h2><span class="section-number">4.4. </span>RAUC<a class="headerlink" href="#rauc" title="Link to this heading">ï</a></h2>
<p>The RAUC (Robust Auto-Update Controller) mechanism support has been added to
meta-ampliphy. It controls the procedure of updating a device with new firmware.
This includes updating the Linux kernel, Device Tree, and root filesystem.
PHYTEC has written an online manual on how we have intergraded RAUC into our
BSPs: <a class="reference external" href="https://www.phytec.de/cdocuments/?doc=F4DiM">L-1006e.A6 RAUC Update &amp; Device Management Manual</a>.</p>
</section>
<section id="efi-boot">
<h2><span class="section-number">4.5. </span>EFI Boot<a class="headerlink" href="#efi-boot" title="Link to this heading">ï</a></h2>
<p>Standardboot in U-Boot also supports booting distros over efi. By default the
U-Boot will search for a bootscript first, which is used to boot our Ampliphy
distro. If it does not find any bootscript, it will search for bootable efi
applications. So for booting over efi just make sure you donât have our distro
installed.</p>
<section id="disable-booting-with-efi">
<h3><span class="section-number">4.5.1. </span>Disable booting with efi<a class="headerlink" href="#disable-booting-with-efi" title="Link to this heading">ï</a></h3>
<p>To disable booting with efi you have to set the <code class="docutils literal notranslate"><span class="pre">doefiboot</span></code> variable to 0.
Also make sure you do not have <code class="docutils literal notranslate"><span class="pre">efi</span></code> or <code class="docutils literal notranslate"><span class="pre">efi_mgr</span></code> specified in the
<code class="docutils literal notranslate"><span class="pre">bootmeths</span></code> environment variable.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; setenv doefiboot 0</span>
<span class="go">u-boot=&gt; env save; env save;</span>
</pre></div>
</div>
</section>
<section id="switch-to-only-efi-boot">
<h3><span class="section-number">4.5.2. </span>Switch to only efi boot<a class="headerlink" href="#switch-to-only-efi-boot" title="Link to this heading">ï</a></h3>
<p>If you want to only boot with efi, you can set the <code class="docutils literal notranslate"><span class="pre">bootmeths</span></code> environment
variable to efi. Also make sure you have the <code class="docutils literal notranslate"><span class="pre">doefiboot</span></code> environment variable
set to 1.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; setenv bootmeths efi</span>
<span class="go">u-boot=&gt; env save; env save;</span>
</pre></div>
</div>
</section>
<section id="installing-a-distro">
<h3><span class="section-number">4.5.3. </span>Installing a distro<a class="headerlink" href="#installing-a-distro" title="Link to this heading">ï</a></h3>
<p>With efi you can install and boot different distros like openSUSE, Fedora or
Debian. First you have to get the iso Image from their website. For example:</p>
<p><a class="reference external" href="https://cdimage.debian.org/debian-cd/current/arm64/iso-dvd/">https://cdimage.debian.org/debian-cd/current/arm64/iso-dvd/</a></p>
<p>Then copy the .iso file to a usb stick for example. Make sure you select the
correct device:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo dd if=file.iso of=/dev/sdx bs=1M conv=fsync status=progress</span>
</pre></div>
</div>
<p>Insert the USB stick into the board and boot it. GRUB will then prompt you with
a menu where you can select what to do. Here select install. Then you have to
click through the installation menu. This is relatively straightforward and
differs a bit for every distro. You can install the distro for example to emmc
(mmc 2) or sdcard (mmc 1). Make sure you do not overwrite
your U-Boot during the install. Best to choose a different medium to install to
than the U-Boot is stored on. Otherwise manual partitioning will be required.
The automatic partitioning will start at the beginning of the disk. To not
overwrite the U-Boot, use an offset of 4MiB at the beginning of the disk.</p>
<p>During the Installation of Debian you will be asked, if you want to Force the
GRUB installation to the EFI removable media path. Select no. Also select no,
when you will be asked if you want to update the NVRAM variables. Otherwise the
grub-dummy installation step will fail and you will be sent back to the
âForce GRUB installationâ prompt.</p>
<p>After the installation is complete, reboot the board and remove the
installation medium (USB-stick). The board should then boot the distro you
installed.</p>
<p>If that does not happen, check if there is a boot option set for the distro.
The easiest way is with the <code class="docutils literal notranslate"><span class="pre">eficonfig</span></code> command.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; eficonfig</span>
</pre></div>
</div>
<p>That will open a menu. Then you can select <code class="docutils literal notranslate"><span class="pre">Edit</span> <span class="pre">Boot</span> <span class="pre">Option</span></code>. It will show
you the current boot options. If this is empty or you donât find your distro,
select <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">Boot</span> <span class="pre">Option</span></code> to add a new one. For debian for example you only
need to set the description and the file. You can enter whatever you want into
the description field. When you select the file field, you can select the disc
you installed the distro on and partition number one. For example
âmmc 2:1â for emmc, or âmmc 1:1â for sdcard. The file you
need to select is at <code class="docutils literal notranslate"><span class="pre">EFI/debian/grubaa64.efi</span></code>. After that save, quit and
reset the board. The board should then boot into debian.</p>
</section>
</section>
</section>
<section id="development">
<span id="imx8mp-head-development"></span><h1><span class="section-number">5. </span>Development<a class="headerlink" href="#development" title="Link to this heading">ï</a></h1>
<p>Starting with this release, the boot behaviour in U-Boot changes. Before, kernel
and device tree came as separate blobs. Now, both will be included in a single
FIT image blob. Further, the logic for booting the PHYTEC ampliphy distributions
is moved to a boot script which itself is part of a separate FIT image blob.
To revert to the old style of booting, you may do</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">run legacyboot</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This way of booting is deprecated and will be removed in the next release.
By default, booting via this command will return an error as kernel and
device tree are missing in the boot partition.</p>
</div>
<section id="standalone-build-preparation">
<h2><span class="section-number">5.1. </span>Standalone Build preparation<a class="headerlink" href="#standalone-build-preparation" title="Link to this heading">ï</a></h2>
<p>In this section, we describe how to build the U-Boot and the Linux kernel
without using the <a class="reference external" href="https://www.yoctoproject.org/">Yocto Project</a>. This
procedure makes the most sense for development. The U-Boot source code,
the Linux kernel, and all other git repositories are available on <a class="reference external" href="https://github.com/phytec">GitHub
`Git server</a> at <a class="reference external" href="https://github.com/phytec">https://github.com/phytec</a>.</p>
<section id="git-repositories">
<h3><span class="section-number">5.1.1. </span>Git Repositories<a class="headerlink" href="#git-repositories" title="Link to this heading">ï</a></h3>
<ul>
<li><p>Used U-Boot repository:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>git://git.phytec.de/u-boot-phytec-imx
</pre></div>
</div>
</li>
<li><p>Our U-Boot is based on the u-boot-phytec-imx and adds board-specific patches.</p></li>
<li><p>Used Linux kernel repository:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>https://github.com/phytec/linux-phytec-imx
</pre></div>
</div>
</li>
<li><p>Our i.MX 8M Plus kernel is based on the linux-phytec-imx kernel.</p></li>
</ul>
<p>To find out which u-boot and kernel tags to use for a specific board, have a
look at your BSP source folder:</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>meta-phytec/recipes-kernel/linux/linux-phytec-imx_*.bb
meta-phytec/recipes-bsp/u-boot/u-boot-phytec-imx_*.bb
</pre></div>
</div>
</div></blockquote>
</section>
<section id="get-the-sdk">
<h3><span class="section-number">5.1.2. </span>Get the SDK<a class="headerlink" href="#get-the-sdk" title="Link to this heading">ï</a></h3>
<p>You can download the SDK <a class="reference external" href="https://download.phytec.de/Software/Linux/BSP-Yocto-i.MX8MP/BSP-Yocto-NXP-i.MX8MP-PD26.1.0/sdk/ampliphy-vendor-xwayland/">here</a>, or build it yourself with Yocto:</p>
<ul>
<li><p>Move to the Yocto build directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span><span class="nb">source</span><span class="w"> </span>sources/poky/oe-init-build-env
<span class="gp">host:~$ </span>bitbake<span class="w"> </span>-c<span class="w"> </span>populate_sdk<span class="w"> </span>phytec-qt6demo-image<span class="w"> </span><span class="c1"># or another image</span>
</pre></div>
</div>
</li>
</ul>
<p>After a successful build the SDK installer is deployed to <code class="docutils literal notranslate"><span class="pre">build/deploy*/sdk</span></code>.</p>
</section>
<section id="install-the-sdk">
<h3><span class="section-number">5.1.3. </span>Install the SDK<a class="headerlink" href="#install-the-sdk" title="Link to this heading">ï</a></h3>
<ul>
<li><p>Set correct permissions and install the SDK:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>chmod<span class="w"> </span>+x<span class="w"> </span>phytec-ampliphy-vendor-glibc-x86_64-phytec-qt6demo-image-cortexa53-crypto-toolchain-5.2.x.sh
<span class="gp">host:~$ </span>./phytec-ampliphy-vendor-glibc-x86_64-phytec-qt6demo-image-cortexa53-crypto-toolchain-5.2.x.sh
<span class="go">============================================================================================================</span>
<span class="go">Enter target directory for SDK (default: /opt/ampliphy-vendor/5.2.x):</span>
<span class="go">You are about to install the SDK to &quot;/opt/ampliphy-vendor/5.2.x&quot;. Proceed [Y/n]? Y</span>
<span class="go">Extracting SDK...done</span>
<span class="go">Setting it up...done</span>
<span class="go">SDK has been successfully set up and is ready to be used.</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="using-the-sdk">
<h3><span class="section-number">5.1.4. </span>Using the SDK<a class="headerlink" href="#using-the-sdk" title="Link to this heading">ï</a></h3>
<p>Activate the toolchain for your shell by sourcing the <em>environment-setup</em> file
in the toolchain directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span><span class="nb">source</span><span class="w"> </span>/opt/ampliphy-vendor/5.2.x/environment-setup-cortexa53-crypto-phytec-linux
</pre></div>
</div>
</section>
<section id="installing-required-tools">
<h3><span class="section-number">5.1.5. </span>Installing Required Tools<a class="headerlink" href="#installing-required-tools" title="Link to this heading">ï</a></h3>
<p>Building Linux and U-Boot out-of-tree requires some additional host tool
dependencies to be installed. For Ubuntu you can install them with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>bison<span class="w"> </span>flex<span class="w"> </span>libssl-dev
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Using the SDK on older host distributions (e.g., Ubuntu 20.04 LTS) with Scarthgap NXP-based BSPs
can cause issues when building U-Boot or Linux kernel tools for host use. If you encounter an
âundefined referenceâ error, a workaround is to prepend the hostâs binutils to the PATH.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">host$ export PATH=/usr/bin:$PATH</span>
</pre></div>
</div>
<p>Run this after sourcing the SDK <em>environment-setup</em> file.</p>
<p>Note, SDK issue has not been observed on newer distributions, such as Ubuntu 22.04, which appear to work
without requiring any modifications.</p>
</div>
</section>
</section>
<section id="u-boot-standalone-build">
<span id="imx8mp-head-development-build-uboot"></span><h2><span class="section-number">5.2. </span>U-Boot standalone build<a class="headerlink" href="#u-boot-standalone-build" title="Link to this heading">ï</a></h2>
<section id="get-the-source-code">
<h3><span class="section-number">5.2.1. </span>Get the source code<a class="headerlink" href="#get-the-source-code" title="Link to this heading">ï</a></h3>
<ul>
<li><p>Get the U-Boot sources:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>git<span class="w"> </span>clone<span class="w"> </span>git://git.phytec.de/u-boot-phytec-imx
</pre></div>
</div>
</li>
<li><p>To get the correct <em>U-Boot</em> <strong>tag</strong> you need to take a look at our release
notes, which can be found here: <a class="reference external" href="https://git.phytec.de/phy2octo/tree/releasenotes?h=imx8mp">release notes</a></p></li>
<li><p>The <strong>tag</strong> used in this release is called v2025.04-2.0.0-phyX</p></li>
<li><p>Check out the needed <em>U-Boot</em> <strong>tag</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span><span class="nb">cd</span><span class="w"> </span>~/u-boot-phytec-imx/
<span class="gp">host:~/u-boot-phytec-imx$ </span>git<span class="w"> </span>fetch<span class="w"> </span>--all<span class="w"> </span>--tags
<span class="gp">host:~/u-boot-phytec-imx$ </span>git<span class="w"> </span>checkout<span class="w"> </span>tags/v2025.04-2.0.0-phyX
</pre></div>
</div>
</li>
<li><p>Set up a build environment:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/u-boot-phytec-imx$ </span><span class="nb">source</span><span class="w"> </span>/opt/ampliphy-vendor/5.2.x/environment-setup-cortexa53-crypto-phytec-linux
</pre></div>
</div>
</li>
</ul>
</section>
<section id="get-the-needed-binaries">
<h3><span class="section-number">5.2.2. </span>Get the needed binaries<a class="headerlink" href="#get-the-needed-binaries" title="Link to this heading">ï</a></h3>
<p>To build the bootloader, you need to <strong>copy</strong> these <strong>files</strong> to your u-boot-phytec-imx
<strong>build directory</strong> and rename them to fit with <em>mkimage</em> script:</p>
<ul class="simple">
<li><p><strong>ARM Trusted firmware binary</strong> (<em>mkimage tool</em> compatible format
<strong>bl31.bin</strong>): bl31-imx8mp.bin</p></li>
<li><p><strong>OPTEE image</strong> (optional): tee.bin</p></li>
<li><p><strong>DDR firmware files</strong> (<em>mkimage tool</em> compatible format
<strong>lpddr4_[i,d]mem_*d_*.bin</strong>):
lpddr4_dmem_1d_*.bin, lpddr4_dmem_2d_*.bin, lpddr4_imem_1d_*.bin,
lpddr4_imem_2d_*.bin</p></li>
</ul>
<p>If you already built our BSP with Yocto, you can get the
bl31-imx8mp.bin, tee.bin and lpddr4_*.bin from the directory mentioned
here: <a class="reference internal" href="#imx8mp-head-images"><span class="std std-ref">BSP Images</span></a></p>
<p>Or you can download the files here: <a class="reference external" href="https://download.phytec.de/Software/Linux/BSP-Yocto-i.MX8MP/BSP-Yocto-NXP-i.MX8MP-PD26.1.0/images/ampliphy-vendor-xwayland/phyboard-pollux-imx8mp-3/imx-boot-tools/">https://download.phytec.de/Software/Linux/BSP-Yocto-i.MX8MP/BSP-Yocto-NXP-i.MX8MP-PD26.1.0/images/ampliphy-vendor-xwayland/phyboard-pollux-imx8mp-3/imx-boot-tools/</a></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure you rename the files you need so that they are compatible with the
<em>mkimage tool</em>.</p>
</div>
</section>
<section id="build-the-bootloader">
<h3><span class="section-number">5.2.3. </span>Build the bootloader<a class="headerlink" href="#build-the-bootloader" title="Link to this heading">ï</a></h3>
<ul>
<li><p>build flash.bin (imx-boot):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/u-boot-phytec-imx$ </span>make<span class="w"> </span>phycore-imx8mp_defconfig
<span class="gp">host:~/u-boot-phytec-imx$ </span>make<span class="w"> </span>flash.bin
</pre></div>
</div>
</li>
</ul>
</section>
<section id="flash-the-bootloader-to-a-block-device">
<h3><span class="section-number">5.2.4. </span>Flash the bootloader to a block device<a class="headerlink" href="#flash-the-bootloader-to-a-block-device" title="Link to this heading">ï</a></h3>
<p>The flash.bin can be found at u-boot-phytec-imx/ directory and now can be
flashed. A chip-specific offset is needed:</p>
<table class="docutils align-default" id="offset-table">
<thead>
<tr class="row-odd"><th class="head"><p>SoC</p></th>
<th class="head"><p>Offset User Area</p></th>
<th class="head"><p>Offset Boot Partition</p></th>
<th class="head"><p>e.MMC Device</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>i.MX 8M Plus</p></td>
<td><p>32 kiB</p></td>
<td><p>0 kiB</p></td>
<td><p>/dev/mmcblk2</p></td>
</tr>
</tbody>
</table>
<p>E.g. flash SD card:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/u-boot-phytec-imx$ </span>sudo<span class="w"> </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>flash.bin<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/sd<span class="o">[</span>x<span class="o">]</span><span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">1024</span><span class="w"> </span><span class="nv">seek</span><span class="o">=</span><span class="m">32</span><span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The specific offset values are also declared in the Yocto variables
âBOOTLOADER_SEEKâ and âBOOTLOADER_SEEK_EMMCâ</p>
</div>
</section>
<section id="build-u-boot-with-a-fixed-ram-size">
<h3><span class="section-number">5.2.5. </span>Build U-Boot With a Fixed RAM Size<a class="headerlink" href="#build-u-boot-with-a-fixed-ram-size" title="Link to this heading">ï</a></h3>
<p>If you cannot boot your system anymore because the hardware introspection in the
EEPROM is damaged or deleted, you can create a flash.bin with a fixed ram size.
You should still contact support and flash the correct EEPROM data, as this
could lead to unexpected behavior.</p>
<p>Follow the steps to get the U-boot sources and check the correct branch in the
<strong>Build U-Boot</strong> section.</p>
<p>Edit the file configs/phycore-imx8mp_defconfig:</p>
<div class="highlight-kconfig notranslate"><div class="highlight"><pre><span></span>CONFIG_TARGET_PHYCORE_IMX8MP=y
CONFIG_PHYCORE_IMX8MP_RAM_SIZE_FIX=y
<span class="c1"># CONFIG_PHYCORE_IMX8MP_RAM_SIZE_1GB=y</span>
<span class="c1"># CONFIG_PHYCORE_IMX8MP_RAM_SIZE_2GB=y</span>
<span class="c1"># CONFIG_PHYCORE_IMX8MP_RAM_SIZE_4GB=y</span>
</pre></div>
</div>
<p>Choose the correct RAM size as populated on the board and uncomment the line for
this ram size.
After saving the changes, follow the remaining steps from <a class="reference internal" href="#imx8mp-head-development-build-uboot"><span class="std std-ref">Build U-Boot</span></a>.</p>
</section>
<section id="build-u-boot-with-a-fixed-ram-size-and-frequency">
<h3><span class="section-number">5.2.6. </span>Build U-Boot With a Fixed RAM Size and Frequency<a class="headerlink" href="#build-u-boot-with-a-fixed-ram-size-and-frequency" title="Link to this heading">ï</a></h3>
<p>Starting with PD23.1.0 NXP or PD24.1.2 mainline release, the phyCORE-i.MX 8M Plus SoMs
with revision 1549.3 and newer also support 2GHz RAM timings. These will be
enabled for supported boards automatically, but they can also be enabled or
disabled manually.</p>
<p>Edit the file configs/phycore-imx8mp_defconfig.
The fixed RAM size with 2GHz timings will be used:</p>
<div class="highlight-kconfig notranslate"><div class="highlight"><pre><span></span>CONFIG_TARGET_PHYCORE_IMX8MP=y
CONFIG_PHYCORE_IMX8MP_RAM_SIZE_FIX=y
<span class="c1"># CONFIG_PHYCORE_IMX8MP_RAM_SIZE_1GB=y</span>
<span class="c1"># CONFIG_PHYCORE_IMX8MP_RAM_SIZE_2GB=y</span>
<span class="c1"># CONFIG_PHYCORE_IMX8MP_RAM_SIZE_4GB=y</span>
CONFIG_PHYCORE_IMX8MP_RAM_FREQ_FIX=y
CONFIG_PHYCORE_IMX8MP_USE_2GHZ_RAM_TIMINGS=y
</pre></div>
</div>
<p>After saving the changes, follow the remaining steps from <a class="reference internal" href="#imx8mp-head-development-build-uboot"><span class="std std-ref">Build U-Boot</span></a>.</p>
</section>
<section id="build-u-boot-with-a-fixed-ram-frequency">
<h3><span class="section-number">5.2.7. </span>Build U-Boot With a Fixed RAM Frequency<a class="headerlink" href="#build-u-boot-with-a-fixed-ram-frequency" title="Link to this heading">ï</a></h3>
<p>Starting with PD24.1.2 mainline release or PD24.1.0 NXP release, U-Boot can
also be built with just fixed RAM Frequency while the RAM size will still be
used from EEPROM.</p>
<p>Edit the file configs/phycore-imx8mp_defconfig.
The RAM size from EEPROM with fixed frequency will be used:</p>
<div class="highlight-kconfig notranslate"><div class="highlight"><pre><span></span>CONFIG_TARGET_PHYCORE_IMX8MP=y
CONFIG_PHYCORE_IMX8MP_RAM_FREQ_FIX=y
<span class="c1"># CONFIG_PHYCORE_IMX8MP_USE_2GHZ_RAM_TIMINGS=y</span>
<span class="c1"># CONFIG_PHYCORE_IMX8MP_USE_1_5GHZ_RAM_TIMINGS=y</span>
</pre></div>
</div>
<p>After saving the changes, follow the remaining steps from <a class="reference internal" href="#imx8mp-head-development-build-uboot"><span class="std std-ref">Build U-Boot</span></a>.</p>
</section>
</section>
<section id="kernel-standalone-build">
<h2><span class="section-number">5.3. </span>Kernel standalone build<a class="headerlink" href="#kernel-standalone-build" title="Link to this heading">ï</a></h2>
<p>The kernel is packaged in a FIT image together with the device tree. U-Boot has
been adapted to be able to load a FIT image and boot the kernel contained in it.
As a result, the kernel Image has to packaged in a FIT image.</p>
<section id="setup-sources">
<h3><span class="section-number">5.3.1. </span>Setup sources<a class="headerlink" href="#setup-sources" title="Link to this heading">ï</a></h3>
<ul>
<li><p>The used linux-phytec-imx branch can be found in the <a class="reference external" href="https://git.phytec.de/phy2octo/tree/releasenotes?h=imx8mp">release notes</a></p></li>
<li><p>The tag needed for this release is called v6.12.20-2.0.0-phyX</p></li>
<li><p>Check out the needed linux-phytec-imx tag:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/phytec/linux-phytec-imx
<span class="gp">host:~$ </span><span class="nb">cd</span><span class="w"> </span>~/linux-phytec-imx/
<span class="gp">host:~/linux-phytec-imx$ </span>git<span class="w"> </span>fetch<span class="w"> </span>--all<span class="w"> </span>--tags
<span class="gp">host:~/linux-phytec-imx$ </span>git<span class="w"> </span>checkout<span class="w"> </span>tags/v6.12.20-2.0.0-phyX
</pre></div>
</div>
</li>
<li><p>For committing changes, it is highly recommended to switch to a new branch:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-imx$ </span>git<span class="w"> </span>switch<span class="w"> </span>--create<span class="w"> </span>&lt;new-branch&gt;
</pre></div>
</div>
</li>
<li><p>Set up a build environment:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-imx$ </span><span class="nb">source</span><span class="w"> </span>/opt/ampliphy-vendor/5.2.x/environment-setup-cortexa53-crypto-phytec-linux
</pre></div>
</div>
</li>
</ul>
</section>
<section id="build-the-kernel">
<h3><span class="section-number">5.3.2. </span>Build the kernel<a class="headerlink" href="#build-the-kernel" title="Link to this heading">ï</a></h3>
<ul>
<li><p>Build the linux kernel:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-imx$ </span>make<span class="w"> </span>imx8_phytec_defconfig
<span class="gp">host:~/linux-phytec-imx$ </span>make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span>
</pre></div>
</div>
</li>
<li><p>Install kernel modules to e.g. NFS directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-imx$ </span>make<span class="w"> </span><span class="nv">INSTALL_MOD_PATH</span><span class="o">=</span>/home/&lt;user&gt;/&lt;rootfspath&gt;<span class="w"> </span>modules_install
</pre></div>
</div>
</li>
<li><p>The Image can be found at ~/linux-phytec-imx/arch/arm64/boot/Image.gz</p></li>
<li><p>The dtb can be found at
~/linux-phytec-imx/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dtb</p></li>
<li><p>For (re-)building only Devicetrees and -overlays, it is sufficient to run</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-imx$ </span>make<span class="w"> </span>dtbs
</pre></div>
</div>
<p>or, to build a specific dtb (e.g. imx8mp-phyboard-pollux-rdk.dtb):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-imx$ </span>make<span class="w"> </span>freescale/imx8mp-phyboard-pollux-rdk.dtb
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are facing the following build issue:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>scripts/dtc/yamltree.c:9:10: fatal error: yaml.h: No such file or directory
</pre></div>
</div>
<p>Make sure you installed the package <em>âlibyaml-devâ</em> on your host system:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>libyaml-dev
</pre></div>
</div>
</div>
</section>
<section id="package-the-kernel-in-a-fit-image">
<h3><span class="section-number">5.3.3. </span>Package the kernel in a FIT image<a class="headerlink" href="#package-the-kernel-in-a-fit-image" title="Link to this heading">ï</a></h3>
<p>To simply replace the kernel, you will need an <code class="docutils literal notranslate"><span class="pre">image</span> <span class="pre">tree</span> <span class="pre">source</span></code> (.its)
file. If you already built our BSP with Yocto, you can get the its file from the
directory mentioned here: <a class="reference internal" href="#imx8mp-head-images"><span class="std std-ref">BSP Images</span></a> Or you can download the file here:
<a class="reference external" href="https://download.phytec.de/Software/Linux/BSP-Yocto-i.MX8MP/BSP-Yocto-NXP-i.MX8MP-PD26.1.0/images/ampliphy-vendor-xwayland/phyboard-pollux-imx8mp-3/">https://download.phytec.de/Software/Linux/BSP-Yocto-i.MX8MP/BSP-Yocto-NXP-i.MX8MP-PD26.1.0/images/ampliphy-vendor-xwayland/phyboard-pollux-imx8mp-3/</a></p>
<p>Copy the .its file to the current working directory, create a link to the kernel
image and create the final fitImage with mkimage.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-imx$ </span>cp<span class="w"> </span>/path/to/yocto/deploydir/fitimage-its*.its<span class="w"> </span>.
<span class="go">                  &amp;&amp; ln -s arch/arm64/boot/Image.gz linux.bin</span>
<span class="go">                  &amp;&amp; uboot-mkimage -f fitImage-its*.its fitImage</span>
</pre></div>
</div>
</section>
<section id="copy-fit-image-and-kernel-modules-to-sd-card">
<h3><span class="section-number">5.3.4. </span>Copy FIT image and kernel modules to SD card<a class="headerlink" href="#copy-fit-image-and-kernel-modules-to-sd-card" title="Link to this heading">ï</a></h3>
<p>When one-time boot via netboot is not sufficient, the FIT image along with the
kernel modules may be copied directly to a mounted SD card.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/linux-phytec-imx$ </span>cp<span class="w"> </span>fitImage<span class="w"> </span>/path/to/sdcard/boot/
<span class="gp">host:~/linux-phytec-imx$ </span>make<span class="w"> </span><span class="nv">INSTALL_MOD_PATH</span><span class="o">=</span>/path/to/sdcard/root/<span class="w"> </span>modules_install
</pre></div>
</div>
</section>
</section>
<section id="working-with-uuu">
<h2><span class="section-number">5.4. </span>Working with UUU<a class="headerlink" href="#working-with-uuu" title="Link to this heading">ï</a></h2>
<p>The Universal Update Utility (UUU) by NXP is software to execute on the host for
loading and running the bootloader on the board through SDP (Serial Download
Protocol). For detailed information visit <a class="reference external" href="https://github.com/nxp-imx/mfgtools">https://github.com/nxp-imx/mfgtools</a> or
download the <a class="reference external" href="https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/imx-processors/140261/1/UUU.pdf">Official UUU-tool documentation</a>.</p>
<section id="host-preparations-for-uuu-usage">
<h3><span class="section-number">5.4.1. </span>Host preparations for UUU Usage<a class="headerlink" href="#host-preparations-for-uuu-usage" title="Link to this heading">ï</a></h3>
<ul>
<li><p>Follow the instructions from <a class="reference external" href="https://github.com/nxp-imx/mfgtools#linux">https://github.com/nxp-imx/mfgtools#linux</a>.</p></li>
<li><p>If you built UUU from source, add it to <code class="docutils literal notranslate"><span class="pre">PATH</span></code>:</p>
<p>This BASH command adds uuu only temporarily to <code class="docutils literal notranslate"><span class="pre">PATH</span></code>. To add it
permanently, add this line to <code class="docutils literal notranslate"><span class="pre">~/.bashrc</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export PATH=~/mfgtools/uuu/:&quot;$PATH&quot;</span>
</pre></div>
</div>
</li>
<li><p>Set udev rules (documented in <code class="docutils literal notranslate"><span class="pre">uuu</span> <span class="pre">-udev</span></code>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>sh<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;uuu -udev &gt;&gt; /etc/udev/rules.d/70-uuu.rules&quot;</span>
<span class="gp">host:~$ </span>sudo<span class="w"> </span>udevadm<span class="w"> </span>control<span class="w"> </span>--reload
</pre></div>
</div>
</li>
</ul>
</section>
<section id="get-images">
<h3><span class="section-number">5.4.2. </span>Get Images<a class="headerlink" href="#get-images" title="Link to this heading">ï</a></h3>
<p>Download imx-boot from our server or get it from your Yocto build directory at
build/deploy-ampliphy-vendor/images/phyboard-pollux-imx8mp-3/. For flashing a wic
image to e.MMC, you will also need
phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic.</p>
</section>
<section id="prepare-target">
<h3><span class="section-number">5.4.3. </span>Prepare Target<a class="headerlink" href="#prepare-target" title="Link to this heading">ï</a></h3>
<p>Set the <a class="reference internal" href="#imx8mp-head-bootswitch"><span class="std std-ref">bootmode switch (S3)</span></a> to <strong>USB Serial Download</strong>. Also, connect USB port
<a class="reference internal" href="#imx8mp-head-components"><span class="std std-ref">X5 (upper connector)</span></a> to your host.</p>
</section>
<section id="starting-bootloader-via-uuu-tool">
<h3><span class="section-number">5.4.4. </span>Starting bootloader via UUU-Tool<a class="headerlink" href="#starting-bootloader-via-uuu-tool" title="Link to this heading">ï</a></h3>
<p>Execute and power up the board:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>uuu<span class="w"> </span>-b<span class="w"> </span>spl<span class="w"> </span>imx-boot
</pre></div>
</div>
<p>You can see the bootlog on the console via <a class="reference internal" href="#imx8mp-head-components"><span class="std std-ref">(X1)</span></a>, as usual.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The default boot command when booting with UUU is set to fastboot. If you
want to change this, please adjust the environment variable bootcmd_mfg in
U-Boot prompt with setenv bootcmd_mfg. Please note, when booting with UUU the
default environment is loaded. <code class="docutils literal notranslate"><span class="pre">saveenv</span></code> has no effect. If you want to
change the boot command permanently for uuu-boot, you need to change this in
U-Boot code.</p>
</div>
</section>
<section id="flashing-u-boot-image-to-e-mmc-via-uuu">
<h3><span class="section-number">5.4.5. </span>Flashing U-boot Image to e.MMC via UUU<a class="headerlink" href="#flashing-u-boot-image-to-e-mmc-via-uuu" title="Link to this heading">ï</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>UUU flashes U-boot into e.MMC BOOT (hardware) boot partitions, and it sets
the BOOT_PARTITION_ENABLE in the e.MMC! This is a problem since we want the
bootloader to reside in the e.MMC USER partition. Flashing next U-Boot
version .wic image and not disabling BOOT_PARTITION_ENABLE bit will result in
device always using U-boot saved in BOOT partitions. To fix this in U-Boot:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; mmc partconf 2 0 0 0</span>
<span class="go">u-boot=&gt; mmc partconf 2</span>
<span class="go">EXT_CSD[179], PARTITION_CONFIG:</span>
<span class="go">BOOT_ACK: 0x0</span>
<span class="go">BOOT_PARTITION_ENABLE: 0x0</span>
<span class="go">PARTITION_ACCESS: 0x0</span>
</pre></div>
</div>
<p>or check <a class="reference internal" href="../../imx9/imx93/pd24.2.1.html#emmc-disable-boot-part"><span class="std std-ref">Disable booting from e.MMC boot partitions</span></a> from Linux.</p>
<p>This way the bootloader is still flashed to e.MMC BOOT partitions but it is
not used!</p>
<p>When using <strong>partup</strong> tool and <code class="docutils literal notranslate"><span class="pre">.partup</span></code> package for e.MMC flashing this is
done by default, which makes partup again superior flash option.</p>
</div>
<p>Execute and power up the board:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>uuu<span class="w"> </span>-b<span class="w"> </span>emmc<span class="w"> </span>imx-boot
</pre></div>
</div>
</section>
<section id="flashing-wic-image-to-e-mmc-via-uuu">
<h3><span class="section-number">5.4.6. </span>Flashing wic Image to e.MMC via UUU<a class="headerlink" href="#flashing-wic-image-to-e-mmc-via-uuu" title="Link to this heading">ï</a></h3>
<p>Execute and power up the board:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>uuu<span class="w"> </span>-b<span class="w"> </span>emmc_all<span class="w"> </span>imx-boot<span class="w"> </span>phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.wic
</pre></div>
</div>
</section>
<section id="flashing-spi-nor-flash-via-uuu">
<h3><span class="section-number">5.4.7. </span>Flashing SPI NOR Flash via UUU<a class="headerlink" href="#flashing-spi-nor-flash-via-uuu" title="Link to this heading">ï</a></h3>
<p>Execute and power up the board:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>uuu<span class="w"> </span>-b<span class="w"> </span>qspi<span class="w"> </span>imx-boot-phyboard-pollux-imx8mp-3-fspi.bin-flash_evk_flexspi
</pre></div>
</div>
<p>This will update the U-Boot on SPI NOR Flash but not the environment. You may need to erase the old
environment so the default environment of the new U-Boot gets loaded:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; env erase</span>
<span class="go">u-boot=&gt; reset</span>
</pre></div>
</div>
</section>
</section>
<section id="host-network-preparation">
<h2><span class="section-number">5.5. </span>Host Network Preparation<a class="headerlink" href="#host-network-preparation" title="Link to this heading">ï</a></h2>
<p>For various tasks involving a network in the Bootloader, some host services are
required to be set up. On the development host, a TFTP, NFS and DHCP server must
be installed and configured. The following tools will be needed to boot via
Ethernet:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>tftpd-hpa<span class="w"> </span>nfs-kernel-server<span class="w"> </span>kea
</pre></div>
</div>
<section id="tftp-server-setup">
<h3><span class="section-number">5.5.1. </span>TFTP Server Setup<a class="headerlink" href="#tftp-server-setup" title="Link to this heading">ï</a></h3>
<ul>
<li><p>First, create a directory to store the TFTP files:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>/srv/tftp
</pre></div>
</div>
</li>
<li><p>Then copy your BSP image files to this directory and make sure other users have read
access to all the files in the tftp directory, otherwise they are not accessible
from the target.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>chmod<span class="w"> </span>-R<span class="w"> </span>o+r<span class="w"> </span>/srv/tftp
</pre></div>
</div>
</li>
<li><p>You also need to configure a static IP address for the appropriate interface.
The default IP address of the PHYTEC evaluation boards is 192.168.3.11. Setting
a host address 192.168.3.10 with netmask 255.255.255.0 is a good choice.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>ip<span class="w"> </span>addr<span class="w"> </span>show<span class="w"> </span>&lt;network-interface&gt;
</pre></div>
</div>
<p>Replace &lt;network-interface&gt; with the network interface you configured and want to
connect the board to. You can show all network interfaces by not specifying a network
interface.</p>
</li>
<li><p>The message you receive should contain this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>inet 192.168.3.10/24 brd 192.168.3.255
</pre></div>
</div>
</li>
<li><p>Create or edit the <code class="docutils literal notranslate"><span class="pre">/etc/default/tftpd-hpa</span></code> file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># /etc/default/tftpd-hpa

TFTP_USERNAME=&quot;tftp&quot;
TFTP_DIRECTORY=&quot;/srv/tftp&quot;
TFTP_ADDRESS=&quot;:69&quot;
TFTP_OPTIONS=&quot;-s -c&quot;
</pre></div>
</div>
</li>
<li><p>Set TFTP_DIRECTORY to your TFTP server root directory</p></li>
<li><p>Set TFTP_ADDRESS to the host address the server is listening to (set to
0.0.0.0:69 to listen to all local IPs)</p></li>
<li><p>Set TFTP_OPTIONS, the following command shows the available options:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>man<span class="w"> </span>tftpd
</pre></div>
</div>
</li>
<li><p>Restart the services to pick up the configuration changes:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>service<span class="w"> </span>tftpd-hpa<span class="w"> </span>restart
</pre></div>
</div>
</li>
</ul>
<p>Now connect the ethernet port of the board to your host system.
We also need a network connection between the embedded board and the TFTP
server. The server should be set to IP 192.168.3.10 and
netmask 255.255.255.0.</p>
<section id="nfs-server-setup">
<h4><span class="section-number">5.5.1.1. </span>NFS Server Setup<a class="headerlink" href="#nfs-server-setup" title="Link to this heading">ï</a></h4>
<ul>
<li><p>Create an nfs directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>/srv/nfs
</pre></div>
</div>
</li>
<li><p>The NFS server is not restricted to a certain file system location, so all we
have to do on most distributions is modify the file <code class="docutils literal notranslate"><span class="pre">/etc/exports</span></code> and export
our root file system to the embedded network. In this example file, the whole
directory is exported and the âlab networkâ address of the development host is
192.168.3.10. The IP address has to be adapted to the local needs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/srv/nfs 192.168.3.0/255.255.255.0(rw,no_root_squash,sync,no_subtree_check)
</pre></div>
</div>
</li>
<li><p>Now the NFS-Server has to read the <code class="docutils literal notranslate"><span class="pre">/etc/exportfs</span></code> file again:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>exportfs<span class="w"> </span>-ra
</pre></div>
</div>
</li>
</ul>
</section>
<section id="dhcp-server-setup">
<h4><span class="section-number">5.5.1.2. </span>DHCP Server setup<a class="headerlink" href="#dhcp-server-setup" title="Link to this heading">ï</a></h4>
<ul>
<li><p>Create or edit the <code class="docutils literal notranslate"><span class="pre">/etc/kea/kea-dhcp4.conf</span></code> file; Using the internal subnet
sample. Replace &lt;network-interface&gt; with the name for the physical network
interface:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;Dhcp4&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;interfaces-config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;interfaces&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;&lt;network-interface&gt;/192.168.3.10&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;lease-database&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;memfile&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;persist&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/tmp/dhcp4.leases&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;valid-lifetime&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">28800</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;subnet4&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">        </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;next-server&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.3.10&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;subnet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.3.0/24&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;pools&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;pool&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.3.1 - 192.168.3.255&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Be careful when creating subnets as this may interfere with the company
network policy. To be on the safe side, use a different network and specify
that via the <code class="docutils literal notranslate"><span class="pre">interfaces</span></code> configuration option.</p>
</div>
<ul>
<li><p>Now the DHCP-Server has to read the <code class="docutils literal notranslate"><span class="pre">/etc/kea/kea-dhcp4.conf</span></code> file again:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>kea-dhcp4-server
</pre></div>
</div>
</li>
</ul>
<p>When you boot/restart your host PC and donât have the network interface, as
specified in the kea-dhcp4 config, already active the kea-dhcp4-server will
fail to start. Make sure to start/restart the systemd service when you connect
the interface.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>DHCP server setup is only needed when using dynamic IP addresses. For our
vendor BSPs, static IP addresses are used by default.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; env print ip_dyn
ip_dyn=no
</pre></div>
</div>
<p>To use dynamic IP addresses for netboot, <code class="docutils literal notranslate"><span class="pre">ip_dyn</span></code> needs to be set to <code class="docutils literal notranslate"><span class="pre">yes</span></code>.</p>
</div>
</section>
</section>
</section>
<section id="booting-the-kernel-from-a-network">
<h2><span class="section-number">5.6. </span>Booting the Kernel from a Network<a class="headerlink" href="#booting-the-kernel-from-a-network" title="Link to this heading">ï</a></h2>
<p>Booting from a network means loading the kernel and device tree over TFTP and
the root file system over NFS. The bootloader itself must already be loaded from
another available boot device.</p>
<section id="place-images-on-host-for-netboot">
<h3><span class="section-number">5.6.1. </span>Place Images on Host for Netboot<a class="headerlink" href="#place-images-on-host-for-netboot" title="Link to this heading">ï</a></h3>
<ul>
<li><p>Copy the kernel fitimage to your tftp directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>cp<span class="w"> </span>fitImage<span class="w"> </span>/srv/tftp
</pre></div>
</div>
</li>
<li><p>Copy the bootscript to your tftp directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>cp<span class="w"> </span>boot.scr.uimg<span class="w"> </span>/srv/tftp
</pre></div>
</div>
</li>
<li><p>Make sure other users have read access to all the files in the tftp directory,
otherwise they are not accessible from the target:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>chmod<span class="w"> </span>-R<span class="w"> </span>o+r<span class="w"> </span>/srv/tftp
</pre></div>
</div>
</li>
<li><p>Extract the rootfs to your nfs directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>tar<span class="w"> </span>-xvzf<span class="w"> </span>phytec-qt6demo-image-phyboard-pollux-imx8mp-3.rootfs.tar.gz<span class="w"> </span>-C<span class="w"> </span>/srv/nfs
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure you extract with sudo to preserve the correct ownership.</p>
</div>
</section>
<section id="set-the-bootenv-txt-for-netboot">
<h3><span class="section-number">5.6.2. </span>Set the bootenv.txt for Netboot<a class="headerlink" href="#set-the-bootenv-txt-for-netboot" title="Link to this heading">ï</a></h3>
<p>Create a bootenv.txt file in your tftp directory and write the following variables into it.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>nfsroot=/srv/nfs
overlays=&lt;overlayconfignames&gt;
</pre></div>
</div>
<p>&lt;overlayconfignames&gt; has to be replaced with the devicetree overlay config names that you want to use.
Separate the config names by hashtag. For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>overlays=conf-example-overlay1.dtbo#conf-example-overlay2.dtbo
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>All supported devicetree overlays are in the <a class="reference internal" href="#imx8mp-head-device-tree"><span class="std std-ref">device tree</span></a> chapter. Or can be printed with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>host:~$ dumpimage -l fitImage
</pre></div>
</div>
</div>
</section>
<section id="network-settings-on-target">
<h3><span class="section-number">5.6.3. </span>Network Settings on Target<a class="headerlink" href="#network-settings-on-target" title="Link to this heading">ï</a></h3>
<p>To customize the targets ethernet configuration, please follow the description
here: <a class="reference internal" href="#imx8mp-head-network"><span class="std std-ref">Network Environment Customization</span></a></p>
</section>
<section id="booting-from-an-embedded-board">
<h3><span class="section-number">5.6.4. </span>Booting from an Embedded Board<a class="headerlink" href="#booting-from-an-embedded-board" title="Link to this heading">ï</a></h3>
<p>Boot the board into the U-boot prompt and press any key to hold.</p>
<ul>
<li><p>To boot from a network, call:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; setenv boot_targets ethernet</span>
<span class="go">u-boot=&gt; bootflow scan -lb</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="accessing-the-development-states">
<h2><span class="section-number">5.7. </span>Accessing the Development states<a class="headerlink" href="#accessing-the-development-states" title="Link to this heading">ï</a></h2>
<section id="development-state-of-current-release">
<h3><span class="section-number">5.7.1. </span>Development state of current release<a class="headerlink" href="#development-state-of-current-release" title="Link to this heading">ï</a></h3>
<p>These release manifests exist to give you access to the development states
of the <em>Yocto</em> BSP. They will not be displayed in the phyLinux selection
menu but need to be selected manually. This can be done using the following
command line:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>./phyLinux<span class="w"> </span>init<span class="w"> </span>-p<span class="w"> </span>imx8mp<span class="w"> </span>-r<span class="w"> </span>BSP-Yocto-NXP-i.MX8MP-PD26.1.y
</pre></div>
</div>
<p>This will initialize a BSP that will track the latest development state of the
current release (BSP-Yocto-NXP-i.MX8MP-PD26.1.0). From now on <em>repo sync</em> in this folder
will pull all the latest changes from our Git repositories:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>repo<span class="w"> </span>sync
</pre></div>
</div>
</section>
<section id="development-state-of-upcoming-release">
<h3><span class="section-number">5.7.2. </span>Development state of upcoming release<a class="headerlink" href="#development-state-of-upcoming-release" title="Link to this heading">ï</a></h3>
<p>Also development states of upcoming releases can be accessed this way.
For this execute the following command and look for a release with a higher
PDXX.Y number than the latest one (BSP-Yocto-NXP-i.MX8MP-PD26.1.0) and <code class="docutils literal notranslate"><span class="pre">.y</span></code> at the
end:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>./phyLinux<span class="w"> </span>init<span class="w"> </span>-p<span class="w"> </span>imx8mp
</pre></div>
</div>
</section>
</section>
<section id="accessing-the-latest-upstream-support">
<h2><span class="section-number">5.8. </span>Accessing the Latest Upstream Support<a class="headerlink" href="#accessing-the-latest-upstream-support" title="Link to this heading">ï</a></h2>
<p>We have a vanilla manifest that makes use of the Yocto master branches (not an
NXP release), Linux, and U-Boot. This can be used to test the latest upstream
kernel/U-Boot.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The master manifest reflects the latest state of development. This tends to
be broken from time to time. We try to fix the master on a regular basis.</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>./phyLinux<span class="w"> </span>init<span class="w"> </span>-p<span class="w"> </span>imx8mp<span class="w"> </span>-r<span class="w"> </span>BSP-Yocto-Ampliphy-i.MX8MP-master
</pre></div>
</div>
</section>
<section id="format-sd-card">
<span id="imx8mp-head-format-sd"></span><h2><span class="section-number">5.9. </span>Format SD card<a class="headerlink" href="#format-sd-card" title="Link to this heading">ï</a></h2>
<p>Most images are larger than the default root partition. To flash any storage
device with SD Card, the rootfs needs to be expanded or a separate partition
needs to be created. There are some different ways to format the SD Card.  The
easiest way to do this is to use the UI program Gparted.</p>
<section id="gparted">
<h3><span class="section-number">5.9.1. </span>Gparted<a class="headerlink" href="#gparted" title="Link to this heading">ï</a></h3>
<ul>
<li><p>Get GParted:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>gparted
</pre></div>
</div>
</li>
<li><p>Insert the SD card into your host and get the device name:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail
<span class="go">...</span>
<span class="go">[30436.175412] sd 4:0:0:0: [sdb] 62453760 512-byte logical blocks: (32.0 GB/29.8 GiB)</span>
<span class="go">[30436.179846]  sdb: sdb1 sdb2</span>
<span class="go">...</span>
</pre></div>
</div>
</li>
<li><p>Unmount all SD card partitions.</p></li>
<li><p>Launch GParted:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>gparted
</pre></div>
</div>
</li>
</ul>
<img alt="../../../_images/gparted1.png" src="../../../_images/gparted1.png" />
<section id="expand-rootfs">
<h4><span class="section-number">5.9.1.1. </span>Expand rootfs<a class="headerlink" href="#expand-rootfs" title="Link to this heading">ï</a></h4>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Running gparted on host systems which are using resize2fs version 1.46.6 and older
(e.g. Ubuntu 22.04) are not able to expand the ext4 partition created with Yocto
Mickledore and newer.
This is due to a new default option in resize2fs which causes a incompatibility.
See <a class="reference external" href="https://e2fsprogs.sourceforge.net/e2fsprogs-release.html#1.47.0">release notes</a>.</p>
</div>
<ul class="simple">
<li><p>Choose your SD card device at the drop-down menu on the top right</p></li>
<li><p>Choose the ext4 root partition and click on resize:</p></li>
</ul>
<img alt="../../../_images/gparted5.png" src="../../../_images/gparted5.png" />
<img alt="../../../_images/gparted2.png" src="../../../_images/gparted2.png" />
<ul class="simple">
<li><p>Drag the slider as far as you like or enter the size manually.</p></li>
</ul>
<img alt="../../../_images/gparted3.png" src="../../../_images/gparted3.png" />
<ul class="simple">
<li><p>Confirm your entry by clicking on the âChange sizeâ button.</p></li>
</ul>
<img alt="../../../_images/gparted4.png" src="../../../_images/gparted4.png" />
<ul>
<li><p>To apply your changes, press the green tick.</p></li>
<li><p>Now you can mount the root partition and copy e.g. the
phytec-qt6demo-image-phyboard-pollux-imx8mp-3.wic image to it. Then unmount it again:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>cp<span class="w"> </span>phytec-qt6demo-image-phyboard-pollux-imx8mp-3.wic<span class="w"> </span>/mnt/<span class="w"> </span><span class="p">;</span><span class="w"> </span>sync
<span class="gp">host:~$ </span>umount<span class="w"> </span>/mnt
</pre></div>
</div>
</li>
</ul>
</section>
<section id="create-the-third-partition">
<h4><span class="section-number">5.9.1.2. </span>Create the Third Partition<a class="headerlink" href="#create-the-third-partition" title="Link to this heading">ï</a></h4>
<ul class="simple">
<li><p>Choose your SD card device at the drop-down menu on the top right</p></li>
</ul>
<img alt="../../../_images/gparted1.png" src="../../../_images/gparted1.png" />
<ul class="simple">
<li><p>Choose the bigger unallocated  area and press âNewâ:</p></li>
</ul>
<img alt="../../../_images/gparted6.png" src="../../../_images/gparted6.png" />
<ul class="simple">
<li><p>Click âAddâ</p></li>
</ul>
<img alt="../../../_images/gparted7.png" src="../../../_images/gparted7.png" />
<ul class="simple">
<li><p>Confirm your changes by pressing the green tick.</p></li>
</ul>
<img alt="../../../_images/gparted8.png" src="../../../_images/gparted8.png" />
<ul>
<li><p>Now you can mount the new partition and copy e.g.
phytec-qt6demo-image-phyboard-pollux-imx8mp-3.wic image to it. Then unmount it again:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>mount<span class="w"> </span>/dev/sde3<span class="w"> </span>/mnt
<span class="gp">host:~$ </span>sudo<span class="w"> </span>cp<span class="w"> </span>phytec-qt6demo-image-phyboard-pollux-imx8mp-3.wic<span class="w"> </span>/mnt/<span class="w"> </span><span class="p">;</span><span class="w"> </span>sync
<span class="gp">host:~$ </span>umount<span class="w"> </span>/mnt
</pre></div>
</div>
</li>
</ul>
</section>
</section>
</section>
<section id="switch-back-to-legacyboot">
<h2><span class="section-number">5.10. </span>Switch back to legacyboot<a class="headerlink" href="#switch-back-to-legacyboot" title="Link to this heading">ï</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>As we switched to standardboot with fitimage as default, legacyboot is
deprecated. We kept the option to switch back to legacyboot for this
release, but it will be removed in the future.</p>
</div>
<section id="changes-in-yocto">
<h3><span class="section-number">5.10.1. </span>Changes in Yocto<a class="headerlink" href="#changes-in-yocto" title="Link to this heading">ï</a></h3>
<p>By default, the fitImage and bootscript will be deployed into the wic.xz Image.
To switch back to legacyboot, you need to replace the fitImage and bootscript
for the kernel image and the devicetrees. They are still in the deploy
folder from the Yocto build, so you can manually copy them to the boot
partition on your device. Otherwise you can do the following changes in Yocto
to get the kernel and devicetrees deployed in the Image again.</p>
<p>First create the variable <cite>KERNEL_DEVICETREE_DEPLOY</cite>. This can be done for
example in the local.conf file in your build directory <cite>conf/local.conf</cite>.
The variable is basically a copy of the <cite>KERNEL_DEVICETREE</cite> variable that is
set in conf/machine/phyboard-pollux-imx8mp-3.conf in meta-phytec but the <cite>freescale</cite>
at the beginning needs to be removed, so that only the devicetree filename are
left. In the end it should look something like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>KERNEL_DEVICETREE_DEPLOY = &quot; \
     imx8mp-phyboard-pollux-rdk.dtb \
     imx8mp-phyboard-pollux-isp-csi1.dtbo \
     imx8mp-phyboard-pollux-isp-csi2.dtbo \
     imx8mp-phyboard-pollux-isi-csi1.dtbo \
     imx8mp-phyboard-pollux-isi-csi2.dtbo \
     imx8mp-phyboard-pollux-peb-av-10.dtbo \
     imx8mp-phyboard-pollux-peb-wlbt-05.dtbo \
     imx8mp-phyboard-pollux-vm016-csi1.dtbo \
     imx8mp-phyboard-pollux-vm016-csi1-fpdlink-port0.dtbo \
     imx8mp-phyboard-pollux-vm016-csi1-fpdlink-port1.dtbo \
     imx8mp-phyboard-pollux-vm016-csi2.dtbo \
     imx8mp-phyboard-pollux-vm016-csi2-fpdlink-port0.dtbo \
     imx8mp-phyboard-pollux-vm016-csi2-fpdlink-port1.dtbo \
     imx8mp-phyboard-pollux-vm017-csi1.dtbo \
     imx8mp-phyboard-pollux-vm017-csi1-fpdlink-port0.dtbo \
     imx8mp-phyboard-pollux-vm017-csi1-fpdlink-port1.dtbo \
     imx8mp-phyboard-pollux-vm017-csi2.dtbo \
     imx8mp-phyboard-pollux-vm017-csi2-fpdlink-port0.dtbo \
     imx8mp-phyboard-pollux-vm017-csi2-fpdlink-port1.dtbo \
     imx8mp-phyboard-pollux-vm020-csi1.dtbo \
     imx8mp-phyboard-pollux-vm020-csi1-fpdlink-port0.dtbo \
     imx8mp-phyboard-pollux-vm020-csi1-fpdlink-port1.dtbo \
     imx8mp-phyboard-pollux-vm020-csi2.dtbo \
     imx8mp-phyboard-pollux-vm020-csi2-fpdlink-port0.dtbo \
     imx8mp-phyboard-pollux-vm020-csi2-fpdlink-port1.dtbo \
     imx8mp-phycore-no-eth.dtbo \
     imx8mp-phycore-no-rtc.dtbo \
     imx8mp-phycore-no-spiflash.dtbo \
     imx8mp-phycore-rpmsg.dtbo \
&quot;
</pre></div>
</div>
<p>Then add this line:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>IMAGE_BOOT_FILES:mx8m-nxp-bsp:append = &quot; Image oftree ${KERNEL_DEVICETREE_DEPLOY}&quot;
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A clean might be required for this to work.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bitbake -c cleanall phytec-qt6demo-image
</pre></div>
</div>
</div>
<p>Then start the build:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>bitbake<span class="w"> </span>phytec-qt6demo-image
</pre></div>
</div>
</section>
<section id="changes-in-u-boot-environment">
<h3><span class="section-number">5.10.2. </span>Changes in U-Boot environment<a class="headerlink" href="#changes-in-u-boot-environment" title="Link to this heading">ï</a></h3>
<p>To re-enable legacyboot set the following variable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">uboot=&gt; setenv dolegacyboot 1</span>
<span class="go">uboot=&gt; env save; env save;</span>
<span class="go">uboot=&gt; boot</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="device-tree-dt">
<span id="imx8mp-head-device-tree"></span><h1><span class="section-number">6. </span>Device Tree (DT)<a class="headerlink" href="#device-tree-dt" title="Link to this heading">ï</a></h1>
<section id="introduction">
<h2><span class="section-number">6.1. </span>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">ï</a></h2>
<p>The following text briefly describes the Device Tree and can be found in
the Linux kernel Documentation
(<a class="reference external" href="https://docs.kernel.org/devicetree/usage-model.html">https://docs.kernel.org/devicetree/usage-model.html</a>)</p>
<p><em>âThe âOpen Firmware Device Treeâ, or simply Devicetree (DT), is a data
structure and language for describing hardware. More specifically, it is a
description of hardware that is readable by an operating system so that the
operating system doesnât need to hard code details of the machine.â</em></p>
<p>The kernel documentation is a really good source for a DT introduction. An
overview of the device tree data format can be found on the device tree usage
page at <a class="reference external" href="https://www.devicetree.org/">devicetree.org</a>.</p>
</section>
<section id="phytec-soc-bsp-device-tree-concept">
<h2><span class="section-number">6.2. </span>PHYTEC i.MX 8M Plus BSP Device Tree Concept<a class="headerlink" href="#phytec-soc-bsp-device-tree-concept" title="Link to this heading">ï</a></h2>
<p>The following sections explain some rules PHYTEC has defined on how to set up
device trees for our i.MX 8M Plus SoC-based boards.</p>
<section id="device-tree-structure">
<h3><span class="section-number">6.2.1. </span>Device Tree Structure<a class="headerlink" href="#device-tree-structure" title="Link to this heading">ï</a></h3>
<ul class="simple">
<li><p><em>Module.dtsi</em> - Module includes all devices mounted on the SoM, such as PMIC
and RAM.</p></li>
<li><p><em>Board.dts</em> - include the module dtsi file. Devices that come from the i.MX 8M Plus
SoC but are just routed down to the carrier board and used there are included
in this dts.</p></li>
<li><p><em>Overlay.dtso</em> - enable/disable features depending on optional hardware that
may be mounted or missing on SoM or baseboard (e.g SPI flash or PEB-AV-10)</p></li>
</ul>
<p>From the root directory of the Linux Kernel our devicetree files for i.MX 8
platforms can be found in <code class="docutils literal notranslate"><span class="pre">arch/arm64/boot/dts/freescale/</span></code>.</p>
</section>
<section id="device-tree-overlay">
<h3><span class="section-number">6.2.2. </span>Device Tree Overlay<a class="headerlink" href="#device-tree-overlay" title="Link to this heading">ï</a></h3>
<p>Device Tree overlays are device tree fragments that can be merged into a device
tree during boot time. These are for example hardware descriptions of an
expansion board. They are instead of being added to the device tree as an extra
include, now applied as an overlay. They also may only contain setting the
status of a node depending on if it is mounted or not. The device tree overlays
are placed next to the other device tree files in our Linux kernel repository in
the folder <code class="docutils literal notranslate"><span class="pre">arch/arm64/boot/dts/freescale/</span></code>.</p>
<p>Available overlays for phyboard-pollux-imx8mp-3.conf are:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>imx8mp-isi-csi1.dtbo
imx8mp-isi-csi2.dtbo
imx8mp-isp-csi1.dtbo
imx8mp-isp-csi2.dtbo
imx8mp-phyboard-pollux-etml1010g3dra.dtbo
imx8mp-phyboard-pollux-peb-av-10-etml1010g3dra.dtbo
imx8mp-phyboard-pollux-peb-av-10-ph128800t006.dtbo
imx8mp-phyboard-pollux-ph128800t006.dtbo
imx8mp-phyboard-pollux-peb-wlbt-05.dtbo
imx8mp-phycore-no-eth.dtbo
imx8mp-phycore-no-rtc.dtbo
imx8mp-phycore-no-spiflash.dtbo
imx8mp-phycore-rpmsg.dtbo
imx8mp-vm016-csi1.dtbo
imx8mp-vm016-csi1-fpdlink.dtbo
imx8mp-vm016-csi2.dtbo
imx8mp-vm016-csi2-fpdlink.dtbo
imx8mp-vm017-csi1.dtbo
imx8mp-vm017-csi1-fpdlink.dtbo
imx8mp-vm017-csi2.dtbo
imx8mp-vm017-csi2-fpdlink.dtbo
</pre></div>
</div>
<p id="imx8mp-head-ubootexternalenv">Otherwise you can show the content of a FIT image including all overlay
configs in the FIT image with this command in Linux:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>dumpimage<span class="w"> </span>-l<span class="w"> </span>/boot/fitImage
</pre></div>
</div>
<p>or in U-Boot:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">u-boot=&gt; load mmc ${mmcdev}:1 ${loadaddr} fitImage</span>
<span class="go">u-boot=&gt; iminfo</span>
</pre></div>
</div>
<p>The usage of overlays can be configured during runtime in Linux or U-Boot.
Overlays are applied during the boot process in the bootloader after the
boot command is called and before the kernel is loaded. The next sections
explain the configuration in more detail.</p>
<section id="set-overlays-variable">
<h4><span class="section-number">6.2.2.1. </span>Set <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> variable<a class="headerlink" href="#set-overlays-variable" title="Link to this heading">ï</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> U-Boot environment variable contains a number-sign (#)
separated list of overlays that will be applied during boot. The overlays
listed in the overlays variable must be included in the FIT image. Overlays set
in the $KERNEL_DEVICETREE Yocto machine variable will automatically be added to
the FIT image.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> variable can either be set directly in the U-Boot
environment or can be part of the external <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code> environment file.
When desired to use the overlays variable as set manually in the U-Boot
environment, disable bootenv by setting <code class="docutils literal notranslate"><span class="pre">env</span> <span class="pre">set</span> <span class="pre">no_bootenv</span> <span class="pre">1</span></code> as the overlays
variable may be overwritten during the execution of the boot script.
By default, the <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> variable comes from the external <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code>
environment file which is located in the boot partition.
You can read and write the file on booted target from linux:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/boot/bootenv.txt
<span class="go">overlays=conf-imx8mp-phyboard-pollux-rdk-peb-eval-01.dtbo#conf-imx8mp-phyboard-pollux-peb-av-10-ph128800t006.dtbo</span>
</pre></div>
</div>
<p>Changes will take effect after the next reboot. If no <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code> file is
available the overlays variable can be set directly in the U-Boot environment.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv overlays conf-imx8mp-phyboard-pollux-peb-av-10-ph128800t006.dtbo
u-boot=&gt; printenv overlays
overlays=conf-imx8mp-phyboard-pollux-peb-av-10-ph128800t006.dtbo
u-boot=&gt; boot
</pre></div>
</div>
<p>If a user defined <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> variable should be directly loaded from U-Boot
environment but there is still an external <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code> available, the <code class="docutils literal notranslate"><span class="pre">${no_bootenv}</span></code>
variable needs to be set as a flag:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv no_bootenv 1
u-boot=&gt; setenv overlays conf-imx8mp-phyboard-pollux-peb-av-10-ph128800t006.dtbo
u-boot=&gt; boot
</pre></div>
</div>
<p>More information about the external environment can be found in
U-boot External Environment subsection of the
<a class="reference internal" href="#imx8mp-head-ubootexternalenv"><span class="std std-ref">device tree overlay section</span></a>.</p>
<p>We use the <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> variable for overlays describing expansion boards and
cameras that can not be detected during run time. To prevent applying overlays
unset the overlays variable and set no_bootenv to anything other than 0.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; env delete overlays
u-boot=&gt; env set no_bootenv 1
</pre></div>
</div>
<p>If desired to use the bootenv.txt file for setting U-Boot variables other than
overlays and having overlays disabled, remove the overlays definition line from
the bootenv.txt file instead of setting no_bootenv.</p>
</section>
<section id="som-variants">
<h4><span class="section-number">6.2.2.2. </span>SoM Variants<a class="headerlink" href="#som-variants" title="Link to this heading">ï</a></h4>
<p>Additional overlays are applied automatically to disable components that are not
populated on the SoM. The detection is done with the EEPROM data (EEPROM SoM
Detection) found on the SoM i2c EEPROM.</p>
<p>It depends on the SoM variant if any device tree overlays will be applied. To check
if an overlay will be applied on the running SoM in U-Boot, run:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; env print fit_extensions
</pre></div>
</div>
<p>If the EEPROM data is not available, no device tree overlays are applied.</p>
<p>To prevent application of the SoM variant related overlays the
<code class="docutils literal notranslate"><span class="pre">${no_extensions}</span></code> variable can be set to <cite>1</cite> in the bootloader environment:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv no_extensions 1
u-boot=&gt; boot
</pre></div>
</div>
</section>
</section>
<section id="u-boot-external-environment">
<h3><span class="section-number">6.2.3. </span>U-boot External Environment<a class="headerlink" href="#u-boot-external-environment" title="Link to this heading">ï</a></h3>
<p>During the start of the Linux Kernel the external environment <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code>
text file will be loaded from the boot partition of an MMC device or via TFTP.
The main intention of this file is to store the <code class="docutils literal notranslate"><span class="pre">${overlays}</span></code> variable. This makes
it easy to pre-define the overlays in Yocto depending on the used machine. The
content from the file is defined in the Yocto recipe bootenv found in
meta-phytec:
<a class="extlink-yocto-bootenv reference external" href="https://git.phytec.de/meta-phytec/tree/recipes-bsp/bootenv?h=walnascar">https://git.phytec.de/meta-phytec/tree/recipes-bsp/bootenv?h=walnascar</a></p>
<p>Other variables can be set in this file, too. They will overwrite the existing
settings in the environment. But only variables evaluated after issuing the boot
command can be overwritten, such as <code class="docutils literal notranslate"><span class="pre">${nfsroot}</span></code> or <code class="docutils literal notranslate"><span class="pre">${mmcargs}</span></code>. Changing other
variables in that file will not have an effect. See the usage during netboot as
an example.</p>
<p>If the external environment can not be loaded the boot process will be anyway
continued with the values of the existing environment settings.</p>
</section>
<section id="change-u-boot-environment-from-linux-on-target">
<h3><span class="section-number">6.2.4. </span>Change U-boot Environment from Linux on Target<a class="headerlink" href="#change-u-boot-environment-from-linux-on-target" title="Link to this heading">ï</a></h3>
<p>Libubootenv is a tool included in our images to modify the U-Boot environment of
Linux on the target machine.</p>
<p>Print the U-Boot environment using the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>fw_printenv
</pre></div>
</div>
<p>Modify a U-Boot environment variable using the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>fw_setenv<span class="w"> </span>&lt;variable&gt;<span class="w"> </span>&lt;value&gt;
</pre></div>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Libubootenv takes the environment selected in a configuration file. The
environment to use is inserted there, and by default it is configured to use
the eMMC environment (known as the default used environment).</p>
<p>If the eMMC is not flashed or the eMMC environment is deleted, libubootenv
will not work. You should modify the <code class="docutils literal notranslate"><span class="pre">/etc/fw_env.config</span></code> file to match the
environment source that you want to use.</p>
</div>
</section>
</section>
</section>
<section id="accessing-peripherals">
<h1><span class="section-number">7. </span>Accessing Peripherals<a class="headerlink" href="#accessing-peripherals" title="Link to this heading">ï</a></h1>
<p>To find out which boards and modules are supported by the release of PHYTECâs
phyCORE-i.MX 8M Plus BSP described herein, visit <a class="reference external" href="https://www.phytec.de/bsp-download/?bsp=BSP-Yocto-NXP-i.MX8MP-PD26.1.0">our BSP</a> web page and click
the corresponding BSP release in the download section. Here you can find all
hardware supported in the columns âHardware Article Numberâ and the correct
machine name in the corresponding cell under âMachine Nameâ.</p>
<p>To achieve maximum software reuse, the Linux kernel offers a sophisticated
infrastructure that layers software components into board-specific parts. The
BSP tries to modularize the kit features as much as possible. When a customized
baseboard or even a customer-specific module is developed, most of the software
support can be reused without error-prone copy-and-paste. The kernel code
corresponding to the boards can be found in device trees (DT) in the kernel
repository under <code class="docutils literal notranslate"><span class="pre">arch/arm64/boot/dts/freescale/*.dts</span></code>.</p>
<p>In fact, software reuse is one of the most important features of the
Linux kernel, especially of the ARM implementation which always has to fight
with an insane number of possibilities of the System-on-Chip CPUs. The whole
board-specific hardware is described in DTs and is not part of the kernel image
itself. The hardware description is in its own separate binary, called the
Device Tree Blob (DTB) (section <a class="reference internal" href="#imx8mp-head-device-tree"><span class="std std-ref">device tree</span></a>).</p>
<p>Please read section PHYTEC i.MX 8M Plus BSP Device Tree Concept to get an understanding
of our i.MX 8 BSP device tree model.</p>
<p>The following sections provide an overview of the supported hardware components
and their operating system drivers on the i.MX 8 platform. Further changes
can be ported upon customer request.</p>
<section id="soc-pin-muxing">
<h2><span class="section-number">7.1. </span>i.MX 8M Plus Pin Muxing<a class="headerlink" href="#soc-pin-muxing" title="Link to this heading">ï</a></h2>
<p>The i.MX 8M Plus SoC contains many peripheral interfaces. In order to reduce package
size and lower overall system cost while maintaining maximum functionality, many
of the i.MX 8M Plus terminals can multiplex up to eight signal functions. Although
there are many combinations of pin multiplexing that are possible, only a
certain number of sets, called IO sets, are valid due to timing limitations.
These valid IO sets were carefully chosen to provide many possible application
scenarios for the user.</p>
<p>Please refer to our Hardware Manual or the NXP i.MX 8M Plus Reference Manual for more
information about the specific pins and the muxing capabilities.</p>
<p>The IO set configuration, also called muxing, is done in the Device Tree. The
driver pinctrl-single reads the DTâs node fsl,pins, and does the appropriate pin
muxing.</p>
<p>The following is an example of the pin muxing of the UART1 device in
imx8mp-phyboard-pollux-rdk.dts:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pinctrl_uart1: uart1grp {
        fsl,pins = &lt;
                MX8MP_IOMUXC_UART1_RXD_UART1_DCE_RX     0x140
                MX8MP_IOMUXC_UART1_TXD_UART1_DCE_TX     0x140
        &gt;;
};
</pre></div>
</div>
<p>The first part of the string MX8MP_IOMUXC_UART1_RXD_UART1_DCE_RX names the pad
(in this example UART1_RXD). The second part of the string (UART1_DCE_RX) is the
desired muxing option for this pad. The pad setting value (hex value on the
right) defines different modes of the pad, for example, if internal pull
resistors are activated or not. In this case, the internal resistors are
disabled.</p>
<p>The device tree representation for UART1 pinmuxing:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L373">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L373</a></p>
</section>
<section id="rs232-rs485">
<h2><span class="section-number">7.2. </span>RS232/RS485<a class="headerlink" href="#rs232-rs485" title="Link to this heading">ï</a></h2>
<p>The phyCORE-i.MX 8M Plus supports up to 4 UART units. On the phyBOARD-Pollux, TTL level signals
of UART1 (the standard console) and UART4 are routed to Silicon Labs CP2105 UART
to USB converter expansion. This USB is brought out at Micro-USB connector X1.
UART3 is at X6 (Expansion Connector) at TTL level. UART2 is connected to a
multi-protocol transceiver for RS-232 and RS-485, available at pin header
connector <a class="reference internal" href="#imx8mp-head-components"><span class="std std-ref">X2</span></a> at the RS-232 level, or at the RS-485 level. The
configuration of the multi-protocol transceiver is done by jumpers <a class="reference internal" href="#imx8mp-head-components"><span class="std std-ref">JP3</span></a> and
<a class="reference internal" href="#imx8mp-head-components"><span class="std std-ref">JP4</span></a> on the baseboard. For more information about the correct setup please
refer to the phyCORE-i.MX 8M Plus/phyBOARD-Pollux Hardware Manual section UARTs.</p>
<p>We use the same device tree node for RS-232 and RS-485. RS-485 mode can be
enabled with ioctl TIOCSRS485. Also, full-duplex support is also configured
using ioctls. Have a look at our small example application rs485test, which is
also included in the BSP. The jumpers <a class="reference internal" href="#imx8mp-head-components"><span class="std std-ref">JP3</span></a> and <a class="reference internal" href="#imx8mp-head-components"><span class="std std-ref">JP4</span></a> need to be set
correctly.</p>
<section id="rs232">
<h3><span class="section-number">7.2.1. </span>RS232<a class="headerlink" href="#rs232" title="Link to this heading">ï</a></h3>
<ul>
<li><p>Display the current settings of a terminal in a human-readable format:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>stty<span class="w"> </span>-a
</pre></div>
</div>
</li>
<li><p>Configuration of the UART interface can be done with stty. For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>stty<span class="w"> </span>-F<span class="w"> </span>/dev/ttymxc1<span class="w"> </span><span class="m">115200</span><span class="w"> </span>crtscts<span class="w"> </span>raw<span class="w"> </span>-echo
</pre></div>
</div>
</li>
<li><p>With a simple echo and cat, basic communication can be tested. Example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">123</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/ttymxc1
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>cat<span class="w"> </span>/dev/ttyUSB2
</pre></div>
</div>
</li>
</ul>
<p>The host should print out â123â.</p>
</section>
<section id="rs485">
<h3><span class="section-number">7.2.2. </span>RS485<a class="headerlink" href="#rs485" title="Link to this heading">ï</a></h3>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Remember to use bus termination resistors of 120 Ohm at each end of the bus,
when using longer cables.</p>
</div>
<p>For easy testing, look at the linux-serial-test. This tool is called the IOCTL
for RS485 and sends a constant stream of data.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>linux-serial-test<span class="w"> </span>-p<span class="w"> </span>/dev/ttymxc1<span class="w"> </span>-b<span class="w"> </span><span class="m">115200</span><span class="w"> </span>--rs485<span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
<p>More information about the linux-serial-test tool and its parameters can be
found here: <a class="reference external" href="https://github.com/cbrake/linux-serial-test">linux-serial-test</a></p>
<p>The linux-serial-test will automatically set ioctls, but they can also be set
manually with rs485conf.</p>
<p>You can show the current config with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>rs485conf<span class="w"> </span>/dev/ttymxc1
</pre></div>
</div>
<p>You can show all options with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>rs485conf<span class="w"> </span>/dev/ttymxc1<span class="w"> </span>-h
</pre></div>
</div>
<p>Documentation for calling the IOCTL within c-code is described in the Linux
kernel documentation:
<a class="reference external" href="https://www.kernel.org/doc/Documentation/serial/serial-rs485.txt">https://www.kernel.org/doc/Documentation/serial/serial-rs485.txt</a></p>
<section id="rs485-half-duplex">
<h4><span class="section-number">7.2.2.1. </span>RS485 half-duplex<a class="headerlink" href="#rs485-half-duplex" title="Link to this heading">ï</a></h4>
<p>For half-duplex mode your connection setup should look like this:</p>
<img alt="../../../_images/RS485_halfduplex_connection2.png" src="../../../_images/RS485_halfduplex_connection2.png" />
<p>Which function is on which pin is described in the hardware manual.</p>
<p>For half-duplex mode you can set the ioctls manually like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>rs485conf<span class="w"> </span>/dev/ttymxc1<span class="w"> </span>-e<span class="w"> </span><span class="m">1</span><span class="w"> </span>-r<span class="w"> </span><span class="m">0</span>
<span class="gp">target:~$ </span>rs485conf<span class="w"> </span>/dev/ttymxc1
<span class="go">= Current configuration:</span>
<span class="go">RS485 enabled:                true</span>
<span class="go">RTS on send:                  high</span>
<span class="go">RTS after send:               low</span>
<span class="go">RTS delay before send:        0</span>
<span class="go">RTS delay after send:         0</span>
<span class="go">Receive during sending data:  false</span>
<span class="go">Bus termination enabled:  false</span>
</pre></div>
</div>
<p>Then you can test if sending and receiving works like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target1:~$ </span>cat<span class="w"> </span>/dev/ttymxc1
<span class="gp">target2:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/ttymxc1
</pre></div>
</div>
<p>You should see âtestâ printed out on target1. You can also switch the roles and
send on target2 and receive on target1.</p>
<p>Alternatively you can also test with the linux-serial-test tool:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target1:~$ </span>linux-serial-test<span class="w"> </span>-s<span class="w"> </span>-e<span class="w"> </span>-f<span class="w"> </span>-p<span class="w"> </span>/dev/ttymxc1<span class="w"> </span>-b<span class="w"> </span><span class="m">115200</span><span class="w"> </span>--rs485<span class="w"> </span><span class="m">0</span><span class="w"> </span>-t<span class="w"> </span>-i<span class="w"> </span><span class="m">8</span>
<span class="go">...</span>
<span class="go">/dev/ttymxc1: count for this session: rx=57330, tx=0, rx err=0</span>
<span class="gp">target2:~$ </span>linux-serial-test<span class="w"> </span>-s<span class="w"> </span>-e<span class="w"> </span>-f<span class="w"> </span>-p<span class="w"> </span>/dev/ttymxc1<span class="w"> </span>-b<span class="w"> </span><span class="m">115200</span><span class="w"> </span>--rs485<span class="w"> </span><span class="m">0</span><span class="w"> </span>-r<span class="w"> </span>-o<span class="w"> </span><span class="m">5</span>
<span class="go">...</span>
<span class="go">/dev/ttymxc1: count for this session: rx=0, tx=57330, rx err=0</span>
</pre></div>
</div>
<p>In this example target1 will be the receiver and target2 will be the
transmitter. You should also be able to switch the roles. Remember to first
start the receiver and then the transmitter immediately after. The receiver
will receive for 8 sec and the transmitter will send for 5 sec. The receiver
needs to receive for a bit longer than the transmitter sends. At the end the
program will print the final âcount for this sessionâ. There you can check,
that all transmitted frames were received.</p>
<p>All the tests are target to target, but can also be done with host to target
with a USB to rs485 converter. You may need to adjust the interfaces then.</p>
</section>
<section id="rs485-full-duplex">
<h4><span class="section-number">7.2.2.2. </span>RS485 full-duplex<a class="headerlink" href="#rs485-full-duplex" title="Link to this heading">ï</a></h4>
<p>For full-duplex mode your connection setup should look like this:</p>
<img alt="../../../_images/RS485_fullduplex_connection.png" src="../../../_images/RS485_fullduplex_connection.png" />
<p>Which function is on which pin is described in the hardware manual.</p>
<p>For full-duplex mode you can set the ioctls manually like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>rs485conf<span class="w"> </span>/dev/ttymxc1<span class="w"> </span>-e<span class="w"> </span><span class="m">1</span><span class="w"> </span>-r<span class="w"> </span><span class="m">1</span>
<span class="gp">target:~$ </span>rs485conf<span class="w"> </span>/dev/ttymxc1
<span class="go">= Current configuration:</span>
<span class="go">RS485 enabled:                true</span>
<span class="go">RTS on send:                  high</span>
<span class="go">RTS after send:               low</span>
<span class="go">RTS delay before send:        0</span>
<span class="go">RTS delay after send:         0</span>
<span class="go">Receive during sending data:  true</span>
<span class="go">Bus termination enabled:  false</span>
</pre></div>
</div>
<p>Also here you can do the echo test to see if sending and receiving works:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target1:~$ </span>cat<span class="w"> </span>/dev/ttymxc1
<span class="gp">target2:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/ttymxc1
</pre></div>
</div>
<p>You should see âtestâ printed out on target1. You can also switch the roles and
send on target2 and receive on target1.</p>
<p>To check if the full-duplex operation works, you need to use the
linux-serial-test tool:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target1:~$ </span>linux-serial-test<span class="w"> </span>-s<span class="w"> </span>-e<span class="w"> </span>-f<span class="w"> </span>-p<span class="w"> </span>/dev/ttymxc1<span class="w"> </span>-b<span class="w"> </span><span class="m">115200</span><span class="w"> </span>--rs485<span class="w"> </span><span class="m">0</span><span class="w"> </span>-o<span class="w"> </span><span class="m">10</span><span class="w"> </span>-i<span class="w"> </span><span class="m">15</span><span class="w"> </span>-W<span class="w"> </span><span class="m">2</span>
<span class="go">...</span>
<span class="go">/dev/ttymxc1: count for this session: rx=114660, tx=118755, rx err=0</span>
<span class="gp">target2:~$ </span>linux-serial-test<span class="w"> </span>-s<span class="w"> </span>-e<span class="w"> </span>-f<span class="w"> </span>-p<span class="w"> </span>/dev/ttymxc1<span class="w"> </span>-b<span class="w"> </span><span class="m">115200</span><span class="w"> </span>--rs485<span class="w"> </span><span class="m">0</span><span class="w"> </span>-o<span class="w"> </span><span class="m">10</span><span class="w"> </span>-i<span class="w"> </span><span class="m">15</span><span class="w"> </span>-W<span class="w"> </span><span class="m">2</span>
<span class="go">...</span>
<span class="go">/dev/ttymxc1: count for this session: rx=118755, tx=114660, rx err=0</span>
</pre></div>
</div>
<p>In this example both targets will send and receive simultaneously. They will
receive for 15sec and send for 10sec. The receiver needs to receive a bit
longer, so that all sent messages will get received. Remember to start both
targets almost simultaneously. A small difference in start time is accounted
for with the <code class="docutils literal notranslate"><span class="pre">-W</span> <span class="pre">2</span></code> option. At the end the program will print the final
âcount for this sessionâ. There you can check that all transmitted frames were
received.</p>
<p>All the test examples are target to target, but can also be done with host to
target with a USB to rs485 converter. You may need to adjust the interfaces for
commands to work on the host then.</p>
<p>The device tree representation for RS232 and RS485:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L412">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L412</a></p>
</section>
</section>
</section>
<section id="ethernet">
<span id="imx8mp-head-network"></span><h2><span class="section-number">7.3. </span>Ethernet<a class="headerlink" href="#ethernet" title="Link to this heading">ï</a></h2>
<p>phyBOARD-Pollux-i.MX 8M Plus provides two ethernet interfaces. A gigabit Ethernet is provided by
our module and board.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The naming convention of the Ethernet interfaces in the hardware (ethernet0
and ethernet1) do not align with the network interfaces (eth0 and eth1) in
Linux. So, be aware of these differences:</p>
<div class="line-block">
<div class="line">ethernet1 = eth0</div>
<div class="line">ethernet0 = eth1</div>
</div>
</div>
<p>All interfaces offer a standard Linux network port that can be programmed using
the BSD socket interface. The whole network configuration is handled by
the systemd-networkd daemon. The relevant configuration files can be found on
the target in <code class="docutils literal notranslate"><span class="pre">/lib/systemd/network/</span></code> as well as the BSP in
<code class="docutils literal notranslate"><span class="pre">meta-ampliphy/recipes-core/systemd/systemd-conf</span></code>.</p>
<p>IP addresses can be configured within *.network files. The interfaces are
configured to static IP as default. The default IP address and netmask for eth0
is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>eth0: 192.168.3.11/24
</pre></div>
</div>
<p>To configure eth0 to dynamic IP over DHCP, go to
<code class="docutils literal notranslate"><span class="pre">/lib/systemd/network/\*-eth0.network</span></code> and delete the line:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Address=192.168.3.11/24
</pre></div>
</div>
<p>The DT Ethernet setup might be split into two files depending on your hardware
configuration: the module DT and the board-specific DT. The device tree set up
for the ethernet where the PHY is populated on the SoM can be found here:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L50">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L50</a>.</p>
<p>The device tree set up for EQOS Ethernet IP core where the PHY is populated
on the phyBOARD-Pollux can be found here:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L179">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L179</a>.</p>
<section id="network-environment-customization">
<h3><span class="section-number">7.3.1. </span>Network Environment Customization<a class="headerlink" href="#network-environment-customization" title="Link to this heading">ï</a></h3>
<section id="u-boot-network-environment">
<h4><span class="section-number">7.3.1.1. </span>U-boot network-environment<a class="headerlink" href="#u-boot-network-environment" title="Link to this heading">ï</a></h4>
<ul>
<li><p>To find the Ethernet settings in the target bootloader:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; printenv ipaddr serverip netmask
</pre></div>
</div>
</li>
<li><p>With your development host set to IP 192.168.3.10 and netmask 255.255.255.0,
the target should return:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; printenv ipaddr serverip netmask
ipaddr=192.168.3.11
serverip=192.168.3.10
netmask=255.225.255.0
</pre></div>
</div>
</li>
<li><p>If you need to make any changes:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv &lt;parameter&gt; &lt;value&gt;
</pre></div>
</div>
<p>&lt;parameter&gt; should be one of ipaddr, netmask, gatewayip or serverip.
&lt;value&gt; will be the actual value of the chosen parameter.</p>
</li>
<li><p>The changes you made are temporary for now. To save these:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; saveenv
</pre></div>
</div>
</li>
</ul>
<p>Here you can also change the IP address to DHCP instead of using a static one.</p>
<ul>
<li><p>Configure:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv ip dhcp
</pre></div>
</div>
</li>
<li><p>Set up paths for TFTP and NFS. A modification could look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; setenv nfsroot /home/user/nfssrc
</pre></div>
</div>
</li>
</ul>
<p>Please note that these modifications will only affect the bootloader settings.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Variables like nfsroot and netargs can be overwritten by the U-boot External
Environment. For netboot, the external environment will be loaded from tftp.
For example, to locally set the nfsroot variable in a <code class="docutils literal notranslate"><span class="pre">bootenv.txt</span></code> file,
locate the tftproot directory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>nfsroot=/home/user/nfssrc
</pre></div>
</div>
<p>There is no need to store the info on the target. Please note that this does
not work for variables like ipaddr or serveraddr as they need to be already
set when the external environment is being loaded.</p>
</div>
</section>
<section id="kernel-network-environment">
<h4><span class="section-number">7.3.1.2. </span>Kernel network-environment<a class="headerlink" href="#kernel-network-environment" title="Link to this heading">ï</a></h4>
<ul>
<li><p>Find the ethernet settings for eth0 in the target kernel:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>-statistics<span class="w"> </span>address<span class="w"> </span>show<span class="w"> </span>eth0
<span class="go">2: eth0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span>
<span class="go">    link/ether 50:2d:f4:19:d6:33 brd ff:ff:ff:ff:ff:ff</span>
<span class="go">    RX:  bytes packets errors dropped  missed   mcast</span>
<span class="go">             0       0      0       0       0       0</span>
<span class="go">    TX:  bytes packets errors dropped carrier collsns</span>
<span class="go">             0       0      0       0       0       0</span>
</pre></div>
</div>
</li>
<li><p>Temporary adaption of the eth0 configuration:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>address<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.3.11/24<span class="w"> </span>dev<span class="w"> </span>eth0
</pre></div>
</div>
</li>
</ul>
</section>
</section>
</section>
<section id="wlan-bluetooth">
<h2><span class="section-number">7.4. </span>WLAN/Bluetooth<a class="headerlink" href="#wlan-bluetooth" title="Link to this heading">ï</a></h2>
<p>WLAN and Bluetooth on the phyBOARD-Pollux are provided by the PEB-WLBT-05 expansion card.
The PEB-WLBT-05 for phyBOARD-Pollux Quickstart Guide shows you how to install the
PEB-WLBT-05.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>With the BSP Version PD22.1 and newer, the PEB-WLBT-05 overlay needs to be activated first,
otherwise the PEB-WLBT-05 wonât be recognized.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>vi<span class="w"> </span>/boot/bootenv.txt
</pre></div>
</div>
<p>Afterwards the bootenv.txt file should look like this (it can also contain other devicetree
overlays!):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>overlays=conf-imx8mp-phyboard-pollux-peb-wlbt-05.dtbo
</pre></div>
</div>
<p>The changes will be applied after a reboot:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>reboot
</pre></div>
</div>
<p>For further information about devicetree overlays, read the <a class="reference internal" href="#imx8mp-head-device-tree"><span class="std std-ref">device tree</span></a> chapter.</p>
</div>
<p>For WLAN and Bluetooth support, we use the Sterling-LWB module from LSR. This
module supports 2,4 GHz bandwidth and can be run in several modes, like client
mode, Access Point (AP) mode using WEP, WPA, WPA2 encryption, and more. More
information about the module can be found at
<a class="reference external" href="https://connectivity-staging.s3.us-east-2.amazonaws.com/2019-09/CS-DS-SterlingLWB%20v7_2.pdf">https://connectivity-staging.s3.us-east-2.amazonaws.com/2019-09/CS-DS-SterlingLWB%20v7_2.pdf</a></p>
<section id="connecting-to-a-wlan-network">
<h3><span class="section-number">7.4.1. </span>Connecting to a WLAN Network<a class="headerlink" href="#connecting-to-a-wlan-network" title="Link to this heading">ï</a></h3>
<p>First set the correct regulatory domain for your country:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>iw<span class="w"> </span>reg<span class="w"> </span><span class="nb">set</span><span class="w"> </span>DE
<span class="gp">target:~$ </span>iw<span class="w"> </span>reg<span class="w"> </span>get
</pre></div>
</div>
<p>You will see:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>country DE: DFS-ETSI
   (2400 - 2483 @ 40), (N/A, 20), (N/A)
   (5150 - 5250 @ 80), (N/A, 20), (N/A), NO-OUTDOOR
   (5250 - 5350 @ 80), (N/A, 20), (0 ms), NO-OUTDOOR, DFS
   (5470 - 5725 @ 160), (N/A, 26), (0 ms), DFS
   (57000 - 66000 @ 2160), (N/A, 40), (N/A)
</pre></div>
</div>
<p>Set up the wireless interface:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>link
<span class="gp">target:~$ </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>up<span class="w"> </span>dev<span class="w"> </span>wlan0
</pre></div>
</div>
<p>Now you can scan for available networks:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>iw<span class="w"> </span>wlan0<span class="w"> </span>scan<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>SSID
</pre></div>
</div>
<p>You can use a cross-platform supplicant with support for WEP, WPA, and WPA2 called wpa_supplicant for an encrypted connection.</p>
<p>To do so, add the network-credentials to the file <code class="docutils literal notranslate"><span class="pre">/etc/wpa_supplicant.conf</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>country=DE
network={
    ssid=&quot;&lt;SSID&gt;&quot;
    proto=WPA2
    psk=&quot;&lt;KEY&gt;&quot;
}
</pre></div>
</div>
<p>Now a connection can be established:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>wpa_supplicant<span class="w"> </span>-D<span class="w"> </span>nl80211<span class="w"> </span>-c<span class="w"> </span>/etc/wpa_supplicant.conf<span class="w"> </span>-i<span class="w"> </span>wlan0<span class="w"> </span>-B
</pre></div>
</div>
<p>This should result in the following output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Successfully initialized wpa_supplicant
</pre></div>
</div>
<p>The ip address is automatically configured over DHCP. For other possible IP configurations,
see section <cite>Changing the Network Configuration</cite> in the <a class="reference internal" href="../../../yocto/master.html#yocto-man-master"><span class="std std-ref">Yocto Reference Manual (walnascar)</span></a>.</p>
</section>
<section id="bluetooth">
<h3><span class="section-number">7.4.2. </span>Bluetooth<a class="headerlink" href="#bluetooth" title="Link to this heading">ï</a></h3>
<p>Bluetooth is supported on phyBOARD-Pollux with the PEB-WLBT-05 expansion card. How this
can be activated is described in the WLAN/Bluetooth section.</p>
<p>Bluetooth is connected to UART3 interface.
The Bluetooth device needs to be set up manually:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hciconfig<span class="w"> </span>hci0<span class="w"> </span>up

<span class="gp">target:~$ </span>hciconfig<span class="w"> </span>-a

<span class="go">hci0:   Type: Primary  Bus: UART</span>
<span class="go">        BD Address: 00:25:CA:2F:39:96  ACL MTU: 1021:8  SCO MTU: 64:1</span>
<span class="go">        UP RUNNING PSCAN</span>
<span class="go">        RX bytes:1392 acl:0 sco:0 events:76 errors:0</span>
<span class="go">        TX bytes:1198 acl:0 sco:0 commands:76 errors:0</span>
<span class="go">        ...</span>
</pre></div>
</div>
<p>Now you can scan your environment for visible Bluetooth devices. Bluetooth is
not visible during a default startup.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hcitool<span class="w"> </span>scan
<span class="go">Scanning ...</span>
<span class="go">       XX:XX:XX:XX:XX:XX       &lt;SSID&gt;</span>
</pre></div>
</div>
</section>
<section id="visibility">
<h3><span class="section-number">7.4.3. </span>Visibility<a class="headerlink" href="#visibility" title="Link to this heading">ï</a></h3>
<p>To activate visibility:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hciconfig<span class="w"> </span>hci0<span class="w"> </span>piscan
</pre></div>
</div>
<p>To disable visibility:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hciconfig<span class="w"> </span>hci0<span class="w"> </span>noscan
</pre></div>
</div>
</section>
<section id="connect">
<h3><span class="section-number">7.4.4. </span>Connect<a class="headerlink" href="#connect" title="Link to this heading">ï</a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>bluetoothctl
<span class="gp">[bluetooth]# </span>discoverable<span class="w"> </span>on
<span class="go">Changing discoverable on succeeded</span>
<span class="gp">[bluetooth]# </span>pairable<span class="w"> </span>on
<span class="go">Changing pairable on succeeded</span>
<span class="gp">[bluetooth]# </span>agent<span class="w"> </span>on
<span class="go">Agent registered</span>
<span class="gp">[bluetooth]# </span>default-agent
<span class="go">Default agent request successful</span>
<span class="gp">[bluetooth]# </span>scan<span class="w"> </span>on
<span class="go">[NEW] Device XX:XX:XX:XX:XX:XX &lt;name&gt;</span>
<span class="gp">[bluetooth]# </span>connect<span class="w"> </span>XX:XX:XX:XX:XX:XX
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the connection fails with the error message: âFailed to connect:
org.bluez.Error.Failedâ try restarting PulseAudio with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>pulseaudio<span class="w"> </span>--start
</pre></div>
</div>
</div>
</section>
</section>
<section id="sd-card">
<h2><span class="section-number">7.5. </span>SD card<a class="headerlink" href="#sd-card" title="Link to this heading">ï</a></h2>
<p>The i.MX 8M Plus supports a slot for Secure Digital cards to be used as general-purpose
block devices. These devices can be used in the same way as any other block
device.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>These kinds of devices are hot-pluggable. Nevertheless, you must ensure not
to unplug the device while it is still mounted. This may result in data loss!</p>
</div>
<p>After inserting an SD card, the kernel will generate new device nodes in /dev.
The full device can be reached via its /dev/mmcblk1 device node. SD card
partitions will show up as:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/dev/mmcblk1p&lt;Y&gt;
</pre></div>
</div>
<p>&lt;Y&gt; counts as the partition number starting from 1 to the max count of
partitions on this device. The partitions can be formatted with any kind of file
system and also handled in a standard manner, e.g. the mount and umount command
work as expected.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>These partition device nodes will only be available if the card contains a
valid partition table (âhard diskâ like handling). If no partition table is
present, the whole device can be used as a file system (âfloppyâ like
handling). In this case, /dev/mmcblk1 must be used for formatting and
mounting. The cards are always mounted as being writable.</p>
</div>
<p>DT configuration for the MMC (SD card slot) interface can be found here:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L422">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L422</a></p>
<p>DT configuration for the eMMC interface can be found here:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L214">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L214</a></p>
</section>
<section id="e-mmc-devices">
<h2><span class="section-number">7.6. </span>e.MMC Devices<a class="headerlink" href="#e-mmc-devices" title="Link to this heading">ï</a></h2>
<p>PHYTEC modules like phyCORE-i.MX 8M Plus are populated with an e.MMC memory chip as the
main storage. e.MMC devices contain raw Multi-Level Cells (MLC) or Triple-Level
Cells (TLC) combined with a memory controller that handles ECC and wear
leveling. They are connected via an SD/MMC interface to the i.MX 8M Plus and are
represented as block devices in the Linux kernel like SD cards, flash drives, or
hard disks.</p>
<p>The electric and protocol specifications are provided by JEDEC
(<a class="reference external" href="https://www.jedec.org/standards-documents/technology-focus-areas/flash-memory-ssds-ufs-emmc/e-mmc">https://www.jedec.org/standards-documents/technology-focus-areas/flash-memory-ssds-ufs-emmc/e-mmc</a>).
The e.MMC manufacturerâs datasheet is relatively short and meant to be read
together with the supported version of the JEDEC e.MMC standard.</p>
<p>PHYTEC currently utilizes the e.MMC chips with JEDEC Version 5.0 and 5.1</p>
<section id="extended-csd-register">
<h3><span class="section-number">7.6.1. </span>Extended CSD Register<a class="headerlink" href="#extended-csd-register" title="Link to this heading">ï</a></h3>
<p>e.MMC devices have an extensive amount of extra information and settings that are
available via the Extended CSD registers. For a detailed list of the registers,
see manufacturer datasheets and the JEDEC standard.</p>
<p>In the Linux user space, you can query the registers:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>extcsd<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
<p>You will see:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>=============================================
   Extended CSD rev 1.7 (MMC 5.0)
=============================================

 Card Supported Command sets [S_CMD_SET: 0x01]
 [...]
</pre></div>
</div>
</section>
<section id="enabling-background-operations-bkops">
<h3><span class="section-number">7.6.2. </span>Enabling Background Operations (BKOPS)<a class="headerlink" href="#enabling-background-operations-bkops" title="Link to this heading">ï</a></h3>
<p>In contrast to raw NAND Flash, an e.MMC device contains a Flash Transfer Layer
(FTL) that handles the wear leveling, block management, and ECC of the raw MLC
or TLC. This requires some maintenance tasks (for example erasing unused blocks)
that are performed regularly. These tasks are called <strong>Background Operations
(BKOPS)</strong>.</p>
<p>By default (depending on the chip), the background operations may or may not be
executed periodically, impacting the worst-case read and write latency.</p>
<p>The JEDEC Standard has specified a method since version v4.41 that the host can
issue BKOPS manually. See the JEDEC Standard chapter Background Operations and
the description of registers BKOPS_EN (Reg: 163) and BKOPS_START (Reg: 164) in
the e.MMC datasheet for more details.</p>
<p>Meaning of Register BKOPS_EN (Reg: 163) Bit MANUAL_EN (Bit 0):</p>
<ul class="simple">
<li><p>Value 0: The host does not support the manual trigger of BKOPS. Device write
performance suffers.</p></li>
<li><p>Value 1: The host does support the manual trigger of BKOPS. It will issue
BKOPS from time to time when it does not need the device.</p></li>
</ul>
<p>The mechanism to issue background operations has been implemented in
the Linux kernel since v3.7. You only have to enable BKOPS_EN on the e.MMC
device (see below for details).</p>
<p>The JEDEC standard v5.1 introduces a new automatic BKOPS feature. It frees the
host to trigger the background operations regularly because the device starts
BKOPS itself when it is idle (see the description of bit AUTO_EN in
register BKOPS_EN (Reg: 163)).</p>
<ul>
<li><p>To check whether <em>BKOPS_EN</em> is set, execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>extcsd<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/mmcblk2<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>BKOPS_EN
</pre></div>
</div>
<p>The output will be, for example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Enable background operations handshake [BKOPS_EN]: 0x01
#OR
Enable background operations handshake [BKOPS_EN]: 0x00
</pre></div>
</div>
<p>Where value 0x00 means BKOPS_EN is disabled and device write performance
suffers. Where value 0x01 means BKOPS_EN is enabled and the host will issue
background operations from time to time.</p>
</li>
<li><p>Enabling can be done with this command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ target:~$ </span>mmc<span class="w"> </span>--help

<span class="go">[...]</span>
<span class="go">mmc bkops_en &lt;auto|manual&gt; &lt;device&gt;</span>
<span class="go">    Enable the eMMC BKOPS feature on &lt;device&gt;.</span>
<span class="go">    The auto (AUTO_EN) setting is only supported on eMMC 5.0 or newer.</span>
<span class="go">    Setting auto won&#39;t have any effect if manual is set.</span>
<span class="go">    NOTE!  Setting manual (MANUAL_EN) is one-time programmable (unreversible) change.</span>
</pre></div>
</div>
</li>
<li><p>To set the BKOPS_EN bit, execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>bkops_en<span class="w"> </span>manual<span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
</li>
<li><p>To ensure that the new setting is taken over and the kernel triggers BKOPS by
itself, shut down the system:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>poweroff
</pre></div>
</div>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The BKOPS_EN bit is one-time programmable only. It cannot be reversed.</p>
</div>
</section>
<section id="reliable-write">
<h3><span class="section-number">7.6.3. </span>Reliable Write<a class="headerlink" href="#reliable-write" title="Link to this heading">ï</a></h3>
<p>There are two different Reliable Write options:</p>
<ol class="arabic simple">
<li><p>Reliable Write option for a whole e.MMC device/partition.</p></li>
<li><p>Reliable Write for single write transactions.</p></li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Do not confuse e.MMC partitions with partitions of a DOS, MBR, or GPT
partition table (see the previous section).</p>
</div>
<p>The first Reliable Write option is mostly already enabled on the e.MMCs mounted
on the phyCORE-i.MX 8M Plus SoMs. To check this on the running target:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>extcsd<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/mmcblk2<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-A<span class="w"> </span><span class="m">5</span><span class="w"> </span>WR_REL_SET
<span class="go">Write reliability setting register [WR_REL_SET]: 0x1f</span>
<span class="go"> user area: the device protects existing data if a power failure occurs during a write o</span>
<span class="go">peration</span>
<span class="go"> partition 1: the device protects existing data if a power failure occurs during a write</span>
<span class="go"> operation</span>
<span class="go"> partition 2: the device protects existing data if a power failure occurs during a write</span>
<span class="go"> operation</span>
<span class="go"> partition 3: the device protects existing data if a power failure occurs during a write</span>
<span class="go"> operation</span>
<span class="go"> partition 4: the device protects existing data if a power failure occurs during a write</span>
<span class="go"> operation</span>
<span class="go">--</span>
<span class="go"> Device supports writing EXT_CSD_WR_REL_SET</span>
<span class="go"> Device supports the enhanced def. of reliable write</span>
</pre></div>
</div>
<p>Otherwise, it can be enabled with the mmc tool:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>--help

<span class="go">[...]</span>
<span class="go">mmc write_reliability set &lt;-y|-n|-c&gt; &lt;partition&gt; &lt;device&gt;</span>
<span class="go">    Enable write reliability per partition for the &lt;device&gt;.</span>
<span class="go">    Dry-run only unless -y or -c is passed.</span>
<span class="go">    Use -c if more partitioning settings are still to come.</span>
<span class="go">    NOTE!  This is a one-time programmable (unreversible) change.</span>
</pre></div>
</div>
<p>The second Reliable Write option is the configuration bit Reliable Write Request
parameter (bit 31) in command CMD23. It has been used in the kernel
since v3.0 by file systems, e.g. ext4 for the journal and user space
applications such as fdisk for the partition table. In the Linux kernel source
code, it is handled via the flag REQ_META.</p>
<p><strong>Conclusion</strong>: ext4 file system with mount option data=journal should be safe
against power cuts. The file system check can recover the file system after a
power failure, but data that was written just before the power cut may be lost.
In any case, a consistent state of the file system can be recovered. To ensure
data consistency for the files of an application, the system functions fdatasync
or fsync should be used in the application.</p>
</section>
<section id="resizing-ext4-root-filesystem">
<h3><span class="section-number">7.6.4. </span>Resizing ext4 Root Filesystem<a class="headerlink" href="#resizing-ext4-root-filesystem" title="Link to this heading">ï</a></h3>
<p>When flashing the SD card image to e.MMC the ext4 root partition is not extended
to the end of the e.MMC. parted can be used to expand the root partition. The
example works for any block device such as e.MMC, SD card, or hard disk.</p>
<ul>
<li><p>Get the current device size:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>parted<span class="w"> </span>/dev/mmcblk2<span class="w"> </span>print
</pre></div>
</div>
</li>
<li><p>The output looks like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Model: MMC Q2J55L (sd/mmc)
Disk /dev/mmcblk2: 7617MB
Sect[ 1799.850385]  mmcblk2: p1 p2
or size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type     File system  Flags
 1      4194kB  72.4MB  68.2MB  primary  fat16        boot, lba
 2      72.4MB  537MB   465MB   primary  ext4
</pre></div>
</div>
</li>
<li><p>Use parted to resize the root partition to the max size of the device:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>parted<span class="w"> </span>/dev/mmcblk2<span class="w"> </span>resizepart<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">100</span>%
<span class="go">Information: You may need to update /etc/fstab.</span>

<span class="gp">target:~$ </span>parted<span class="w"> </span>/dev/mmcblk2<span class="w"> </span>print
<span class="go">Model: MMC Q2J55L (sd/mmc)</span>
<span class="go">Disk /dev/mmcblk2: 7617MB</span>
<span class="go">Sector size (logical/physical): 512[ 1974.191657]  mmcblk2: p1 p2</span>
<span class="go">B/512B</span>
<span class="go">Partition Table: msdos</span>
<span class="go">Disk Flags:</span>

<span class="go">Number  Start   End     Size    Type     File system  Flags</span>
<span class="go"> 1      4194kB  72.4MB  68.2MB  primary  fat16        boot, lba</span>
<span class="go"> 2      72.4MB  7617MB  7545MB  primary  ext4</span>
</pre></div>
</div>
</li>
<li><p>Resize the filesystem to a new partition size:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>resize2fs<span class="w"> </span>/dev/mmcblk2p2
<span class="go">resize2fs 1.46.1 (9-Feb-2021)</span>
<span class="go">Filesystem at /dev/mmcblk2p2 is mounted on /; on-line resizing required</span>
<span class="go">[ 131.609512] EXT4-fs (mmcblk2p2): resizing filesystem</span>
<span class="go">from 454136 to 7367680 blocks</span>
<span class="go">old_desc_blocks = 4, new_desc_blocks = 57</span>
<span class="go">[ 131.970278] EXT4-fs (mmcblk2p2): resized filesystem to 7367680</span>
<span class="go">The filesystem on /dev/mmcblk2p2 is now 7367680 (1k) blocks long</span>
</pre></div>
</div>
</li>
</ul>
<p>Increasing the filesystem size can be done while it is mounted.  But you can
also boot the board from an SD card and then resize the file system on the e.MMC
partition while it is not mounted.</p>
</section>
<section id="enable-pseudo-slc-mode">
<h3><span class="section-number">7.6.5. </span>Enable pseudo-SLC Mode<a class="headerlink" href="#enable-pseudo-slc-mode" title="Link to this heading">ï</a></h3>
<p>e.MMC devices use MLC or TLC
(<a class="reference external" href="https://en.wikipedia.org/wiki/Multi-level_cell">https://en.wikipedia.org/wiki/Multi-level_cell</a>) to store the data. Compared
with SLC used in NAND Flash, MLC or TLC have lower reliability and a higher
error rate at lower costs.</p>
<p>If you prefer reliability over storage capacity, you can enable
the pseudo-SLC mode or SLC mode. The method used here employs the enhanced
attribute, described in the JEDEC standard, which can be set for continuous
regions of the device. The JEDEC standard does not specify the implementation
details and the guarantees of the enhanced attribute. This is left to the
chipmaker. For the Micron chips, the enhanced attribute increases the
reliability but also halves the capacity.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When enabling the enhanced attribute on the device, all data will be lost.</p>
</div>
<p>The following sequence shows how to enable the enhanced attribute.</p>
<ul>
<li><p>First obtain the current size of the e.MMC device with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>parted<span class="w"> </span>-m<span class="w"> </span>/dev/mmcblk2<span class="w"> </span>unit<span class="w"> </span>B<span class="w"> </span>print
</pre></div>
</div>
<p>You will receive:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>BYT;
/dev/mmcblk2:63652757504B:sd/mmc:512:512:unknown:MMC S0J58X:;
</pre></div>
</div>
<p>As you can see this device has 63652757504 Byte = 60704 MiB.</p>
</li>
<li><p>To get the maximum size of the device after pseudo-SLC is enabled use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>extcsd<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/mmcblk2<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ENH_SIZE_MULT<span class="w"> </span>-A<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<p>which shows, for example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Max Enhanced Area Size [MAX_ENH_SIZE_MULT]: 0x000764
i.e. 3719168 KiB
--
Enhanced User Data Area Size [ENH_SIZE_MULT]: 0x000000
i.e. 0 KiB
</pre></div>
</div>
<p>Here the maximum size is 3719168 KiB = 3632 MiB.</p>
</li>
<li><p>Now, you can set enhanced attribute for the whole device, e.g. 3719168 KiB, by
typing:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>enh_area<span class="w"> </span><span class="nb">set</span><span class="w"> </span>-y<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">3719168</span><span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
<p>You will get:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Done setting ENH_USR area on /dev/mmcblk2
setting OTP PARTITION_SETTING_COMPLETED!
Setting OTP PARTITION_SETTING_COMPLETED on /dev/mmcblk2 SUCCESS
Device power cycle needed for settings to take effect.
Confirm that PARTITION_SETTING_COMPLETED bit is set using &#39;extcsd read&#39; after power cycle
</pre></div>
</div>
</li>
<li><p>To ensure that the new setting has taken over, shut down the system:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>poweroff
</pre></div>
</div>
<p>and perform a power cycle. It is recommended that you verify the settings now.</p>
</li>
<li><p>First, check the value of ENH_SIZE_MULT which must be 3719168 KiB:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>extcsd<span class="w"> </span><span class="nb">read</span><span class="w"> </span>/dev/mmcblk2<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ENH_SIZE_MULT<span class="w">  </span>-A<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<p>You should receive:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Max Enhanced Area Size [MAX_ENH_SIZE_MULT]: 0x000764
i.e. 3719168 KiB
--
Enhanced User Data Area Size [ENH_SIZE_MULT]: 0x000764
i.e. 3719168 KiB
</pre></div>
</div>
</li>
<li><p>Finally, check the size of the device:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>parted<span class="w"> </span>-m<span class="w"> </span>/dev/mmcblk2<span class="w"> </span>unit<span class="w"> </span>B<span class="w"> </span>print
<span class="go">BYT;</span>
<span class="go">/dev/mmcblk2:31742492672B:sd/mmc:512:512:unknown:MMC S0J58X:;</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="erasing-the-device">
<h3><span class="section-number">7.6.6. </span>Erasing the Device<a class="headerlink" href="#erasing-the-device" title="Link to this heading">ï</a></h3>
<p>It is possible to erase the e.MMC device directly rather than overwriting it
with zeros. The e.MMC block management algorithm will erase the underlying MLC
or TLC or mark these blocks as discard. The data on the device is lost and will
be read back as zeros.</p>
<ul>
<li><p>After booting from SD card execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>blkdiscard<span class="w"> </span>-f<span class="w"> </span>--secure<span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
<p>The option âsecure ensures that the command waits until the eMMC device has
erased all blocks. The -f (force) option disables all checking before erasing
and it is needed when the eMMC device contains existing partitions with data.</p>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/mmcblk2<span class="w"> </span><span class="nv">conv</span><span class="o">=</span>fsync
</pre></div>
</div>
<p>also destroys all information on the device, but this command is bad for wear
leveling and takes much longer!</p>
</div>
</section>
<section id="e-mmc-boot-partitions">
<h3><span class="section-number">7.6.7. </span>e.MMC Boot Partitions<a class="headerlink" href="#e-mmc-boot-partitions" title="Link to this heading">ï</a></h3>
<p>An e.MMC device contains four different hardware partitions: user, boot1, boot2,
and rpmb.</p>
<p>The user partition is called the User Data Area in the JEDEC standard and is the
main storage partition. The partitions boot1 and boot2 can be used to host the
bootloader and are more reliable. Which partition the i.MX 8M Plus uses to load
the bootloader is controlled by the boot configuration of the e.MMC device. The
partition rpmb is a small partition and can only be accessed via a trusted
mechanism.</p>
<p>Furthermore, the user partition can be divided into four user-defined General
Purpose Area Partitions. An explanation of this feature exceeds the scope of
this document. For further information, see the JEDEC Standard Chapter 7.2
Partition Management.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Do not confuse e.MMC partitions with partitions of a DOS, MBR, or GPT
partition table.</p>
</div>
<p>The current PHYTEC BSP does not use the extra partitioning feature of e.MMC
devices. The U-Boot is flashed at the beginning of the user partition.
The U-Boot environment is placed at a fixed location after the U-Boot. An MBR
partition table is used to create two partitions, a FAT32 boot, and ext4 rootfs
partition. They are located right after the U-Boot and the U-Boot environment.
The FAT32 boot partition contains the kernel and device tree.</p>
<p>With e.MMC flash storage it is possible to use the dedicated boot partitions for
redundantly storing the bootloader. The Bootloader environment still resides in
the user area before the first partition. The user area also still contains the
bootloader which the image first shipped during its initialization process.
Below is an example, to flash the bootloader to one of the two boot partitions
and switch the boot device via userspace commands.</p>
<section id="via-userspace-commands">
<h4><span class="section-number">7.6.7.1. </span>Via userspace Commands<a class="headerlink" href="#via-userspace-commands" title="Link to this heading">ï</a></h4>
<p>On the host, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>scp<span class="w"> </span>&lt;bootloader&gt;<span class="w"> </span>root@192.168.3.11:/tmp/
</pre></div>
</div>
<p>The partitions boot1 and boot2 are read-only by default. To write to them from
user space, you have to disable <code class="docutils literal notranslate"><span class="pre">force_ro</span></code> in the sysfs.</p>
<p>To manually write the bootloader to the e.MMC boot partitions, first disable the
write protection:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/block/mmcblk2boot0/force_ro
<span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/block/mmcblk2boot1/force_ro
</pre></div>
</div>
<p>Write the bootloader to the e.MMC boot partitions:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/tmp/&lt;bootloader&gt;<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/mmcblk2boot0
<span class="gp">target:~$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/tmp/&lt;bootloader&gt;<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/dev/mmcblk2boot1
</pre></div>
</div>
<p>The following table is for the offset of the i.MX 8M Plus SoC:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>SoC</p></th>
<th class="head"><p>Offset User Area</p></th>
<th class="head"><p>Offset Boot
Partition</p></th>
<th class="head"><p>e.MMC Device</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>i.MX 8M Plus</p></td>
<td><p>32 kiB</p></td>
<td><p>0 kiB</p></td>
<td><p>/dev/mmcblk2</p></td>
</tr>
</tbody>
</table>
<p>After that set the boot partition from user space using the <code class="docutils literal notranslate"><span class="pre">mmc</span></code> tool:</p>
<p>(for âboot0â) :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>bootpart<span class="w"> </span><span class="nb">enable</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
<p>(for âboot1â) :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>bootpart<span class="w"> </span><span class="nb">enable</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
<p id="emmc-disable-boot-part">To disable booting from the e.MMC boot partitions simply enter the following
command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>bootpart<span class="w"> </span><span class="nb">enable</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
<p>To explicitly enable booting from the e.MMC user area, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>mmc<span class="w"> </span>bootpart<span class="w"> </span><span class="nb">enable</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>/dev/mmcblk2
</pre></div>
</div>
</section>
<section id="automatic-failover">
<h4><span class="section-number">7.6.7.2. </span>Automatic failover<a class="headerlink" href="#automatic-failover" title="Link to this heading">ï</a></h4>
<p>The ROM loader implements an automatic failover mechanism for e.MMC boot partitions. If booting
from the primary partition fails, the system automatically attempts to boot from the secondary
partition. This failover is indicated by a change in the boot message from
<code class="docutils literal notranslate"><span class="pre">Boot</span> <span class="pre">Stage:</span> <span class="pre">Primary</span> <span class="pre">boot</span></code> to <code class="docutils literal notranslate"><span class="pre">Boot</span> <span class="pre">Stage:</span> <span class="pre">Secondary</span> <span class="pre">boot</span></code>.
This functionality is limited to boot0 and boot1 partitions and does not apply to the user area.</p>
</section>
</section>
</section>
<section id="spi-master">
<h2><span class="section-number">7.7. </span>SPI Master<a class="headerlink" href="#spi-master" title="Link to this heading">ï</a></h2>
<p>The i.MX 8M Plus controller has a FlexSPI and an ECSPI IP core included. The FlexSPI
host controller supports two SPI channels with up to 4 devices. Each channel
supports Single/Dual/Quad/Octal mode data transfer (1/2/4/8 bidirectional data
lines). The ECSPI controller supports 3 SPI interfaces with one dedicated chip
selected for each interface. As chip selects should be realized with GPIOs, more
than one device on each channel is possible.</p>
<section id="spi-nor-flash">
<h3><span class="section-number">7.7.1. </span>SPI NOR Flash<a class="headerlink" href="#spi-nor-flash" title="Link to this heading">ï</a></h3>
<p>phyCORE-i.MX 8M Plus is equipped with a QSPI NOR Flash which connects to the i.MX 8M Plusâs
FlexSPI interface. The QSPI NOR Flash is suitable for booting. Please see
different sections for flashing and bootmode setup. Due to limited space on the
SPI NOR Flash, only the bootloader is stored inside. By default, the kernel,
device tree, and rootfs are taken from eMMC.</p>
<p>The Bootloader does detect with the help of the EEPROM Introspection data if an
SPI flash is mounted or not. If no SPI flash is mounted a device tree overlay is
applied with the expansion command to disable the SPI flash device tree node
during boot. If no introspection data is available the SPI NOR flash node is
always enabled. Find more information in the device tree overlay section.</p>
<p>The bootloader also passes the SPI MTD partition table to Linux by fixing up the
device tree based on the mtdparts boot parameter. The default partition layout
in the BSP is set to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mtdparts=30bb0000.spi:3840k(u-boot),128k(env),128k(env_redund),-(none)
</pre></div>
</div>
<p>This is a bootloader environment variable that is defined here and can be
changed during runtime. From Linux userspace, the NOR Flash partitions are
accessible via /dev/mtd&lt;N&gt; devices where &lt;N&gt; is the MTD device number associated
with the NOR flash partition to access. To find the correct MTD device number
for a partition, run on the target:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@phyboard-pollux-imx8mp-3:~$ </span>mtdinfo<span class="w"> </span>--all
<span class="go">Count of MTD devices:           4</span>
<span class="go">Present MTD devices:            mtd0, mtd1, mtd2, mtd3</span>
<span class="go">Sysfs interface supported:      yes</span>

<span class="go">mtd0</span>
<span class="go">Name:                           u-boot</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                65536 bytes, 64.0 KiB</span>
<span class="go">Amount of eraseblocks:          60 (3932160 bytes, 3.7 MiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:0</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>

<span class="go">mtd1</span>
<span class="go">Name:                           env</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                65536 bytes, 64.0 KiB</span>
<span class="go">Amount of eraseblocks:          2 (131072 bytes, 128.0 KiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:2</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>

<span class="go">mtd2</span>
<span class="go">Name:                           env_redund</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                65536 bytes, 64.0 KiB</span>
<span class="go">Amount of eraseblocks:          2 (131072 bytes, 128.0 KiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:4</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>

<span class="go">mtd3</span>
<span class="go">Name:                           none</span>
<span class="go">Type:                           nor</span>
<span class="go">Eraseblock size:                65536 bytes, 64.0 KiB</span>
<span class="go">Amount of eraseblocks:          448 (29360128 bytes, 28.0 MiB)</span>
<span class="go">Minimum input/output unit size: 1 byte</span>
<span class="go">Sub-page size:                  1 byte</span>
<span class="go">Character device major/minor:   90:6</span>
<span class="go">Bad blocks are allowed:         false</span>
<span class="go">Device is writable:             true</span>
</pre></div>
</div>
<p>It lists all MTD devices and the corresponding partition names. The flash node
is defined inside of the SPI master node in the module DTS. The SPI node
contains all devices connected to this SPI bus which is in this case only the
SPI NOR Flash.</p>
<p>The definition of the SPI master node in the device tree can be found here:</p>
<p><a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L76">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L76</a></p>
</section>
</section>
<section id="gpios">
<h2><span class="section-number">7.8. </span>GPIOs<a class="headerlink" href="#gpios" title="Link to this heading">ï</a></h2>
<p>The phyBOARD-Pollux has a set of pins especially dedicated to user I/Os. Those pins are
connected directly to i.MX 8M Plus pins and are muxed as GPIOs. They are directly
usable in Linux userspace. The processor has organized its GPIOs into five banks
of 32 GPIOs each (GPIO1 â GPIO5)
GPIOs. gpiochip0, gpiochip32, gpiochip64, gpiochip96, and gpiochip128 are
the sysfs representation of these internal i.MX 8M Plus GPIO banks GPIO1 â GPIO5.</p>
<p>The GPIOs are identified as GPIO&lt;X&gt;_&lt;Y&gt; (e.g. GPIO5_07). &lt;X&gt; identifies the GPIO
bank and counts from 1 to 5, while &lt;Y&gt; stands for the GPIO within the bank. &lt;Y&gt;
is being counted from 0 to 31 (32 GPIOs on each bank).</p>
<p>By contrast, the Linux kernel uses a single integer to enumerate all available
GPIOs in the system. The formula to calculate the right number is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Linux GPIO number: &lt;N&gt; = (&lt;X&gt; - 1) * 32 + &lt;Y&gt;
</pre></div>
</div>
<p>Accessing GPIOs from userspace will be done using the libgpiod. It provides a
library and tools for interacting with the Linux GPIO character device. Examples
of some usages of various tools:</p>
<ul>
<li><p>Detecting the gpiochips on the chip:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gpiodetect
<span class="go">gpiochip0 [30200000.gpio] (32 lines)</span>
<span class="go">gpiochip1 [30210000.gpio] (32 lines)</span>
<span class="go">gpiochip2 [30220000.gpio] (32 lines)</span>
<span class="go">gpiochip3 [30230000.gpio] (32 lines)</span>
<span class="go">gpiochip4 [30240000.gpio] (32 lines)</span>
</pre></div>
</div>
</li>
</ul>
<ul>
<li><p>Show detailed information about the gpiochips. Like their names, consumers,
direction, active state, and additional flags:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gpioinfo<span class="w"> </span>-c<span class="w"> </span>gpiochip0
</pre></div>
</div>
</li>
<li><p>Read the value of a GPIO (e.g GPIO 20 from chip0):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gpioget<span class="w"> </span>-c<span class="w"> </span>gpiochip0<span class="w"> </span><span class="m">20</span>
</pre></div>
</div>
</li>
<li><p>Set the value of GPIO 20 on chip0 to 0 and exit tool:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gpioset<span class="w"> </span>-z<span class="w"> </span>-c<span class="w"> </span>gpiochip0<span class="w"> </span><span class="nv">20</span><span class="o">=</span><span class="m">0</span>
</pre></div>
</div>
</li>
<li><p>Help text of gpioset shows possible options:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gpioset<span class="w"> </span>--help
<span class="go">Usage: gpioset [OPTIONS] &lt;line=value&gt;...</span>

<span class="go">Set values of GPIO lines.</span>

<span class="go">Lines are specified by name, or optionally by offset if the chip option</span>
<span class="go">is provided.</span>
<span class="go">Values may be &#39;1&#39; or &#39;0&#39;, or equivalently &#39;active&#39;/&#39;inactive&#39; or &#39;on&#39;/&#39;off&#39;.</span>

<span class="go">The line output state is maintained until the process exits, but after that</span>
<span class="go">is not guaranteed.</span>

<span class="go">Options:</span>
<span class="go">      --banner            display a banner on successful startup</span>
<span class="go">  -b, --bias &lt;bias&gt;       specify the line bias</span>
<span class="go">                  Possible values: &#39;pull-down&#39;, &#39;pull-up&#39;, &#39;disabled&#39;.</span>
<span class="go">                  (default is to leave bias unchanged)</span>
<span class="go">      --by-name           treat lines as names even if they would parse as an offset</span>
<span class="go">  -c, --chip &lt;chip&gt;       restrict scope to a particular chip</span>
<span class="go">  -C, --consumer &lt;name&gt;   consumer name applied to requested lines (default is &#39;gpioset&#39;)</span>
<span class="go">  -d, --drive &lt;drive&gt;     specify the line drive mode</span>
<span class="go">                  Possible values: &#39;push-pull&#39;, &#39;open-drain&#39;, &#39;open-source&#39;.</span>
<span class="go">                  (default is &#39;push-pull&#39;)</span>
<span class="go">  -h, --help              display this help and exit</span>
<span class="go">  -l, --active-low        treat the line as active low</span>
<span class="go">  -p, --hold-period &lt;period&gt;</span>
<span class="go">                  the minimum time period to hold lines at the requested values</span>
<span class="go">  -s, --strict            abort if requested line names are not unique</span>
<span class="go">  -t, --toggle &lt;period&gt;[,period]...</span>
<span class="go">                  toggle the line(s) after the specified period(s)</span>
<span class="go">                  If the last period is non-zero then the sequence repeats.</span>
<span class="go">      --unquoted  don&#39;t quote line names</span>
<span class="go">  -v, --version           output version information and exit</span>
<span class="go">  -z, --daemonize set values then detach from the controlling terminal</span>

<span class="go">Chips:</span>
<span class="go">    A GPIO chip may be identified by number, name, or path.</span>
<span class="go">    e.g. &#39;0&#39;, &#39;gpiochip0&#39;, and &#39;/dev/gpiochip0&#39; all refer to the same chip.</span>

<span class="go">Periods:</span>
<span class="go">    Periods are taken as milliseconds unless units are specified. e.g. 10us.</span>
<span class="go">    Supported units are &#39;s&#39;, &#39;ms&#39;, and &#39;us&#39;.</span>

<span class="go">*Note*</span>
<span class="go">    The state of a GPIO line controlled over the character device reverts to default</span>
<span class="go">    when the last process referencing the file descriptor representing the device file exits.</span>
<span class="go">    This means that it&#39;s wrong to run gpioset, have it exit and expect the line to continue</span>
<span class="go">    being driven high or low. It may happen if given pin is floating but it must be interpreted</span>
<span class="go">    as undefined behavior.</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Some of the user IOs are used for special functions. Before using a user IO,
refer to the schematic or the hardware manual of your board to ensure that it
is not already in use.</p>
</div>
<section id="gpios-via-sysfs">
<h3><span class="section-number">7.8.1. </span>GPIOs via sysfs<a class="headerlink" href="#gpios-via-sysfs" title="Link to this heading">ï</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Accessing gpios via sysfs is deprecated and we encourage to use libgpiod
instead.</p>
</div>
<p>Support to access GPIOs via sysfs is not enabled by default any more.
It is only possible with manually enabling <code class="docutils literal notranslate"><span class="pre">CONFIG_GPIO_SYSFS</span></code> in the kernel
configuration. To make <code class="docutils literal notranslate"><span class="pre">CONFIG_GPIO_SYSFS</span></code> visible in menuconfig the option
<code class="docutils literal notranslate"><span class="pre">CONFIG_EXPERT</span></code> has to be enabled first.</p>
<p>You can also add this option for example to the defconfig you use in
<code class="docutils literal notranslate"><span class="pre">arch/arm64/configs/</span></code> in the linux kernel sources. For our NXP based releases,
this could be for example imx8_phytec_defconfig:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>..
CONFIG_EXPERT=y
CONFIG_GPIO_SYSFS=y
..
</pre></div>
</div>
<p>Otherwise you can create a new config fragment. This is described in our
<a class="reference internal" href="../../../yocto/master.html#yocto-man-master-kernel-and-bootloader-conf"><span class="std std-ref">Yocto Reference Manual</span></a>.</p>
</section>
</section>
<section id="leds">
<h2><span class="section-number">7.9. </span>LEDs<a class="headerlink" href="#leds" title="Link to this heading">ï</a></h2>
<p>If any LEDs are connected to GPIOs, you have the possibility to access them by a
special LED driver interface instead of the general GPIO interface (section
GPIOs). You will then access them using <code class="docutils literal notranslate"><span class="pre">/sys/class/leds/</span></code> instead
of <code class="docutils literal notranslate"><span class="pre">/sys/class/gpio/</span></code>. The maximum brightness of the LEDs can be read from
the <code class="docutils literal notranslate"><span class="pre">max_brightness</span></code> file. The brightness file will set the brightness of the LED
(taking a value from 0 up to max_brightness). Most LEDs do not have hardware
brightness support and will just be turned on by all non-zero brightness
settings.</p>
<p>Below is a simple example.</p>
<p>To get all available LEDs, type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ls<span class="w"> </span>/sys/class/leds
<span class="go">led-1@  led-2@  led-3@  mmc1::@  mmc2::@</span>
</pre></div>
</div>
<p>The phyBOARD-Pollux provides the following LED indicators: red:user1, green:user2 and blue:user3.</p>
<ul>
<li><p>To toggle the LEDs ON:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">255</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/leds/red<span class="se">\:</span>user1/brightness
</pre></div>
</div>
</li>
<li><p>To toggle OFF:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/leds/red<span class="se">\:</span>user1/brightness
</pre></div>
</div>
</li>
</ul>
<p>Device tree configuration for the User I/O configuration can be found here:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L255">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L255</a></p>
</section>
<section id="i2c-bus">
<h2><span class="section-number">7.10. </span>IÂ²C Bus<a class="headerlink" href="#i2c-bus" title="Link to this heading">ï</a></h2>
<p>The i.MX 8M Plus contains several Multimaster fast-mode IÂ²C modules. PHYTEC boards
provide plenty of different IÂ²C devices connected to the IÂ²C modules of the
i.MX 8M Plus. This section describes the basic device usage and its DT representation
of some IÂ²C devices integrated into our phyBOARD-Pollux.</p>
<p>The device tree node for i2c contains settings such as clock-frequency to set
the bus frequency and the pin control settings including scl-gpios and sda-gpios
which are alternate pin configurations used for bus recovery.</p>
<p>General IÂ²C1 bus configuration (e.g. imx8mp-phycore-som.dtsi):
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L113">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L113</a></p>
<p>General IÂ²C2 bus configuration (e.g. imx8mp-phyboard-pollux-rdk.dts)
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L239">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L239</a></p>
</section>
<section id="eeprom">
<h2><span class="section-number">7.11. </span>EEPROM<a class="headerlink" href="#eeprom" title="Link to this heading">ï</a></h2>
<p>On the phyCORE-i.MX 8M Plus there is an i2c EEPROM flash populated. It has two addresses. The
main EEPROM space (bus: I2C-0 address: 0x51) can be accessed via the sysfs
interface in Linux. The first 256 bytes of the main EEPROM and the ID-page
(bus: I2C-0 address: 0x59) are used for board detection and must not be
overwritten. Therefore the ID-page can not be accessed via the sysfs interface.
Overwriting reserved spaces will result in boot issues.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you deleted reserved EEPROM spaces, please contact our support!</p>
</div>
<section id="i2c-eeprom-on-som">
<h3><span class="section-number">7.11.1. </span>I2C EEPROM on phyCORE-i.MX 8M Plus<a class="headerlink" href="#i2c-eeprom-on-som" title="Link to this heading">ï</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The EEPROM ID page (bus: I2C-0 addr: 0x59) and the first 256 bytes of the
normal EEPROM area (bus: I2C-0 addr: 0x51) should not be erased or
overwritten. As this will influence the behavior of the bootloader. The board
might not boot correctly anymore.</p>
</div>
<p>The I2C EEPROM on the phyCORE-i.MX 8M Plus SoM is connected to I2C address 0x51 on the I2C-0
bus. It is possible to read and write directly to the device populated:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hexdump<span class="w"> </span>-c<span class="w"> </span>/sys/class/i2c-dev/i2c-0/device/0-0051/eeprom
</pre></div>
</div>
<p>To read and print the first 1024 bytes of the EEPROM as a hex number,
execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/sys/class/i2c-dev/i2c-0/device/0-0051/eeprom<span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">1024</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>od<span class="w"> </span>-x
</pre></div>
</div>
<p>To fill the 4KiB EEPROM (bus: I2C-0 addr: 0x51) with zeros leaving out the EEPROM data use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>/sys/class/i2c-dev/i2c-0/device/0-0051/eeprom<span class="w"> </span><span class="nv">seek</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">bs</span><span class="o">=</span><span class="m">256</span><span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">15</span>
</pre></div>
</div>
</section>
<section id="eeprom-som-detection">
<h3><span class="section-number">7.11.2. </span>EEPROM SoM Detection<a class="headerlink" href="#eeprom-som-detection" title="Link to this heading">ï</a></h3>
<p>The I2C EEPROM, populated on the phyCORE-i.MX 8M Plus, has a separate ID page that is
addressable over I2C address 0x59 on bus 0 and a normal area that is addressable
over I2C address 0x51 on bus 0. PHYTEC uses this data area of 32 Bytes to store
information about the SoM. This includes PCB revision and mounting options.</p>
<p>The EEPROM data is read at a really early stage during startup. It is used to
select the correct RAM configuration. This makes it possible to use the same
bootloader image for different RAM sizes and choose the correct DTS overlays
automatically.</p>
<p>If the EEPROM ID page data and the first 256 bytes of the normal area are
deleted, the bootloader will fall back to the phyCORE-i.MX 8M Plus Kit RAM setup, which
is 2GiB RAM.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The EEPROM ID page (bus: I2C-0 addr: 0x59) and the first 256 bytes of the
normal EEPROM area (bus: I2C-0 addr: 0x51) should not be erased or
overwritten. As this will influence the behavior of the bootloader. The board
might not boot correctly anymore.</p>
</div>
<p>SoMs that are flashed with data format API revision 2 will print out information
about the module in the early stage.</p>
<p>DT representation, e.g. in phyCORE-i.MX 8M Plus file imx8mp-phycore-som.dtsi can be
found in our PHYTEC git:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L201">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L201</a></p>
</section>
</section>
<section id="rtc">
<h2><span class="section-number">7.12. </span>RTC<a class="headerlink" href="#rtc" title="Link to this heading">ï</a></h2>
<p>RTCs can be accessed via <code class="docutils literal notranslate"><span class="pre">/dev/rtc*</span></code>. Because PHYTEC boards have often more than
one RTC, there might be more than one RTC device file.</p>
<ul>
<li><p>To find the name of the RTC device, you can read its sysfs entry with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/class/rtc/rtc*/name
</pre></div>
</div>
</li>
<li><p>You will get, for example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rtc-rv3028 0-0052
snvs_rtc 30370000.snvs:snvs-rtc-lp
</pre></div>
</div>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This will list all RTCs including the non-IÂ²C RTCs. Linux assigns RTC device
IDs based on the device tree/aliases entries if present.</p>
</div>
<p>Date and time can be manipulated with the <code class="docutils literal notranslate"><span class="pre">hwclock</span></code> tool and the date command.
To show the current date and time set on the target:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>date
<span class="go">Thu Jan  1 00:01:26 UTC 1970</span>
</pre></div>
</div>
<p>Change the date and time with the date command. The date command sets the time
with the following syntax âYYYY-MM-DD hh:mm:ss (+|-)hh:mmâ:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>date<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;2022-03-02 11:15:00 +0100&quot;</span>
<span class="go">Wed Mar  2 10:15:00 UTC 2022</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Your timezone (in this example +0100) may vary.</p>
</div>
<p>Using the date command does not change the time and date of the RTC, so if we
were to restart the target those changes would be discarded. To write to the RTC
we need to use the <code class="docutils literal notranslate"><span class="pre">hwclock</span></code> command. Write the current date and time (set
with the date command) to the RTC using the <code class="docutils literal notranslate"><span class="pre">hwclock</span></code> tool and reboot the
target to check if the changes were applied to the RTC:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hwclock<span class="w"> </span>-w
<span class="gp">target:~$ </span>reboot
<span class="go">    .</span>
<span class="go">    .</span>
<span class="go">    .</span>
<span class="gp">target:~$ </span>date
<span class="go">Wed Mar  2 10:34:06 UTC 2022</span>
</pre></div>
</div>
<p>To set the time and date from the RTC use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>date
<span class="go">Thu Jan  1 01:00:02 UTC 1970</span>
<span class="gp">target:~$ </span>hwclock<span class="w"> </span>-s
<span class="gp">target:~$ </span>date
<span class="go">Wed Mar  2 10:45:01 UTC 2022</span>
</pre></div>
</div>
<section id="rtc-wakealarm">
<h3><span class="section-number">7.12.1. </span>RTC Wakealarm<a class="headerlink" href="#rtc-wakealarm" title="Link to this heading">ï</a></h3>
<p>It is possible to issue an interrupt from the RTC to wake up the system. The
format uses the Unix epoch time, which is the number of seconds since UTC
midnight on 1 January 1970. To wake up the system after 4 minutes from suspend
to ram state, type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;+240&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/rtc/rtc0/wakealarm
<span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span>mem<span class="w"> </span>&gt;<span class="w"> </span>/sys/power/state
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Internally the wake alarm time will be rounded up to the next minute since
the alarm function doesnât support seconds.</p>
</div>
</section>
<section id="rtc-parameters">
<h3><span class="section-number">7.12.2. </span>RTC Parameters<a class="headerlink" href="#rtc-parameters" title="Link to this heading">ï</a></h3>
<p>RTCs have a few abilities which can be read/set with the help of <code class="docutils literal notranslate"><span class="pre">hwclock</span></code>
tool.</p>
<ul>
<li><p>We can check RTC supported features with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hwclock<span class="w"> </span>--param-get<span class="w"> </span>features
<span class="go">The RTC parameter 0x0 is set to 0x71.</span>
</pre></div>
</div>
<p>What this value means is encoded in kernel, each set bit translates to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#define RTC_FEATURE_ALARM               0
#define RTC_FEATURE_ALARM_RES_MINUTE    1
#define RTC_FEATURE_NEED_WEEK_DAY       2
#define RTC_FEATURE_ALARM_RES_2S        3
#define RTC_FEATURE_UPDATE_INTERRUPT    4
#define RTC_FEATURE_CORRECTION          5
#define RTC_FEATURE_BACKUP_SWITCH_MODE  6
#define RTC_FEATURE_ALARM_WAKEUP_ONLY   7
#define RTC_FEATURE_CNT                 8
</pre></div>
</div>
</li>
<li><p>We can check RTC BSM (Backup Switchover Mode) with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hwclock<span class="w"> </span>--param-get<span class="w"> </span>bsm
<span class="go">The RTC parameter 0x2 is set to 0x1.</span>
</pre></div>
</div>
</li>
<li><p>We can set RTC BSM with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hwclock<span class="w"> </span>--param-set<span class="w"> </span><span class="nv">bsm</span><span class="o">=</span>0x2
<span class="go">The RTC parameter 0x2 will be set to 0x2.</span>
</pre></div>
</div>
<p>What BSM values mean translates to these values:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#define RTC_BSM_DISABLED   0
#define RTC_BSM_DIRECT     1
#define RTC_BSM_LEVEL      2
#define RTC_BSM_STANDBY    3
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You should set BSM mode to DSM or LSM for RTC to switch to backup power
source when the initial power source is not available. Check <strong>RV-3028</strong> RTC
datasheet to read what LSM (Level Switching Mode) and DSM (Direct Switching
Mode) actually mean.</p>
</div>
</li>
</ul>
<p>DT representation for IÂ²C RTCs:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L208">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phycore-som.dtsi#L208</a></p>
</section>
</section>
<section id="usb-host-controller">
<h2><span class="section-number">7.13. </span>USB Host Controller<a class="headerlink" href="#usb-host-controller" title="Link to this heading">ï</a></h2>
<p>The USB controller of the i.MX 8M Plus SoC provides a low-cost connectivity solution
for numerous consumer portable devices by providing a mechanism for data
transfer between USB devices with a line/bus speed of up to 4 Gbit/s (SuperSpeed
âSSâ). The USB subsystem has two independent USB controller cores. Both cores
are capable of acting as a USB peripheral device or a USB host. Each is
connected to a USB 3.0 PHY.</p>
<p>The unified BSP includes support for mass storage devices and keyboards. Other
USB-related device drivers must be enabled in the kernel configuration on
demand. Due to udev, all mass storage devices connected get unique IDs and can
be found in <code class="docutils literal notranslate"><span class="pre">/dev/disk/by-id</span></code>. These IDs can be used in <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> to mount the
different USB memory devices in different ways.</p>
<p>DT representation for USB Host:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L380">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L380</a></p>
</section>
<section id="can-fd">
<h2><span class="section-number">7.14. </span>CAN FD<a class="headerlink" href="#can-fd" title="Link to this heading">ï</a></h2>
<p>The phyBOARD-Pollux has two flexCAN interfaces supporting CAN FD. They are supported by
the Linux standard CAN framework which builds upon then the Linux network
layer.
Using this framework, the CAN interfaces behave like an ordinary Linux network
device, with some additional features special to CAN. More information can be
found in the Linux Kernel
documentation: <a class="reference external" href="https://www.kernel.org/doc/html/latest/networking/can.html">https://www.kernel.org/doc/html/latest/networking/can.html</a></p>
<ul>
<li><p>Use:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>link
</pre></div>
</div>
<p>to see the state of the interfaces. The two CAN interfaces should show up as
can0 and can1.</p>
</li>
<li><p>To get information on can0, such as bit rate and error counters, type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>-d<span class="w"> </span>-s<span class="w"> </span>link<span class="w"> </span>show<span class="w"> </span>can0
</pre></div>
</div>
<p>The information for can0 will look like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>2: can0: &lt;NOARP,UP,LOWER_UP,ECHO&gt; mtu 16 qdisc pfifo_fast state UNKNOWN mode DEFAULT group default qlen 10
    link/can  promiscuity 0 minmtu 0 maxmtu 0
    can state ERROR-ACTIVE (berr-counter tx 0 rx 0) restart-ms 0
          bitrate 500000 sample-point 0.875
          tq 50 prop-seg 17 phase-seg1 17 phase-seg2 5 sjw 1
          mcp25xxfd: tseg1 2..256 tseg2 1..128 sjw 1..128 brp 1..256 brp-inc 1
          mcp25xxfd: dtseg1 1..32 dtseg2 1..16 dsjw 1..16 dbrp 1..256 dbrp-inc 1
          clock 20000000
          re-started bus-errors arbit-lost error-warn error-pass bus-off
          0          0          0          0          0          0         numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535
    RX: bytes  packets  errors  dropped overrun mcast
    0          0        0       0       0       0
    TX: bytes  packets  errors  dropped carrier collsns
    0          0        0       0       0       0
</pre></div>
</div>
</li>
</ul>
<p>The output contains a standard set of parameters also shown for Ethernet
interfaces, so not all of these are necessarily relevant for CAN (for example
the MAC address). The following output parameters contain useful information:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>can0</p></th>
<th class="head"><p>Interface Name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>NOARP</p></td>
<td><p>CAN cannot use ARP protocol</p></td>
</tr>
<tr class="row-odd"><td><p>MTU</p></td>
<td><p>Maximum Transfer Unit</p></td>
</tr>
<tr class="row-even"><td><p>RX packets</p></td>
<td><p>Number of Received Packets</p></td>
</tr>
<tr class="row-odd"><td><p>TX packets</p></td>
<td><p>Number of Transmitted Packets</p></td>
</tr>
<tr class="row-even"><td><p>RX bytes</p></td>
<td><p>Number of Received Bytes</p></td>
</tr>
<tr class="row-odd"><td><p>TX bytes</p></td>
<td><p>Number of Transmitted Bytes</p></td>
</tr>
<tr class="row-even"><td><p>errorsâ¦</p></td>
<td><p>Bus Error Statistics</p></td>
</tr>
</tbody>
</table>
<p>The CAN configuration is done in the systemd configuration
file <code class="docutils literal notranslate"><span class="pre">/lib/systemd/network/can0.network</span></code>. For a persistent change of (as an
example, the default bitrates), change the configuration in the BSP
under <code class="docutils literal notranslate"><span class="pre">./meta-ampliphy/recipes-core/systemd/systemd-conf/can0.network</span></code> in
the root filesystem and rebuild the root filesystem.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Match]
Name=can0

[Can]
BitRate=500000
</pre></div>
</div>
<p>The bitrate can also be changed manually, for example, to make use of the
flexible bitrate:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>can0<span class="w"> </span>down
<span class="gp">target:~$ </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>can0<span class="w"> </span>txqueuelen<span class="w"> </span><span class="m">10</span><span class="w"> </span>up<span class="w"> </span><span class="nb">type</span><span class="w"> </span>can<span class="w"> </span>bitrate<span class="w"> </span><span class="m">500000</span><span class="w"> </span>sample-point<span class="w"> </span><span class="m">0</span>.75<span class="w"> </span>dbitrate<span class="w"> </span><span class="m">4000000</span><span class="w"> </span>dsample-point<span class="w"> </span><span class="m">0</span>.8<span class="w"> </span>fd<span class="w"> </span>on
</pre></div>
</div>
<p>You can send messages with cansend or receive messages with candump:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cansend<span class="w"> </span>can0<span class="w"> </span><span class="m">123</span><span class="c1">#45.67</span>
<span class="gp">target:~$ </span>candump<span class="w"> </span>can0
</pre></div>
</div>
<p>To generate random CAN traffic for testing purposes, use cangen:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cangen
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cansend</span> <span class="pre">--help</span></code> and <code class="docutils literal notranslate"><span class="pre">candump</span> <span class="pre">--help</span></code> provide help messages for further information
on options and usage.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The mcp2518fd SPI to CANfd supports only baudrates starting from 125kB/s.
Slower rates can be selected but may not work correctly.</p>
</div>
<p>Device Tree CAN configuration of imx8mp-phyboard-pollux-rdk.dts:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L203">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L203</a></p>
</section>
<section id="pcie">
<h2><span class="section-number">7.15. </span>PCIe<a class="headerlink" href="#pcie" title="Link to this heading">ï</a></h2>
<p>The phyCORE-i.MX 8M Plus has one Mini-PCIe slot. In general, PCIe autodetects new
devices on the bus. After connecting the device and booting up the system, you
can use the command lspci to see all PCIe devices recognized.</p>
<ul>
<li><p>Type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>lspci<span class="w"> </span>-v
</pre></div>
</div>
</li>
<li><p>You will receive:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>00:00.0 PCI bridge: Synopsys, Inc. Device abcd (rev 01) (prog-if 00 [Normal decode])
        Flags: bus master, fast devsel, latency 0, IRQ 218
        Memory at 18000000 (64-bit, non-prefetchable) [size=1M]
        Bus: primary=00, secondary=01, subordinate=ff, sec-latency=0
        I/O behind bridge: None
        Memory behind bridge: 18100000-181fffff [size=1M]
        Prefetchable memory behind bridge: None
        [virtual] Expansion ROM at 18200000 [disabled] [size=64K]
        Capabilities: [40] Power Management version 3
        Capabilities: [50] MSI: Enable+ Count=1/1 Maskable+ 64bit+
        Capabilities: [70] Express Root Port (Slot-), MSI 00
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [148] L1 PM Substates
        Kernel driver in use: dwc3-haps

01:00.0 Network controller: Intel Corporation WiFi Link 5100
        Subsystem: Intel Corporation WiFi Link 5100 AGN
        Flags: fast devsel
        Memory at 18100000 (64-bit, non-prefetchable) [disabled] [size=8K]
        Capabilities: [c8] Power Management version 3
        Capabilities: [d0] MSI: Enable- Count=1/1 Maskable- 64bit+
        Capabilities: [e0] Express Endpoint, MSI 00
        Capabilities: [100] Advanced Error Reporting
        Capabilities: [140] Device Serial Number 00-24-d6-ff-ff-84-0d-1e
        Kernel modules: iwlwifi
</pre></div>
</div>
</li>
</ul>
<p>In this example, the PCIe device is the <em>Intel Corporation WiFi Link 5100</em>.</p>
<p>For PCIe devices, you have to enable the correct driver in the kernel
configuration. This WLAN card, for example, is manufactured by Intel. The
option for the driver, which must be enabled, is named <code class="docutils literal notranslate"><span class="pre">CONFIG_IWLWIFI</span></code> and can be
found under <em>Intel Wireless WiFi Next Gen AGN - Wireless-N/Advanced-N/Ultimat</em> in
the kernel configuration.</p>
<ul class="simple">
<li><p>In order to activate the driver, follow the instructions from our
<a class="reference internal" href="../../../yocto/master.html#yocto-man-master-kernel-and-bootloader-conf"><span class="std std-ref">Yocto Reference Manual</span></a>.</p>
<ul>
<li><p>The linux-imx is represented by: <strong>virtual/kernel</strong></p></li>
</ul>
</li>
</ul>
<p>For some devices like the WLAN card, additional binary firmware blobs are
needed. These firmware blobs have to be placed in <code class="docutils literal notranslate"><span class="pre">/lib/firmware/</span></code> before the
device can be used.</p>
<ul>
<li><p>Type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>scp<span class="w"> </span>-r<span class="w"> </span>&lt;firmware&gt;<span class="w"> </span>root@192.168.3.11:/lib/firmware
</pre></div>
</div>
</li>
<li><p>For example, if you try to bring up the network interface:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>up<span class="w"> </span>wlp1s0
</pre></div>
</div>
</li>
<li><p>You will get the following output on the serial console:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[   58.682104] iwlwifi 0000:01:00.0: L1 Disabled - LTR Disabled</span>
<span class="go">[   58.690822] iwlwifi 0000:01:00.0: L1 Disabled - LTR Disabled</span>
<span class="go">[   58.696577] iwlwifi 0000:01:00.0: Radio type=0x1-0x2-0x0</span>
<span class="go">[   58.831022] iwlwifi 0000:01:00.0: L1 Disabled - LTR Disabled</span>
<span class="go">[   58.839679] iwlwifi 0000:01:00.0: L1 Disabled - LTR Disabled</span>
<span class="go">[   58.845435] iwlwifi 0000:01:00.0: Radio type=0x1-0x2-0x0</span>
<span class="go">[   58.902797] IPv6: ADDRCONF(NETDEV_UP): wlp1s0: link is not ready</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Some PCIe devices, e.g. the Ethernet card, may function properly even if no
firmware blob is loaded from <code class="docutils literal notranslate"><span class="pre">/lib/firmware/</span></code> and you received an error message
as shown in the first line of the output above. This is because some
manufacturers provide the firmware as a fallback on the card itself. In this
case, the behavior and output depend strongly on the manufacturerâs firmware.</p>
</div>
<p>Device Tree PCIe configuration of imx8mp-phyboard-pollux-rdk.dts:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L345">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L345</a></p>
</section>
<section id="audio">
<h2><span class="section-number">7.16. </span>Audio<a class="headerlink" href="#audio" title="Link to this heading">ï</a></h2>
<p>Playback devices supported for phyBOARD-Pollux are HDMI and the TI TLV320AIC3007 audio
codec on the PEB-AV-10 connector. On the AV-Connector there is a 3.5mm headset
jack with OMTP-standard and an 8-pin header. The 8-pin header contains a mono
speaker, headphones, and line in signals.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Using the PEB-AV-10 connector for display output along HDMI as audio output
is not supported. The audio output device must match the video output device.</p>
</div>
<p>To check if your soundcard driver is loaded correctly and what the device is
called, type for playback devices:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>aplay<span class="w"> </span>-L
</pre></div>
</div>
<p>Or type for recording devices:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>arecord<span class="w"> </span>-L
</pre></div>
</div>
<section id="alsamixer">
<h3><span class="section-number">7.16.1. </span>Alsamixer<a class="headerlink" href="#alsamixer" title="Link to this heading">ï</a></h3>
<p>To inspect the capabilities of your soundcard, call:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>alsamixer
</pre></div>
</div>
<p>You should see a lot of options as the audio-IC has many features you can
experiment with. It might be better to open alsamixer via ssh instead of the
serial console, as the console graphical effects are better. You have either
mono or stereo gain controls for all mix points. âMMâ means the feature is muted
(both output, left &amp; right), which can be toggled by hitting â<strong>m</strong>â. You can also
toggle by hitting â<strong>&lt;</strong>â for left and â<strong>&gt;</strong>â for right output. With the <strong>tab</strong>
key, you can switch between controls for playback and recording.</p>
</section>
<section id="restore-default-volumes">
<h3><span class="section-number">7.16.2. </span>Restore default volumes<a class="headerlink" href="#restore-default-volumes" title="Link to this heading">ï</a></h3>
<p>There are some default settings stored in <code class="docutils literal notranslate"><span class="pre">/var/lib/alsa/asound.state</span></code>.
You can save your current alsa settings with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>alsactl<span class="w"> </span>--file<span class="w"> </span>&lt;/path/to/filename&gt;<span class="w"> </span>store
</pre></div>
</div>
<p>You can restore saved alsa settings with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>alsactl<span class="w"> </span>--file<span class="w"> </span>&lt;/path/to/filename&gt;<span class="w"> </span>restore
</pre></div>
</div>
</section>
<section id="alsa-configuration">
<h3><span class="section-number">7.16.3. </span>ALSA configuration<a class="headerlink" href="#alsa-configuration" title="Link to this heading">ï</a></h3>
<p>Our BSP comes with a ALSA configuration file <code class="docutils literal notranslate"><span class="pre">/etc/asound.conf</span></code>.</p>
<p>The ALSA configuration file can be edited as desired or deleted since it is not
required for ALSA to work properly.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>vi<span class="w"> </span>/etc/asound.conf
</pre></div>
</div>
<p>To set PEB-AV-10 as output, set <em>playback.pcm</em> from âdummyâ to âpebav10â:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[...]

pcm.asymed {
        type asym
        playback.pcm &quot;pebav10&quot;
        capture.pcm &quot;dsnoop&quot;
}

[...]
</pre></div>
</div>
<p>If the sound is not audible change playback devices to the software volume control
playback devices, set <em>playback.pcm</em> to the respective softvol playback device e.g.
âsoftvol_pebav10â. Use alsamixer controls to vary the volume levels.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[...]

pcm.asymed {
        type asym
        playback.pcm &quot;softvol_pebav10&quot;
        capture.pcm &quot;dsnoop&quot;
}

[...]
</pre></div>
</div>
</section>
<section id="pulseaudio-configuration">
<h3><span class="section-number">7.16.4. </span>Pulseaudio Configuration<a class="headerlink" href="#pulseaudio-configuration" title="Link to this heading">ï</a></h3>
<p>For applications using <em>Pulseaudio</em>, check for available sinks:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>pactl<span class="w"> </span>list<span class="w"> </span>short<span class="w"> </span>sinks
</pre></div>
</div>
<p>To select the output device, type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>pactl<span class="w"> </span>set-default-sink<span class="w"> </span>&lt;sink_number&gt;
</pre></div>
</div>
</section>
<section id="playback">
<h3><span class="section-number">7.16.5. </span>Playback<a class="headerlink" href="#playback" title="Link to this heading">ï</a></h3>
<p>Run speaker-test to check playback availability:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>speaker-test<span class="w"> </span>-c<span class="w"> </span><span class="m">2</span><span class="w"> </span>-t<span class="w"> </span>wav
</pre></div>
</div>
<p>To playback simple audio streams, you can use aplay. For example to play the
ALSA test sounds:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>aplay<span class="w"> </span>/usr/share/sounds/alsa/*
</pre></div>
</div>
<p>To playback other formats like mp3 for example, you can use Gstreamer:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gst-launch-1.0<span class="w"> </span>playbin<span class="w"> </span><span class="nv">uri</span><span class="o">=</span>file:/path/to/file.mp3
</pre></div>
</div>
</section>
<section id="capture">
<h3><span class="section-number">7.16.6. </span>Capture<a class="headerlink" href="#capture" title="Link to this heading">ï</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">arecord</span></code> is a command-line tool for capturing audio streams which use Line In as
the default input source. To select a different audio source you can
use <code class="docutils literal notranslate"><span class="pre">alsamixer</span></code>. For example, switch on <em>Right PGA Mixer Mic3R</em> and <em>Left PGA Mixer
Mic3R</em> in order to capture the audio from the microphone input of the
TLV320-Codec using the 3.5mm jack.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>amixer<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;sndpebav10&quot;</span><span class="w"> </span>sset<span class="w"> </span><span class="s1">&#39;Left PGA Mixer Mic3R&#39;</span><span class="w"> </span>on
<span class="gp">target:~$ </span>amixer<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;sndpebav10&quot;</span><span class="w"> </span>sset<span class="w"> </span><span class="s1">&#39;Right PGA Mixer Mic3R&#39;</span><span class="w"> </span>on
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>arecord<span class="w"> </span>-t<span class="w"> </span>wav<span class="w"> </span>-c<span class="w"> </span><span class="m">2</span><span class="w"> </span>-r<span class="w"> </span><span class="m">44100</span><span class="w"> </span>-f<span class="w"> </span>S16_LE<span class="w"> </span>test.wav
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Since playback and capture share hardware interfaces, it is not possible to
use different sampling rates and formats for simultaneous playback and
capture operations.</p>
</div>
<p>Device Tree Audio configuration:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-peb-av-10.dtso#L58">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-peb-av-10.dtso#L58</a></p>
</section>
</section>
<section id="video">
<h2><span class="section-number">7.17. </span>Video<a class="headerlink" href="#video" title="Link to this heading">ï</a></h2>
<section id="videos-with-gstreamer">
<h3><span class="section-number">7.17.1. </span>Videos with Gstreamer<a class="headerlink" href="#videos-with-gstreamer" title="Link to this heading">ï</a></h3>
<p>One example video is installed by default in the BSP at <cite>/usr/share/qtphy/videos/</cite>.
Start the video playback with one of these commands:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gst-launch-1.0<span class="w"> </span>playbin<span class="w"> </span><span class="nv">uri</span><span class="o">=</span>file:///usr/share/qtphy/videos/caminandes_3_llamigos_720p_vp9.webm
</pre></div>
</div>
<ul class="simple">
<li><p>Or:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gst-launch-1.0<span class="w"> </span>-v<span class="w"> </span>filesrc<span class="w"> </span><span class="nv">location</span><span class="o">=</span>/usr/share/qtphy/videos/caminandes_3_llamigos_720p_vp9.webm<span class="w"> </span>!<span class="w"> </span>decodebin<span class="w"> </span><span class="nv">name</span><span class="o">=</span>decoder<span class="w"> </span>decoder.<span class="w"> </span>!<span class="w"> </span>videoconvert<span class="w"> </span>!<span class="w"> </span>waylandsink
</pre></div>
</div>
<ul class="simple">
<li><p>Or:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>gst-play-1.0<span class="w"> </span>/usr/share/qtphy/videos/caminandes_3_llamigos_720p_vp9.webm<span class="w"> </span>--videosink<span class="w"> </span>waylandsink
</pre></div>
</div>
</section>
</section>
<section id="display">
<h2><span class="section-number">7.18. </span>Display<a class="headerlink" href="#display" title="Link to this heading">ï</a></h2>
<p>The phyBOARD-Pollux supports up to 3 different display outputs. Two can be used
simultaneously. The following table shows the required extensions and devicetree
overlays for the different interfaces.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Interface</p></th>
<th class="head"><p>Expansion</p></th>
<th class="head"><p>devicetree overlay</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>HDMI</p></td>
<td><p>phyBOARD-Pollux</p></td>
<td><p>no overlay needed (enabled by default)</p></td>
</tr>
<tr class="row-odd"><td><p>LVDS0</p></td>
<td><p>PEB-AV-10</p></td>
<td><p>imx8mp-phyboard-pollux-peb-av-10-ph128800t006.dtbo
(loaded by default)</p></td>
</tr>
<tr class="row-even"><td><p>LVDS1</p></td>
<td><p>phyBOARD-Pollux</p></td>
<td><p>disabled if PEB-AV-10 overlay is used</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>When changing Weston output, make sure to match the audio output as well.</p></li>
<li><p>LVDS0 (PEB-AV-10) and LVDS1 (onboard)can not be used at the same time.</p></li>
</ul>
</div>
<p>HDMI is always enabled in the devicetree. The other interfaces can be enabled
with Device Tree Overlay.</p>
<p>The default-enabled Interfaces are HDMI and LVDS0 (PEB-AV-010). We support a
10ââ edt,etml1010g0dka display for the PEB-AV-10.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The current display driver limits the pixel clock for a display connected to
LVDS to 74.25Mhz (or a divider of it).  If this does not fit your display
requirements, please contact Support for further help.</p>
</div>
<section id="weston-configuration">
<h3><span class="section-number">7.18.1. </span>Weston Configuration<a class="headerlink" href="#weston-configuration" title="Link to this heading">ï</a></h3>
<p>In order to get an output from Weston on the correct display, it still needs to
be configured correctly. This will be done at /etc/xdg/weston/weston.ini.</p>
<section id="single-display">
<h4><span class="section-number">7.18.1.1. </span>Single Display<a class="headerlink" href="#single-display" title="Link to this heading">ï</a></h4>
<p>In our BSP, the default Weston output is set to HDMI.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[output]
name=HDMI-A-1
mode=preferred

[output]
name=LVDS-1
mode=off
</pre></div>
</div>
<p>When using the LVDS0 (PEB-AV-10) as output, set the output mode to off for
HDMI-A-1 and for LVDS-1 to current.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[output]
name=HDMI-A-1
mode=off

[output]
name=LVDS-1
mode=current
</pre></div>
</div>
<p>If you want to use LVDS1 (onboard) then you need to load no overlay. Remove the
imx8mp-phyboard-pollux-peb-av-xxx.dtbo from bootenv.txt.</p>
</section>
<section id="dual-display">
<h4><span class="section-number">7.18.1.2. </span>Dual Display<a class="headerlink" href="#dual-display" title="Link to this heading">ï</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For dual and triple display output you can not use LVDS1 (onboard) and HDMI
together.</p>
</div>
<p>For dual display in dual view mode at HDMI and LVDS0 (PEB-AV-10), both modes
have to be set to the:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[output]
name=HDMI-A-1
mode=preferred

[output]
name=LVDS-1
mode=current
</pre></div>
</div>
</section>
</section>
<section id="qt-demo">
<h3><span class="section-number">7.18.2. </span>Qt Demo<a class="headerlink" href="#qt-demo" title="Link to this heading">ï</a></h3>
<p>With the <code class="docutils literal notranslate"><span class="pre">phytec-qt6demo-image</span></code>, Weston starts during boot. Our Qt6 demo application named
âqtphyâ can be stopped with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>systemctl<span class="w"> </span>stop<span class="w"> </span>qtphy
</pre></div>
</div>
<ul>
<li><p>To start the demo again, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>systemctl<span class="w"> </span>start<span class="w"> </span>qtphy
</pre></div>
</div>
</li>
<li><p>To disable autostart of the demo, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>systemctl<span class="w"> </span>disable<span class="w"> </span>qtphy
</pre></div>
</div>
</li>
<li><p>To enable autostart of the demo, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>qtphy
</pre></div>
</div>
</li>
<li><p>Weston can be stopped with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>systemctl<span class="w"> </span>stop<span class="w"> </span>weston
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Qt demo must be closed before Weston can be closed.</p>
</div>
</section>
<section id="backlight-control">
<h3><span class="section-number">7.18.3. </span>Backlight Control<a class="headerlink" href="#backlight-control" title="Link to this heading">ï</a></h3>
<p>If a display is connected to the PHYTEC board, you can control its backlight
with the Linux kernel sysfs interface. All available backlight devices in the
system can be found in the folder /sys/class/backlight. Reading the appropriate
files and writing to them allows you to control the backlight.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some boards with multiple display connectors might have multiple backlight
controls in /sys/class/backlight. For example: backlight0 and backlight1</p>
</div>
<ul>
<li><p>To get, for example, the maximum brightness level (max_brightness) execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/class/backlight/backlight/max_brightness
</pre></div>
</div>
<p>Valid brightness values are 0 to &lt;max_brightness&gt;.</p>
</li>
<li><p>To obtain the current brightness level, type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/class/backlight/backlight/brightness
</pre></div>
</div>
</li>
<li><p>Write to the file brightness to change the brightness:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/class/backlight/backlight/brightness
</pre></div>
</div>
<p>turns the backlight off for example.</p>
<p>For documentation of all files, see
<a class="reference external" href="https://www.kernel.org/doc/Documentation/ABI/stable/sysfs-class-backlight">https://www.kernel.org/doc/Documentation/ABI/stable/sysfs-class-backlight</a>.</p>
</li>
</ul>
<p>Device tree description of LVDS-1 and HDMI can be found here:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L294">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L294</a>
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L218">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L218</a></p>
<p>The device tree of LVDS-0 on PEB-AV-10 can be found here:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-peb-av-10-ph128800t006.dtso#L133">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-peb-av-10-ph128800t006.dtso#L133</a></p>
</section>
</section>
<section id="power-management">
<h2><span class="section-number">7.19. </span>Power Management<a class="headerlink" href="#power-management" title="Link to this heading">ï</a></h2>
<section id="cpu-core-frequency-scaling">
<h3><span class="section-number">7.19.1. </span>CPU Core Frequency Scaling<a class="headerlink" href="#cpu-core-frequency-scaling" title="Link to this heading">ï</a></h3>
<p>The CPU in the i.MX 8M Plus SoC is able to scale the clock frequency and the voltage.
This is used to save power when the full performance of the CPU is not needed.
Scaling the frequency and the voltage is referred to as âDynamic Voltage and
Frequency Scalingâ (DVFS). The i.MX 8M Plus BSP supports the DVFS feature.
The Linux kernel provides a DVFS framework that allows each CPU core to have a
min/max frequency and a governor that governs it. Depending on the i.MX 8
variant used, several different frequencies are supported.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Although the DVFS framework provides frequency settings for each CPU core, a
change in the frequency settings of one CPU core always affects all other CPU
cores too. So all CPU cores always share the same DVFS setting. An individual
DVFS setting for each core is not possible.</p>
</div>
<ul>
<li><p>To get a complete list type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/devices/system/cpu/cpu0/cpufreq/scaling_available_frequencies
</pre></div>
</div>
<p>In case you have, for example, i.MX 8MPlus CPU with a maximum of approximately
1,6 GHz, the result will be:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1200000 1600000
</pre></div>
</div>
</li>
<li><p>To ask for the current frequency type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
</pre></div>
</div>
</li>
</ul>
<p>So-called governors are automatically selecting one of these frequencies in
accordance with their goals.</p>
<ul>
<li><p>List all governors available with the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors
</pre></div>
</div>
<p>The result will be:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>conservative ondemand userspace powersave performance schedutil
</pre></div>
</div>
</li>
<li><p><strong>conservative</strong> is much like the ondemand governor. It differs in behavior in
that it gracefully increases and decreases the CPU speed rather than jumping
to max speed the moment there is any load on the CPU.</p></li>
<li><p><strong>ondemand</strong> (default) switches between possible CPU core frequencies in
reference to the current system load. When the system load increases above a
specific limit, it increases the CPU core frequency immediately.</p></li>
<li><p><strong>powersave</strong> always selects the lowest possible CPU core frequency.</p></li>
<li><p><strong>performance</strong> always selects the highest possible CPU core frequency.</p></li>
<li><p><strong>userspace</strong> allows the user or userspace program running as root to set a
specific frequency (e.g. to 1600000). Type:</p></li>
<li><p>In order to ask for the current governor, type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
</pre></div>
</div>
<p>You will normally get:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ondemand
</pre></div>
</div>
</li>
<li><p>Switching over to another governor (e.g. userspace) is done with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span>userspace<span class="w"> </span>&gt;<span class="w"> </span>/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
</pre></div>
</div>
</li>
<li><p>Now you can set the speed:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">1600000</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/devices/system/cpu/cpu0/cpufreq/scaling_setspeed
</pre></div>
</div>
</li>
</ul>
<p>For more detailed information about the governors, refer to the Linux kernel
documentation in the linux kernel repository at
<code class="docutils literal notranslate"><span class="pre">Documentation/admin-guide/pm/cpufreq.rst</span></code>.</p>
</section>
<section id="cpu-core-management">
<h3><span class="section-number">7.19.2. </span>CPU Core Management<a class="headerlink" href="#cpu-core-management" title="Link to this heading">ï</a></h3>
<p>The i.MX 8M Plus SoC can have multiple processor cores on the die. The i.MX 8M Plus, for
example, has 4 ARM Cores which can be turned on and off individually at runtime.</p>
<ul>
<li><p>To see all available cores in the system, execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>ls<span class="w"> </span>/sys/devices/system/cpu<span class="w">  </span>-1
</pre></div>
</div>
</li>
<li><p>This will show, for example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cpu0    cpu1   cpu2   cpu3   cpufreq
[...]
</pre></div>
</div>
<p>Here the system has four processor cores. By default, all available cores in the
system are enabled to get maximum performance.</p>
</li>
<li><p>To switch off a single-core, execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/devices/system/cpu/cpu3/online
</pre></div>
</div>
<p>As confirmation, you will see:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[  110.505012] psci: CPU3 killed
</pre></div>
</div>
<p>Now the core is powered down and no more processes are scheduled on this core.</p>
</li>
<li><p>You can use top to see a graphical overview of the cores and processes:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>htop
</pre></div>
</div>
</li>
<li><p>To power up the core again, execute:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/devices/system/cpu/cpu3/online
</pre></div>
</div>
</li>
</ul>
</section>
<section id="suspend-to-ram">
<h3><span class="section-number">7.19.3. </span>Suspend to RAM<a class="headerlink" href="#suspend-to-ram" title="Link to this heading">ï</a></h3>
<p>The phyCORE-i.MX 8M Plus supports basic suspend and resume. Different wake-up sources can be
used. Suspend/resume is possible with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span>mem<span class="w"> </span>&gt;<span class="w"> </span>/sys/power/state
<span class="gp">#</span>resume<span class="w"> </span>with<span class="w"> </span>pressing<span class="w"> </span>on/off<span class="w"> </span>button
</pre></div>
</div>
<p>To wake up with serial console run</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span>enabled<span class="w"> </span>&gt;<span class="w"> </span>/sys/class/tty/ttymxc0/power/wakeup
<span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span>mem<span class="w"> </span>&gt;<span class="w"> </span>/sys/power/state
</pre></div>
</div>
</section>
</section>
<section id="thermal-management">
<h2><span class="section-number">7.20. </span>Thermal Management<a class="headerlink" href="#thermal-management" title="Link to this heading">ï</a></h2>
<section id="u-boot">
<h3><span class="section-number">7.20.1. </span>U-Boot<a class="headerlink" href="#u-boot" title="Link to this heading">ï</a></h3>
<p>The previous temperature control in the U-Boot was not satisfactory. Now the
u-boot has a temperature shutdown to prevent the board from getting too hot
during booting. The temperatures at which the shutdown occurs are identical to
those in the kernel.</p>
<p>The individual temperature ranges with the current temperature are displayed in
the boot log:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU:   Industrial temperature grade (-40C to 105C) at 33C
</pre></div>
</div>
</section>
<section id="kernel">
<h3><span class="section-number">7.20.2. </span>Kernel<a class="headerlink" href="#kernel" title="Link to this heading">ï</a></h3>
<p>The Linux kernel has integrated thermal management that is capable of monitoring
SoC temperatures, reducing the CPU frequency, driving fans, advising other
drivers to reduce the power consumption of devices, and â worst-case â shutting
down the system gracefully
(<a class="reference external" href="https://www.kernel.org/doc/Documentation/thermal/sysfs-api.txt">https://www.kernel.org/doc/Documentation/thermal/sysfs-api.txt</a>).</p>
<p>This section describes how the thermal management kernel API is used for the
i.MX 8M Plus SoC platform. The i.MX 8 has internal temperature sensors for the
SoC.</p>
<ul>
<li><p>The current temperature can be read in millicelsius with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>cat<span class="w"> </span>/sys/class/thermal/thermal_zone0/temp
</pre></div>
</div>
</li>
<li><p>You will get, for example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>49000
</pre></div>
</div>
</li>
</ul>
<p>There are two trip points registered by the imx_thermal kernel driver. These
differ depending on the CPU variant. A distinction is made between Industrial
and Commercial.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>Commercial</p></th>
<th class="head"><p>Industrial</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>passive (warning)</p></td>
<td><p>85Â°C</p></td>
<td><p>95Â°C</p></td>
</tr>
<tr class="row-odd"><td><p>critical (shutdown)</p></td>
<td><p>90Â°C</p></td>
<td><p>100Â°C</p></td>
</tr>
</tbody>
</table>
<p>(see kernel sysfs folder <code class="docutils literal notranslate"><span class="pre">/sys/class/thermal/thermal_zone0/</span></code>)</p>
<p>The kernel thermal management uses these trip points to trigger events and
change the cooling behavior. The following thermal policies (also named thermal
governors) are available in the kernel: Step Wise, Fair Share, Bang Bang, and
Userspace. The default policy used in the BSP is step_wise. If the value of the
SoC temperature in the sysfs file temp is above <em>trip_point_0</em>, the CPU frequency
is set to the lowest CPU frequency. When the SoC temperature drops below
<em>trip_point_0</em> again, the throttling is released.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The actual values of the thermal trip points may differ since we mount CPUs
with different temperature grades.</p>
</div>
</section>
<section id="gpio-fan">
<h3><span class="section-number">7.20.3. </span>GPIO Fan<a class="headerlink" href="#gpio-fan" title="Link to this heading">ï</a></h3>
<p>A GPIO fan can be connected to the phyBOARD-Pollux-i.MX 8M Plus. The SoC only contains one
temperature sensor which is already used by the thermal frequency scaling. The
fan can not be controlled by the kernel. We use lmsensors with hwmon for this
instead. lmsensors reads the temperature periodically and enables or disables
the fan at a configurable threshold. For the phyBOARD-Pollux-i.MX 8M Plus, this is 60Â°C.</p>
<p>The settings can be configured in the configuration file:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/etc/fancontrol
</pre></div>
</div>
<p>Fan control is started by a systemd service during boot. This can be disabled
with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>systemctl<span class="w"> </span>disable<span class="w"> </span>fancontrol
</pre></div>
</div>
<p>The device tree description of GPIO Fan can be found here:
<a class="extlink-linux-phytec-imx reference external" href="https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L35">https://github.com/phytec/linux-phytec-imx/tree/v6.12.20-2.0.0-phy1/arch/arm64/boot/dts/freescale/imx8mp-phyboard-pollux-rdk.dts#L35</a></p>
</section>
</section>
<section id="watchdog">
<h2><span class="section-number">7.21. </span>Watchdog<a class="headerlink" href="#watchdog" title="Link to this heading">ï</a></h2>
<p>The PHYTEC i.MX 8M Plus modules include a hardware watchdog that is able to reset the
board when the system hangs. The watchdog is started on default in U-Boot with a
timeout of 60s. So even during early kernel start, the watchdog is already up
and running. The Linux kernel driver takes control over the watchdog and makes
sure that it is fed. This section explains how to configure the watchdog in
Linux using systemd to check for system hangs and during reboot.</p>
<section id="watchdog-support-in-systemd">
<h3><span class="section-number">7.21.1. </span>Watchdog Support in systemd<a class="headerlink" href="#watchdog-support-in-systemd" title="Link to this heading">ï</a></h3>
<p>Systemd has included hardware watchdog support since version 183.</p>
<ul>
<li><p>To activate watchdog support, the file system.conf in <code class="docutils literal notranslate"><span class="pre">/etc/systemd/</span></code> has to be
adapted by enabling the options:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>RuntimeWatchdogSec=60s
ShutdownWatchdogSec=10min
</pre></div>
</div>
</li>
</ul>
<p><em>RuntimeWatchdogSec</em> defines the timeout value of the watchdog,
while <em>ShutdownWatchdogSec</em> defines the timeout when the system is rebooted. For
more detailed information about hardware watchdogs under systemd can be found at
<a class="reference external" href="http://0pointer.de/blog/projects/watchdog.html">http://0pointer.de/blog/projects/watchdog.html</a>. The changes will take effect
after a reboot or run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$  </span>systemctl<span class="w"> </span>daemon-reload
</pre></div>
</div>
</section>
</section>
<section id="snvs-power-key">
<h2><span class="section-number">7.22. </span>snvs Power Key<a class="headerlink" href="#snvs-power-key" title="Link to this heading">ï</a></h2>
<p>The X_ONOFF pin connected to the ON/OFF button can be pressed long to trigger
Power OFF without SW intervention or used to wake up the system out of suspend.
With the <em>snvs_pwrkey</em> driver, the KEY_POWER event is also reported to userspace
when the button is pressed. On default, systemd is configured to ignore such
events. The function of Power OFF without SW intervention and the wake-up from
suspend are not configured. Triggering a power off with systemd when pushing the
ON/OFF button can be configured under <code class="docutils literal notranslate"><span class="pre">/etc/systemd/logind.conf</span></code> and set using:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>HandlePowerKey=poweroff
</pre></div>
</div>
</section>
<section id="npu">
<h2><span class="section-number">7.23. </span>NPU<a class="headerlink" href="#npu" title="Link to this heading">ï</a></h2>
<p>The i.MX 8M Plus SoC contains a Neural Processing Unit up to 2.3 TOPS as an accelerator
for artificial intelligence operations. Refer to our latest phyCORE-i.MX 8M Plus AI Kit
Guide on the phyCORE-i.MX 8M Plus download section to get information about the
NPU: <a class="reference external" href="https://www.phytec.de/cdocuments/?doc=9oB5Hg">L-1015e.A1 phyCORE-i.MX 8M Plus AI Kit Guide</a></p>
</section>
<section id="isp">
<h2><span class="section-number">7.24. </span>ISP<a class="headerlink" href="#isp" title="Link to this heading">ï</a></h2>
<p>The i.MX 8M Plus SoC contains an Image Signal Processor (ISP). For more information see
Using the ISPs on the phyBOARD-Pollux i.MX 8M Plus documentation. This documentation is also
available in German.</p>
</section>
<section id="on-chip-otp-controller-ocotp-ctrl-efuses">
<h2><span class="section-number">7.25. </span>On-Chip OTP Controller (OCOTP_CTRL) - eFuses<a class="headerlink" href="#on-chip-otp-controller-ocotp-ctrl-efuses" title="Link to this heading">ï</a></h2>
<p>The i.MX 8M Plus provides one-time programmable fuses to store information such as the
MAC address, boot configuration, and other permanent settings (âOn-Chip OTP
Controller (OCOTP_CTRL)â in the i.MX 8M Plus Reference Manual). The following list is
an abstract from the i.MX 8M Plus Reference Manual and includes some useful registers
in the OCOTP_CTRL (at base address 0x30350000):</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Bank</p></th>
<th class="head"><p>Word</p></th>
<th class="head"><p>Memory offset
at 0x30350000</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>OCOTP_MAC_ADDR0</p></td>
<td><p>9</p></td>
<td><p>0</p></td>
<td><p>0x640</p></td>
<td><p>contains lower 32 bits
of ENET0 MAC address</p></td>
</tr>
<tr class="row-odd"><td><p>OCOTP_MAC_ADDR1</p></td>
<td><p>9</p></td>
<td><p>1</p></td>
<td><p>0x650</p></td>
<td><p>contains upper 16 bits
of ENET0 MAC address
and the lower 16 bits
of ENET1 MAC address</p></td>
</tr>
<tr class="row-even"><td><p>OCOTP_MAC_ADDR2</p></td>
<td><p>9</p></td>
<td><p>2</p></td>
<td><p>0x660</p></td>
<td><p>contains upper 32 bits
of ENET1 MAC address</p></td>
</tr>
</tbody>
</table>
<p>A complete list and a detailed mapping between the fuses in the OCOTP_CTRL and
the boot/mac/â¦ configuration are available in the section âFuse Mapâ of the
i.MX 8M Plus Security Reference Manual.</p>
<section id="reading-fuse-values-in-uboot">
<h3><span class="section-number">7.25.1. </span>Reading Fuse Values in uBoot<a class="headerlink" href="#reading-fuse-values-in-uboot" title="Link to this heading">ï</a></h3>
<p>You can read the content of a fuse using memory-mapped shadow registers. To
calculate the memory address, use the fuse Bank and Word in the following
formula:</p>
<p>OCOTP_MAC_ADDR:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; fuse read 9 0
</pre></div>
</div>
</section>
<section id="reading-fuse-values-in-linux">
<h3><span class="section-number">7.25.2. </span>Reading Fuse Values in Linux<a class="headerlink" href="#reading-fuse-values-in-linux" title="Link to this heading">ï</a></h3>
<p>To access the content of the fuses in Linux NXP provides the NVMEM_IMX_OCOTP
module. All fuse content of the memory-mapped shadow registers is accessible via
sysfs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span>hexdump<span class="w"> </span>/sys/devices/platform/soc@0/30000000.bus/30350000.efuse/imx-ocotp0/nvmem
</pre></div>
</div>
</section>
</section>
</section>
<section id="soc-mcore">
<h1><span class="section-number">8. </span>i.MX 8M Plus M7 Core<a class="headerlink" href="#soc-mcore" title="Link to this heading">ï</a></h1>
<p>In addition to the Cortex-A53 cores, there is a Cortex-M7 Core as MCU
integrated into the i.MX 8M Plus SoC. Our Yocto-Linux-BSP runs on the A53-Cores and
the M7 Core can be used as a secondary core for additional tasks using
bare-metal or RTOS firmware.
Both cores have access to the same peripherals and thus peripheral
usage needs to be limited either in the M7 Coreâs firmware or the devicetree
for the Linux operating system. This section describes how to build firmware
examples and how to run them on phyBOARD-Pollux.</p>
<p>The phyBOARD-Pollux is currently supported by the NXP MCUXpresso SDK and by
The Zephyr Project. This section only describes the NXP MCUXpresso SDK because
the MCUXpresso SDK has more supported features at the moment.</p>
<p>If you want to use the M7 Core with The Zephyr Project, please refer to the
The Zephyr Project documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.zephyrproject.org/latest/boards/phytec/mimx8mp_phyboard_pollux/doc/index.html">https://docs.zephyrproject.org/latest/boards/phytec/mimx8mp_phyboard_pollux/doc/index.html</a></p></li>
</ul>
<section id="getting-the-firmware-examples">
<h2><span class="section-number">8.1. </span>Getting the Firmware Examples<a class="headerlink" href="#getting-the-firmware-examples" title="Link to this heading">ï</a></h2>
<p>The firmware can be built using the NXP MCUxpresso SDK with a compatible
compiler toolchain using command-line tools.</p>
<section id="getting-the-sources">
<h3><span class="section-number">8.1.1. </span>Getting the Sources<a class="headerlink" href="#getting-the-sources" title="Link to this heading">ï</a></h3>
<p>The MCUX SDK and the examples for the i.MX 8M Plus can be obtained from PHYTECâs GitHub
page:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/phytec/mcux-sdk/">https://github.com/phytec/mcux-sdk/</a></p></li>
<li><p><a class="reference external" href="https://github.com/phytec/mcux-sdk-phytec-examples/">https://github.com/phytec/mcux-sdk-phytec-examples/</a></p></li>
</ul>
<ol class="arabic">
<li><p>Initialize the MCUX SDK via west:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>west<span class="w"> </span>init<span class="w"> </span>-m<span class="w"> </span>https://github.com/phytec/mcux-sdk/<span class="w"> </span>--mr<span class="w"> </span>&lt;VERSION&gt;<span class="w"> </span>mcuxsdk
</pre></div>
</div>
<p>This will create a mcuxsdk directory with the mcux-sdk repository in it.
The <code class="docutils literal notranslate"><span class="pre">mcux-sdk-phytec-examples</span></code> repository will be automatically cloned into
the mcuxsdk directory.
The given argument &lt;VERSION&gt; is a the branch name of the mcux-sdk repository
that represents the MCUX SDK version. For the newest tested version
you can use 2.13.0.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">west</span></code> is a repository management tool and a part of the Zephyr
Project.
To install west, you can use pip. In this example west is installed in
a python virtual environment:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>host:~$ sudo apt install python3-venv python3-pip
host:~$ python3 -m venv west-env
host:~$ source west-env/bin/activate
(west-env) host:~$ pip3 install west
</pre></div>
</div>
</div>
</li>
<li><p>Update the dependencies:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span><span class="nb">cd</span><span class="w"> </span>mcuxsdk
<span class="gp">host:~/mcuxsdk$ </span>west<span class="w"> </span>update
</pre></div>
</div>
<p>The directory <code class="docutils literal notranslate"><span class="pre">examples-phytec</span></code> contains all examples ported and tested
for phyBOARD-Pollux with version 2.13.0 of MCUX.</p>
<p>To build the firmware, a compiler toolchain and make/cmake are required.
The GNU Arm Embedded Toolchain may be available in your distributionâs
repositories, e.g. for Ubuntu.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>gcc-arm-none-eabi<span class="w"> </span>binutils-arm-none-eabi<span class="w"> </span>make<span class="w"> </span>cmake
</pre></div>
</div>
<p>The compiler toolchain can also be obtained directly from
<a class="reference external" href="https://developer.arm.com/">https://developer.arm.com/</a>. After the archive has been extracted,
the <code class="docutils literal notranslate"><span class="pre">ARMGCC_DIR</span></code> has to be added to the environment, e.g. for the
ARM toolchain 10-2020-q4-major release located in the home directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">ARMGCC_DIR</span><span class="o">=</span>~/gcc-arm-none-eabi-10-2020-q4-major
</pre></div>
</div>
</li>
</ol>
</section>
<section id="building-the-firmware">
<h3><span class="section-number">8.1.2. </span>Building the Firmware<a class="headerlink" href="#building-the-firmware" title="Link to this heading">ï</a></h3>
<p>To build the PHYTEC samples an environment has to be sourced</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~/mcuxsdk$ </span><span class="nb">source</span><span class="w"> </span>scripts/setenv
</pre></div>
</div>
<p>The scripts to build the firmware are located in
&lt;sdk-directory&gt;/phytec-mcux-boards/phyboard-pollux/&lt;example_category&gt;/&lt;example&gt;/armgcc.
There are scripts for each memory location the firmware is supposed to run in,
e.g.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>./build_release.sh
</pre></div>
</div>
<p>to build the firmware for the M7 Coreâs TCM. The output will be placed under
release/ in the armgcc directory. .bin files and can be run in U-Boot and .elf
files within Linux.</p>
<p>To build the firmware for the DRAM, run the script build_ddr_release.
The script of the firmware that is supposed to run, e.g.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>./build_ddr_release.sh
</pre></div>
</div>
<p>The output will be placed under ddr_release/ in the armgcc
directory. .bin files and can be run in U-Boot and .elf
files within Linux.</p>
</section>
</section>
<section id="running-mcore-examples">
<h2><span class="section-number">8.2. </span>Running M7 Core Examples<a class="headerlink" href="#running-mcore-examples" title="Link to this heading">ï</a></h2>
<p>There are two ways to run the M7 Core with the built firmware, U-Boot and
Remoteproc within a running Linux.</p>
<p>To receive debug messages start your favorite terminal software (e.g. Minicom,
Tio, or Tera Term) on your host PC and configure it for 115200 baud, 8 data
bits, no parity, and 1 stop bit (8n1) with no handshake.</p>
<p>Once a micro-USB cable is connected to the USB-debug port on the phyBOARD-Pollux, two
ttyUSB devices are registered. One prints messages from A53-Coreâs debug UART
and the other one from the M7 Coreâs debug UART.</p>
<section id="running-examples-from-u-boot">
<h3><span class="section-number">8.2.1. </span>Running Examples from U-Boot<a class="headerlink" href="#running-examples-from-u-boot" title="Link to this heading">ï</a></h3>
<p>To load firmware using the bootloader U-Boot, the bootaux command can be used:</p>
<ol class="arabic simple">
<li><p>Prepare an SD Card with our Yocto-BSP</p></li>
<li><p>Copy the generated .bin file to the SD Cards first partition</p></li>
<li><p>Stop the autoboot by pressing any key</p></li>
<li><p>Type the command depending on the type of firmware:</p></li>
</ol>
<p>For firmware built to run in the M7 Coreâs TCM:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; fatload mmc 1:1 0x48000000 firmware.bin;cp.b 0x48000000 0x7e0000 20000;
u-boot=&gt; bootaux 0x7e0000
## Starting auxiliary core stack = 0x20020000, pc = 0x000004CD...
</pre></div>
</div>
<p>For firmware built to run in the DRAM:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; fatload mmc 1:1 0x80000000 firmware.bin
u-boot=&gt; dcache flush
u-boot=&gt; bootaux 0x80000000
## Starting auxiliary core stack = 0x80400000, pc = 0x80000539...
</pre></div>
</div>
<p>The programâs output should appear on the M7 Coreâs debug UART.</p>
</section>
<section id="running-examples-from-linux-using-remoteproc">
<h3><span class="section-number">8.2.2. </span>Running Examples from Linux using Remoteproc<a class="headerlink" href="#running-examples-from-linux-using-remoteproc" title="Link to this heading">ï</a></h3>
<p>Remoteproc is a module that allows you to control the M7 Core from Linux
during runtime. Firmware built for TCM can be loaded and the execution started
or stopped. To use Remoteproc a devicetree overlay needs to be set:</p>
<p>Edit the bootenv.txt file located in the /boot directory on the target by
adding conf-imx8mp-phycore-rpmsg.dtbo:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>overlays=conf-imx8mp-phycore-rpmsg.dtbo
</pre></div>
</div>
<p>Restart the target and execute in U-Boot:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>u-boot=&gt; run prepare_mcore
</pre></div>
</div>
<p>Firmware .elf files for the M7 Core can be found under /lib/firmware.
To load the firmware, type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span>/lib/firmware/&lt;firmware&gt;.elf<span class="w"> </span>&gt;<span class="w"> </span>/sys/class/remoteproc/remoteproc0/firmware
<span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span>start<span class="w"> </span>&gt;<span class="w"> </span>/sys/class/remoteproc/remoteproc0/state
</pre></div>
</div>
<p>To load a different firmware, the M7 Core needs to be stopped:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">target:~$ </span><span class="nb">echo</span><span class="w"> </span>stop<span class="w"> </span>&gt;<span class="w"> </span>/sys/class/remoteproc/remoteproc0/state
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The samples found in <code class="docutils literal notranslate"><span class="pre">/lib/firmware</span></code> on the target come from NXPâs
Yocto layer meta-imx.
To use the samples you built yourself through MCUX SDK, please copy them
to <code class="docutils literal notranslate"><span class="pre">/lib/firmware</span></code> on the target after building them.</p>
</div>
</section>
<section id="debugging-using-j-link">
<h3><span class="section-number">8.2.3. </span>Debugging Using J-Link<a class="headerlink" href="#debugging-using-j-link" title="Link to this heading">ï</a></h3>
<p>The Segger software can be obtained from
<a class="reference external" href="https://www.segger.com/downloads/jlink/">https://www.segger.com/downloads/jlink/</a>. As of version V7.20a of the Segger
software, accessing the i.MX 8M Plusâ M7 Core requires additional configuration files
to be copied into the J-Link software directory: NXP J-Link files for i.MX 8M Plus</p>
<p>Together with the J-Link, GDB Server can be used for running and debugging the
software.  On the phyBOARD-Pollux, the JTAG-Pins are accessible via the
X6 Expansion Connector. The simplest way is to use a
PEB-EVAL-01 board that has the JTAG-Pins reachable with a pin header
on the top.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>gdb<span class="w"> </span>gdb-multiarch
</pre></div>
</div>
<p>To start the J-Link software, type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>JLinkGDBServer<span class="w"> </span>-if<span class="w"> </span>JTAG<span class="w"> </span>-device<span class="w"> </span>MIMX8ML8_M7
<span class="go">...</span>
<span class="go">Connected to target</span>
<span class="go">Waiting for GDB connection...</span>
</pre></div>
</div>
<p>To start GDB with a firmware example in another window, type:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">host:~$ </span>gdb-multiarch<span class="w"> </span>firmware.elf
<span class="go">...</span>
<span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">target remote localhost:2331</span>
<span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">monitor reset</span>
<span class="go">Resetting target</span>
<span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">load</span>
<span class="go">...</span>
<span class="gp gp-VirtualEnv">(gdb)</span> <span class="go">monitor go</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="imx8mp.html" class="btn btn-neutral float-left" title="i.MX 8M Plus Manuals" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mainline-head.html" class="btn btn-neutral float-right" title="1. PHYTEC Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, PHYTEC Messtechnik GmbH.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    Languages
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    
    <dl>
      <dt>Languages</dt>
        
          <dd><a href="https://phytec.github.io/doc-bsp-yocto/index.html">en</a></dd>
        
          <dd><a href="https://phytec.github.io/doc-bsp-yocto/zh_CN/index.html">zh_CN</a></dd>
        
    </dl>
    

    <div style="margin: 10px 0;"></div>
    <dl>
      <dt>Version</dt>
      <dd>imx95-alpha1-94-gf791886</dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>